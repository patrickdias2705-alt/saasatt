<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
   <link rel="shortcut icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
   <link rel="apple-touch-icon" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload de Lista</title>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Timeline Styles -->
    <link rel="stylesheet" href="styles/campaign-timeline.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Raleway', sans-serif;
        }

        body {
            background: #0a0420;
            min-height: 100vh;
            color: #ffffff;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(165, 148, 255, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.06) 0%, transparent 50%);
            animation: backgroundFloat 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(3%, 3%); }
        }

        .container {
            max-width: 100%;
            width: 100%;
            padding: 2rem 3rem;
            animation: fadeIn 0.6s ease-out;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .selection-info {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .selection-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .selection-item {
            text-align: center;
        }

        .selection-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .selection-value {
            font-size: 0.9rem;
            color: #ffffff;
            font-weight: 600;
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        .title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            padding: 0.25rem;
            margin-bottom: 1.5rem;
        }

        .tab {
            flex: 1;
            padding: 0.75rem 1rem;
            text-align: center;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: #ffffff;
            background: rgba(139, 122, 255, 0.3);
        }

        .subtitle {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2rem;
        }

        .upload-area {
            border: 2px dashed rgba(165, 148, 255, 0.3);
            border-radius: 1rem;
            padding: 3rem 2rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: rgba(165, 148, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .file-input {
            display: none;
        }

        .header {
            margin-bottom: 2rem;
        }

        .mapping-section {
            display: none;
        }

        .mapping-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 1rem;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: rgba(30, 25, 60, 0.8);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.75rem;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #A594FF;
            background: rgba(40, 32, 75, 0.85);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 0.875rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .btn-primary {
            background: linear-gradient(135deg, #A594FF, #764ba2);
            color: white;
            box-shadow: 0 4px 16px rgba(165, 148, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(165, 148, 255, 0.4);
            background: linear-gradient(135deg, #B5A4FF, #8B6BC2);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .error-message, .success-message {
            padding: 0.875rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: none;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ffffff;
        }

        .success-message {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #ffffff;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 4, 32, 0.85);
            backdrop-filter: blur(12px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .popup-modal {
            background: linear-gradient(135deg, rgba(25, 20, 50, 0.95), rgba(20, 15, 45, 0.95));
            backdrop-filter: blur(30px);
            border: 1.5px solid rgba(165, 148, 255, 0.25);
            border-radius: 1.25rem;
            padding: 2.5rem 2rem;
            max-width: 440px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            animation: slideUp 0.3s ease;
        }

        .popup-icon-container {
            width: 72px;
            height: 72px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.15), rgba(165, 148, 255, 0.08));
            border: 1.5px solid rgba(165, 148, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #A594FF;
        }

        .popup-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1rem;
        }

        .popup-description {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .contact-highlight {
            color: #A594FF;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .popup-buttons {
            display: flex;
            gap: 0.875rem;
            justify-content: center;
        }

        .btn-cancel {
            padding: 0.875rem 1.5rem;
            background: rgba(255, 255, 255, 0.06);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .btn-start-campaign {
            padding: 0.875rem 1.75rem;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.9), rgba(145, 128, 235, 0.9));
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 16px rgba(165, 148, 255, 0.25);
        }

        .btn-start-campaign:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(165, 148, 255, 0.35);
            background: linear-gradient(135deg, rgba(175, 158, 255, 0.95), rgba(155, 138, 245, 0.95));
        }

        .btn-start-campaign:active {
            transform: translateY(0);
        }

        /* ==================== CAPACITY CARD ==================== */

        .capacity-card {
            background: linear-gradient(135deg, rgba(30, 25, 60, 0.6), rgba(25, 20, 55, 0.6));
            border: 1.5px solid rgba(165, 148, 255, 0.25);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .capacity-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .capacity-card-icon {
            color: #A594FF;
        }

        .capacity-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #ffffff;
        }

        .capacity-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .capacity-item {
            background: rgba(10, 5, 30, 0.4);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 0.75rem;
            padding: 1.25rem;
            text-align: center;
        }

        .capacity-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .capacity-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
        }

        .capacity-value.highlight {
            color: #A594FF;
        }

        .capacity-progress {
            margin-top: 1.5rem;
        }

        .capacity-progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .capacity-progress-label > span:first-child {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .capacity-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .capacity-status svg {
            width: 16px;
            height: 16px;
        }

        .capacity-status.status-ok {
            color: #22C55E;
        }

        .capacity-status.status-warning {
            color: #F59E0B;
        }

        .capacity-status.status-danger {
            color: #EF4444;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(165, 148, 255, 0.1);
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #A594FF, #8B7AE5);
            border-radius: 1rem;
            transition: width 0.6s ease, background 0.3s ease;
            box-shadow: 0 0 10px rgba(165, 148, 255, 0.5);
        }

        .progress-bar-fill.warning {
            background: linear-gradient(90deg, #F59E0B, #D97706);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .progress-bar-fill.danger {
            background: linear-gradient(90deg, #EF4444, #DC2626);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        @media (max-width: 768px) {
            .mapping-grid, .selection-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .popup-buttons {
                flex-direction: column;
            }

            .capacity-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="selection-info" id="selectionInfo" style="display: none;">
            <div class="selection-title">Configura√ß√£o da Campanha</div>
            <div class="selection-grid">
                <div class="selection-item">
                    <div class="selection-label">Assistente</div>
                    <div class="selection-value" id="selectedAssistant">-</div>
                </div>
                <div class="selection-item">
                    <div class="selection-label">N√∫mero</div>
                    <div class="selection-value" id="selectedNumber">-</div>
                </div>
                <div class="selection-item">
                    <div class="selection-label">Inst√¢ncia WhatsApp</div>
                    <div class="selection-value" id="selectedInstance">N√£o selecionada</div>
                </div>
            </div>
        </div>

        <div class="glass-card">
            <div class="header">
                <h1 class="title">Upload de Lista</h1>
            </div>

            <div class="tabs">
                <div class="tab">Lista com Leads</div>
            </div>

            <p class="subtitle">
                Envie sua planilha com os leads que deseja contatar
            </p>

            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <div id="uploadSection">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-text">üìä Selecionar Arquivo</div>
                    <div class="upload-subtext">Clique ou arraste um arquivo CSV ou Excel</div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls">
            </div>

            <!-- Card de Capacidade do Plano -->
            <div id="capacitySection" class="capacity-card" style="display: none;">
                <div class="capacity-card-header">
                    <svg class="capacity-card-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>
                    <h3 class="capacity-card-title">Capacidade do Seu Plano</h3>
                </div>

                <div class="capacity-grid">
                    <div class="capacity-item">
                        <div class="capacity-label">Liga√ß√µes/Hora</div>
                        <div class="capacity-value" id="planHourlyCapacity">-</div>
                    </div>
                    <div class="capacity-item">
                        <div class="capacity-label">Limite Di√°rio</div>
                        <div class="capacity-value highlight" id="planDailyCapacity">-</div>
                    </div>
                    <div class="capacity-item">
                        <div class="capacity-label">Leads no Arquivo</div>
                        <div class="capacity-value highlight" id="uploadedLeadsCount">-</div>
                    </div>
                </div>

                <div class="capacity-progress">
                    <div class="capacity-progress-label">
                        <span>Uso da Capacidade</span>
                        <span class="capacity-status" id="capacityStatus">-</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="capacityProgressBar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <div id="mappingSection" class="mapping-section">
                <h2 class="mapping-title">Mapear Colunas</h2>

                <div class="mapping-grid">
                    <div class="form-group">
                        <label for="nameColumn" class="form-label">Coluna de Nome</label>
                        <select id="nameColumn" class="form-select">
                            <option value="">Selecionar...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="phoneColumn" class="form-label">Coluna de Telefone</label>
                        <select id="phoneColumn" class="form-select">
                            <option value="">Selecionar...</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="campaignName" class="form-label">Nome da Campanha</label>
                    <input
                        type="text"
                        id="campaignName"
                        class="form-input"
                        placeholder="Ex: Prospec√ß√£o Im√≥veis - Setembro 2024"
                    />
                </div>
            </div>

            <!-- Seletor de Data -->
            <div id="schedulingSection" class="scheduling-section" style="display: none;">
                <h3>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.5rem;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Configurar Data da Campanha
                </h3>

                <div class="date-time-selector">
                    <div class="campaign-date-selector">
                        <!-- Display da data selecionada -->
                        <div class="current-date-display">
                            <div class="current-date-info">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#A594FF" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                <span class="current-date-label" id="currentDateLabel">Selecione uma data</span>
                            </div>
                            <button type="button" class="choose-date-btn" onclick="toggleCampaignCalendar()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                Escolher data
                            </button>
                        </div>

                        <!-- Calend√°rio (escondido por padr√£o) -->
                        <div id="campaignCalendarWrapper" class="campaign-calendar-wrapper">
                            <div class="calendar-month-nav">
                                <button type="button" class="calendar-nav-btn" onclick="changeCampaignMonth(-1)">‚óÄ</button>
                                <span class="calendar-month-label" id="campaignMonthLabel">Novembro 2025</span>
                                <button type="button" class="calendar-nav-btn" onclick="changeCampaignMonth(1)">‚ñ∂</button>
                            </div>
                            <div id="campaignCalendarContainer">
                                <div class="date-loading">Carregando calend√°rio...</div>
                            </div>
                        </div>

                        <!-- Input hidden para manter compatibilidade -->
                        <input type="hidden" id="campaignDate" class="form-input">
                    </div>
                </div>
            </div>

            <!-- Visualiza√ß√£o da Timeline Interativa -->
            <div id="campaignTimeline" class="campaign-timeline" style="display: none;">
                <div class="timeline-header-actions">
                    <div>
                        <h3>
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: middle; margin-right: 0.5rem;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Escolha o Hor√°rio da Campanha
                        </h3>
                        <p class="timeline-instruction">
                            <span class="pulse-dot"></span>
                            Arraste o bloco para o hor√°rio desejado
                        </p>
                    </div>
                    <button type="button" id="resetCampaignBtn" class="btn-reset" onclick="resetCampaignPosition()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                            <path d="M21 3v5h-5"></path>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                            <path d="M3 21v-5h5"></path>
                        </svg>
                        Reiniciar
                    </button>
                </div>

                <div class="timeline-summary">
                    <div class="summary-card">
                        <div class="summary-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="20" x2="12" y2="10"></line>
                                <line x1="18" y1="20" x2="18" y2="4"></line>
                                <line x1="6" y1="20" x2="6" y2="16"></line>
                            </svg>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Dura√ß√£o</div>
                            <div class="summary-value" id="selectedHoursCount">0h</div>
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Total de Liga√ß√µes</div>
                            <div class="summary-value" id="totalCallsScheduled">0</div>
                        </div>
                    </div>
                    <div class="summary-card highlight">
                        <div class="summary-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="summary-content">
                            <div class="summary-label">Hor√°rio</div>
                            <div class="summary-value">
                                <span id="startTime">-</span>
                                <span class="separator">at√©</span>
                                <span id="endTime">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="calendar-timeline">
                    <div class="timeline-hours-column" id="hoursColumn">
                        <!-- Hor√°rios do dia -->
                    </div>

                    <div class="campaign-block-container" id="campaignBlockContainer">
                        <div class="drop-zone-hint">
                            <div class="hint-animation">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M19 12H5M5 12l7-7M5 12l7 7"/>
                                </svg>
                            </div>
                            <p>Arraste o bloco da sua campanha para um dos hor√°rios ao lado para definir o in√≠cio</p>
                        </div>

                        <div id="campaignBlock" class="campaign-block" draggable="true">
                            <div class="campaign-block-header">
                                <div class="block-icon">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                </div>
                                <span>Sua Campanha</span>
                            </div>
                            <div class="campaign-block-stats">
                                <div class="stat-badge">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                    </svg>
                                    <span id="campaignBlockLeads">0 leads</span>
                                </div>
                                <div class="stat-badge">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    <span id="campaignBlockDuration">0h</span>
                                </div>
                            </div>
                            <div class="campaign-drag-hint">
                                Arraste para o hor√°rio desejado
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button type="button" id="previousBtn" class="btn btn-secondary">
                    ‚Üê <span id="previousBtnText">Voltar</span>
                </button>
                <button type="button" id="nextBtn" class="btn btn-primary">
                    <span id="nextBtnText">Pr√≥ximo ‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <div id="campaignPopup" class="popup-overlay">
        <div class="popup-modal">
            <div class="popup-icon-container">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            <h2 class="popup-title">Confirmar Campanha</h2>
            <p class="popup-description">
                Sua campanha est√° pronta para iniciar com <span id="contactCount" class="contact-highlight">0</span> leads
            </p>
            <div class="popup-buttons">
                <button type="button" id="cancelCampaign" class="btn-cancel">
                    Cancelar
                </button>
                <button type="button" id="startCampaign" class="btn-start-campaign">
                    <span id="campaignBtnText">Iniciar Campanha</span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        // ==================== FUN√á√ïES DE C√ÅLCULO DE CAPACIDADE ====================

        const CALLS_PER_HOUR_PER_LINE = 75;
        const COMMERCIAL_HOURS = 8;
        const CALLS_PER_DAY_PER_LINE = 600;
        const COMMERCIAL_START = "08:00";
        const COMMERCIAL_END = "18:00";
        const INTERVAL_MINUTES = 30;

        function calculateHourlyCapacity(numeroLinhas) {
            return numeroLinhas * CALLS_PER_HOUR_PER_LINE;
        }

        function calculateDailyCapacity(numeroLinhas) {
            return numeroLinhas * CALLS_PER_DAY_PER_LINE;
        }

        function calculateCampaignDuration(numLeads, numeroLinhas) {
            const hourlyCapacity = calculateHourlyCapacity(numeroLinhas);
            const horasCompletas = Math.floor(numLeads / hourlyCapacity);
            const leadsRestantes = numLeads % hourlyCapacity;
            const minutosRestantes = leadsRestantes > 0
                ? Math.ceil((leadsRestantes / hourlyCapacity) * 60 / INTERVAL_MINUTES) * INTERVAL_MINUTES
                : 0;
            return (horasCompletas * 60) + minutosRestantes;
        }

        function addMinutes(time, minutes) {
            const [hours, mins] = time.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, mins + minutes, 0, 0);
            const newHours = String(date.getHours()).padStart(2, '0');
            const newMins = String(date.getMinutes()).padStart(2, '0');
            return `${newHours}:${newMins}`;
        }

        function calculateEndTime(startTime, durationMinutes) {
            return addMinutes(startTime, durationMinutes);
        }

        function isCommercialTime(time) {
            const [hours, minutes] = time.split(':').map(Number);
            const timeInMinutes = hours * 60 + minutes;
            const [startHours, startMins] = COMMERCIAL_START.split(':').map(Number);
            const startInMinutes = startHours * 60 + startMins;
            const [endHours, endMins] = COMMERCIAL_END.split(':').map(Number);
            const endInMinutes = endHours * 60 + endMins;
            return timeInMinutes >= startInMinutes && timeInMinutes <= endInMinutes;
        }

        function generateTimeline(numLeads, startTime, numeroLinhas) {
            const hourlyCapacity = calculateHourlyCapacity(numeroLinhas);
            const halfHourCapacity = Math.floor(hourlyCapacity / 2);
            const intervalos = [];
            let leadsRestantes = numLeads;
            let currentTime = startTime;

            while (leadsRestantes > 0) {
                const ligacoesIntervalo = Math.min(leadsRestantes, halfHourCapacity);
                const endTime = addMinutes(currentTime, INTERVAL_MINUTES);
                intervalos.push({
                    inicio: currentTime,
                    fim: endTime,
                    ligacoes: ligacoesIntervalo,
                    isPartial: ligacoesIntervalo < halfHourCapacity,
                    isFull: ligacoesIntervalo === halfHourCapacity
                });
                leadsRestantes -= ligacoesIntervalo;
                currentTime = endTime;
            }
            return intervalos;
        }

        function groupIntervalsToHours(intervalos) {
            const hoursBlocks = [];
            for (let i = 0; i < intervalos.length; i += 2) {
                const first = intervalos[i];
                const second = intervalos[i + 1];
                if (second) {
                    hoursBlocks.push({
                        inicio: first.inicio,
                        fim: second.fim,
                        ligacoes: first.ligacoes + second.ligacoes,
                        isFull: first.isFull && second.isFull
                    });
                } else {
                    hoursBlocks.push({
                        inicio: first.inicio,
                        fim: first.fim,
                        ligacoes: first.ligacoes,
                        isFull: false,
                        isPartial: true
                    });
                }
            }
            return hoursBlocks;
        }

        function validateCampaign(numLeads, startTime, numeroLinhas) {
            const dailyCapacity = calculateDailyCapacity(numeroLinhas);
            if (numLeads > dailyCapacity) {
                return {
                    valid: false,
                    error: `LIMIT_EXCEEDED`,
                    maxLeads: dailyCapacity,
                    attemptedLeads: numLeads
                };
            }
            if (!isCommercialTime(startTime)) {
                return {
                    valid: false,
                    error: `INVALID_START_TIME`,
                    commercialStart: COMMERCIAL_START,
                    commercialEnd: COMMERCIAL_END
                };
            }
            const duration = calculateCampaignDuration(numLeads, numeroLinhas);
            const endTime = calculateEndTime(startTime, duration);
            if (!isCommercialTime(endTime) || endTime > COMMERCIAL_END) {
                return {
                    valid: false,
                    error: `INVALID_TIMEFRAME`,
                    endTime: endTime,
                    commercialEnd: COMMERCIAL_END
                };
            }
            return { valid: true };
        }

        async function getUserPlanData() {
            let numeroLinhas = parseInt(localStorage.getItem('numero_linhas') || '0');

            // Se numero_linhas for 0, tenta buscar do servidor
            if (numeroLinhas === 0) {
                console.warn('‚ö†Ô∏è [PLANILHA] numero_linhas est√° zerado, buscando do servidor...');
                try {
                    const tenantId = localStorage.getItem('tenant_id');
                    const orgPrivateKey = localStorage.getItem('org_private_key');
                    const userEmail = localStorage.getItem('userEmail') || localStorage.getItem('login');

                    if (tenantId && orgPrivateKey && userEmail) {
                        const response = await fetch('https://sdr.salesdever.io/webhook/ver-minutos-saas', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                tenant_id: tenantId,
                                org_private_key: orgPrivateKey,
                                login: userEmail
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const planData = Array.isArray(data) ? data[0] : data;

                            // Tenta diferentes nomes de campos
                            numeroLinhas = parseInt(planData.numero_linhas || planData.number_lines || planData.num_linhas || planData.lines || '0');

                            console.log('üìä [PLANILHA] numero_linhas carregado do servidor:', numeroLinhas);

                            if (numeroLinhas > 0) {
                                // Salva no localStorage para pr√≥ximas vezes
                                localStorage.setItem('numero_linhas', String(numeroLinhas));
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå [PLANILHA] Erro ao buscar numero_linhas do servidor:', error);
                }
            }

            const ligacoesPorHora = calculateHourlyCapacity(numeroLinhas);
            const ligacoesDiarias = calculateDailyCapacity(numeroLinhas);
            return { numeroLinhas, ligacoesPorHora, ligacoesDiarias };
        }

        function getAvailableStartTimes() {
            const times = [];
            const [startHour] = COMMERCIAL_START.split(':').map(Number);
            const [endHour] = COMMERCIAL_END.split(':').map(Number);
            for (let hour = startHour; hour < endHour; hour++) {
                times.push(`${String(hour).padStart(2, '0')}:00`);
                times.push(`${String(hour).padStart(2, '0')}:30`);
            }
            return times;
        }

        function getMinScheduleDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ==================== FUN√á√ïES DE TIMEZONE E VALIDA√á√ÉO DE HOR√ÅRIO ====================

        function getBrasiliaDateTime() {
            // Retorna objeto Date no timezone de Bras√≠lia
            const brazilTime = new Date().toLocaleString("en-US", {
                timeZone: "America/Sao_Paulo"
            });
            return new Date(brazilTime);
        }

        function getBrasiliaTime() {
            // Retorna hor√°rio atual de Bras√≠lia no formato HH:mm
            const brasiliaDate = getBrasiliaDateTime();
            const hours = String(brasiliaDate.getHours()).padStart(2, '0');
            const minutes = String(brasiliaDate.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function getNextAvailableHour() {
            // Arredonda para a pr√≥xima hora cheia (ex: 13h32 -> 14h00)
            const brasiliaDate = getBrasiliaDateTime();
            let nextHour = brasiliaDate.getHours();

            // Se tem minutos, vai para pr√≥xima hora
            if (brasiliaDate.getMinutes() > 0) {
                nextHour += 1;
            }

            return `${String(nextHour).padStart(2, '0')}:00`;
        }

        function canScheduleToday(campaignDurationHours) {
            // Verifica se a campanha cabe no hor√°rio comercial de hoje
            const brasiliaDate = getBrasiliaDateTime();
            const currentHour = brasiliaDate.getHours();
            const currentMinutes = brasiliaDate.getMinutes();

            // Pr√≥ximo hor√°rio dispon√≠vel (arredondado para hora cheia)
            let nextAvailableHour = currentHour;
            if (currentMinutes > 0) {
                nextAvailableHour += 1;
            }

            // Hor√°rio de t√©rmino da campanha
            const endHour = nextAvailableHour + campaignDurationHours;

            // Extrai hora do COMMERCIAL_END (18:00)
            const [commercialEndHour] = COMMERCIAL_END.split(':').map(Number);

            // Verifica se a campanha terminaria antes do fim do expediente
            return endHour <= commercialEndHour;
        }

        function isHourInPast(hourString) {
            // Verifica se um hor√°rio (HH:mm) j√° passou hoje
            const brasiliaTime = getBrasiliaTime();
            const [currentHour, currentMinutes] = brasiliaTime.split(':').map(Number);
            const [checkHour, checkMinutes] = hourString.split(':').map(Number);

            const currentInMinutes = currentHour * 60 + currentMinutes;
            const checkInMinutes = checkHour * 60 + checkMinutes;

            return checkInMinutes < currentInMinutes;
        }

        function isDateToday(dateString) {
            // Verifica se a data selecionada √© hoje
            const brasiliaDate = getBrasiliaDateTime();
            const todayString = `${brasiliaDate.getFullYear()}-${String(brasiliaDate.getMonth() + 1).padStart(2, '0')}-${String(brasiliaDate.getDate()).padStart(2, '0')}`;
            return dateString === todayString;
        }

        // ==================== CALEND√ÅRIO PERSONALIZADO ====================

        let calendarCurrentMonth = null;
        let calendarCurrentYear = null;
        let todayUnavailable = false; // Se true, hoje ser√° tratado como passado no calend√°rio

        function initializeCampaignCalendar() {
            const brasiliaDate = getBrasiliaDateTime();
            calendarCurrentMonth = brasiliaDate.getMonth();
            calendarCurrentYear = brasiliaDate.getFullYear();

            // Define a data de hoje como padr√£o
            const todayString = `${calendarCurrentYear}-${String(calendarCurrentMonth + 1).padStart(2, '0')}-${String(brasiliaDate.getDate()).padStart(2, '0')}`;
            selectCampaignDate(todayString);

            renderCampaignCalendar();
        }

        function checkTodayAvailability() {
            // Verifica se a campanha cabe hoje e atualiza o calend√°rio
            if (campaignDuration > 0 && !canScheduleToday(campaignDuration)) {
                todayUnavailable = true;

                // Seleciona amanh√£ automaticamente
                const brasiliaDate = getBrasiliaDateTime();
                const tomorrow = new Date(brasiliaDate);
                tomorrow.setDate(tomorrow.getDate() + 1);

                const tomorrowString = `${tomorrow.getFullYear()}-${String(tomorrow.getMonth() + 1).padStart(2, '0')}-${String(tomorrow.getDate()).padStart(2, '0')}`;
                selectCampaignDate(tomorrowString);

                // Re-renderiza o calend√°rio para marcar hoje como passado
                renderCampaignCalendar();

                // Mostra o aviso
                showError(`‚ö†Ô∏è Campanha de ${campaignDuration}h n√£o cabe hoje (hor√°rio atual: ${getBrasiliaTime()}). Selecionamos automaticamente amanh√£.`);

                return false;
            }

            todayUnavailable = false;
            return true;
        }

        function renderCampaignCalendar() {
            const container = document.getElementById('campaignCalendarContainer');
            const monthLabel = document.getElementById('campaignMonthLabel');

            // Nome do m√™s
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            monthLabel.textContent = `${monthNames[calendarCurrentMonth]} ${calendarCurrentYear}`;

            // Grid do calend√°rio
            let html = '<div class="calendar-grid">';

            // Dias da semana
            const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            weekdays.forEach(day => {
                html += `<div class="calendar-weekday">${day}</div>`;
            });

            // Primeiro dia do m√™s e total de dias
            const firstDay = new Date(calendarCurrentYear, calendarCurrentMonth, 1).getDay();
            const daysInMonth = new Date(calendarCurrentYear, calendarCurrentMonth + 1, 0).getDate();

            // Data atual (Bras√≠lia)
            const brasiliaDate = getBrasiliaDateTime();
            const todayYear = brasiliaDate.getFullYear();
            const todayMonth = brasiliaDate.getMonth();
            const todayDay = brasiliaDate.getDate();

            // Data selecionada atual
            const selectedDate = document.getElementById('campaignDate').value;

            // Espa√ßos vazios antes do primeiro dia
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // Dias do m√™s
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${calendarCurrentYear}-${String(calendarCurrentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // Verifica se √© passado
                let isPast = false;
                if (calendarCurrentYear < todayYear) {
                    isPast = true;
                } else if (calendarCurrentYear === todayYear && calendarCurrentMonth < todayMonth) {
                    isPast = true;
                } else if (calendarCurrentYear === todayYear && calendarCurrentMonth === todayMonth && day < todayDay) {
                    isPast = true;
                }

                const isToday = calendarCurrentYear === todayYear && calendarCurrentMonth === todayMonth && day === todayDay;

                // Se hoje est√° indispon√≠vel (campanha n√£o cabe), trata hoje como passado
                if (isToday && todayUnavailable) {
                    isPast = true;
                }

                const isSelected = dateStr === selectedDate;

                let classes = 'calendar-day';
                if (isPast) {
                    classes += ' past';
                } else {
                    classes += ' available';
                }
                if (isToday && !todayUnavailable) classes += ' today';
                if (isSelected) classes += ' active';

                const onclick = !isPast ? `onclick="selectCampaignDate('${dateStr}')"` : '';

                html += `<div class="${classes}" ${onclick}>${day}</div>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function changeCampaignMonth(delta) {
            calendarCurrentMonth += delta;
            if (calendarCurrentMonth > 11) {
                calendarCurrentMonth = 0;
                calendarCurrentYear++;
            } else if (calendarCurrentMonth < 0) {
                calendarCurrentMonth = 11;
                calendarCurrentYear--;
            }
            renderCampaignCalendar();
        }

        function selectCampaignDate(dateStr) {
            // Atualiza o input hidden
            document.getElementById('campaignDate').value = dateStr;

            // Atualiza o display da data
            const parts = dateStr.split('-');
            const day = parseInt(parts[2]);
            const month = parseInt(parts[1]);
            const year = parseInt(parts[0]);

            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

            const brasiliaDate = getBrasiliaDateTime();
            const todayYear = brasiliaDate.getFullYear();
            const todayMonth = brasiliaDate.getMonth();
            const todayDay = brasiliaDate.getDate();

            let displayText = '';
            if (year === todayYear && month - 1 === todayMonth && day === todayDay) {
                displayText = 'Hoje';
            } else if (year === todayYear && month - 1 === todayMonth && day === todayDay + 1) {
                displayText = 'Amanh√£';
            } else {
                displayText = `${day} de ${monthNames[month - 1]}`;
                if (year !== todayYear) {
                    displayText += ` de ${year}`;
                }
            }

            document.getElementById('currentDateLabel').textContent = displayText;

            // Re-renderiza o calend√°rio para atualizar o active
            renderCampaignCalendar();

            // Fecha o calend√°rio
            document.getElementById('campaignCalendarWrapper').classList.remove('show');

            // Dispara evento de mudan√ßa para atualizar a timeline
            const event = new Event('change');
            document.getElementById('campaignDate').dispatchEvent(event);

            console.log('[CALENDAR] Data selecionada:', dateStr);
        }

        function toggleCampaignCalendar() {
            const wrapper = document.getElementById('campaignCalendarWrapper');
            wrapper.classList.toggle('show');
        }

        // Fechar calend√°rio ao clicar fora
        document.addEventListener('click', function(e) {
            const wrapper = document.getElementById('campaignCalendarWrapper');
            const selector = document.querySelector('.campaign-date-selector');

            if (wrapper && selector && !selector.contains(e.target)) {
                wrapper.classList.remove('show');
            }
        });

        // ==================== RENDERIZA√á√ÉO DE CALEND√ÅRIO COM DRAG AND DROP ====================

        let campaignStartHour = null;
        let campaignDuration = 0; // em horas
        let allHours = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];
        let draggedBlock = null;

        function renderInteractiveTimeline() {
            const hoursColumn = document.getElementById('hoursColumn');
            if (!hoursColumn) {
                console.error('Elemento hoursColumn n√£o encontrado');
                return;
            }

            hoursColumn.innerHTML = '';

            // Calcula dura√ß√£o necess√°ria da campanha
            const numLeads = processedLeads.length;
            const hourlyCapacity = calculateHourlyCapacity(planData.numeroLinhas);
            campaignDuration = Math.ceil(numLeads / hourlyCapacity);

            // Verifica se a data selecionada √© hoje
            const dateInput = document.getElementById('campaignDate');
            const selectedDate = dateInput ? dateInput.value : '';
            const isToday = isDateToday(selectedDate);

            // Renderiza cada hora do dia
            allHours.forEach((hour, index) => {
                const hourRow = document.createElement('div');
                hourRow.className = 'hour-row';
                hourRow.dataset.hour = hour;
                hourRow.dataset.index = index;

                // Verifica se o hor√°rio est√° no passado (apenas se for hoje)
                const isPast = isToday && isHourInPast(hour);

                // Verifica se a campanha cabe come√ßando neste hor√°rio
                const [hourNum] = hour.split(':').map(Number);
                const endHour = hourNum + campaignDuration;
                const [commercialEndHour] = COMMERCIAL_END.split(':').map(Number);
                const isUnavailable = endHour > commercialEndHour;

                // Adiciona classes CSS apropriadas (sem badges visuais)
                if (isPast) {
                    hourRow.classList.add('past-hour');
                    hourRow.dataset.disabled = 'true';
                    hourRow.dataset.reason = 'Hor√°rio j√° passou';
                } else if (isUnavailable) {
                    hourRow.classList.add('unavailable');
                    hourRow.dataset.disabled = 'true';
                    hourRow.dataset.reason = `Campanha de ${campaignDuration}h terminaria ap√≥s ${COMMERCIAL_END}`;
                }

                hourRow.innerHTML = `
                    <div>
                        <div class="hour-row-time">${formatTimeForDisplay(hour)}</div>
                        <div class="hour-row-capacity">Cap: ${formatNumber(hourlyCapacity)}/h</div>
                    </div>
                `;

                // Eventos de drop e click (s√≥ adiciona se n√£o estiver desabilitado)
                if (!isPast && !isUnavailable) {
                    hourRow.addEventListener('dragover', handleDragOver);
                    hourRow.addEventListener('dragleave', handleDragLeave);
                    hourRow.addEventListener('drop', handleDrop);
                    hourRow.addEventListener('click', handleHourClick);
                    hourRow.style.cursor = 'pointer';
                }

                hoursColumn.appendChild(hourRow);
            });

            setupCampaignBlock();
            suggestInitialPosition();

            console.log('‚úÖ Calend√°rio interativo renderizado');
        }

        function setupCampaignBlock() {
            const block = document.getElementById('campaignBlock');
            const numLeads = processedLeads.length;

            document.getElementById('campaignBlockLeads').textContent = `${formatNumber(numLeads)} leads`;
            document.getElementById('campaignBlockDuration').textContent = `${campaignDuration}h necess√°rias`;

            block.addEventListener('dragstart', handleDragStart);
            block.addEventListener('dragend', handleDragEnd);
        }

        function suggestInitialPosition() {
            // Encontra o primeiro hor√°rio dispon√≠vel (n√£o passado e n√£o indispon√≠vel)
            const hoursColumn = document.getElementById('hoursColumn');
            const hourRows = hoursColumn.querySelectorAll('.hour-row');

            for (let i = 0; i < hourRows.length; i++) {
                const row = hourRows[i];
                const isDisabled = row.dataset.disabled === 'true';

                if (!isDisabled && i + campaignDuration <= allHours.length) {
                    placeCampaignBlock(i);
                    return;
                }
            }

            // Se n√£o encontrou hor√°rio dispon√≠vel, n√£o posiciona
            console.warn('‚ö†Ô∏è N√£o h√° hor√°rio dispon√≠vel para a campanha');
        }

        // ==================== DRAG AND DROP HANDLERS ====================

        function handleDragStart(e) {
            const block = e.target;
            block.classList.add('dragging');
            draggedBlock = block;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', block.innerHTML);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedBlock = null;
            document.querySelectorAll('.hour-row').forEach(row => {
                row.classList.remove('drop-target');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }

            const hourRow = e.currentTarget;

            // Bloqueia hover em hor√°rios desabilitados
            if (hourRow.dataset.disabled === 'true') {
                e.dataTransfer.dropEffect = 'none';
                return false;
            }

            e.dataTransfer.dropEffect = 'move';
            hourRow.classList.add('drop-target');
            return false;
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drop-target');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();

            const hourRow = e.currentTarget;
            let startIndex = parseInt(hourRow.dataset.index);

            // Se o hor√°rio est√° desabilitado, encontra o pr√≥ximo dispon√≠vel
            if (hourRow.dataset.disabled === 'true') {
                const reason = hourRow.dataset.reason || 'Hor√°rio indispon√≠vel';
                const nextAvailable = findNextAvailableSlot(startIndex);

                if (nextAvailable === -1) {
                    showError('N√£o h√° hor√°rios dispon√≠veis para esta campanha hoje. Tente selecionar outra data.');
                    hourRow.classList.remove('drop-target');
                    return false;
                }

                // Mostra mensagem e move automaticamente para pr√≥ximo hor√°rio
                showError(`${reason}. Movendo para ${formatTimeForDisplay(allHours[nextAvailable])}`);
                startIndex = nextAvailable;
            }

            // Verifica se cabe no per√≠odo
            if (startIndex + campaignDuration > allHours.length) {
                showError(`Campanha de ${campaignDuration}h n√£o cabe come√ßando √†s ${formatTimeForDisplay(allHours[startIndex])}`);
                hourRow.classList.remove('drop-target');
                return false;
            }

            placeCampaignBlock(startIndex);
            hourRow.classList.remove('drop-target');
            return false;
        }

        function handleHourClick(e) {
            const hourRow = e.currentTarget;
            let startIndex = parseInt(hourRow.dataset.index);

            // Se o hor√°rio est√° desabilitado, n√£o faz nada
            if (hourRow.dataset.disabled === 'true') {
                return;
            }

            // Verifica se cabe no per√≠odo
            if (startIndex + campaignDuration > allHours.length) {
                showError(`Campanha de ${campaignDuration}h n√£o cabe come√ßando √†s ${formatTimeForDisplay(allHours[startIndex])}`);
                return;
            }

            placeCampaignBlock(startIndex);
        }

        function findNextAvailableSlot(fromIndex) {
            // Encontra o pr√≥ximo hor√°rio dispon√≠vel a partir de um √≠ndice
            const hoursColumn = document.getElementById('hoursColumn');
            const hourRows = hoursColumn.querySelectorAll('.hour-row');

            for (let i = fromIndex; i < hourRows.length; i++) {
                const row = hourRows[i];
                const isDisabled = row.dataset.disabled === 'true';

                // Verifica se est√° dispon√≠vel e se a campanha cabe
                if (!isDisabled && i + campaignDuration <= allHours.length) {
                    return i;
                }
            }

            return -1; // Nenhum hor√°rio dispon√≠vel
        }

        function placeCampaignBlock(startIndex) {
            campaignStartHour = allHours[startIndex];

            const block = document.getElementById('campaignBlock');
            const hoursColumn = document.getElementById('hoursColumn');
            const hourRows = hoursColumn.querySelectorAll('.hour-row');
            const startRow = hourRows[startIndex];

            if (!startRow) return;

            // Posiciona o bloco
            const rowHeight = 70;
            const topPosition = startIndex * rowHeight;
            const blockHeight = campaignDuration * rowHeight;

            block.style.position = 'absolute';
            block.style.top = `${topPosition}px`;
            block.style.height = `${blockHeight}px`;
            block.style.left = '2rem';
            block.style.right = '2rem';
            block.style.width = 'auto';
            block.style.minWidth = 'auto';

            // Marca hora rows como ocupadas (remove unavailable para sobressair o visual)
            document.querySelectorAll('.hour-row').forEach(row => row.classList.remove('occupied'));
            for (let i = startIndex; i < startIndex + campaignDuration && i < allHours.length; i++) {
                hourRows[i].classList.remove('unavailable', 'past-hour'); // Remove bloqueio visual
                hourRows[i].classList.add('occupied');
                hourRows[i].style.opacity = '1'; // Garante visibilidade total
            }

            updateDragSummary();
            console.log(`‚úÖ Campanha posicionada: ${campaignStartHour} (${campaignDuration}h)`);
        }

        function resetCampaignPosition() {
            const block = document.getElementById('campaignBlock');
            block.style.position = 'relative';
            block.style.top = 'auto';
            block.style.height = 'auto';
            block.style.left = 'auto';
            block.style.right = 'auto';
            block.style.width = 'auto';

            campaignStartHour = null;
            document.querySelectorAll('.hour-row').forEach(row => row.classList.remove('occupied'));
            updateDragSummary();
            suggestInitialPosition();
        }

        function updateDragSummary() {
            if (campaignStartHour) {
                const startIndex = allHours.indexOf(campaignStartHour);
                const endHour = allHours[startIndex + campaignDuration - 1];
                const endTime = addMinutes(endHour, 60);

                document.getElementById('selectedHoursCount').textContent = `${campaignDuration}h`;
                document.getElementById('totalCallsScheduled').textContent = formatNumber(processedLeads.length);
                document.getElementById('startTime').textContent = formatTimeForDisplay(campaignStartHour);
                document.getElementById('endTime').textContent = formatTimeForDisplay(endTime);
            } else {
                document.getElementById('selectedHoursCount').textContent = '0';
                document.getElementById('totalCallsScheduled').textContent = '0';
                document.getElementById('startTime').textContent = '-';
                document.getElementById('endTime').textContent = '-';
            }
        }

        function formatTimeForDisplay(time) {
            const [hour, minute] = time.split(':');
            return `${parseInt(hour)}h${minute}`;
        }

        function renderTimeline(intervalos, containerId) {
            // Redireciona para a nova interface interativa
            renderInteractiveTimeline();
        }

        function renderMergedTimelineGrid(intervalos, tbody) {
            const allHours = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];

            // Usa intervalos diretamente (j√° agrupados por hora)
            const blocos = intervalos;
            const startTime = blocos.length > 0 ? blocos[0].inicio : '08:00';
            const endTime = blocos.length > 0 ? blocos[blocos.length - 1].fim : '08:00';

            const ocupacaoMap = {};
            blocos.forEach(bloco => {
                ocupacaoMap[bloco.inicio] = bloco;
            });

            let skipRows = 0;
            let isFirstOccupiedCell = true;

            allHours.forEach((hora) => {
                if (skipRows > 0) {
                    skipRows--;
                    return;
                }

                const tr = document.createElement('tr');
                tr.className = 'schedule-row';

                const tdTime = document.createElement('td');
                tdTime.className = 'time-cell-grid';
                tdTime.textContent = formatTimeForDisplay(hora);
                tr.appendChild(tdTime);

                const tdContent = document.createElement('td');
                tdContent.className = 'content-cell';

                const blocoOcupado = ocupacaoMap[hora];

                if (blocoOcupado && isFirstOccupiedCell) {
                    tdContent.rowSpan = blocos.length;
                    tdContent.className = 'content-cell occupied-cell';
                    const occupiedBlock = createOccupiedBlock(blocos, startTime, endTime);
                    tdContent.appendChild(occupiedBlock);
                    skipRows = blocos.length - 1;
                    isFirstOccupiedCell = false;
                } else if (!blocoOcupado) {
                    tdContent.className = 'content-cell empty-cell';
                    tdContent.innerHTML = '<span class="empty-label">Sem atividade</span>';
                }

                tr.appendChild(tdContent);
                tbody.appendChild(tr);
            });
        }

        function createOccupiedBlock(blocos, startTime, endTime) {
            const container = document.createElement('div');
            container.className = 'occupied-block-container';

            const header = document.createElement('div');
            header.className = 'occupied-block-header';
            header.innerHTML = `
                <div class="block-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Campanha Programada
                </div>
                <div class="block-time">${formatTimeForDisplay(startTime)} - ${formatTimeForDisplay(endTime)}</div>
            `;
            container.appendChild(header);

            const hoursList = document.createElement('div');
            hoursList.className = 'hours-list';

            blocos.forEach((bloco, index) => {
                const hourItem = document.createElement('div');
                hourItem.className = 'hour-item';

                hourItem.innerHTML = `
                    <div class="hour-time">${formatTimeForDisplay(bloco.inicio)} - ${formatTimeForDisplay(bloco.fim)}</div>
                    <div class="hour-calls">
                        ${formatNumber(bloco.ligacoes)} liga√ß√µes
                    </div>
                `;
                hoursList.appendChild(hourItem);
            });

            container.appendChild(hoursList);

            const totalCalls = blocos.reduce((sum, b) => sum + b.ligacoes, 0);
            const totalHours = blocos.length;
            const footer = document.createElement('div');
            footer.className = 'occupied-block-footer';
            footer.innerHTML = `
                <div class="footer-stat">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">${formatNumber(totalCalls)} lig.</span>
                </div>
                <div class="footer-stat">
                    <span class="stat-label">Dura√ß√£o:</span>
                    <span class="stat-value">${totalHours}h</span>
                </div>
            `;
            container.appendChild(footer);

            return container;
        }

        console.log('‚úÖ Fun√ß√µes de capacidade e timeline carregadas');
    </script>

    <script>
        let uploadedData = null;
        let processedLeads = [];
        let finalSelections = null;
        let planData = null;
        let selectedDate = null;
        let selectedStartTime = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const mappingSection = document.getElementById('mappingSection');
        const nameColumn = document.getElementById('nameColumn');
        const phoneColumn = document.getElementById('phoneColumn');
        const nextBtn = document.getElementById('nextBtn');
        const nextBtnText = document.getElementById('nextBtnText');
        const previousBtn = document.getElementById('previousBtn');
        const previousBtnText = document.getElementById('previousBtnText');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const campaignPopup = document.getElementById('campaignPopup');
        const cancelCampaign = document.getElementById('cancelCampaign');
        const startCampaign = document.getElementById('startCampaign');
        const contactCount = document.getElementById('contactCount');
        const campaignBtnText = document.getElementById('campaignBtnText');

        function loadFinalSelections() {
            console.log('[UPLOAD] Carregando sele√ß√µes...');
            
            try {
                const stored = localStorage.getItem('finalSelections');
                if (!stored) {
                    showError('Dados n√£o encontrados. Retorne √† p√°gina anterior.');
                    return false;
                }

                finalSelections = JSON.parse(stored);
                console.log('[UPLOAD] Dados carregados:', finalSelections);

                if (!finalSelections?.userData?.user?.tenant_id) {
                    console.error('[UPLOAD] tenant_id n√£o encontrado');
                    showError('Dados incompletos. Fa√ßa login novamente.');
                    return false;
                }

                if (finalSelections.assistant && finalSelections.number) {
                    document.getElementById('selectedAssistant').textContent = finalSelections.assistant.name;
                    document.getElementById('selectedNumber').textContent = finalSelections.number.number;

                    if (finalSelections.instance) {
                        document.getElementById('selectedInstance').textContent = finalSelections.instance.instance_name || 'N√£o selecionada';
                    }

                    document.getElementById('selectionInfo').style.display = 'block';
                }
                
                return true;
            } catch (error) {
                console.error('[UPLOAD] Erro:', error);
                showError('Erro ao carregar dados.');
                return false;
            }
        }

        async function loadPlanData() {
            console.log('[PLAN] Carregando dados do plano...');

            planData = await getUserPlanData();

            console.log('[PLAN] Dados do plano:', planData);

            if (planData.numeroLinhas === 0) {
                showError('N√∫mero de linhas n√£o encontrado. Fa√ßa login novamente.');
                return false;
            }

            // Inicializa seletor de hor√°rios
            initializeTimeSelector();

            // Inicializa o calend√°rio personalizado
            initializeCampaignCalendar();

            return true;
        }

        function initializeTimeSelector() {
            const startSelector = document.getElementById('campaignStartTime');
            const endSelector = document.getElementById('campaignEndTime');

            if (!startSelector || !endSelector) return;

            const times = getAvailableStartTimes();

            // Inicializa seletor de in√≠cio
            startSelector.innerHTML = '<option value="">Selecionar...</option>';
            times.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                startSelector.appendChild(option);
            });

            // Inicializa seletor de t√©rmino
            endSelector.innerHTML = '<option value="">Selecionar...</option>';
            times.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                endSelector.appendChild(option);
            });

            console.log('[PLAN] Seletores de hor√°rios inicializados');
        }

        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        async function processFile(file) {
            if (!file.name.match(/\.(csv|xlsx|xls)$/i)) {
                showError('Por favor, envie um arquivo CSV ou Excel.');
                return;
            }

            hideMessages();
            
            try {
                if (file.name.match(/\.csv$/i)) {
                    await processCSV(file);
                } else {
                    await processExcel(file);
                }
                
                if (uploadedData && uploadedData.headers.length > 0) {
                    // Calcula limite di√°rio de liga√ß√µes
                    const numeroLinhas = parseInt(localStorage.getItem('numero_linhas') || '0');
                    const ligacoesPorHora = calculateHourlyCapacity(numeroLinhas);
                    const limiteLeads = numeroLinhas * 600;
                    const totalLeads = uploadedData.rows.length;

                    console.log('[UPLOAD] Total de leads:', totalLeads);
                    console.log('[UPLOAD] Limite di√°rio:', limiteLeads);

                    // Verifica se excede o limite
                    if (totalLeads > limiteLeads) {
                        showError(`‚ùå Sua planilha cont√©m ${formatNumber(totalLeads)} leads, mas seu plano permite apenas ${formatNumber(limiteLeads)} liga√ß√µes di√°rias. Por favor, reduza o n√∫mero de leads ou entre em contato para upgrade do plano.`);
                        uploadedData = null;
                        fileInput.value = '';
                        return;
                    }

                    populateColumnSelectors();

                    // Mostra card de capacidade com os dados
                    const capacitySection = document.getElementById('capacitySection');
                    document.getElementById('planHourlyCapacity').textContent = formatNumber(ligacoesPorHora);
                    document.getElementById('planDailyCapacity').textContent = formatNumber(limiteLeads);
                    document.getElementById('uploadedLeadsCount').textContent = formatNumber(totalLeads);

                    // Atualiza barra de progresso
                    const percentage = Math.min((totalLeads / limiteLeads) * 100, 100);
                    const progressBar = document.getElementById('capacityProgressBar');
                    progressBar.style.width = percentage + '%';

                    setTimeout(() => {
                        uploadSection.style.display = 'none';
                        capacitySection.style.display = 'block';
                        mappingSection.style.display = 'block';
                        nextBtn.style.display = 'block';
                        previousBtn.style.display = 'block';
                    }, 800);
                }
            } catch (error) {
                console.error('[UPLOAD] Erro:', error);
                showError(`Erro ao processar arquivo: ${error.message}`);
            }
        }

        async function processCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        uploadedData = {
                            headers: Object.keys(results.data[0] || {}),
                            rows: results.data
                        };
                        resolve();
                    },
                    error: reject
                });
            });
        }

        async function processExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        uploadedData = {
                            headers: Object.keys(jsonData[0] || {}),
                            rows: jsonData
                        };
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function populateColumnSelectors() {
            nameColumn.innerHTML = '<option value="">Selecionar...</option>';
            phoneColumn.innerHTML = '<option value="">Selecionar...</option>';

            uploadedData.headers.forEach((header, index) => {
                const optionName = document.createElement('option');
                optionName.value = index;
                optionName.textContent = header;
                nameColumn.appendChild(optionName);

                const optionPhone = document.createElement('option');
                optionPhone.value = index;
                optionPhone.textContent = header;
                phoneColumn.appendChild(optionPhone);
            });
        }

        previousBtn.addEventListener('click', () => {
            if (mappingSection.style.display === 'block') {
                mappingSection.style.display = 'none';
                uploadSection.style.display = 'block';
                nextBtn.style.display = 'none';
                previousBtn.style.display = 'none';
                uploadedData = null;
                fileInput.value = '';

                // Oculta card de capacidade ao voltar
                document.getElementById('capacitySection').style.display = 'none';
            } else {
                window.location.href = 'seleciona-assistente.html';
            }
        });

        nextBtn.addEventListener('click', validateMapping);

        function validateMapping() {
            console.log('[VALIDATE] üéØ Iniciando valida√ß√£o de mapeamento...');
            hideMessages();

            const nameCol = nameColumn.value;
            const phoneCol = phoneColumn.value;

            console.log('[VALIDATE] Colunas selecionadas:', { nameCol, phoneCol });

            if (!nameCol || !phoneCol) {
                showError('Por favor, selecione as colunas de nome e telefone');
                return;
            }

            if (nameCol === phoneCol) {
                showError('Colunas de nome e telefone devem ser diferentes');
                return;
            }

            // Processa leads
            processedLeads = uploadedData.rows.map(row => ({
                name: row[uploadedData.headers[nameCol]],
                phone: row[uploadedData.headers[phoneCol]]
            })).filter(lead => lead.name && lead.phone);

            console.log('[VALIDATE] ‚úÖ Leads processados:', processedLeads.length);

            // Valida limite
            if (!validateLeadsLimit()) {
                console.log('[VALIDATE] ‚ùå Valida√ß√£o de limite falhou');
                return;
            }

            console.log('[VALIDATE] ‚úÖ Limite validado, exibindo se√ß√µes...');

            // Exibe se√ß√µes de agendamento e timeline
            showSchedulingSections();
        }

        function validateLeadsLimit() {
            const numLeads = processedLeads.length;
            const { numeroLinhas, ligacoesPorHora, ligacoesDiarias } = planData;

            console.log('[VALIDATE] Validando limite:', numLeads, '<=', ligacoesDiarias);

            // Renderiza card de capacidade manualmente
            document.getElementById('planHourlyCapacity').textContent = formatNumber(ligacoesPorHora);
            document.getElementById('planDailyCapacity').textContent = formatNumber(ligacoesDiarias);
            document.getElementById('uploadedLeadsCount').textContent = formatNumber(numLeads);

            // Atualiza barra de progresso
            const percentage = Math.min((numLeads / ligacoesDiarias) * 100, 100);
            const progressBar = document.getElementById('capacityProgressBar');
            progressBar.style.width = percentage + '%';

            // Remove classes anteriores de cor
            progressBar.classList.remove('warning', 'danger');

            // Atualiza status com √≠cones SVG
            const statusElement = document.getElementById('capacityStatus');
            if (numLeads > ligacoesDiarias) {
                statusElement.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    Limite excedido
                `;
                statusElement.className = 'capacity-status status-danger';
                progressBar.classList.add('danger');
            } else if (percentage >= 90) {
                statusElement.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Pr√≥ximo ao limite
                `;
                statusElement.className = 'capacity-status status-warning';
                progressBar.classList.add('warning');
            } else {
                statusElement.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Dentro do limite
                `;
                statusElement.className = 'capacity-status status-ok';
            }

            document.getElementById('capacitySection').style.display = 'block';

            // Verifica se excede limite
            if (numLeads > ligacoesDiarias) {
                console.error('[VALIDATE] Limite excedido!');
                showLimitExceededError(ligacoesDiarias, numLeads);
                return false;
            }

            return true;
        }

        function formatNumber(num) {
            return num.toLocaleString('pt-BR');
        }

        function showLimitExceededError(maxLeads, attemptedLeads) {
            const errorHtml = `
                <div class="error-modal">
                    <div class="error-content">
                        <div class="error-icon">‚ùå</div>
                        <h2 class="error-title">Limite Excedido</h2>
                        <p class="error-message">
                            Seu plano permite at√© <strong>${formatNumber(maxLeads)}</strong> liga√ß√µes por dia.
                            <br>
                            Voc√™ tentou fazer upload de <strong>${formatNumber(attemptedLeads)}</strong> leads.
                        </p>
                        <div class="error-details">
                            <p>Para aumentar seu limite, entre em contato com o suporte:</p>
                            <a href="mailto:suporte@salesdever.io" class="support-link">
                                üìß suporte@salesdever.io
                            </a>
                        </div>
                        <button class="error-close-btn" onclick="closeLimitError()">
                            Entendi
                        </button>
                    </div>
                </div>
            `;

            const modalContainer = document.createElement('div');
            modalContainer.id = 'limitErrorModal';
            modalContainer.className = 'error-modal-overlay';
            modalContainer.innerHTML = errorHtml;
            document.body.appendChild(modalContainer);

            setTimeout(() => {
                modalContainer.classList.add('active');
            }, 10);
        }

        function closeLimitError() {
            const modal = document.getElementById('limitErrorModal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        function showInvalidTimeframeError(endTime, commercialEnd) {
            const errorHtml = `
                <div class="error-modal">
                    <div class="error-content">
                        <div class="error-icon">‚è∞</div>
                        <h2 class="error-title">Hor√°rio Inv√°lido</h2>
                        <p class="error-message">
                            A campanha terminaria √†s <strong>${endTime}</strong>
                            <br>
                            Hor√°rio comercial: at√© <strong>${commercialEnd}</strong>
                        </p>
                        <p class="error-suggestion">
                            Tente:
                            <br>
                            ‚Ä¢ Escolher um hor√°rio de in√≠cio mais cedo
                            <br>
                            ‚Ä¢ Reduzir o n√∫mero de leads
                        </p>
                        <button class="error-close-btn" onclick="closeLimitError()">
                            Entendi
                        </button>
                    </div>
                </div>
            `;

            const modalContainer = document.createElement('div');
            modalContainer.id = 'limitErrorModal';
            modalContainer.className = 'error-modal-overlay';
            modalContainer.innerHTML = errorHtml;
            document.body.appendChild(modalContainer);

            setTimeout(() => {
                modalContainer.classList.add('active');
            }, 10);
        }

        function showSchedulingSections() {
            console.log('[UI] üéØ Iniciando showSchedulingSections...');

            // Oculta se√ß√£o de mapeamento e capacidade (j√° que ser√° mostrado embaixo)
            mappingSection.style.display = 'none';
            document.getElementById('capacitySection').style.display = 'none';

            // Exibe se√ß√µes de agendamento
            const schedulingSection = document.getElementById('schedulingSection');
            schedulingSection.style.display = 'block';

            // Define data padr√£o
            const dateInput = document.getElementById('campaignDate');
            selectedDate = dateInput.value;

            // Adiciona event listener para data
            dateInput.addEventListener('change', () => {
                selectedDate = dateInput.value;
                console.log('[DATE] Data atualizada:', selectedDate);

                // Re-renderiza a timeline para atualizar hor√°rios dispon√≠veis
                renderInteractiveTimeline();

                // Se tentou selecionar hoje e hoje n√£o est√° dispon√≠vel, for√ßa amanh√£
                if (isDateToday(selectedDate) && !canScheduleToday(campaignDuration)) {
                    checkTodayAvailability();
                } else {
                    // Reseta a flag se selecionou outra data
                    todayUnavailable = campaignDuration > 0 && !canScheduleToday(campaignDuration);
                    renderCampaignCalendar();
                }
            });

            // Renderiza timeline interativa automaticamente
            renderInteractiveTimeline();
            document.getElementById('campaignTimeline').style.display = 'block';

            // Verifica se a campanha cabe hoje e seleciona amanh√£ automaticamente se n√£o cabe
            checkTodayAvailability();

            // Atualiza texto do bot√£o
            nextBtnText.textContent = 'Criar Campanha ‚Üí';
            nextBtn.removeEventListener('click', validateMapping);
            nextBtn.addEventListener('click', validateAndShowPopup);

            // Scroll suave
            setTimeout(() => {
                schedulingSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);

            console.log('[UI] ‚úÖ Se√ß√µes de agendamento exibidas');
        }

        function updateTimelineWithCustomHours() {
            const date = document.getElementById('campaignDate').value;
            const startTime = document.getElementById('campaignStartTime').value;
            const endTime = document.getElementById('campaignEndTime').value;

            console.log('[TIMELINE] Hor√°rios personalizados:', { date, startTime, endTime });

            if (!date || !startTime || !endTime) {
                console.log('[TIMELINE] Aguardando sele√ß√£o completa');
                return;
            }

            // Valida√ß√£o: t√©rmino deve ser maior que in√≠cio
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;

            if (endMinutes <= startMinutes) {
                showError('O hor√°rio de t√©rmino deve ser maior que o hor√°rio de in√≠cio');
                document.getElementById('campaignTimeline').style.display = 'none';
                return;
            }

            selectedDate = date;
            selectedStartTime = startTime;

            // Renderiza timeline interativa
            renderInteractiveTimeline();

            // Exibe se√ß√£o de timeline
            document.getElementById('campaignTimeline').style.display = 'block';

            console.log('[TIMELINE] Timeline interativa renderizada');
        }

        function generateCustomTimeline(numLeads, startTime, endTime, numeroLinhas) {
            // Calcula quantas horas est√£o dispon√≠veis
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;
            const totalMinutes = endMinutes - startMinutes;
            const totalHours = totalMinutes / 60;

            // Distribui leads igualmente por hora
            const leadsPerHour = Math.floor(numLeads / totalHours);
            const leadsRemainder = numLeads % totalHours;

            const intervalos = [];
            let currentTime = startTime;
            let leadsDistributed = 0;

            for (let i = 0; i < Math.ceil(totalHours); i++) {
                // Define quantos leads v√£o nesta hora
                let leadsThisHour = leadsPerHour;
                if (i < leadsRemainder) {
                    leadsThisHour += 1; // Distribui o resto nas primeiras horas
                }

                if (leadsDistributed >= numLeads) break;

                const nextTime = addMinutes(currentTime, 60);
                const actualLeads = Math.min(leadsThisHour, numLeads - leadsDistributed);

                intervalos.push({
                    inicio: currentTime,
                    fim: nextTime,
                    ligacoes: actualLeads,
                    isPartial: actualLeads < leadsPerHour,
                    isFull: actualLeads === leadsPerHour
                });

                leadsDistributed += actualLeads;
                currentTime = nextTime;
            }

            return intervalos;
        }

        function renderCampaignSummary(summary) {
            const { startTime, endTime, duration, totalLeads } = summary;

            document.getElementById('startTime').textContent = startTime;
            document.getElementById('endTime').textContent = endTime;
            document.getElementById('duration').textContent = formatDuration(duration);
        }

        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;

            if (hours === 0) return `${mins}min`;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}min`;
        }

        function updateTimeline() {
            const date = document.getElementById('campaignDate').value;
            const time = document.getElementById('campaignStartTime').value;

            if (!date || !time) {
                console.log('[TIMELINE] Data ou hor√°rio n√£o selecionado');
                return;
            }

            selectedDate = date;
            selectedStartTime = time;

            console.log('[TIMELINE] Atualizando com', {
                leads: processedLeads.length,
                startTime: time,
                linhas: planData.numeroLinhas
            });

            // Valida hor√°rio e gera timeline
            const validation = validateCampaign(processedLeads.length, time, planData.numeroLinhas);

            if (!validation.valid) {
                if (validation.error === 'INVALID_TIMEFRAME') {
                    showInvalidTimeframeError(validation.endTime, validation.commercialEnd);
                }
                return;
            }

            // Gera timeline
            const intervalos = generateTimeline(processedLeads.length, time, planData.numeroLinhas);
            const duration = calculateCampaignDuration(processedLeads.length, planData.numeroLinhas);
            const endTime = calculateEndTime(time, duration);

            // Renderiza timeline
            renderTimeline(intervalos, 'timelineBody');

            // Renderiza resumo
            renderCampaignSummary({
                startTime: time,
                endTime: endTime,
                duration: duration,
                totalLeads: processedLeads.length,
                hourlyCapacity: planData.ligacoesPorHora,
                dailyCapacity: planData.ligacoesDiarias
            });

            console.log('[TIMELINE] Renderizada com sucesso');
        }

        function animateTimelineRender() {
            // Anima√ß√£o opcional
        }

        function validateAndShowPopup() {
            hideMessages();

            // Valida sele√ß√£o de data
            if (!selectedDate) {
                showError('Por favor, selecione a data da campanha');
                return;
            }

            // Valida se a campanha foi posicionada
            if (!campaignStartHour) {
                showError('Por favor, posicione a campanha arrastando o bloco roxo sobre os hor√°rios desejados');
                return;
            }

            // Valida se o hor√°rio est√° no passado (se for hoje)
            if (isDateToday(selectedDate)) {
                if (isHourInPast(campaignStartHour)) {
                    showError('O hor√°rio selecionado j√° passou. Por favor, escolha um hor√°rio futuro ou selecione outra data.');
                    return;
                }

                // Valida se a campanha cabe no hor√°rio comercial
                const duration = calculateCampaignDuration(processedLeads.length, planData.numeroLinhas);
                const durationHours = Math.ceil(duration / 60);
                if (!canScheduleToday(durationHours)) {
                    showError(`Campanha de ${durationHours}h n√£o pode ser agendada para hoje. Por favor, selecione outra data.`);
                    return;
                }
            }

            contactCount.textContent = formatNumber(processedLeads.length);
            campaignPopup.style.display = 'flex';
        }

        cancelCampaign.addEventListener('click', () => {
            campaignPopup.style.display = 'none';
        });

        startCampaign.addEventListener('click', async () => {
            startCampaign.disabled = true;
            campaignBtnText.textContent = 'Enviando...';

            try {
                const campaignName = document.getElementById('campaignName').value.trim() ||
                    `Campanha ${new Date().toLocaleDateString('pt-BR')}`;

                const campaignId = `camp_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;

                // Calcula dados de agendamento
                const duration = calculateCampaignDuration(processedLeads.length, planData.numeroLinhas);
                const endTime = calculateEndTime(campaignStartHour, duration);
                const intervalos = generateTimeline(processedLeads.length, campaignStartHour, planData.numeroLinhas);

                // Cria timestamp de in√≠cio em UTC-3 (Bras√≠lia)
                const scheduledStartAt = `${selectedDate}T${campaignStartHour}:00-03:00`;
                const scheduledEndAt = `${selectedDate}T${endTime}:00-03:00`;

                const payload = {
                    campaign_id: campaignId,
                    campaign_name: campaignName,
                    campaign_type: 'outbound',
                    leads: processedLeads,
                    assistant_id: finalSelections?.assistant?.id,
                    assistant_name: finalSelections?.assistant?.name,
                    number_id: finalSelections?.number?.id,
                    number_name: finalSelections?.number?.name,
                    phone_number: finalSelections?.number?.number,
                    tenant_id: finalSelections?.userData?.user?.tenant_id,
                    org_private_key: finalSelections?.userData?.user?.org_private_key,
                    instance_name: finalSelections?.instance?.instance_name || null,
                    // Dados de agendamento
                    scheduled_date: selectedDate,
                    start_time: campaignStartHour,
                    end_time: endTime,
                    scheduled_start_at: scheduledStartAt,  // Timestamptz UTC-3
                    scheduled_end_at: scheduledEndAt,      // Timestamptz UTC-3
                    estimated_duration_minutes: duration,
                    hourly_capacity: planData.ligacoesPorHora,
                    daily_capacity: planData.ligacoesDiarias,
                    timeline: intervalos,
                    // Metadados
                    timestamp: new Date().toISOString(),
                    total_contacts: processedLeads.length
                };

                console.log('[CAMPAIGN] üöÄ Enviando payload:', payload);

                const response = await fetch('https://sdr.salesdever.io/webhook/17de397e-8f85-4b3c-9807-7e28ae16c0c4', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    window.location.href = `obrigado.html?contacts=${processedLeads.length}&campaign=${encodeURIComponent(campaignName)}`;
                } else {
                    throw new Error('Erro ao enviar dados');
                }
            } catch (error) {
                console.error('[CAMPAIGN] Erro:', error);
                showError(`Erro ao iniciar campanha: ${error.message}`);
                startCampaign.disabled = false;
                campaignBtnText.textContent = 'Iniciar Campanha';
            }
        });

        function showError(message) {
            showModernPopup(message, 'error');
        }

        function showSuccess(message) {
            showModernPopup(message, 'success');
        }

        function showModernPopup(message, type = 'error') {
            const existing = document.getElementById('modernPopup');
            if (existing) existing.remove();

            const popup = document.createElement('div');
            popup.id = 'modernPopup';
            popup.className = `modern-popup ${type}`;

            const icon = type === 'error' ? '‚ö†Ô∏è' : '‚úÖ';
            const title = type === 'error' ? 'Aten√ß√£o!' : 'Sucesso!';

            popup.innerHTML = `
                <div class="popup-content">
                    <div class="popup-icon">${icon}</div>
                    <h3 class="popup-title">${title}</h3>
                    <p class="popup-message">${message}</p>
                    <button class="popup-btn" onclick="closeModernPopup()">Entendi</button>
                </div>
                <div class="popup-overlay" onclick="closeModernPopup()"></div>
            `;

            document.body.appendChild(popup);

            setTimeout(() => popup.classList.add('show'), 10);
        }

        function closeModernPopup() {
            const popup = document.getElementById('modernPopup');
            if (popup) {
                popup.classList.remove('show');
                setTimeout(() => popup.remove(), 300);
            }
        }

        function hideMessages() {
            // Mantido para compatibilidade
        }

        window.addEventListener('load', async () => {
            console.log('[INIT] üöÄ Inicializando sistema...');

            // Verifica se os m√≥dulos foram carregados
            console.log('[INIT] Verificando m√≥dulos:');
            console.log('  - calculateHourlyCapacity:', typeof calculateHourlyCapacity);
            console.log('  - generateTimeline:', typeof generateTimeline);
            console.log('  - renderTimeline:', typeof renderTimeline);
            console.log('  - renderCapacityCard:', typeof renderCapacityCard);

            if (!loadFinalSelections()) {
                setTimeout(() => {
                    window.location.href = 'seleciona-assistente.html';
                }, 3000);
                return;
            }

            if (!(await loadPlanData())) {
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 3000);
                return;
            }

            console.log('[INIT] ‚úÖ Sistema inicializado com sucesso');
            console.log('[INIT] üìä Plan Data:', planData);
        });
    </script>
</body>
</html>