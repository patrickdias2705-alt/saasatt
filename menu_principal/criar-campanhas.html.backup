<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
    <link rel="shortcut icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
    <link rel="apple-touch-icon" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Campanhas - Salesdever</title>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bibliotecas para upload de planilhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Sistema de Onboarding -->
    <!-- Botão de Tutorial -->
    <link rel="stylesheet" href="../css/tutorial-button.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Raleway', sans-serif;
        }

        body {
            background: #0a0420;
            min-height: 100vh;
            color: #ffffff;
            padding: 0;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(165, 148, 255, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.06) 0%, transparent 50%);
            animation: backgroundFloat 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(3%, 3%); }
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .page-header {
            margin-bottom: 2.5rem;
            animation: fadeInDown 0.6s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.85rem;
            flex-wrap: wrap;
        }

        .user-badge {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1rem;
            padding: 0.75rem 1.25rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff, #A594FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            font-size: 1.05rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 400;
        }

        /* Metrics Cards Section */
        .metrics-section {
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.6s ease 0.1s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.25rem;
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1rem;
            padding: 1.5rem;
            min-height: 130px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(165, 148, 255, 0.2);
            border-color: rgba(165, 148, 255, 0.3);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .metric-card:hover::before {
            opacity: 1;
        }

        .metric-card.purple {
            --accent-color: linear-gradient(90deg, #A594FF, #8B5CF6);
        }

        .metric-card.green {
            --accent-color: linear-gradient(90deg, #22C55E, #16A34A);
        }

        .metric-card.blue {
            --accent-color: linear-gradient(90deg, #3B82F6, #2563EB);
        }

        .metric-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .metric-card.purple .metric-icon {
            background: rgba(165, 148, 255, 0.15);
        }

        .metric-card.green .metric-icon {
            background: rgba(34, 197, 94, 0.15);
        }

        .metric-card.blue .metric-icon {
            background: rgba(59, 130, 246, 0.15);
        }

        .metric-icon svg {
            width: 20px;
            height: 20px;
        }

        .metric-card.purple .metric-icon svg {
            stroke: #A594FF;
        }

        .metric-card.green .metric-icon svg {
            stroke: #22C55E;
        }

        .metric-card.blue .metric-icon svg {
            stroke: #3B82F6;
        }

        .metric-title {
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex: 1;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.5rem;
            line-height: 1;
        }

        .metric-subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
        }

        .metric-card.green .metric-subtitle,
        .metric-card.purple .metric-subtitle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-percentage {
            font-weight: 600;
        }

        .metric-card.green .metric-percentage {
            color: #22C55E;
        }

        .metric-card.purple .metric-percentage {
            color: #A594FF;
        }

        /* Status Inline */
        .status-inline {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-item.active {
            color: #22C55E;
        }

        .status-item.paused {
            color: #FBBF24;
        }

        .status-item.ended {
            color: #9CA3AF;
        }

        /* Action Button (in header) */
        .action-btn-primary {
            background: rgba(165, 148, 255, 0.15);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.875rem;
            padding: 0.85rem 1.75rem;
            color: #A594FF;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.65rem;
        }

        .action-btn-secondary {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.35);
            color: #34D399;
        }

        .action-btn-secondary:hover {
            background: rgba(34, 197, 94, 0.25);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .action-btn-primary:hover {
            background: rgba(165, 148, 255, 0.25);
            border-color: rgba(165, 148, 255, 0.5);
            transform: translateY(-1px);
        }

        .action-btn-primary svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        /* Campaigns List Section */
        .campaigns-section {
            animation: fadeInUp 0.6s ease 0.2s both;
        }

        .section-header {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.35rem;
        }

        .section-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .campaigns-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .campaigns-filters {
            display: flex;
            gap: 0.75rem;
        }

        .filter-btn {
            background: rgba(30, 25, 60, 0.6);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 0.625rem;
            padding: 0.625rem 1.25rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: rgba(165, 148, 255, 0.15);
            border-color: rgba(165, 148, 255, 0.4);
            color: #A594FF;
        }

        .campaigns-grid {
            display: grid;
            gap: 1.5rem;
        }

        .campaign-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1.25rem;
            padding: 2rem;
            transition: all 0.3s ease;
        }

        .campaign-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(165, 148, 255, 0.2);
            border-color: rgba(165, 148, 255, 0.3);
        }

        .campaign-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .campaign-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .campaign-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .meta-item svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        .campaign-status {
            padding: 0.4rem 0.9rem;
            border-radius: 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22C55E;
        }

        .status-paused {
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid rgba(251, 191, 36, 0.4);
            color: #FBBF24;
        }

        .status-completed {
            background: rgba(107, 114, 128, 0.15);
            border: 1px solid rgba(107, 114, 128, 0.4);
            color: #9CA3AF;
        }

        .campaign-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #A594FF;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .campaign-actions {
            display: flex;
            gap: 0.75rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(165, 148, 255, 0.15);
        }

        .action-btn {
            background: rgba(30, 25, 60, 0.8);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            background: rgba(165, 148, 255, 0.2);
            border-color: rgba(165, 148, 255, 0.5);
            color: #A594FF;
        }

        .action-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
        }

        .empty-state {
            text-align: center;
            padding: 6rem 3rem;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1.25rem;
        }

        .empty-icon {
            margin-bottom: 2rem;
            opacity: 0.4;
        }

        .empty-icon svg {
            width: 64px;
            height: 64px;
            color: rgba(165, 148, 255, 0.6);
        }

        .empty-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.75rem;
        }

        .empty-description {
            font-size: 1.05rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .campaign-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1.5rem 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .metric-card {
                min-height: 110px;
            }

            .campaign-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .campaigns-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1.5rem;
            }

            .campaigns-filters {
                flex-wrap: wrap;
                width: 100%;
            }

            .filter-btn {
                flex: 1;
                min-width: 120px;
            }

            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
                flex-direction: column;
            }

            .action-btn-primary {
                width: 100%;
                justify-content: center;
            }

            .action-btn-secondary {
                width: 100%;
                justify-content: center;
            }

            .empty-state {
                padding: 4rem 2rem;
                min-height: 300px;
            }

            .empty-icon svg {
                width: 48px;
                height: 48px;
            }

            .empty-title {
                font-size: 1.5rem;
            }

            .empty-description {
                font-size: 0.95rem;
            }

            /* Modal Responsivo */
            .call-now-dialog {
                max-width: calc(100% - 2rem);
                margin: 1rem;
                padding: 1.5rem;
            }

            .call-now-icon-wrapper {
                width: 48px;
                height: 48px;
            }

            .call-now-icon-wrapper svg {
                width: 24px;
                height: 24px;
            }

            .call-now-title {
                font-size: 1.5rem;
            }

            .call-now-description {
                font-size: 0.85rem;
            }

            .call-now-field select,
            .call-now-field input {
                padding: 0.85rem 0.85rem 0.85rem 2.75rem;
                font-size: 0.9rem;
            }

            .call-now-footer {
                flex-direction: column;
            }

            .call-now-footer button {
                width: 100%;
            }

            .call-now-close {
                top: 1rem;
                right: 1rem;
            }
        }

        /* Ligue Agora Modal - Design Premium */
        .call-now-overlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 2, 15, 0.85);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }

        .call-now-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .call-now-dialog {
            width: 100%;
            max-width: 480px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            backdrop-filter: blur(40px);
            border-radius: 1.5rem;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow:
                0 30px 60px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(165, 148, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: scale(0.96) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .call-now-dialog::before {
            content: '';
            position: absolute;
            top: -50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(165, 148, 255, 0.15), transparent 70%);
            pointer-events: none;
            transform: translateX(-50%);
        }

        .call-now-overlay.show .call-now-dialog {
            transform: scale(1) translateY(0);
        }

        .call-now-close {
            position: absolute;
            top: 1.25rem;
            right: 1.25rem;
            width: 32px;
            height: 32px;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .call-now-close:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .call-now-close svg {
            width: 18px;
            height: 18px;
            stroke: rgba(255, 255, 255, 0.6);
        }

        .call-now-header {
            margin-bottom: 1.75rem;
            position: relative;
            z-index: 1;
        }

        .call-now-title-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .call-now-icon-wrapper {
            width: 56px;
            height: 56px;
            border-radius: 1rem;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.2), rgba(165, 148, 255, 0.1));
            border: 1px solid rgba(165, 148, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 8px 24px rgba(165, 148, 255, 0.2);
        }

        .call-now-icon-wrapper svg {
            width: 28px;
            height: 28px;
            stroke: #A594FF;
        }

        .call-now-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.2;
        }

        .call-now-title span {
            background: linear-gradient(135deg, #A594FF, #8B7EFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .call-now-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
        }

        .call-now-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            position: relative;
            z-index: 1;
        }

        .call-now-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .call-now-field label {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .call-now-field label svg {
            width: 14px;
            height: 14px;
            stroke: #A594FF;
        }

        .call-now-input-wrapper {
            position: relative;
        }

        .call-now-input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            stroke: rgba(165, 148, 255, 0.7);
            pointer-events: none;
            transition: stroke 0.2s ease;
        }

        .call-now-field select,
        .call-now-field input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(8, 5, 22, 0.6);
            backdrop-filter: blur(10px);
            color: #ffffff;
            font-size: 0.95rem;
            font-weight: 500;
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .call-now-field input {
            cursor: text;
            font-family: 'Raleway', sans-serif;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .call-now-field select:hover,
        .call-now-field input:hover {
            border-color: rgba(165, 148, 255, 0.3);
            background: rgba(8, 5, 22, 0.8);
        }

        .call-now-field select:hover ~ .call-now-input-icon,
        .call-now-field input:hover ~ .call-now-input-icon {
            stroke: rgba(165, 148, 255, 0.7);
        }

        .call-now-field input.formatting {
            border-color: rgba(34, 197, 94, 0.4);
        }

        .call-now-field select:focus,
        .call-now-field input:focus {
            border-color: rgba(165, 148, 255, 0.6);
            background: rgba(8, 5, 22, 0.9);
            box-shadow: 0 0 0 4px rgba(165, 148, 255, 0.1);
        }

        .call-now-field select:focus ~ .call-now-input-icon,
        .call-now-field input:focus ~ .call-now-input-icon {
            stroke: #A594FF;
            filter: drop-shadow(0 0 4px rgba(165, 148, 255, 0.5));
        }

        .call-now-helper {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.45);
            margin-top: 0.35rem;
        }

        .call-now-status {
            padding: 0.85rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            line-height: 1.4;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .call-now-status:not(:empty) {
            display: flex;
        }

        .call-now-status.loading {
            background: rgba(165, 148, 255, 0.15);
            border: 1px solid rgba(165, 148, 255, 0.3);
            color: #A594FF;
        }

        .call-now-status.loading::before {
            content: '';
            width: 14px;
            height: 14px;
            border: 2px solid rgba(165, 148, 255, 0.3);
            border-top-color: #A594FF;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        .call-now-status.error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #F87171;
        }

        .call-now-status.error::before {
            content: '⚠';
            font-size: 1rem;
            color: #f59e0b;
        }

        .call-now-status.success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #22C55E;
        }

        .call-now-status.success::before {
            content: '✓';
            font-size: 1.1rem;
            font-weight: 700;
        }

        .call-now-divider {
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            margin: 0.5rem 0;
        }

        .call-now-footer {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .call-now-footer button {
            flex: 1;
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .call-now-footer button::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .call-now-footer button:hover::before {
            opacity: 1;
        }

        .call-now-submit {
            background: linear-gradient(135deg, #A594FF, #8B7EFF);
            color: #ffffff;
            box-shadow:
                0 8px 24px rgba(165, 148, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .call-now-submit:hover {
            transform: translateY(-2px);
            box-shadow:
                0 12px 32px rgba(165, 148, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .call-now-submit:active {
            transform: translateY(0);
        }

        .call-now-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .call-now-cancel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
        }

        .call-now-cancel:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.25);
            color: #ffffff;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0420;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(165, 148, 255, 0.2);
            border-top-color: #A594FF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .main-content {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .main-content.loaded {
            opacity: 1;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background: linear-gradient(145deg, rgba(30, 25, 55, 0.98), rgba(20, 15, 40, 0.98));
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 1.25rem;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-overlay.show .modal-container {
            transform: scale(1) translateY(0);
        }

        .modal-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .modal-icon.warning {
            background: rgba(255, 187, 0, 0.15);
            border: 2px solid rgba(255, 187, 0, 0.4);
            color: #FFBB00;
        }

        .modal-icon.danger {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.4);
            color: #EF4444;
        }

        .modal-icon.success {
            background: rgba(34, 197, 94, 0.15);
            border: 2px solid rgba(34, 197, 94, 0.4);
            color: #22C55E;
        }

        .modal-icon.error {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.4);
            color: #EF4444;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.75rem;
        }

        .modal-message {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.6rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            min-width: 100px;
        }

        .modal-btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
        }

        .modal-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .modal-btn-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .modal-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .modal-btn-warning {
            background: linear-gradient(135deg, #FFBB00, #F59E0B);
            color: #1a1a1a;
            box-shadow: 0 4px 15px rgba(255, 187, 0, 0.3);
        }

        .modal-btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 187, 0, 0.4);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #A594FF, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(165, 148, 255, 0.3);
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(165, 148, 255, 0.4);
        }

        /* Campaign Type Selection Modal */
        .campaign-type-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .campaign-type-modal.show {
            display: flex;
        }

        .campaign-type-content {
            background: linear-gradient(135deg, rgba(30, 25, 60, 0.95), rgba(20, 15, 45, 0.98));
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 1.5rem;
            padding: 2.5rem;
            max-width: 650px;
            width: 90%;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .campaign-type-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .campaign-type-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ffffff, #A594FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .campaign-type-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        .modal-close-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.7);
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .campaign-type-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .campaign-type-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .campaign-type-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .campaign-type-card:hover::before {
            left: 100%;
        }

        .campaign-type-card:hover {
            border-color: rgba(165, 148, 255, 0.5);
            background: rgba(165, 148, 255, 0.1);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(165, 148, 255, 0.2);
        }

        .campaign-type-card .type-icon {
            margin-bottom: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .campaign-type-card .type-icon svg {
            width: 48px;
            height: 48px;
            color: #A594FF;
            transition: color 0.3s ease;
        }

        .campaign-type-card:hover .type-icon svg {
            color: #ffffff;
        }

        .campaign-type-card h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .campaign-type-card p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Messaging Campaign Modal */
        .messaging-campaign-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: blur(10px);
        }

        .messaging-campaign-modal.show {
            display: flex;
        }

        .messaging-campaign-content {
            background: linear-gradient(135deg, rgba(30, 25, 60, 0.95), rgba(20, 15, 45, 0.98));
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 1.5rem;
            max-width: 1200px; /* Tamanho ideal para UX perfeito */
            width: 92%; /* Proporção equilibrada */
            max-height: 92vh; /* Altura proporcional */
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            min-height: 600px; /* Altura mínima fixa mais elegante */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
        }

        .msg-campaign-header {
            padding: 2rem 2.5rem 1.5rem; /* Espaçamento equilibrado */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, rgba(30, 25, 60, 0.95), rgba(20, 15, 45, 0.98));
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .msg-campaign-title {
            font-size: 1.75rem; /* Tamanho proporcional perfeito */
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #A594FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            line-height: 1.2;
        }

        .msg-campaign-step {
            display: none;
            padding: 2rem 2.5rem; /* Espaçamento proporcional elegante */
            animation: fadeInSlide 0.3s ease;
        }

        .msg-campaign-step.active {
            display: block;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: #ffffff;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #A594FF;
            box-shadow: 0 0 0 2px rgba(165, 148, 255, 0.2);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-hint {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .form-hint code {
            background: rgba(165, 148, 255, 0.2);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
        }

        /* Interval Options */
        .interval-options {
            display: flex;
            gap: 1rem;
        }

        .interval-option {
            flex: 1;
        }

        .interval-option input {
            display: none;
        }

        .interval-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            height: 160px; /* Altura fixa para padronização */
            justify-content: center;
            box-sizing: border-box; /* Garante padding consistente */
        }

        .interval-option input:checked + .interval-card {
            border-color: #A594FF;
            background: rgba(165, 148, 255, 0.1);
        }

        .interval-card:hover {
            border-color: rgba(165, 148, 255, 0.5);
            transform: translateY(-2px);
        }

        .interval-card .icon {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .interval-card .icon svg {
            width: 32px;
            height: 32px;
            transition: color 0.3s ease;
        }

        /* Cores específicas para cada tipo */
        .interval-card.risk .icon svg {
            stroke: #EF4444;
        }

        .interval-card.moderate .icon svg {
            stroke: #3B82F6;
        }

        .interval-card.safe .icon svg {
            stroke: #22C55E;
        }

        /* Efeito hover nos ícones */
        .interval-option input:checked + .interval-card .icon svg {
            stroke: #A594FF;
        }

        .interval-card .title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .interval-card .desc {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.75rem;
        }

        .interval-card .warning {
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: auto; /* Empurra para baixo */
        }

        .interval-card .info {
            color: #22c55e;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: auto; /* Empurra para baixo */
        }

        .interval-card .badge {
            background: #A594FF;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: auto; /* Empurra para baixo */
        }

        /* Messaging Schedule Styles */
        .schedule-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .schedule-icon {
            background: rgba(165, 148, 255, 0.15);
            border-radius: 0.75rem;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .schedule-icon svg {
            stroke: #A594FF;
        }

        .schedule-title {
            flex: 1;
        }

        .schedule-title h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #ffffff;
            margin: 0 0 0.25rem 0;
        }

        .schedule-title p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            margin: 0;
        }

        .schedule-restart-btn {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            color: #EF4444;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .schedule-restart-btn:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .schedule-date-picker {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }

        .schedule-date-picker label {
            font-size: 0.875rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        .schedule-date-picker input[type="date"] {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            color: #ffffff;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .schedule-date-picker input[type="date"]:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(165, 148, 255, 0.4);
        }

        .schedule-date-picker input[type="date"]:focus {
            outline: none;
            border-color: #A594FF;
            box-shadow: 0 0 0 3px rgba(165, 148, 255, 0.1);
        }

        /* Schedule Actions - positioned on the right */
        .schedule-header {
            justify-content: space-between !important;
            align-items: flex-start !important;
        }

        .schedule-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: auto;
        }

        .date-picker-container {
            position: relative;
        }

        .choose-date-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            color: #ffffff;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .choose-date-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(165, 148, 255, 0.4);
        }

        .choose-date-btn svg {
            opacity: 0.7;
        }

        .date-picker-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            z-index: 1000;
        }

        .date-picker-content {
            background: rgba(24, 24, 27, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            width: 350px;
            overflow: hidden;
        }

        .date-picker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .date-picker-header button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            padding: 0.5rem;
            transition: all 0.2s ease;
        }

        .date-picker-header button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border-color: rgba(165, 148, 255, 0.3);
        }

        .date-picker-header span {
            font-weight: 600;
            font-size: 1.1rem;
            color: #ffffff;
        }

        .date-picker-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .date-picker-weekdays span {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            padding: 0.5rem;
        }

        .date-picker-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            overflow: hidden;
        }

        .date-picker-day {
            text-align: center;
            padding: 0.6rem 0.4rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid transparent;
            font-weight: 500;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .date-picker-day:hover:not(.disabled):not(.other-month) {
            background: rgba(165, 148, 255, 0.15);
            color: #ffffff;
            border-color: rgba(165, 148, 255, 0.3);
        }

        .date-picker-day.disabled {
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        .date-picker-day.selected {
            background: linear-gradient(135deg, #A594FF, #8B7EE8);
            color: #ffffff;
            font-weight: 700;
            border-color: rgba(165, 148, 255, 0.5);
            box-shadow: 0 4px 12px rgba(165, 148, 255, 0.3);
        }

        .date-picker-day.other-month {
            color: rgba(255, 255, 255, 0.3);
        }

        .date-picker-day.today {
            border-color: rgba(165, 148, 255, 0.6);
            font-weight: 600;
            color: #A594FF;
        }

        .schedule-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.25rem; /* Padding equilibrado */
            display: flex;
            align-items: center;
            gap: 0.875rem; /* Gap proporcional */
            transition: all 0.3s ease;
            height: 80px; /* Altura consistente */
            box-sizing: border-box;
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(165, 148, 255, 0.2);
        }

        .stat-icon {
            background: rgba(165, 148, 255, 0.15);
            border-radius: 0.625rem; /* Raio proporcional */
            padding: 0.625rem; /* Padding proporcional */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-icon svg {
            stroke: #A594FF;
        }

        .stat-info {
            flex: 1;
        }

        .stat-title {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }

        .schedule-container {
            display: flex;
            gap: 2.5rem; /* Espaçamento proporcional */
            min-height: 480px; /* Altura equilibrada */
            align-items: stretch;
        }

        .time-slots {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.625rem; /* Espaçamento consistente */
            min-width: 0; /* Permite flexibilidade */
        }

        .time-slot {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 1rem 1.25rem; /* Padding proporcional */
            cursor: pointer;
            transition: all 0.3s ease;
            height: 50px; /* Altura reduzida sem capacity label */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .time-slot:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(165, 148, 255, 0.3);
        }

        .time-slot.selected {
            background: rgba(165, 148, 255, 0.15);
            border-color: #A594FF;
        }

        .time-slot.disabled {
            background: rgba(255, 255, 255, 0.02) !important;
            border-color: rgba(255, 255, 255, 0.05) !important;
            cursor: not-allowed !important;
            opacity: 0.3 !important;
            pointer-events: none;
        }

        .time-slot.disabled .hour-label {
            color: rgba(255, 255, 255, 0.3) !important;
        }

        .time-slot.disabled .capacity-label {
            color: rgba(255, 255, 255, 0.2) !important;
        }

        .hour-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.25rem;
        }

        .capacity-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .campaign-block {
            width: 380px; /* Largura proporcional perfeita */
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.15), rgba(165, 148, 255, 0.05));
            border: 2px dashed rgba(165, 148, 255, 0.4);
            border-radius: 1rem;
            padding: 2rem 2.25rem; /* Padding equilibrado */
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 480px; /* Altura consistente com time-slots */
        }

        .campaign-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .campaign-icon {
            background: rgba(165, 148, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .campaign-icon svg {
            stroke: #A594FF;
        }

        .campaign-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
        }

        .campaign-stats {
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .campaign-count {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            color: #A594FF;
            margin-bottom: 0.25rem;
            line-height: 1;
        }

        .campaign-duration {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .campaign-instruction {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            max-width: 320px;
            margin: 0 auto;
        }

        /* Mobile responsiveness for schedule */
        @media (max-width: 768px) {
            .schedule-stats {
                grid-template-columns: 1fr;
            }

            .schedule-container {
                flex-direction: column;
            }

            .campaign-block {
                width: 100%;
            }


            .date-picker-dropdown {
                right: auto;
                left: 0;
                width: 100%;
            }

            .date-picker-content {
                width: 100%;
                max-width: 320px;
                margin: 0 auto;
                padding: 1rem;
            }

            .date-picker-day {
                padding: 0.5rem 0.3rem;
                font-size: 0.8rem;
                min-height: 2.2rem;
            }
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed rgba(165, 148, 255, 0.3);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: rgba(165, 148, 255, 0.5);
            background: rgba(165, 148, 255, 0.05);
        }

        .upload-area.dragover {
            border-color: #A594FF;
            background: rgba(165, 148, 255, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-formats {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Column Mapping */
        .column-mapping {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
        }

        .leads-preview {
            margin-top: 1.5rem;
        }

        .leads-preview h4 {
            margin-bottom: 1rem;
            color: #A594FF;
        }

        .leads-count {
            margin-top: 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Schedule Info */
        .schedule-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .schedule-info p {
            margin: 0.25rem 0;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        /* Capacity Calculator */
        .capacity-calculator {
            background: rgba(165, 148, 255, 0.1);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .capacity-calculator h4 {
            margin-bottom: 1rem;
            color: #A594FF;
        }

        .capacity-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .capacity-item {
            text-align: center;
        }

        .capacity-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: #A594FF;
        }

        .capacity-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .capacity-note {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .capacity-note.warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .capacity-note:not(.warning) {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        /* Step Navigation */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }

        .step-counter {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .step-buttons {
            display: flex;
            gap: 1rem;
        }

        .step-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .step-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .step-btn-primary {
            background: linear-gradient(135deg, #A594FF, #8B5CF6);
            color: white;
        }

        .step-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(165, 148, 255, 0.4);
        }

        .step-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Type Badge in Campaign List */
        .campaign-type-icon {
            margin-right: 0.5rem;
        }

        .type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .type-badge.messaging {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .type-badge.calling {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .campaign-type-options {
                grid-template-columns: 1fr;
            }

            .interval-options {
                flex-direction: column;
            }

            .capacity-grid {
                grid-template-columns: 1fr;
            }
        }

    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando campanhas...</div>
    </div>

    <!-- Custom Modal -->
    <div class="modal-overlay" id="customModal">
        <div class="modal-container">
            <div class="modal-icon" id="modalIcon">
                <svg id="modalIconSvg" width="28" height="28" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
            </div>
            <h3 class="modal-title" id="modalTitle">Título</h3>
            <p class="modal-message" id="modalMessage">Mensagem</p>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <div class="container main-content" id="mainContent">
        <!-- Header -->
        <div class="page-header">
            <div class="header-top">
                <div>
                    <h1 class="page-title">Dashboard de Campanhas</h1>
                    <p class="page-subtitle">Monitore e gerencie suas campanhas em tempo real</p>
                </div>
                <div class="header-actions">
                    <button class="action-btn-primary action-btn-secondary" onclick="openCallNowModal()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        Ligue Agora
                    </button>
                    <button class="action-btn-primary" onclick="createCampaign('outbound')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
                            <path d="M13 13l6 6"/>
                        </svg>
                        Nova Campanha
                    </button>
                </div>
            </div>
        </div>


        <!-- Campaigns List Section -->
        <div class="campaigns-section">
            <div class="campaigns-header">
                <div class="section-header">
                    <h2 class="section-title">Suas Campanhas</h2>
                    <p class="section-description">Visualize e gerencie todas as suas campanhas ativas</p>
                </div>
                <div class="campaigns-filters">
                    <button class="filter-btn active" onclick="filterCampaigns('all')">Todas</button>
                    <button class="filter-btn" onclick="filterCampaigns('active')">Ativas</button>
                    <button class="filter-btn" onclick="filterCampaigns('paused')">Pausadas</button>
                    <button class="filter-btn" onclick="filterCampaigns('ended')">Finalizadas</button>
                </div>
            </div>

            <div id="campaignsGrid" class="campaigns-grid">
                <!-- Empty state will be shown here -->
                <div class="empty-state">
                    <div class="empty-icon" id="emptyIconStatic">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10,9 9,9 8,9"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">Nenhuma campanha criada ainda</h3>
                    <p class="empty-description">
                        Crie sua primeira campanha para começar a prospectar
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ligue Agora -->
    <div class="call-now-overlay" id="callNowModal">
        <div class="call-now-dialog">
            <button class="call-now-close" onclick="closeCallNowModal()" type="button" aria-label="Fechar">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <div class="call-now-header">
                <div class="call-now-title-row">
                    <div class="call-now-icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                    </div>
                    <div class="call-now-title"><span>Ligue</span> Agora</div>
                </div>
                <div class="call-now-description">Conecte-se instantaneamente com seus leads através de nossa assistente virtual inteligente.</div>
            </div>

            <form id="callNowForm" class="call-now-form" onsubmit="handleCallNowSubmit(event)">
                <div class="call-now-field">
                    <label for="callAssistantSelect">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Assistente
                    </label>
                    <div class="call-now-input-wrapper">
                        <svg class="call-now-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2a10 10 0 0 0-9.95 9h11.64L9.74 7.05a1 1 0 0 1 1.41-1.41l5.66 5.65a1 1 0 0 1 0 1.42l-5.66 5.65a1 1 0 0 1-1.41 0 1 1 0 0 1 0-1.41L13.69 13H2.05A10 10 0 1 0 12 2z"/>
                        </svg>
                        <select id="callAssistantSelect" required>
                            <option value="">Carregando assistentes...</option>
                        </select>
                    </div>
                </div>

                <div class="call-now-field">
                    <label for="callAssistantNumberSelect">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                            <line x1="12" y1="18" x2="12.01" y2="18"></line>
                        </svg>
                        Número da Assistente
                    </label>
                    <div class="call-now-input-wrapper">
                        <svg class="call-now-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <select id="callAssistantNumberSelect" required>
                            <option value="">Carregando números...</option>
                        </select>
                    </div>
                    <div class="call-now-helper">Use o número conectado ao provider VoIP desejado.</div>
                </div>

                <div class="call-now-field">
                    <label for="callLeadNumberInput">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Número do Lead
                    </label>
                    <div class="call-now-input-wrapper">
                        <svg class="call-now-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <input id="callLeadNumberInput" type="tel" placeholder="Digite apenas os números" required>
                    </div>
                    <div class="call-now-helper">O número será formatado automaticamente: +55 11 98888-7777</div>
                </div>

                <div class="call-now-divider"></div>
                <div class="call-now-status" id="callNowStatus"></div>

                <div class="call-now-footer">
                    <button type="button" class="call-now-cancel" onclick="closeCallNowModal()">Cancelar</button>
                    <button type="submit" class="call-now-submit" id="callNowSubmitBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        Iniciar Ligação
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Mock data variables
        let metricsData = {
            totalAttempted: 0,
            connectedCalls: 0,
            completedCalls: 0,
            activeCampaigns: 0,
            pausedCampaigns: 0,
            endedCampaigns: 0
        };

        // Call Now data
        let callAssistants = [];
        let callNumbers = [];
        let isCallDataLoaded = false;
        let isCallDataLoading = false;

        function normalizePhone(value) {
            if (!value) return '';
            const trimmed = value.trim();
            if (!trimmed) return '';
            const hasPlus = trimmed.startsWith('+');
            const digits = trimmed.replace(/\D/g, '');
            if (!digits) return '';
            return hasPlus ? `+${digits}` : digits;
        }

        function safeParseJSON(value) {
            if (!value) return null;
            try {
                return JSON.parse(value);
            } catch {
                return value;
            }
        }

        function collectClientSnapshot() {
            const snapshot = {};
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    snapshot[key] = safeParseJSON(localStorage.getItem(key));
                }
            } catch (error) {
                console.warn('[CALL NOW] Não foi possível coletar todo o localStorage:', error);
            }
            return snapshot;
        }

        function formatPhoneNumber(value) {
            // Remove tudo exceto números
            const numbers = value.replace(/\D/g, '');

            // Se vazio, retorna vazio
            if (!numbers) return '';

            // Garante que sempre comece com +
            let formatted = '+';

            // Adiciona os números com formatação
            if (numbers.length <= 2) {
                // Apenas DDI: +55
                formatted += numbers;
            } else if (numbers.length <= 4) {
                // DDI + parte do DDD: +55 11
                formatted += numbers.slice(0, 2) + ' ' + numbers.slice(2);
            } else if (numbers.length <= 9) {
                // DDI + DDD completo + parte do número: +55 11 9888
                formatted += numbers.slice(0, 2) + ' ' + numbers.slice(2, 4) + ' ' + numbers.slice(4);
            } else if (numbers.length <= 13) {
                // Formato completo: +55 11 98888-7777
                formatted += numbers.slice(0, 2) + ' ' + numbers.slice(2, 4) + ' ' +
                            numbers.slice(4, 9) + '-' + numbers.slice(9);
            } else {
                // Limita ao tamanho máximo
                formatted += numbers.slice(0, 2) + ' ' + numbers.slice(2, 4) + ' ' +
                            numbers.slice(4, 9) + '-' + numbers.slice(9, 13);
            }

            return formatted;
        }

        function setupPhoneInput() {
            const phoneInput = document.getElementById('callLeadNumberInput');
            if (!phoneInput) return;

            phoneInput.addEventListener('input', function(e) {
                const cursorPosition = e.target.selectionStart;
                const oldValue = e.target.value;
                const oldLength = oldValue.length;

                // Formata o valor
                const formatted = formatPhoneNumber(oldValue);
                e.target.value = formatted;

                // Adiciona feedback visual quando estiver formatando
                if (formatted.length > 1) {
                    e.target.classList.add('formatting');
                } else {
                    e.target.classList.remove('formatting');
                }

                // Ajusta a posição do cursor
                const newLength = formatted.length;
                const diff = newLength - oldLength;

                // Se o tamanho aumentou mais do que 1, provavelmente adicionou formatação
                if (diff > 0) {
                    e.target.selectionStart = cursorPosition + diff;
                    e.target.selectionEnd = cursorPosition + diff;
                } else {
                    e.target.selectionStart = cursorPosition;
                    e.target.selectionEnd = cursorPosition;
                }
            });

            // Garante que sempre comece com +
            phoneInput.addEventListener('focus', function(e) {
                if (!e.target.value) {
                    e.target.value = '+';
                }
            });

            // Previne que o usuário delete o +
            phoneInput.addEventListener('keydown', function(e) {
                if ((e.key === 'Backspace' || e.key === 'Delete') && e.target.value === '+') {
                    e.preventDefault();
                }
            });
        }

        function openCallNowModal() {
            const modal = document.getElementById('callNowModal');
            if (!modal) return;
            modal.classList.add('show');
            setCallNowStatus('', '');

            // Setup phone input formatting
            setupPhoneInput();

            fetchCallNowData();
        }

        function closeCallNowModal() {
            const modal = document.getElementById('callNowModal');
            if (!modal) return;
            modal.classList.remove('show');
            const submitBtn = document.getElementById('callNowSubmitBtn');
            if (submitBtn) submitBtn.disabled = false;
            setCallNowStatus('', '');

            // Limpa o formulário
            const form = document.getElementById('callNowForm');
            if (form) form.reset();

            // Remove event listeners do phone input
            const phoneInput = document.getElementById('callLeadNumberInput');
            if (phoneInput) {
                phoneInput.value = '';
            }
        }

        function setCallNowStatus(type, message) {
            const statusEl = document.getElementById('callNowStatus');
            if (!statusEl) return;
            statusEl.className = 'call-now-status';
            if (type) {
                statusEl.classList.add(type);
            }
            statusEl.textContent = message || '';
        }

        async function fetchCallNowData(forceReload = false) {
            if (isCallDataLoading) return;
            if (isCallDataLoaded && !forceReload) return;

            const tenantId = localStorage.getItem('tenant_id');
            const login = localStorage.getItem('userEmail') || localStorage.getItem('user_email');
            const orgPrivateKey = localStorage.getItem('org_private_key') || localStorage.getItem('orgPrivateKey');

            if (!tenantId) {
                setCallNowStatus('error', 'Tenant ID não encontrado. Faça login novamente.');
                return;
            }

            isCallDataLoading = true;
            // Status de loading removido para melhor UX

            const assistantSelect = document.getElementById('callAssistantSelect');
            const numberSelect = document.getElementById('callAssistantNumberSelect');
            if (assistantSelect) assistantSelect.disabled = true;
            if (numberSelect) numberSelect.disabled = true;

            try {
                const response = await fetch('https://sdr.salesdever.io/webhook/assistentes-saas-att', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        login,
                        org_private_key: orgPrivateKey
                    })
                });

                const text = await response.text();
                let payload = [];

                if (text && text.trim() !== '') {
                    try {
                        payload = JSON.parse(text);
                    } catch (error) {
                        console.error('[CALL NOW] Erro ao parsear dados:', error);
                        setCallNowStatus('error', 'Resposta inválida ao carregar assistentes.');
                        return;
                    }
                }

                let mergedArray = [];
                if (Array.isArray(payload)) {
                    mergedArray = payload;
                } else if (payload && typeof payload === 'object') {
                    const assistantsList = payload.assistants || payload.assistentes || [];
                    const numbersList = payload.numbers || payload.numeros || [];
                    mergedArray = [...assistantsList, ...numbersList];
                }

                callAssistants = mergedArray
                    .filter(item => {
                        const isAssistant = item.assistant_id || item.assistente_id || (item.name && !item.phone_number && !item.number);
                        return Boolean(isAssistant);
                    })
                    .map(item => ({
                        id: String(item.assistente_id || item.assistant_id || item.id || ''),
                        name: item.name || item.assistant_name || 'Assistente sem nome',
                        raw: item
                    }))
                    .filter(item => item.id);

                callNumbers = mergedArray
                    .filter(item => item.number_name && (item.phone_number || item.number || item.phone))
                    .map(item => ({
                        id: String(item.number_id || item.id || ''),
                        name: item.number_name,
                        phone: (item.phone_number || item.number || item.phone || '').trim(),
                        raw: item
                    }))
                    .filter(item => item.id && item.phone);

                populateCallNowAssistants();
                populateCallNowNumbers();

                if (!callAssistants.length && !callNumbers.length) {
                    setCallNowStatus('error', 'Nenhum assistente ou número encontrado para este tenant.');
                    return;
                }

                // Status limpo silenciosamente
                isCallDataLoaded = true;
            } catch (error) {
                console.error('[CALL NOW] Erro ao buscar dados:', error);
                setCallNowStatus('error', 'Erro ao carregar dados. Tente novamente.');
            } finally {
                isCallDataLoading = false;
                if (assistantSelect && callAssistants.length) assistantSelect.disabled = false;
                if (numberSelect && callNumbers.length) numberSelect.disabled = false;
            }
        }

        function populateCallNowAssistants() {
            const select = document.getElementById('callAssistantSelect');
            if (!select) return;

            select.innerHTML = '';
            if (!callAssistants.length) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum assistente disponível';
                option.disabled = true;
                option.selected = true;
                select.appendChild(option);
                select.disabled = true;
                return;
            }

            select.disabled = false;
            select.innerHTML = '<option value="">Selecione um assistente</option>';
            callAssistants.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                option.setAttribute('data-assistant-name', item.name);
                select.appendChild(option);
            });
        }

        function populateCallNowNumbers() {
            const select = document.getElementById('callAssistantNumberSelect');
            if (!select) return;

            select.innerHTML = '';
            if (!callNumbers.length) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhum número disponível';
                option.disabled = true;
                option.selected = true;
                select.appendChild(option);
                select.disabled = true;
                return;
            }

            select.disabled = false;
            select.innerHTML = '<option value="">Selecione um número</option>';
            callNumbers.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (${item.phone})`;
                option.setAttribute('data-number-value', item.phone);
                select.appendChild(option);
            });
        }

        async function handleCallNowSubmit(event) {
            event.preventDefault();
            const assistantSelect = document.getElementById('callAssistantSelect');
            const numberSelect = document.getElementById('callAssistantNumberSelect');
            const leadInput = document.getElementById('callLeadNumberInput');
            const submitBtn = document.getElementById('callNowSubmitBtn');
            const defaultButtonText = submitBtn ? submitBtn.textContent : '';

            const assistantId = assistantSelect ? assistantSelect.value : '';
            const numberId = numberSelect ? numberSelect.value : '';
            const leadNumber = leadInput ? leadInput.value.trim() : '';
            const normalizedLead = normalizePhone(leadNumber);

            if (!assistantId || !numberId || !normalizedLead) {
                setCallNowStatus('error', 'Preencha os 3 campos para iniciar a chamada.');
                return;
            }

            const tenantId = localStorage.getItem('tenant_id');
            if (!tenantId) {
                setCallNowStatus('error', 'Tenant ID não encontrado. Faça login novamente.');
                return;
            }

            const assistant = callAssistants.find(item => item.id === assistantId);
            const number = callNumbers.find(item => item.id === numberId);

            const payload = {
                tenant_id: tenantId,
                assistant_id: assistantId,
                assistant_name: assistant ? assistant.name : '',
                assistant_number_id: numberId,
                assistant_number: number ? number.phone : '',
                assistant_number_label: number ? number.name : '',
                lead_number: normalizedLead,
                lead_number_display: leadNumber,
                login: localStorage.getItem('userEmail') || localStorage.getItem('user_email') || '',
                org_private_key: localStorage.getItem('org_private_key') || localStorage.getItem('orgPrivateKey') || '',
                user_data: safeParseJSON(localStorage.getItem('userData')) || {},
                client_snapshot: collectClientSnapshot()
            };

            console.log('[CALL NOW] Payload pronto para envio:', payload);
            setCallNowStatus('loading', 'Conectando com o discador seguro...');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Chamando...';
            }

            try {
                const response = await fetch('https://sdr.salesdever.io/webhook/ligue_agora_salesdever', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const responseBody = await response.text();
                let parsedResponse = null;
                if (responseBody) {
                    try {
                        parsedResponse = JSON.parse(responseBody);
                    } catch (error) {
                        console.warn('[CALL NOW] Resposta não estruturada:', responseBody);
                    }
                }

                if (!response.ok) {
                    const message = (parsedResponse && (parsedResponse.message || parsedResponse.error)) || 'Falha ao iniciar ligação.';
                    throw new Error(message);
                }

                const successMessage = (parsedResponse && (parsedResponse.message || parsedResponse.status)) || 'Ligação enviada para a assistente!';
                setCallNowStatus('success', successMessage);

                setTimeout(() => {
                    const form = document.getElementById('callNowForm');
                    if (form) form.reset();
                    closeCallNowModal();
                }, 1300);
            } catch (error) {
                console.error('[CALL NOW] Erro ao enviar:', error);
                setCallNowStatus('error', error.message || 'Não foi possível iniciar a chamada.');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = defaultButtonText || 'Iniciar Ligação';
                }
            }
        }

        // Load user data
        function loadUserData() {
            const userEmail = localStorage.getItem('userEmail');
            const tenantId = localStorage.getItem('tenant_id');

            const userBadge = document.getElementById('userBadge');
            if (userBadge) {
                if (userEmail) {
                    userBadge.textContent = userEmail;
                } else {
                    userBadge.textContent = 'Usuário não identificado';
                }
            }

            console.log('[INIT] User data loaded:', { userEmail, tenantId });
        }

        // Update metrics display
        function updateMetrics() {
            document.getElementById('totalAttempted').textContent = metricsData.totalAttempted;
            document.getElementById('connectedCalls').textContent = metricsData.connectedCalls;
            document.getElementById('completedCalls').textContent = metricsData.completedCalls;
            document.getElementById('activeCampaigns').textContent = metricsData.activeCampaigns;
            document.getElementById('pausedCampaigns').textContent = metricsData.pausedCampaigns;
            document.getElementById('endedCampaigns').textContent = metricsData.endedCampaigns;

            // Calculate rates
            const connectionRate = metricsData.totalAttempted > 0
                ? ((metricsData.connectedCalls / metricsData.totalAttempted) * 100).toFixed(1)
                : '0.0';

            const conversionRate = metricsData.totalAttempted > 0
                ? ((metricsData.completedCalls / metricsData.totalAttempted) * 100).toFixed(1)
                : '0.0';

            document.getElementById('connectionRate').textContent = connectionRate + '%';
            document.getElementById('conversionRate').textContent = conversionRate + '%';
        }

        // Create campaign based on type
        function createCampaign(type) {
            console.log('[CAMPAIGN] Creating campaign type:', type);

            // Instead of redirecting directly, open campaign type selection modal
            openCampaignTypeModal();
        }

        // Open campaign type selection modal
        function openCampaignTypeModal() {
            document.getElementById('campaignTypeModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Close campaign type selection modal
        function closeCampaignTypeModal() {
            document.getElementById('campaignTypeModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        // Handle campaign type selection
        function selectCampaignType(type) {
            console.log('[CAMPAIGN] Selected campaign type:', type);

            if (type === 'calling') {
                // Original flow for calling campaigns
                localStorage.setItem('campaign_type', 'outbound');
                window.location.href = 'seleciona-assistente.html';
            } else if (type === 'messaging') {
                // Open messaging campaign modal
                closeCampaignTypeModal();
                openMessagingCampaignModal();
            }
        }

        // Filter campaigns
        function filterCampaigns(filter) {
            console.log('[FILTER] Filtering campaigns:', filter);

            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filter campaign cards
            const campaignCards = document.querySelectorAll('.campaign-card');
            campaignCards.forEach(card => {
                const cardStatus = card.dataset.status;
                let shouldShow = false;

                switch(filter) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'active':
                        shouldShow = cardStatus === 'started' || cardStatus === 'pending';
                        break;
                    case 'paused':
                        shouldShow = cardStatus === 'paused';
                        break;
                    case 'ended':
                        shouldShow = cardStatus === 'completed' || cardStatus === 'cancelled';
                        break;
                }

                card.style.display = shouldShow ? 'block' : 'none';
            });

            // Update count if needed
            const visibleCards = document.querySelectorAll('.campaign-card[style="display: block"], .campaign-card:not([style*="display: none"])');
            console.log(`[FILTER] Showing ${visibleCards.length} campaigns for filter: ${filter}`);
        }

        // Load campaigns from API
        async function loadCampaigns() {
            console.log('[CAMPAIGNS] ========================================');
            console.log('[CAMPAIGNS] Função loadCampaigns() foi chamada!');
            console.log('[CAMPAIGNS] Timestamp:', new Date().toISOString());

            const tenantId = localStorage.getItem('tenant_id');
            console.log('[CAMPAIGNS] 📋 Tenant ID obtido do localStorage:', tenantId);
            console.log('[CAMPAIGNS] 📋 Tipo do tenant_id:', typeof tenantId);

            if (!tenantId) {
                console.error('[CAMPAIGNS] ❌ Tenant ID not found - abortando');
                alert('ERRO: Tenant ID não encontrado no localStorage. Faça login novamente.');
                hideLoading();
                return;
            }

            try {
                const url = 'https://sdr.salesdever.io/webhook/procura_campanhas';
                const body = { tenant_id: tenantId };

                console.log('[CAMPAIGNS] 🔍 Buscando campanhas...');
                console.log('[CAMPAIGNS] 📤 URL:', url);
                console.log('[CAMPAIGNS] 📤 Body:', JSON.stringify(body));
                console.log('[CAMPAIGNS] 📤 Iniciando fetch...');

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                console.log('[CAMPAIGNS] ✅ Fetch completou!');
                console.log('[CAMPAIGNS] ✅ Status:', response.status);
                console.log('[CAMPAIGNS] ✅ OK?:', response.ok);
                console.log('[CAMPAIGNS] ✅ Headers:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[CAMPAIGNS] ❌ Erro HTTP - Body:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                console.log('[CAMPAIGNS] 📥 Verificando conteúdo da resposta...');

                // Verificar se há conteúdo antes de parsear JSON
                const contentType = response.headers.get('content-type');
                const text = await response.text();

                console.log('[CAMPAIGNS] 📄 Content-Type:', contentType);
                console.log('[CAMPAIGNS] 📄 Tamanho da resposta:', text.length);
                console.log('[CAMPAIGNS] 📄 Conteúdo (primeiros 200 chars):', text.substring(0, 200));

                let data = [];

                // Se a resposta estiver vazia, retornar array vazio
                if (!text || text.trim() === '') {
                    console.log('[CAMPAIGNS] ⚠️ Resposta vazia - sem campanhas');
                    data = [];
                } else {
                    try {
                        data = JSON.parse(text);
                        console.log('[CAMPAIGNS] 📦 JSON parseado com sucesso!');
                        console.log('[CAMPAIGNS] 📦 Dados recebidos:', data);
                        console.log('[CAMPAIGNS] 📦 Tipo dos dados:', typeof data);
                        console.log('[CAMPAIGNS] 📦 É array?', Array.isArray(data));

                        if (Array.isArray(data)) {
                            console.log('[CAMPAIGNS] 📦 Quantidade de campanhas:', data.length);
                        }
                    } catch (parseError) {
                        console.error('[CAMPAIGNS] ❌ Erro ao parsear JSON:', parseError);
                        console.error('[CAMPAIGNS] ❌ Resposta recebida:', text);
                        throw new Error('Resposta do servidor não é um JSON válido: ' + parseError.message);
                    }
                }

                console.log('[CAMPAIGNS] ✅ Dados carregados com sucesso!');

                // Process data and render campaigns
                renderCampaigns(data);

                // Hide loading and show content
                hideLoading();

            } catch (error) {
                console.error('[CAMPAIGNS] ❌ ERRO CAPTURADO:', error);
                console.error('[CAMPAIGNS] ❌ Tipo do erro:', error.constructor.name);
                console.error('[CAMPAIGNS] ❌ Mensagem:', error.message);
                console.error('[CAMPAIGNS] ❌ Stack:', error.stack);
                alert('ERRO ao carregar campanhas: ' + error.message);
                hideLoading();
            }
        }

        // Hide loading overlay and show content
        function hideLoading() {
            console.log('[UI] Escondendo loading...');
            const overlay = document.getElementById('loadingOverlay');
            const content = document.getElementById('mainContent');

            overlay.classList.add('hidden');
            content.classList.add('loaded');

            console.log('[UI] ✅ Conteúdo exibido!');
        }

        // Show loading overlay
        function showLoading(text = 'Carregando...') {
            console.log('[UI] Mostrando loading:', text);
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = overlay.querySelector('.loading-text');

            if (loadingText) {
                loadingText.textContent = text;
            }

            overlay.classList.remove('hidden');
            console.log('[UI] ✅ Loading exibido!');
        }

        // Render campaigns
        function renderCampaigns(campaigns) {
            console.log('[RENDER] Renderizando campanhas:', campaigns);
            console.log('[RENDER] Tipo de campaigns:', typeof campaigns);
            console.log('[RENDER] É array?:', Array.isArray(campaigns));

            const grid = document.getElementById('campaignsGrid');

            // Ensure campaigns is an array
            let campaignsArray = campaigns;
            if (!Array.isArray(campaigns)) {
                console.log('[RENDER] Convertendo para array...');
                // If it's an object with a campaigns property
                if (campaigns && campaigns.campaigns && Array.isArray(campaigns.campaigns)) {
                    campaignsArray = campaigns.campaigns;
                }
                // If it's a single object, wrap it in an array
                else if (campaigns && typeof campaigns === 'object') {
                    campaignsArray = [campaigns];
                }
                // Otherwise, treat as empty
                else {
                    campaignsArray = [];
                }
            }

            console.log('[RENDER] Array final:', campaignsArray);
            console.log('[RENDER] Quantidade:', campaignsArray.length);

            if (!campaignsArray || campaignsArray.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon" id="emptyIconFixed">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                        </div>
                        <h3 class="empty-title">Nenhuma campanha criada ainda</h3>
                        <p class="empty-description">
                            Crie sua primeira campanha para começar a prospectar
                        </p>
                    </div>
                `;
                return;
            }

            // Render campaign cards
            grid.innerHTML = campaignsArray.map(campaign => {
                // Format created_at date
                const createdDate = new Date(campaign.created_at);
                const formattedCreatedDate = createdDate.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Format start_at date (scheduled start)
                let formattedStartDate = 'Não agendada';
                if (campaign.start_at) {
                    const startDate = new Date(campaign.start_at);
                    formattedStartDate = startDate.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                // SVG Icons
                const icons = {
                    clock: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
                    rocket: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"/></svg>`,
                    check: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
                    pause: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`,
                    users: `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#A594FF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
                    calendar: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
                    bot: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"/><rect x="4" y="8" width="16" height="12" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>`,
                    phone: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
                    calendarSmall: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
                    ban: `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>`
                };

                // Status badge configuration
                const statusConfig = {
                    pending: {
                        label: 'Agendada',
                        icon: icons.clock,
                        bg: 'rgba(255, 187, 0, 0.15)',
                        color: '#FFBB00',
                        border: 'rgba(255, 187, 0, 0.4)'
                    },
                    started: {
                        label: 'Em andamento',
                        icon: icons.rocket,
                        bg: 'rgba(34, 197, 94, 0.15)',
                        color: '#22C55E',
                        border: 'rgba(34, 197, 94, 0.4)'
                    },
                    completed: {
                        label: 'Concluída',
                        icon: icons.check,
                        bg: 'rgba(165, 148, 255, 0.15)',
                        color: '#A594FF',
                        border: 'rgba(165, 148, 255, 0.4)'
                    },
                    paused: {
                        label: 'Pausada',
                        icon: icons.pause,
                        bg: 'rgba(255, 100, 100, 0.15)',
                        color: '#FF6464',
                        border: 'rgba(255, 100, 100, 0.4)'
                    },
                    cancelled: {
                        label: 'Cancelada',
                        icon: icons.ban,
                        bg: 'rgba(156, 163, 175, 0.15)',
                        color: '#9CA3AF',
                        border: 'rgba(156, 163, 175, 0.4)'
                    }
                };
                const status = statusConfig[campaign.status] || statusConfig.pending;

                // Format total leads number
                const totalLeads = campaign.total_leads ? campaign.total_leads.toLocaleString('pt-BR') : '0';

                return `
                    <div class="campaign-card" style="
                        background: linear-gradient(145deg, rgba(30, 25, 55, 0.9), rgba(20, 15, 40, 0.95));
                        backdrop-filter: blur(20px);
                        border: 1px solid rgba(165, 148, 255, 0.2);
                        border-radius: 1.25rem;
                        padding: 1.5rem;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    ">
                        <!-- Gradient accent line at top -->
                        <div style="
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            height: 3px;
                            background: linear-gradient(90deg, #A594FF, #7C6FD4);
                        "></div>

                        <!-- Header: Title + Status + Delete -->
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.25rem; gap: 0.75rem;">
                            <h3 style="font-size: 1.15rem; font-weight: 700; color: #ffffff; margin: 0; line-height: 1.3; flex: 1;">
                                <span class="campaign-type-icon" style="margin-right: 0.5rem;">
                                    ${campaign.campaign_type === 'messaging' ? '💬' : '📞'}
                                </span>
                                ${campaign.campaign_name}
                            </h3>
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <!-- Type Badge -->
                                <span class="type-badge ${campaign.campaign_type === 'messaging' ? 'messaging' : 'calling'}" style="
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 0.25rem;
                                    padding: 0.25rem 0.6rem;
                                    border-radius: 1rem;
                                    font-size: 0.65rem;
                                    font-weight: 600;
                                    white-space: nowrap;
                                    background: ${campaign.campaign_type === 'messaging' ? 'rgba(34, 197, 94, 0.15)' : 'rgba(59, 130, 246, 0.15)'};
                                    color: ${campaign.campaign_type === 'messaging' ? '#22c55e' : '#3b82f6'};
                                    border: 1px solid ${campaign.campaign_type === 'messaging' ? 'rgba(34, 197, 94, 0.3)' : 'rgba(59, 130, 246, 0.3)'};
                                ">
                                    ${campaign.campaign_type === 'messaging' ? 'Mensagem' : 'Ligação'}
                                </span>
                                <!-- Status Badge -->
                                <span style="
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 0.35rem;
                                    padding: 0.4rem 0.75rem;
                                    border-radius: 2rem;
                                    font-size: 0.7rem;
                                    font-weight: 600;
                                    letter-spacing: 0.3px;
                                    white-space: nowrap;
                                    background: ${status.bg};
                                    color: ${status.color};
                                    border: 1px solid ${status.border};
                                ">
                                    <span style="display: flex; align-items: center;">${status.icon}</span>
                                    <span>${status.label}</span>
                                </span>
                                <button onclick="deleteCampaign('${campaign.campaign_id}')" title="Excluir campanha" style="
                                    width: 28px;
                                    height: 28px;
                                    background: rgba(255, 255, 255, 0.05);
                                    border: 1px solid rgba(255, 255, 255, 0.1);
                                    border-radius: 0.4rem;
                                    color: rgba(255, 255, 255, 0.5);
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.2s ease;
                                    padding: 0;
                                " onmouseover="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.borderColor='rgba(239, 68, 68, 0.4)'; this.style.color='#EF4444'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'; this.style.color='rgba(255, 255, 255, 0.5)'">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Stats Row: Total Leads highlight -->
                        <div style="
                            display: flex;
                            align-items: center;
                            gap: 1rem;
                            padding: 1rem;
                            margin-bottom: 1rem;
                            background: rgba(165, 148, 255, 0.08);
                            border-radius: 0.75rem;
                            border: 1px solid rgba(165, 148, 255, 0.15);
                        ">
                            <div style="
                                width: 42px;
                                height: 42px;
                                border-radius: 0.6rem;
                                background: linear-gradient(135deg, rgba(165, 148, 255, 0.3), rgba(165, 148, 255, 0.1));
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">${icons.users}</div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 800; color: #ffffff; line-height: 1;">${totalLeads}</div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); margin-top: 0.15rem;">contatos</div>
                            </div>
                        </div>

                        <!-- Info Grid -->
                        <div style="display: grid; gap: 0.65rem; margin-bottom: 1.25rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.5);">${icons.calendar}</span>
                                <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">Início:</span>
                                <span style="color: #A594FF; font-size: 0.8rem; font-weight: 600;">${formattedStartDate}</span>
                            </div>
                            ${campaign.campaign_type === 'messaging' ? `
                            <!-- Messaging Campaign Info -->
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.5);">💬</span>
                                <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">Instância:</span>
                                <span style="color: rgba(255, 255, 255, 0.9); font-size: 0.8rem; font-weight: 500;">${campaign.instance_name || 'Não definido'}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.5);">⏱️</span>
                                <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">Intervalo:</span>
                                <span style="color: rgba(255, 255, 255, 0.9); font-size: 0.8rem; font-weight: 500;">${campaign.interval_min && campaign.interval_max ? campaign.interval_min + '-' + campaign.interval_max + ' min' : 'Não definido'}</span>
                            </div>
                            ` : `
                            <!-- Calling Campaign Info -->
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.5);">${icons.bot}</span>
                                <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">Assistente:</span>
                                <span style="color: rgba(255, 255, 255, 0.9); font-size: 0.8rem; font-weight: 500;">${campaign.assistant_name || 'Não definido'}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.5);">${icons.phone}</span>
                                <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">Número:</span>
                                <span style="color: rgba(255, 255, 255, 0.9); font-size: 0.8rem; font-weight: 500; font-family: 'JetBrains Mono', monospace;">${campaign.number_value || 'Não definido'}</span>
                            </div>
                            `}
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="display: flex; align-items: center; color: rgba(255, 255, 255, 0.4);">${icons.calendarSmall}</span>
                                <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.8rem;">Criada:</span>
                                <span style="color: rgba(255, 255, 255, 0.6); font-size: 0.75rem;">${formattedCreatedDate}</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 0.6rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                            <button onclick="viewCampaign('${campaign.campaign_id}')" style="
                                flex: 1;
                                padding: 0.7rem;
                                background: linear-gradient(135deg, rgba(165, 148, 255, 0.2), rgba(165, 148, 255, 0.1));
                                border: 1px solid rgba(165, 148, 255, 0.35);
                                border-radius: 0.6rem;
                                color: #A594FF;
                                font-size: 0.8rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='linear-gradient(135deg, rgba(165, 148, 255, 0.3), rgba(165, 148, 255, 0.2))'" onmouseout="this.style.background='linear-gradient(135deg, rgba(165, 148, 255, 0.2), rgba(165, 148, 255, 0.1))'">
                                Ver Detalhes
                            </button>
                            <button onclick="cancelCampaign('${campaign.campaign_id}', '${campaign.campaign_type || 'calling'}')" style="
                                flex: 1;
                                padding: 0.7rem;
                                background: rgba(255, 255, 255, 0.05);
                                border: 1px solid rgba(255, 255, 255, 0.15);
                                border-radius: 0.6rem;
                                color: rgba(255, 255, 255, 0.7);
                                font-size: 0.8rem;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='rgba(255, 100, 100, 0.15)'; this.style.borderColor='rgba(255, 100, 100, 0.3)'; this.style.color='#FF6464'" onmouseout="this.style.background='rgba(255, 255, 255, 0.05)'; this.style.borderColor='rgba(255, 255, 255, 0.15)'; this.style.color='rgba(255, 255, 255, 0.7)'">
                                Cancelar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            console.log('[RENDER] ✅ Campanhas renderizadas com sucesso!');
        }

        // Toggle campaign details
        function toggleCampaignDetails(campaignId) {
            const detailsEl = document.getElementById(`details-${campaignId}`);
            const toggleTextEl = document.getElementById(`toggle-text-${campaignId}`);
            const toggleIconEl = document.getElementById(`toggle-icon-${campaignId}`);

            if (detailsEl.style.display === 'none') {
                detailsEl.style.display = 'block';
                toggleTextEl.textContent = 'Ocultar detalhes';
                toggleIconEl.style.transform = 'rotate(180deg)';
            } else {
                detailsEl.style.display = 'none';
                toggleTextEl.textContent = 'Ver detalhes';
                toggleIconEl.style.transform = 'rotate(0deg)';
            }
        }

        // Modal Helper Functions
        const modalIcons = {
            warning: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>`,
            danger: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>`,
            success: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>`,
            error: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>`
        };

        function showModal(options) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const icon = document.getElementById('modalIcon');
                const iconSvg = document.getElementById('modalIconSvg');
                const title = document.getElementById('modalTitle');
                const message = document.getElementById('modalMessage');
                const buttons = document.getElementById('modalButtons');

                // Set icon
                icon.className = 'modal-icon ' + (options.iconType || 'warning');
                iconSvg.innerHTML = modalIcons[options.iconType || 'warning'];

                // Set content
                title.textContent = options.title || 'Confirmação';
                message.textContent = options.message || '';

                // Set buttons
                buttons.innerHTML = '';

                if (options.showCancel !== false) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'modal-btn modal-btn-cancel';
                    cancelBtn.textContent = options.cancelText || 'Cancelar';
                    cancelBtn.onclick = () => {
                        hideModal();
                        resolve(false);
                    };
                    buttons.appendChild(cancelBtn);
                }

                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'modal-btn modal-btn-' + (options.confirmType || 'primary');
                confirmBtn.textContent = options.confirmText || 'Confirmar';
                confirmBtn.onclick = () => {
                    hideModal();
                    resolve(true);
                };
                buttons.appendChild(confirmBtn);

                // Show modal
                modal.classList.add('show');
            });
        }

        function hideModal() {
            document.getElementById('customModal').classList.remove('show');
        }

        function showAlert(options) {
            return showModal({
                ...options,
                showCancel: false,
                confirmText: options.confirmText || 'Ok'
            });
        }

        // Campaign actions
        function viewCampaign(id) {
            console.log('[ACTION] View campaign:', id);
            showAlert({
                iconType: 'warning',
                title: 'Em breve!',
                message: 'Estamos trabalhando nesta funcionalidade.',
                confirmText: 'Entendi',
                confirmType: 'primary'
            });
        }

        async function cancelCampaign(campaignId, campaignType = 'calling') {
            console.log('[ACTION] Cancel campaign:', campaignId, 'type:', campaignType);

            const confirmed = await showModal({
                iconType: 'warning',
                title: 'Cancelar Campanha',
                message: 'Tem certeza que deseja cancelar esta campanha? Esta ação não pode ser desfeita.',
                cancelText: 'Voltar',
                confirmText: 'Sim, cancelar',
                confirmType: 'warning'
            });

            if (!confirmed) return;

            const tenantId = localStorage.getItem('tenant_id');

            if (!tenantId) {
                showAlert({
                    iconType: 'error',
                    title: 'Erro',
                    message: 'Tenant ID não encontrado. Por favor, faça login novamente.',
                    confirmType: 'danger'
                });
                return;
            }

            // Different webhook URL depending on campaign type
            const webhookUrl = campaignType === 'messaging'
                ? 'https://sdr.salesdever.io/webhook/cancela-campanha-mensagem'
                : 'https://sdr.salesdever.io/webhook/b487bd9d-9a01-417c-b4a0-93a3a9339cf8';

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaign_id: campaignId,
                        tenant_id: tenantId,
                        action: 'cancel'
                    })
                });

                if (response.ok) {
                    await showAlert({
                        iconType: 'success',
                        title: 'Campanha Cancelada',
                        message: 'A campanha foi cancelada com sucesso.',
                        confirmText: 'Ok',
                        confirmType: 'primary'
                    });
                    loadCampaigns();
                } else {
                    throw new Error('Erro ao cancelar campanha');
                }
            } catch (error) {
                console.error('[ERROR] Erro ao cancelar campanha:', error);
                showAlert({
                    iconType: 'error',
                    title: 'Erro',
                    message: 'Não foi possível cancelar a campanha. Tente novamente.',
                    confirmType: 'danger'
                });
            }
        }

        async function deleteCampaign(campaignId) {
            console.log('[ACTION] Delete campaign:', campaignId);

            const confirmed = await showModal({
                iconType: 'danger',
                title: 'Excluir Campanha',
                message: 'Tem certeza que deseja excluir esta campanha? Esta ação é permanente e não pode ser desfeita.',
                cancelText: 'Voltar',
                confirmText: 'Sim, excluir',
                confirmType: 'danger'
            });

            if (!confirmed) return;

            const tenantId = localStorage.getItem('tenant_id');

            if (!tenantId) {
                showAlert({
                    iconType: 'error',
                    title: 'Erro',
                    message: 'Tenant ID não encontrado. Por favor, faça login novamente.',
                    confirmType: 'danger'
                });
                return;
            }

            try {
                const response = await fetch('https://sdr.salesdever.io/webhook/6e738e13-d514-4a79-ba63-cc1f717eebc5', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        campaign_id: campaignId,
                        tenant_id: tenantId
                    })
                });

                if (response.ok) {
                    await showAlert({
                        iconType: 'success',
                        title: 'Campanha Excluída',
                        message: 'A campanha foi excluída com sucesso.',
                        confirmText: 'Ok',
                        confirmType: 'primary'
                    });
                    loadCampaigns();
                } else {
                    throw new Error('Erro ao excluir campanha');
                }
            } catch (error) {
                console.error('[ERROR] Erro ao excluir campanha:', error);
                showAlert({
                    iconType: 'error',
                    title: 'Erro',
                    message: 'Não foi possível excluir a campanha. Tente novamente.',
                    confirmType: 'danger'
                });
            }
        }

        // Initialize on load
        console.log('[DEBUG] ========================================');
        console.log('[DEBUG] Script carregado! Timestamp:', new Date().toISOString());
        console.log('[DEBUG] document.readyState:', document.readyState);
        console.log('[DEBUG] ========================================');

        // Try multiple initialization methods
        function initializeDashboard() {
            console.log('INICIALIZANDO DASHBOARD - FORÇANDO ESCONDER LOADING');

            // FORÇA ESCONDER LOADING DE TODAS AS FORMAS POSSÍVEIS
            const overlay = document.getElementById('loadingOverlay');
            const content = document.getElementById('mainContent');

            if (overlay) {
                overlay.style.display = 'none';
                overlay.style.visibility = 'hidden';
                overlay.style.opacity = '0';
                overlay.classList.add('hidden');
            }

            if (content) {
                content.style.opacity = '1';
                content.style.visibility = 'visible';
                content.style.display = 'block';
                content.classList.add('loaded');
            }

            console.log('LOADING ESCONDIDO COM SUCESSO!');
        }

        // Simplified initialization
        let dashboardInitialized = false;

        function safeDashboardInit() {
            if (dashboardInitialized) return;
            dashboardInitialized = true;

            const callNowOverlay = document.getElementById('callNowModal');
            if (callNowOverlay) {
                callNowOverlay.addEventListener('click', (event) => {
                    if (event.target === callNowOverlay) {
                        closeCallNowModal();
                    }
                });
            }

            // Carregar campanhas quando a página inicializar
            console.log('[DASHBOARD] Iniciando carregamento de campanhas...');
            loadCampaigns();

            initializeDashboard();
        }

        // FORÇA ESCONDER LOADING MÚLTIPLAS VEZES
        setTimeout(() => {
            initializeDashboard();
        }, 50);

        setTimeout(() => {
            initializeDashboard();
        }, 200);

        setTimeout(() => {
            initializeDashboard();
        }, 500);

        // Try DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM LOADED - FORÇANDO ESCONDER');
            initializeDashboard();
            // Initialize calendar when DOM is loaded
            setTimeout(initMsgCalendar, 100);
        });

        // Immediate execution if already loaded
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            console.log('DOCUMENTO JÁ CARREGADO - EXECUTANDO AGORA');
            initializeDashboard();
        }

        // FORÇAR CARREGAMENTO DE CAMPANHAS EM TODOS OS CENÁRIOS POSSÍVEIS
        function forceLoadCampaigns() {
            console.log('[FORCE_CAMPAIGNS] Carregando campanhas agora...');
            loadCampaigns();
        }

        // Event listeners para garantir carregamento
        window.addEventListener('load', forceLoadCampaigns);
        window.addEventListener('pageshow', forceLoadCampaigns);
        window.addEventListener('focus', forceLoadCampaigns);

        // Múltiplas tentativas por timeout
        setTimeout(forceLoadCampaigns, 500);
        setTimeout(forceLoadCampaigns, 1000);
        setTimeout(forceLoadCampaigns, 2000);

        // Carregamento periódico para manter atualizado
        setInterval(forceLoadCampaigns, 30000); // A cada 30 segundos

        // Detectar cliques em links de campanhas ou navegação
        document.addEventListener('click', function(e) {
            const target = e.target;
            const href = target.href || target.closest('a')?.href || '';
            const onclick = target.onclick || target.getAttribute('onclick') || '';

            // Se clicou em algo relacionado a campanhas
            if (href.includes('campanha') || onclick.includes('campanha') ||
                target.textContent?.toLowerCase().includes('campanha')) {
                console.log('[CLICK_DETECT] Clique em elemento de campanha detectado');
                setTimeout(forceLoadCampaigns, 100);
            }
        });

        // Detectar mudanças na URL
        let currentUrl = window.location.href;
        setInterval(() => {
            if (window.location.href !== currentUrl) {
                currentUrl = window.location.href;
                if (currentUrl.includes('campanha')) {
                    console.log('[URL_CHANGE] Navegação para página de campanhas detectada');
                    forceLoadCampaigns();
                }
            }
        }, 500);

        // === MESSAGING CAMPAIGN FUNCTIONS ===

        let currentMsgStep = 1;
        let msgProcessedLeads = [];

        // Função para rolar modal para o topo
        function scrollModalToTop() {
            const modalContent = document.querySelector('.messaging-campaign-content');
            if (modalContent) {
                modalContent.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                console.log('[SCROLL] Modal scrolled to top');
            }
        }

        // Open messaging campaign modal
        function openMessagingCampaignModal() {
            console.log('[MODAL] Opening messaging campaign modal...');

            const modal = document.getElementById('messagingCampaignModal');
            if (!modal) {
                console.error('[MODAL] messagingCampaignModal not found');
                return;
            }

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // Reset form
            resetMessagingForm();

            // Initialize date picker after modal is opened
            setTimeout(() => {
                console.log('[MODAL] Initializing date picker after modal open...');
                initMsgDatePicker();
            }, 200);

            // SEMPRE começar do topo quando abrir
            setTimeout(() => scrollModalToTop(), 100);

            // Load WhatsApp instances
            loadWhatsAppInstances();

            // Set default start date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateInput = document.getElementById('msgStartDate');
            if (dateInput) {
                dateInput.value = tomorrow.toISOString().split('T')[0];
            }

            // Setup file upload
            setupMsgFileUpload();

            console.log('[MODAL] Messaging campaign modal opened');
        }

        // Close messaging campaign modal
        function closeMessagingCampaignModal() {
            document.getElementById('messagingCampaignModal').classList.remove('show');
            document.body.style.overflow = '';
            resetMessagingForm();
        }

        // Reset messaging form
        function resetMessagingForm() {
            currentMsgStep = 1;
            msgProcessedLeads = [];

            // Reset form fields - with null checks
            const campaignNameEl = document.getElementById('msgCampaignName');
            const instanceSelectEl = document.getElementById('msgInstanceSelect');
            const templateEl = document.getElementById('msgTemplate');
            const fileInputEl = document.getElementById('msgFileInput');
            const columnMappingEl = document.getElementById('msgColumnMapping');
            const step1El = document.getElementById('msgStep1');

            if (campaignNameEl) campaignNameEl.value = '';
            if (instanceSelectEl) instanceSelectEl.innerHTML = '<option value="">Selecione a instância...</option>';
            if (templateEl) templateEl.value = '';
            if (fileInputEl) fileInputEl.value = '';

            // Reset steps
            document.querySelectorAll('.msg-campaign-step').forEach(step => step.classList.remove('active'));
            if (step1El) step1El.classList.add('active');
            currentMsgStep = 1;

            // Reset navigation
            updateMsgStepNavigation();

            // Hide column mapping
            if (columnMappingEl) columnMappingEl.style.display = 'none';
        }

        // Load WhatsApp instances
        async function loadWhatsAppInstances() {
            const tenantId = localStorage.getItem('tenant_id');

            try {
                const response = await fetch('https://sdr.salesdever.io/webhook/busca-instancias-whatsapp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tenant_id: tenantId })
                });

                const instances = await response.json();
                console.log('[MSG_CAMPAIGN] WhatsApp instances loaded:', instances);

                const select = document.getElementById('msgInstanceSelect');
                select.innerHTML = '<option value="">Selecione a instância...</option>';

                if (instances && instances.length > 0) {
                    instances.forEach(instance => {
                        // Verifica se instância está disponível para uso
                        const isConnected = instance.status === 'connected' || instance.status === 'conectada';
                        const isActive = instance.ativo === true;
                        const isDeleted = instance.deletado === true;

                        console.log(`[INSTANCE] ${instance.instance_name}:`, {
                            status: instance.status,
                            ativo: instance.ativo,
                            deletado: instance.deletado,
                            isConnected,
                            isActive,
                            willShow: (isConnected || isActive) && !isDeleted
                        });

                        // Mostra instâncias que estão conectadas OU ativas, desde que não estejam deletadas
                        if ((isConnected || isActive) && !isDeleted) {
                            const option = document.createElement('option');
                            option.value = instance.instance_name;
                            option.dataset.instanceId = instance.id;

                            // Melhora a exibição com status visual
                            const statusIcon = isConnected ? '🟢' : '🟡';
                            const statusText = isConnected ? 'Conectada' : 'Ativa';

                            option.textContent = `${statusIcon} ${instance.instance_name} (${instance.phone_number || 'Sem número'}) - ${statusText}`;
                            select.appendChild(option);
                        }
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhuma instância ativa encontrada';
                    option.disabled = true;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('[MSG_CAMPAIGN] Error loading instances:', error);
                const select = document.getElementById('msgInstanceSelect');
                select.innerHTML = '<option value="">Erro ao carregar instâncias</option>';
            }
        }

        // Navigate to next step
        function nextMsgStep() {
            console.log('[MSG_STEP] Trying to go to next step from:', currentMsgStep);

            if (!validateCurrentMsgStep()) {
                console.log('[MSG_STEP] Validation failed for step:', currentMsgStep);
                return;
            }

            if (currentMsgStep < 4) {
                // Hide current step
                document.getElementById(`msgStep${currentMsgStep}`).classList.remove('active');

                // Show next step
                currentMsgStep++;
                document.getElementById(`msgStep${currentMsgStep}`).classList.add('active');

                // SEMPRE rolar para o topo do modal
                scrollModalToTop();

                updateMsgStepNavigation();

                // Setup upload when reaching step 3
                if (currentMsgStep === 3) {
                    console.log('[MSG_STEP] Reached step 3, setting up file upload...');
                    setTimeout(() => setupMsgFileUpload(), 100); // Small delay to ensure DOM is ready
                }

                // Update capacity calculation when reaching step 4
                if (currentMsgStep === 4) {
                    setTimeout(() => {
                        calculateMessagingCapacity();
                        initializeMsgSchedule();
                    }, 200);
                }
            }
        }

        // Navigate to previous step
        function previousMsgStep() {
            if (currentMsgStep > 1) {
                // Hide current step
                document.getElementById(`msgStep${currentMsgStep}`).classList.remove('active');

                // Show previous step
                currentMsgStep--;
                document.getElementById(`msgStep${currentMsgStep}`).classList.add('active');

                // SEMPRE rolar para o topo do modal
                scrollModalToTop();

                updateMsgStepNavigation();
            }
        }

        // Update step navigation buttons
        function updateMsgStepNavigation() {
            const prevBtn = document.getElementById('msgPrevBtn');
            const nextBtn = document.getElementById('msgNextBtn');
            const createBtn = document.getElementById('msgCreateBtn');
            const stepCounter = document.getElementById('currentStep');

            stepCounter.textContent = currentMsgStep;

            // Show/hide previous button
            if (currentMsgStep === 1) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'inline-block';
            }

            // Show/hide next/create buttons
            if (currentMsgStep === 4) {
                nextBtn.style.display = 'none';
                createBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                createBtn.style.display = 'none';
            }
        }

        // Validate current step
        function validateCurrentMsgStep() {
            switch (currentMsgStep) {
                case 1:
                    const campaignName = document.getElementById('msgCampaignName').value.trim();
                    const instance = document.getElementById('msgInstanceSelect').value;
                    const interval = document.querySelector('input[name="interval"]:checked');

                    if (!campaignName) {
                        showAlert({
                            iconType: 'error',
                            title: 'Campo Obrigatório',
                            message: 'Por favor, digite o nome da campanha.'
                        });
                        return false;
                    }

                    if (!instance) {
                        showAlert({
                            iconType: 'error',
                            title: 'Campo Obrigatório',
                            message: 'Por favor, selecione uma instância WhatsApp.'
                        });
                        return false;
                    }

                    if (!interval) {
                        showAlert({
                            iconType: 'error',
                            title: 'Campo Obrigatório',
                            message: 'Por favor, selecione um ritmo de envio.'
                        });
                        return false;
                    }
                    break;

                case 2:
                    const messageTemplate = document.getElementById('msgTemplate').value.trim();

                    if (!messageTemplate) {
                        showAlert({
                            iconType: 'error',
                            title: 'Campo Obrigatório',
                            message: 'Por favor, digite a mensagem que será enviada.'
                        });
                        return false;
                    }
                    break;

                case 3:
                    // Verifica tanto a variável local quanto a global
                    const totalLeads = window.msgProcessedLeads?.length || msgProcessedLeads?.length || 0;
                    console.log('[VALIDATION] Verificando leads - Local:', msgProcessedLeads?.length, 'Global:', window.msgProcessedLeads?.length, 'Total:', totalLeads);

                    if (totalLeads === 0) {
                        console.log('[VALIDATION] ❌ Nenhum lead encontrado');
                        showAlert({
                            iconType: 'error',
                            title: 'Lista Vazia',
                            message: 'Por favor, faça upload da planilha com a lista de leads.'
                        });
                        return false;
                    }

                    console.log('[VALIDATION] ✅ Leads encontrados:', totalLeads);
                    break;

                case 4:
                    const startDate = document.getElementById('msgStartDate').value;
                    const startTime = document.getElementById('msgStartTime').value;

                    if (!startDate) {
                        showAlert({
                            iconType: 'error',
                            title: 'Campo Obrigatório',
                            message: 'Por favor, selecione a data de início.'
                        });
                        return false;
                    }

                    if (!startTime) {
                        showAlert({
                            iconType: 'error',
                            title: 'Campo Obrigatório',
                            message: 'Por favor, selecione a hora de início.'
                        });
                        return false;
                    }

                    // Validate start datetime is in the future
                    const startDateTime = new Date(`${startDate}T${startTime}:00`);
                    const now = new Date();

                    if (startDateTime <= now) {
                        showAlert({
                            iconType: 'error',
                            title: 'Data Inválida',
                            message: 'A data e hora de início deve ser no futuro.'
                        });
                        return false;
                    }
                    break;
            }

            return true;
        }

        // Setup file upload for messaging campaign
        function setupMsgFileUpload() {
            console.log('[UPLOAD_SETUP] Setting up file upload...');

            const uploadArea = document.getElementById('msgUploadArea');
            const fileInput = document.getElementById('msgFileInput');

            if (!uploadArea || !fileInput) {
                console.error('[UPLOAD_SETUP] Upload elements not found');
                return;
            }

            // CÓPIA EXATA DO PLANILHA.HTML
            uploadArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) processMsgFile(file);
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                if (!uploadArea.contains(e.relatedTarget)) {
                    uploadArea.classList.remove('dragover');
                }
            });

            uploadArea.addEventListener('drop', (e) => {
                console.log('[UPLOAD_SETUP] 🗂️ Files dropped:', e.dataTransfer.files?.length);
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log('[UPLOAD_SETUP] 📁 File dropped:', files[0].name);

                    // Create a new FileList to assign to input
                    const dt = new DataTransfer();
                    dt.items.add(files[0]);
                    fileInput.files = dt.files;

                    console.log('[UPLOAD_SETUP] 🔄 Calling handleMsgFileUpload...');
                    handleMsgFileUpload();
                }
            });

            console.log('[UPLOAD_SETUP] File upload setup completed');
        }

        // FUNÇÃO CÓPIA EXATA DO PLANILHA.HTML
        async function processMsgFile(file) {
            if (!file.name.match(/\.(csv|xlsx|xls)$/i)) {
                alert('Por favor, envie um arquivo CSV ou Excel.');
                return;
            }

            console.log('[MSG_UPLOAD] Processando arquivo:', file.name);

            try {
                if (file.name.match(/\.csv$/i)) {
                    await processMsgCSV(file);
                } else {
                    await processMsgExcel(file);
                }

                if (window.msgUploadedData && window.msgUploadedData.headers.length > 0) {
                    console.log('[MSG_UPLOAD] ✅ Arquivo processado:', window.msgUploadedData.rows.length, 'linhas');

                    // Populate column selectors
                    populateMsgColumnSelectors();

                    // Update upload area design
                    updateUploadAreaAfterSuccess(file.name, window.msgUploadedData.rows.length);

                    // Show column mapping section
                    document.getElementById('msgColumnMapping').style.display = 'block';

                    // FORÇA CONTAGEM IMEDIATA
                    console.log('📊 DADOS CARREGADOS - FORÇANDO CONTAGEM...');
                    setTimeout(() => {
                        forceCountLeads();
                    }, 100);

                    // Auto-select columns and process if possible
                    autoSelectColumnsAndProcess();
                }
            } catch (error) {
                console.error('[MSG_UPLOAD] Erro:', error);
                alert(`Erro ao processar arquivo: ${error.message}`);
            }
        }

        // Process CSV (igual ao planilha.html)
        // CÓPIA EXATA DA FUNÇÃO DO PLANILHA.HTML
        async function processMsgCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        window.msgUploadedData = {
                            headers: Object.keys(results.data[0] || {}),
                            rows: results.data
                        };
                        resolve();
                    },
                    error: reject
                });
            });
        }

        // Process Excel (igual ao planilha.html)
        // CÓPIA EXATA DA FUNÇÃO DO PLANILHA.HTML
        async function processMsgExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                        window.msgUploadedData = {
                            headers: Object.keys(jsonData[0] || {}),
                            rows: jsonData
                        };
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Read Excel file
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                console.log('[FILE_READ] Starting to read file:', file.name, file.type);

                const reader = new FileReader();

                reader.onload = function(e) {
                    console.log('[FILE_READ] File loaded, processing...');
                    try {
                        // Check if it's CSV by file extension (more reliable than MIME type)
                        const isCSV = file.name.toLowerCase().endsWith('.csv');

                        if (isCSV) {
                            console.log('[FILE_READ] Processing as CSV file');
                            // Handle CSV files
                            const text = e.target.result;
                            const lines = text.split(/\r?\n/); // Handle different line endings
                            console.log('[FILE_READ] CSV lines:', lines.length);

                            const data = lines.map(line => {
                                if (!line.trim()) return []; // Skip empty lines
                                // Simple CSV parsing (handles basic cases)
                                return line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                            }).filter(row => row.length > 0 && row.some(cell => cell.trim())); // Remove completely empty rows

                            console.log('[FILE_READ] CSV processed, rows:', data.length);

                            // Create a mock workbook for consistency
                            resolve({
                                Sheets: {
                                    'Sheet1': {
                                        // Mock sheet data - we'll use the data directly
                                    }
                                },
                                SheetNames: ['Sheet1'],
                                csvData: data // Add our parsed data
                            });
                        } else {
                            console.log('[FILE_READ] Processing as Excel file');
                            // Handle Excel files
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            console.log('[FILE_READ] Excel processed, sheets:', workbook.SheetNames);
                            resolve(workbook);
                        }
                    } catch (error) {
                        console.error('[FILE_READ] Error processing file:', error);
                        reject(error);
                    }
                };

                reader.onerror = () => {
                    console.error('[FILE_READ] FileReader error');
                    reject(new Error('Erro ao ler arquivo'));
                };

                // Choose reading method based on file type
                const isCSV = file.name.toLowerCase().endsWith('.csv');
                if (isCSV) {
                    console.log('[FILE_READ] Reading as text (CSV)');
                    reader.readAsText(file, 'UTF-8');
                } else {
                    console.log('[FILE_READ] Reading as array buffer (Excel)');
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        // Atualiza design da área de upload após sucesso
        function updateUploadAreaAfterSuccess(fileName, leadCount) {
            const uploadArea = document.getElementById('msgUploadArea');
            uploadArea.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="flex-shrink: 0;">
                        <div style="width: 50px; height: 50px; background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <span style="font-size: 1.5rem;">✅</span>
                        </div>
                    </div>
                    <div style="flex-grow: 1; text-align: left;">
                        <div style="font-weight: 600; color: #ffffff; margin-bottom: 0.25rem;">${fileName}</div>
                        <div style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.7);">${leadCount} leads encontrados</div>
                    </div>
                    <div style="flex-shrink: 0;">
                        <button onclick="trocarArquivoMsg()" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.8); padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.75rem;">
                            Trocar arquivo
                        </button>
                    </div>
                </div>
            `;
            uploadArea.style.border = '2px solid rgba(34, 197, 94, 0.3)';
            uploadArea.style.background = 'rgba(34, 197, 94, 0.05)';
            uploadArea.style.cursor = 'default';
        }

        // Função simples para trocar arquivo
        function trocarArquivoMsg() {
            const uploadArea = document.getElementById('msgUploadArea');
            const fileInput = document.getElementById('msgFileInput');

            uploadArea.innerHTML = `
                <div class="upload-icon">📎</div>
                <p>Arraste sua planilha aqui ou clique para selecionar</p>
                <span class="upload-formats">Formatos aceitos: .xlsx, .xls, .csv</span>
            `;
            uploadArea.style.border = '2px dashed rgba(165, 148, 255, 0.3)';
            uploadArea.style.background = 'rgba(255, 255, 255, 0.03)';
            uploadArea.style.cursor = 'pointer';

            // Clear data
            window.msgUploadedData = null;
            fileInput.value = '';
            document.getElementById('msgColumnMapping').style.display = 'none';

            // Clear preview
            const preview = document.getElementById('msgLeadsPreview');
            const totalElement = document.getElementById('msgTotalLeads');
            if (preview) preview.innerHTML = 'Nenhum lead encontrado';
            if (totalElement) totalElement.textContent = '0';

            // Re-add event listener APENAS uma vez
            uploadArea.onclick = function() {
                fileInput.click();
            };
        }

        // === SISTEMA DE UPLOAD DE MENSAGEM RECONSTRUÍDO ===

        // Usar a variável global que já existe (não redeclarar)
        // msgProcessedLeads já foi declarada acima

        // Popula as opções dos seletores de coluna
        function populateMsgColumnSelectors() {
            console.log('📋 === POPULANDO SELETORES SEGUROS ===');

            try {
                const nameSelect = document.getElementById('msgNameColumn');
                const phoneSelect = document.getElementById('msgPhoneColumn');

                if (!nameSelect || !phoneSelect) {
                    console.error('❌ Elementos select não encontrados');
                    return;
                }

                if (!window.msgUploadedData || !window.msgUploadedData.headers) {
                    console.error('❌ Dados ou headers não encontrados');
                    return;
                }

                console.log('📋 Headers disponíveis:', window.msgUploadedData.headers);

                // Remove event listeners antigos para evitar duplicação
                nameSelect.onchange = null;
                phoneSelect.onchange = null;

                // Limpa e popula as opções com PROTEÇÃO
                nameSelect.innerHTML = '<option value="">Selecionar...</option>';
                phoneSelect.innerHTML = '<option value="">Selecionar...</option>';

                window.msgUploadedData.headers.forEach((header, index) => {
                    const headerStr = String(header || '').trim();
                    if (headerStr) {
                        nameSelect.innerHTML += '<option value="' + index + '">' + headerStr + '</option>';
                        phoneSelect.innerHTML += '<option value="' + index + '">' + headerStr + '</option>';
                    }
                });

                console.log('📋 Opções adicionadas - Nome:', nameSelect.options.length, 'Telefone:', phoneSelect.options.length);

                // Adiciona listeners com MÁXIMA PROTEÇÃO
                console.log('📋 Adicionando event listeners ultra-seguros...');

                nameSelect.addEventListener('change', function(event) {
                    console.log('📋 🔥 MUDANÇA DE NOME DETECTADA:', this.value);
                    event.preventDefault();

                    // Proteção dupla contra erros
                    setTimeout(() => {
                        try {
                            if (document.getElementById('msgNameColumn') === this) {
                                console.log('📋 ✅ Elemento ainda válido, processando...');
                                processSelectedColumns();
                            } else {
                                console.log('📋 ⚠️ Elemento mudou, ignorando...');
                            }
                        } catch (error) {
                            console.error('❌ ERRO CAPTURADO na mudança de nome:', error);
                            try {
                                safeUpdateDisplay(window.msgUploadedData?.rows?.length || 0);
                            } catch (e2) {
                                console.error('❌ Erro duplo:', e2);
                            }
                        }
                    }, 150);
                });

                phoneSelect.addEventListener('change', function(event) {
                    console.log('📋 🔥 MUDANÇA DE TELEFONE DETECTADA:', this.value);
                    event.preventDefault();

                    // Proteção dupla contra erros
                    setTimeout(() => {
                        try {
                            if (document.getElementById('msgPhoneColumn') === this) {
                                console.log('📋 ✅ Elemento ainda válido, processando...');
                                processSelectedColumns();
                            } else {
                                console.log('📋 ⚠️ Elemento mudou, ignorando...');
                            }
                        } catch (error) {
                            console.error('❌ ERRO CAPTURADO na mudança de telefone:', error);
                            try {
                                safeUpdateDisplay(window.msgUploadedData?.rows?.length || 0);
                            } catch (e2) {
                                console.error('❌ Erro duplo:', e2);
                            }
                        }
                    }, 150);
                });

                console.log('📋 ✅ Event listeners adicionados com sucesso');

                // Tenta auto-selecionar com proteção
                setTimeout(() => {
                    try {
                        autoSelectColumns();
                    } catch (error) {
                        console.error('❌ Erro na auto-seleção:', error);
                    }
                }, 200);

            } catch (error) {
                console.error('❌ ERRO FATAL ao popular seletores:', error);
                try {
                    safeUpdateDisplay(0);
                } catch (e2) {
                    console.error('❌ Erro duplo fatal:', e2);
                }
            }
        }

        // Auto-seleciona colunas baseado em nomes comuns
        function autoSelectColumns() {
            console.log('🎯 Auto-selecionando colunas...');

            const nameSelect = document.getElementById('msgNameColumn');
            const phoneSelect = document.getElementById('msgPhoneColumn');

            window.msgUploadedData.headers.forEach((header, index) => {
                const lowerHeader = header.toLowerCase();

                // Auto-seleciona nome
                if (!nameSelect.value && (lowerHeader.includes('nome') || lowerHeader.includes('name'))) {
                    nameSelect.value = index;
                    console.log('✅ Auto-selecionado nome:', header);
                }

                // Auto-seleciona telefone
                if (!phoneSelect.value && (lowerHeader.includes('telefone') || lowerHeader.includes('phone'))) {
                    phoneSelect.value = index;
                    console.log('✅ Auto-selecionado telefone:', header);
                }
            });

            // Força contagem independente da seleção
            console.log('🔢 FORÇANDO CONTAGEM SEMPRE...');
            setTimeout(() => {
                forceCountLeads();
                if (nameSelect.value && phoneSelect.value) {
                    console.log('🎯 Colunas selecionadas - processando detalhado...');
                    processSelectedColumns();
                }
            }, 200);
        }

        // VERSÃO ULTRA SEGURA - Processa as colunas selecionadas
        function processSelectedColumns() {
            console.log('🔄 === PROCESSAMENTO ULTRA SEGURO INICIADO ===');
            console.log('🔄 Estado atual do window.msgUploadedData:', !!window.msgUploadedData);

            try {
                // Verificações básicas de segurança com logging detalhado
                if (!window.msgUploadedData) {
                    console.log('❌ window.msgUploadedData não existe');
                    safeUpdateDisplay(0);
                    return;
                }

                console.log('🔍 Dados encontrados:', {
                    hasRows: !!window.msgUploadedData.rows,
                    rowsIsArray: Array.isArray(window.msgUploadedData.rows),
                    rowsLength: window.msgUploadedData.rows?.length,
                    hasHeaders: !!window.msgUploadedData.headers,
                    headersIsArray: Array.isArray(window.msgUploadedData.headers),
                    headersLength: window.msgUploadedData.headers?.length
                });

                if (!window.msgUploadedData.rows || !Array.isArray(window.msgUploadedData.rows)) {
                    console.log('❌ Linhas inválidas ou não são array');
                    safeUpdateDisplay(0);
                    return;
                }

                if (!window.msgUploadedData.headers || !Array.isArray(window.msgUploadedData.headers)) {
                    console.log('❌ Headers inválidos ou não são array');
                    safeUpdateDisplay(0);
                    return;
                }

                if (window.msgUploadedData.rows.length === 0) {
                    console.log('⚠️ Nenhuma linha de dados encontrada');
                    safeUpdateDisplay(0);
                    return;
                }

                // Busca elementos DOM com logging detalhado
                console.log('🔍 Buscando elementos DOM...');
                const nameSelect = document.getElementById('msgNameColumn');
                const phoneSelect = document.getElementById('msgPhoneColumn');

                console.log('🔍 Elementos encontrados:', {
                    nameSelect: !!nameSelect,
                    phoneSelect: !!phoneSelect,
                    nameSelectValue: nameSelect?.value,
                    phoneSelectValue: phoneSelect?.value
                });

                if (!nameSelect || !phoneSelect) {
                    console.log('❌ Elementos de seleção não encontrados');
                    safeUpdateDisplay(0);
                    return;
                }

                // Verifica se valores foram selecionados com proteção contra null/undefined
                const nameValue = String(nameSelect.value || '').trim();
                const phoneValue = String(phoneSelect.value || '').trim();

                console.log('📋 Valores selecionados (limpos):', { nameValue, phoneValue });

                if (!nameValue || !phoneValue || nameValue === "" || phoneValue === "") {
                    console.log('⚠️ Colunas não selecionadas - mostrando total de linhas:', window.msgUploadedData.rows.length);
                    safeUpdateDisplay(window.msgUploadedData.rows.length);
                    return;
                }

                // Parse com verificação dupla
                const nameIndex = parseInt(nameValue, 10);
                const phoneIndex = parseInt(phoneValue, 10);

                console.log('📊 Índices parseados:', { nameIndex, phoneIndex });

                // Verifica se índices são válidos com mais detalhes
                if (isNaN(nameIndex) || isNaN(phoneIndex)) {
                    console.log('❌ Índices não são números válidos:', { nameIndex, phoneIndex });
                    safeUpdateDisplay(0);
                    return;
                }

                const headersLength = window.msgUploadedData.headers.length;

                if (nameIndex < 0 || phoneIndex < 0 || nameIndex >= headersLength || phoneIndex >= headersLength) {
                    console.log('❌ Índices fora do range:', {
                        nameIndex, phoneIndex, headersLength,
                        nameValid: nameIndex >= 0 && nameIndex < headersLength,
                        phoneValid: phoneIndex >= 0 && phoneIndex < headersLength
                    });
                    safeUpdateDisplay(0);
                    return;
                }

                // Headers seguros com verificação
                const nameHeader = window.msgUploadedData.headers[nameIndex];
                const phoneHeader = window.msgUploadedData.headers[phoneIndex];

                console.log('📊 Headers selecionados:', {
                    nameIndex, nameHeader,
                    phoneIndex, phoneHeader,
                    allHeaders: window.msgUploadedData.headers
                });

                // Processa leads com máxima segurança e logs detalhados
                const validLeads = [];
                let processedCount = 0;
                let validCount = 0;
                let errorCount = 0;

                console.log('🔄 === INICIANDO PROCESSAMENTO DETALHADO ===');
                console.log('🔄 Total de linhas na planilha:', window.msgUploadedData.rows.length);
                console.log('🔄 Headers disponíveis:', window.msgUploadedData.headers);
                console.log('🔄 Colunas selecionadas - Nome:', nameHeader, '(índice:', nameIndex, '), Telefone:', phoneHeader, '(índice:', phoneIndex, ')');

                window.msgUploadedData.rows.forEach((row, index) => {
                    try {
                        processedCount++;

                        if (!row || (typeof row !== 'object' && !Array.isArray(row))) {
                            console.log(`⚠️ Row ${index + 1}: dados inválidos (tipo: ${typeof row})`);
                            errorCount++;
                            return;
                        }

                        // Extrai valores com múltiplas tentativas e logs
                        let name, phone;

                        // Método 1: acesso direto por header (mais comum)
                        try {
                            name = row[nameHeader];
                            phone = row[phoneHeader];
                            if (name && phone) {
                                console.log(`✅ Row ${index + 1}: Método 1 funcionou - ${name} / ${phone}`);
                            }
                        } catch (e) {
                            console.log(`⚠️ Row ${index + 1}: Erro no método 1:`, e.message);
                        }

                        // Método 2: se não funcionou e row é array
                        if ((!name || !phone) && Array.isArray(row)) {
                            try {
                                name = name || row[nameIndex];
                                phone = phone || row[phoneIndex];
                                if (name && phone) {
                                    console.log(`✅ Row ${index + 1}: Método 2 funcionou - ${name} / ${phone}`);
                                }
                            } catch (e) {
                                console.log(`⚠️ Row ${index + 1}: Erro no método 2:`, e.message);
                            }
                        }

                        // Método 3: Object.values como último recurso
                        if (!name || !phone) {
                            try {
                                const values = Object.values(row);
                                if (values.length > Math.max(nameIndex, phoneIndex)) {
                                    name = name || values[nameIndex];
                                    phone = phone || values[phoneIndex];
                                    if (name && phone) {
                                        console.log(`✅ Row ${index + 1}: Método 3 funcionou - ${name} / ${phone}`);
                                    }
                                }
                            } catch (e) {
                                console.log(`⚠️ Row ${index + 1}: Erro no método 3:`, e.message);
                            }
                        }

                        // Validação e limpeza final
                        if (name && phone) {
                            try {
                                const nameStr = String(name).trim();
                                const phoneStr = String(phone).replace(/[^\d]/g, '');

                                if (nameStr.length > 0 && phoneStr.length >= 8 && phoneStr.length <= 15) {
                                    validLeads.push({
                                        name: nameStr,
                                        phone: phoneStr
                                    });
                                    validCount++;
                                    if (validCount <= 5 || validCount % 50 === 0) { // Log apenas primeiros 5 e múltiplos de 50
                                        console.log(`✅ Lead válido ${validCount}: ${nameStr} - ${phoneStr}`);
                                    }
                                } else {
                                    console.log(`⚠️ Row ${index + 1} REJEITADO: nome: "${nameStr}" (len:${nameStr.length}), telefone: "${phoneStr}" (len:${phoneStr.length}) - MOTIVO: ${nameStr.length === 0 ? 'nome vazio' : phoneStr.length < 8 ? 'telefone muito curto' : 'telefone muito longo'}`);
                                    errorCount++;
                                }
                            } catch (e) {
                                console.log(`❌ Row ${index + 1}: Erro na validação final:`, e.message);
                                errorCount++;
                            }
                        } else {
                            console.log(`⚠️ Row ${index + 1}: Nome ou telefone vazio - nome: "${name}", telefone: "${phone}"`);
                            errorCount++;
                        }

                    } catch (rowError) {
                        console.error(`❌ Erro ao processar row ${index + 1}:`, rowError);
                        errorCount++;
                    }
                });

                console.log('📊 === RESULTADO FINAL ===');
                console.log('📊 Total processado:', processedCount);
                console.log('📊 Leads válidos:', validCount);
                console.log('📊 Erros/inválidos:', errorCount);
                console.log('📊 Taxa de sucesso:', ((validCount / processedCount) * 100).toFixed(1) + '%');

                // Atualiza AMBAS as variáveis para manter sincronização
                window.msgProcessedLeads = validLeads;
                msgProcessedLeads = validLeads; // Sincroniza variável local também
                console.log('📊 Variáveis atualizadas - Global:', window.msgProcessedLeads.length, 'Local:', msgProcessedLeads.length);

                // Atualiza display
                safeUpdateDisplay(validLeads.length, validLeads);

            } catch (error) {
                console.error('❌ === ERRO FATAL DURANTE PROCESSAMENTO ===');
                console.error('❌ Tipo:', error.constructor.name);
                console.error('❌ Mensagem:', error.message);
                console.error('❌ Stack:', error.stack);

                try {
                    safeUpdateDisplay(0);
                } catch (displayError) {
                    console.error('❌ Erro duplo ao atualizar display:', displayError);
                    // Último recurso - atualizar elementos diretamente
                    try {
                        const totalEl = document.getElementById('msgTotalLeads');
                        const previewEl = document.getElementById('msgLeadsPreview');
                        if (totalEl) totalEl.textContent = '0';
                        if (previewEl) previewEl.innerHTML = '<div style="color: #EF4444;">❌ Erro no processamento</div>';
                    } catch (e) {
                        console.error('❌ Erro triplo:', e);
                    }
                }
            }
        }

        // Função super segura para atualizar display
        function safeUpdateDisplay(count, leads = []) {
            console.log('🛡️ === SAFE UPDATE INICIADO ===');
            console.log('🛡️ Count:', count, '| Leads array length:', leads?.length);

            try {
                // Sanitização dos parâmetros
                const safeCount = Math.max(0, parseInt(count) || 0);
                const safeLeads = Array.isArray(leads) ? leads : [];

                console.log('🛡️ Valores sanitizados - Count:', safeCount, '| Leads:', safeLeads.length);

                // Atualiza total com múltiplas verificações
                const totalEl = document.getElementById('msgTotalLeads');
                console.log('🛡️ Elemento total encontrado:', !!totalEl);

                if (totalEl) {
                    try {
                        totalEl.textContent = String(safeCount);
                        totalEl.style.color = safeCount > 0 ? '#22C55E' : '#ffffff';
                        totalEl.style.fontWeight = 'bold';
                        console.log('🛡️ ✅ Total atualizado:', totalEl.textContent);
                    } catch (totalError) {
                        console.error('❌ Erro ao atualizar total:', totalError);
                        totalEl.textContent = String(safeCount);
                    }
                } else {
                    console.error('❌ Elemento msgTotalLeads não encontrado');
                }

                // Atualiza preview com máxima proteção
                const previewEl = document.getElementById('msgLeadsPreview');
                console.log('🛡️ Elemento preview encontrado:', !!previewEl);

                if (previewEl) {
                    try {
                        let html = '';

                        if (safeCount === 0) {
                            html = '<div style="color: #EF4444; text-align: center; padding: 20px; border-radius: 8px; background: rgba(239, 68, 68, 0.1);">';
                            html += '❌ Nenhum lead válido encontrado';
                            html += '</div>';
                        } else {
                            // Header de sucesso
                            html = '<div style="color: #22C55E; text-align: center; font-weight: bold; margin-bottom: 15px; padding: 10px; border-radius: 8px; background: rgba(34, 197, 94, 0.1);">';
                            html += '✅ ' + safeCount + ' LEADS ENCONTRADOS!';
                            html += '</div>';

                            // Mostra primeiros leads como exemplo
                            if (safeLeads && safeLeads.length > 0) {
                                const showLeads = safeLeads.slice(0, 3);
                                console.log('🛡️ Mostrando', showLeads.length, 'leads de exemplo');

                                showLeads.forEach((lead, index) => {
                                    try {
                                        if (lead && typeof lead === 'object' && lead.name && lead.phone) {
                                            const safeName = String(lead.name).trim() || 'Nome indisponível';
                                            const safePhone = String(lead.phone).trim() || 'Telefone indisponível';

                                            html += '<div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(34, 197, 94, 0.05); margin: 6px 0; border-radius: 6px; border-left: 3px solid #22C55E;">';
                                            html += '<span style="font-weight: 500;">' + safeName + '</span>';
                                            html += '<span style="color: rgba(255, 255, 255, 0.8); font-family: monospace;">' + safePhone + '</span>';
                                            html += '</div>';
                                        } else {
                                            console.log('⚠️ Lead inválido no índice', index, ':', lead);
                                        }
                                    } catch (leadError) {
                                        console.error('❌ Erro ao processar lead', index, ':', leadError);
                                    }
                                });

                                // Indica se há mais leads
                                if (safeCount > 3) {
                                    const remaining = safeCount - 3;
                                    html += '<div style="text-align: center; color: rgba(255, 255, 255, 0.6); margin-top: 15px; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">';
                                    html += '... e mais ' + remaining + ' leads';
                                    html += '</div>';
                                }
                            } else {
                                console.log('⚠️ Array de leads vazio mas count > 0');
                                html += '<div style="text-align: center; color: rgba(255, 255, 255, 0.7); padding: 10px;">';
                                html += 'Leads processados mas preview indisponível';
                                html += '</div>';
                            }
                        }

                        previewEl.innerHTML = html;
                        console.log('🛡️ ✅ Preview atualizado com sucesso');

                    } catch (previewError) {
                        console.error('❌ Erro ao atualizar preview:', previewError);
                        try {
                            previewEl.innerHTML = '<div style="color: #EF4444; text-align: center; padding: 20px;">❌ Erro na exibição dos dados</div>';
                        } catch (fallbackError) {
                            console.error('❌ Erro no fallback do preview:', fallbackError);
                        }
                    }
                } else {
                    console.error('❌ Elemento msgLeadsPreview não encontrado');
                }

                // Verifica se algum elemento crítico não foi encontrado
                if (!totalEl && !previewEl) {
                    console.error('❌ NENHUM elemento de display encontrado - possível problema estrutural');
                } else {
                    console.log('🛡️ ✅ Display atualizado com sucesso');
                }

            } catch (error) {
                console.error('❌ === ERRO FATAL no safeUpdateDisplay ===');
                console.error('❌ Tipo:', error.constructor.name);
                console.error('❌ Mensagem:', error.message);
                console.error('❌ Stack:', error.stack);

                // Último recurso - tentativas de emergência
                try {
                    const totalEl = document.getElementById('msgTotalLeads');
                    const previewEl = document.getElementById('msgLeadsPreview');

                    if (totalEl) {
                        totalEl.textContent = '0';
                        totalEl.style.color = '#EF4444';
                    }

                    if (previewEl) {
                        previewEl.innerHTML = '<div style="color: #EF4444; text-align: center; padding: 20px;">❌ Erro crítico na exibição</div>';
                    }

                    console.log('🛡️ ⚠️ Recuperação de emergência executada');

                } catch (emergencyError) {
                    console.error('❌ Falha na recuperação de emergência:', emergencyError);
                }
            }
        }

        // FORÇA A CONTAGEM DIRETA DOS LEADS - VERSÃO QUE FUNCIONA
        function updateLeadDisplay(count, leads) {
            console.log('🚀 FORÇANDO CONTAGEM:', count);

            // FORÇA o total a ser exibido
            const totalElement = document.getElementById('msgTotalLeads');
            if (totalElement) {
                totalElement.innerHTML = '<strong style="color: #22C55E; font-size: 1.1em;">' + count + '</strong>';
                console.log('✅ TOTAL FORÇADO:', count);
            } else {
                console.error('❌ ELEMENTO msgTotalLeads NÃO ENCONTRADO!');
            }

            // FORÇA o preview a ser exibido
            const previewElement = document.getElementById('msgLeadsPreview');
            if (previewElement) {
                if (count === 0) {
                    previewElement.innerHTML = '<div style="color: #EF4444; text-align: center; padding: 20px; border: 1px solid #EF4444; border-radius: 8px;">❌ Nenhum lead encontrado</div>';
                } else {
                    let html = '<div style="color: #22C55E; font-weight: bold; margin-bottom: 15px; text-align: center; padding: 10px; background: rgba(34, 197, 94, 0.1); border-radius: 8px;">🎉 ' + count + ' LEADS ENCONTRADOS!</div>';

                    // Mostra os primeiros leads
                    if (leads && leads.length > 0) {
                        const showLeads = leads.slice(0, 5);
                        showLeads.forEach((lead, i) => {
                            html += '<div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(165, 148, 255, 0.1); border: 1px solid rgba(165, 148, 255, 0.3); border-radius: 6px; margin: 8px 0;">';
                            html += '<span style="color: #ffffff; font-weight: 500;">' + (lead.name || 'Nome ' + (i + 1)) + '</span>';
                            html += '<span style="color: #A594FF; font-family: monospace;">' + (lead.phone || 'Telefone ' + (i + 1)) + '</span>';
                            html += '</div>';
                        });

                        if (count > 5) {
                            html += '<div style="color: rgba(255,255,255,0.7); text-align: center; margin-top: 15px; padding: 10px; border: 1px dashed rgba(255,255,255,0.3); border-radius: 6px;">📋 + mais ' + (count - 5) + ' leads na planilha...</div>';
                        }
                    } else {
                        // Se não tem leads detalhados, mostra só a contagem
                        html += '<div style="color: rgba(255,255,255,0.8); text-align: center; padding: 15px;">📊 ' + count + ' linhas de dados detectadas na planilha</div>';
                    }

                    previewElement.innerHTML = html;
                }
                console.log('✅ PREVIEW FORÇADO ATUALIZADO');
            } else {
                console.error('❌ ELEMENTO msgLeadsPreview NÃO ENCONTRADO!');
            }
        }

        // FUNÇÃO SIMPLES PARA CONTAR LEADS DIRETAMENTE
        function forceCountLeads() {
            console.log('🔢 FORÇANDO CONTAGEM DE LEADS...');

            if (!window.msgUploadedData || !window.msgUploadedData.rows) {
                console.log('❌ Sem dados para contar');
                updateLeadDisplay(0, []);
                return 0;
            }

            const totalRows = window.msgUploadedData.rows.length;
            console.log('📊 TOTAL DE LINHAS:', totalRows);

            // Força mostrar pelo menos o número de linhas
            updateLeadDisplay(totalRows, []);
            return totalRows;
        }

        // Funções de compatibilidade (mantidas para não quebrar outras partes)
        function autoSelectColumnsAndProcess() {
            autoSelectColumns();
        }

        function updateMsgLeadCount() {
            // Esta função agora é substituída por updateLeadDisplay
        }

        function showMsgColumnMapping() {
            const columnMapping = document.getElementById('msgColumnMapping');
            if (columnMapping) {
                columnMapping.style.display = 'block';
            }
        }

        // Função principal de processamento (compatibilidade)
        function processMsgLeads() {
            processSelectedColumns();
        }

        // Função de preview (compatibilidade)
        function updateMsgLeadsPreview(leads) {
            updateLeadDisplay(leads.length, leads);
        }

        // Calculate messaging capacity
        function calculateMessagingCapacity() {
            const totalLeads = msgProcessedLeads.length;
            const interval = document.querySelector('input[name="interval"]:checked')?.value || '2-4';

            // Get the maximum interval (worst case) for guarantees
            const [minInterval, maxInterval] = interval.split('-').map(Number);

            // Calculations based on MAXIMUM interval (guaranteed worst case)
            const enviosPorHora = Math.floor(60 / maxInterval);

            // Working hours per day: 8am to 6pm = 10 hours
            const horasPorDia = 10;
            const enviosPorDia = enviosPorHora * horasPorDia;

            // Total time to send all leads
            const diasNecessarios = Math.ceil(totalLeads / enviosPorDia);

            // Update UI
            document.getElementById('msgEnviosPorHora').textContent = `~${enviosPorHora}`;
            document.getElementById('msgEnviosPorDia').textContent = `~${enviosPorDia}`;

            if (diasNecessarios <= 1) {
                const horasNecessarias = Math.ceil(totalLeads / enviosPorHora);
                document.getElementById('msgTempoTotal').textContent = `~${horasNecessarias}h`;
            } else {
                document.getElementById('msgTempoTotal').textContent = `~${diasNecessarios} dias`;
            }

            // Explanatory note
            const note = document.getElementById('msgCapacityNote');
            if (totalLeads > enviosPorDia) {
                note.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; margin-right: 6px; vertical-align: middle;"><path d="M12 9v2m0 4h.01M12 1a11 11 0 1 0 0 22 11 11 0 0 0 0-22z"/></svg> Sua lista tem ${totalLeads} leads. Com o ritmo selecionado, levará aproximadamente ${diasNecessarios} dias úteis para concluir.`;
                note.classList.add('warning');
            } else {
                note.innerHTML = `✅ Sua lista de ${totalLeads} leads será enviada em aproximadamente ${Math.ceil(totalLeads / enviosPorHora)} horas.`;
                note.classList.remove('warning');
            }
        }

        // Create messaging campaign
        async function createMessagingCampaign() {
            console.log('[MSG_CAMPAIGN] Starting campaign creation...');
            console.log('[MSG_CAMPAIGN] Current step:', currentMsgStep);
            console.log('[MSG_CAMPAIGN] Processed leads:', msgProcessedLeads?.length || 0);

            if (!validateCurrentMsgStep()) {
                console.log('[MSG_CAMPAIGN] Validation failed');
                return;
            }

            const tenantId = localStorage.getItem('tenant_id');
            console.log('[MSG_CAMPAIGN] Tenant ID:', tenantId);

            if (!tenantId) {
                showAlert({
                    iconType: 'error',
                    title: 'Erro de Autenticação',
                    message: 'Sessão expirada. Por favor, faça login novamente.'
                });
                return;
            }
            const campaignId = `msg_camp_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;

            // Collect form data
            const campaignName = document.getElementById('msgCampaignName').value.trim();
            const instanceSelect = document.getElementById('msgInstanceSelect');
            const instanceName = instanceSelect.value;
            const instanceId = instanceSelect.selectedOptions[0]?.dataset.instanceId || null;
            const interval = document.querySelector('input[name="interval"]:checked').value;
            const [intervalMin, intervalMax] = interval.split('-').map(Number);
            const messageTemplate = document.getElementById('msgTemplate').value.trim();
            const startDate = document.getElementById('msgStartDate').value;
            const startTime = document.getElementById('msgStartTime').value;

            // Build start date
            const scheduledStartAt = new Date(`${startDate}T${startTime}:00`).toISOString();

            // Collect processed leads
            const leads = msgProcessedLeads || [];
            console.log('[MSG_CAMPAIGN] Leads to send:', leads);

            // Final validation
            if (!campaignName) {
                showAlert({
                    iconType: 'error',
                    title: 'Campo Obrigatório',
                    message: 'Por favor, digite o nome da campanha.'
                });
                return;
            }

            if (!instanceName) {
                showAlert({
                    iconType: 'error',
                    title: 'Campo Obrigatório',
                    message: 'Por favor, selecione uma instância WhatsApp.'
                });
                return;
            }

            if (!messageTemplate) {
                showAlert({
                    iconType: 'error',
                    title: 'Campo Obrigatório',
                    message: 'Por favor, digite a mensagem que será enviada.'
                });
                return;
            }

            if (leads.length === 0) {
                showAlert({
                    iconType: 'error',
                    title: 'Lista Vazia',
                    message: 'Por favor, faça upload da planilha com a lista de leads.'
                });
                return;
            }

            // Validate leads have required fields
            const invalidLeads = leads.filter(lead => !lead.name || !lead.phone);
            if (invalidLeads.length > 0) {
                showAlert({
                    iconType: 'error',
                    title: 'Dados Inválidos',
                    message: `${invalidLeads.length} leads têm dados inválidos. Verifique a planilha.`
                });
                return;
            }

            // Payload for webhook
            const payload = {
                tenant_id: tenantId,
                campaign_id: campaignId,
                campaign_name: campaignName,
                instance_name: instanceName,
                instance_id: instanceId,
                interval_min: intervalMin,
                interval_max: intervalMax,
                message_template: messageTemplate,
                scheduled_start_at: scheduledStartAt,
                total_leads: leads.length,
                leads: leads  // Array of {name, phone}
            };

            try {
                showLoading('Criando campanha...');

                console.log('[MSG_CAMPAIGN] Sending payload:', payload);

                const response = await fetch('https://sdr.salesdever.io/webhook/cria-campanha-mensagem', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('[MSG_CAMPAIGN] Response status:', response.status);

                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    console.log('[MSG_CAMPAIGN] Response data:', result);

                    hideLoading();
                    await showAlert({
                        iconType: 'success',
                        title: 'Campanha Criada!',
                        message: `Sua campanha "${campaignName}" foi criada com sucesso e começará em ${startDate} às ${startTime}.`
                    });

                    closeMessagingCampaignModal();
                    loadCampaigns(); // Reload campaigns list
                } else {
                    const errorText = await response.text().catch(() => '');
                    console.error('[MSG_CAMPAIGN] Response error:', errorText);
                    throw new Error(`Erro ${response.status}: ${errorText || 'Erro desconhecido'}`);
                }
            } catch (error) {
                hideLoading();
                console.error('[MSG_CAMPAIGN] Error:', error);
                showAlert({
                    iconType: 'error',
                    title: 'Erro ao Criar Campanha',
                    message: error.message || 'Não foi possível criar a campanha. Tente novamente.'
                });
            }
        }

        // Ensure XLSX library is loaded
        function ensureXLSXLoaded() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) {
                    resolve(window.XLSX);
                    return;
                }

                console.log('[MSG_CAMPAIGN] Loading XLSX library...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';

                script.onload = () => {
                    console.log('[MSG_CAMPAIGN] XLSX library loaded successfully');
                    resolve(window.XLSX);
                };

                script.onerror = () => {
                    console.error('[MSG_CAMPAIGN] Failed to load XLSX library');
                    reject(new Error('Falha ao carregar biblioteca de planilhas'));
                };

                document.head.appendChild(script);
            });
        }

        // Load XLSX library on page load
        if (!window.XLSX) {
            ensureXLSXLoaded().catch(console.error);
        }

        // Test function to add sample leads (for debugging)
        function addSampleLeads() {
            console.log('[SAMPLE] Adding sample leads for testing...');

            // Create sample data in the format expected (like processMsgCSV creates)
            window.msgUploadedData = {
                headers: ['Nome', 'Telefone'],
                rows: [
                    { 'Nome': 'João Silva', 'Telefone': '11999887766' },
                    { 'Nome': 'Maria Santos', 'Telefone': '(11) 9 8888-7777' },
                    { 'Nome': 'Pedro Costa', 'Telefone': '11987654321' }
                ]
            };

            populateMsgColumnSelectors();
            showMsgColumnMapping();
            console.log('[SAMPLE] Sample leads added');
        }

        // Test function that simulates a complete file upload
        function testUploadWithSampleData() {
            console.log('[TEST] Testing upload with sample data...');

            // Create sample data in the format expected (like processMsgCSV creates)
            window.msgUploadedData = {
                headers: ['Nome', 'Telefone', 'Email'],
                rows: [
                    { 'Nome': 'João Silva', 'Telefone': '11999887766', 'Email': 'joao@email.com' },
                    { 'Nome': 'Maria Santos', 'Telefone': '(11) 98888-7777', 'Email': 'maria@email.com' },
                    { 'Nome': 'Pedro Costa', 'Telefone': '11987654321', 'Email': 'pedro@email.com' },
                    { 'Nome': 'Ana Lima', 'Telefone': '(11) 9 5555-4444', 'Email': 'ana@email.com' },
                    { 'Nome': 'Carlos Rocha', 'Telefone': '11977776666', 'Email': 'carlos@email.com' }
                ]
            };

            console.log('[TEST] Processing test data with', window.msgUploadedData.rows.length, 'leads');

            // Call the column populate and mapping functions
            populateMsgColumnSelectors();
            showMsgColumnMapping();
        }

        // Force file selector function
        function forceOpenFileSelector() {
            console.log('🔥 FORÇANDO ABERTURA DO SELETOR DE ARQUIVO');

            const fileInput = document.getElementById('msgFileInput');
            console.log('📁 File input element:', fileInput);

            if (fileInput) {
                fileInput.click();
                console.log('✅ Click forçado no input');
            } else {
                console.error('❌ Elemento msgFileInput não encontrado');
            }
        }

        // Debug upload area click
        function debugUploadClick() {
            console.log('🔍 DEBUGANDO CLIQUE NA ÁREA DE UPLOAD');

            const uploadArea = document.getElementById('msgUploadArea');
            console.log('📦 Upload area element:', uploadArea);

            if (uploadArea) {
                console.log('✅ Upload area encontrada');
                forceOpenFileSelector();
            } else {
                console.error('❌ Upload area não encontrada');
            }
        }

        // Messaging Schedule Functions
        let selectedMsgHour = 12; // Default to 12h00
        let msgScheduleDuration = 1; // Default duration in hours
        let selectedMsgDate = null; // Selected date for campaign

        function initializeMsgSchedule() {
            console.log('[MSG_SCHEDULE] Initializing schedule...');

            // Initialize date to tomorrow by default
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            selectedMsgDate = tomorrow.toISOString().split('T')[0];

            const dateInput = document.getElementById('msgScheduleDate');
            if (dateInput) {
                dateInput.value = selectedMsgDate;
                dateInput.min = new Date().toISOString().split('T')[0]; // Cannot select past dates
            }

            // Setup time slot click handlers
            const timeSlots = document.querySelectorAll('.time-slot');
            timeSlots.forEach(slot => {
                slot.addEventListener('click', function() {
                    const hour = parseInt(this.dataset.hour);
                    if (!this.classList.contains('disabled')) {
                        selectMsgTimeSlot(hour);
                    }
                });
            });

            // Setup interval change listeners
            const intervalRadios = document.querySelectorAll('input[name="interval"]');
            intervalRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    console.log('[MSG_SCHEDULE] Interval changed to:', this.value);
                    setTimeout(updateMsgScheduleDisplay, 100);
                });
            });

            // Update time slots based on selected date
            updateTimeSlotAvailability();

            // Calculate initial values
            updateMsgScheduleDisplay();
            console.log('[MSG_SCHEDULE] Schedule initialized');
        }

        function selectMsgTimeSlot(hour) {
            console.log('[MSG_SCHEDULE] Selected hour:', hour);

            // Remove previous selection
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });

            // Select new slot
            const selectedSlot = document.querySelector(`[data-hour="${hour}"]`);
            if (selectedSlot) {
                selectedSlot.classList.add('selected');
                selectedMsgHour = hour;

                // Update hidden inputs for compatibility
                document.getElementById('msgStartDate').value = selectedMsgDate || new Date().toISOString().split('T')[0];
                document.getElementById('msgStartTime').value = hour.toString().padStart(2, '0') + ':00';

                updateMsgScheduleDisplay();
            }
        }

        function updateMsgScheduleDisplay() {
            const totalLeads = window.msgProcessedLeads?.length || 128;
            const intervalValue = document.querySelector('input[name="interval"]:checked')?.value || '2-4';

            // Parse interval
            const [minInterval, maxInterval] = intervalValue.split('-').map(Number);
            const avgInterval = (minInterval + maxInterval) / 2; // Average interval in minutes

            // Calculate timing
            const messagesPerHour = Math.floor(60 / avgInterval); // Messages per hour
            const hoursNeeded = Math.ceil(totalLeads / messagesPerHour); // Total hours needed
            const endHour = selectedMsgHour + hoursNeeded;

            console.log('[MSG_SCHEDULE] Calculation:', {
                totalLeads,
                intervalValue,
                avgInterval,
                messagesPerHour,
                hoursNeeded,
                selectedMsgHour,
                endHour
            });

            // Update duration display
            msgScheduleDuration = hoursNeeded;

            // Update all display elements
            const durationEl = document.getElementById('msgDuration');
            const totalMessagesEl = document.getElementById('msgTotalMessages');
            const scheduleTimeEl = document.getElementById('msgScheduleTime');
            const campaignCountEl = document.getElementById('msgCampaignCount');
            const campaignDurationEl = document.getElementById('msgCampaignDuration');

            if (durationEl) durationEl.textContent = `${hoursNeeded}h`;
            if (totalMessagesEl) totalMessagesEl.textContent = `${totalLeads}`;
            if (scheduleTimeEl) {
                const endTimeStr = endHour > 24 ? `${endHour - 24}h00 (+1 dia)` : `${endHour}h00`;
                scheduleTimeEl.textContent = `${selectedMsgHour}h00 até ${endTimeStr}`;
            }
            if (campaignCountEl) campaignCountEl.innerHTML = `${totalLeads}<br><small style="font-size: 0.6em; font-weight: 500; color: rgba(255,255,255,0.7);">leads</small>`;
            if (campaignDurationEl) campaignDurationEl.textContent = `${hoursNeeded}h necessárias`;

            // Update capacity note with intelligent messaging
            let capacityMessage = '';
            if (endHour <= 18) {
                capacityMessage = `✅ Sua campanha de ${totalLeads} mensagens será enviada em ${hoursNeeded}h, terminando às ${endHour}h00.`;
            } else if (endHour <= 24) {
                capacityMessage = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; margin-right: 6px; vertical-align: middle;"><path d="M12 9v2m0 4h.01M12 1a11 11 0 1 0 0 22 11 11 0 0 0 0-22z"/></svg> Campanha terminará às ${endHour}h00, fora do horário comercial. Considere iniciar mais cedo.`;
            } else {
                const nextDayEnd = endHour - 24;
                capacityMessage = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; margin-right: 6px; vertical-align: middle;"><path d="M12 9v2m0 4h.01M12 1a11 11 0 1 0 0 22 11 11 0 0 0 0-22z"/></svg> Campanha continuará no próximo dia, terminando às ${nextDayEnd}h00. Duração: ${hoursNeeded}h total.`;
            }

            // Show capacity in campaign instruction
            const instructionEl = document.querySelector('.campaign-instruction');
            if (instructionEl) {
                instructionEl.innerHTML = capacityMessage;
            }
        }

        function onMsgDateChange() {
            const dateInput = document.getElementById('msgScheduleDate');
            if (dateInput && dateInput.value) {
                selectedMsgDate = dateInput.value;
                console.log('[MSG_SCHEDULE] Date changed to:', selectedMsgDate);

                // Update date in hidden input for compatibility
                document.getElementById('msgStartDate').value = selectedMsgDate;

                // Update calendar display
                const date = new Date(selectedMsgDate + 'T12:00:00');
                const display = date.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                document.getElementById('selectedMsgDateDisplay').textContent = display;

                // Update time slot availability
                updateTimeSlotAvailability();

                // Check if selected hour is still valid
                if (isHourDisabled(selectedMsgHour)) {
                    // Find the next available hour
                    const availableHour = findNextAvailableHour();
                    if (availableHour) {
                        selectMsgTimeSlot(availableHour);
                    }
                }

                updateMsgScheduleDisplay();
            }
        }

        function updateTimeSlotAvailability() {
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentHour = now.getHours();
            const isToday = selectedMsgDate === currentDate;

            console.log('[MSG_SCHEDULE] Updating availability - isToday:', isToday, 'currentHour:', currentHour);

            const timeSlots = document.querySelectorAll('.time-slot');
            timeSlots.forEach(slot => {
                const hour = parseInt(slot.dataset.hour);
                const shouldDisable = isToday && hour <= currentHour;

                slot.classList.toggle('disabled', shouldDisable);

                if (shouldDisable) {
                    slot.style.opacity = '0.3';
                    slot.style.cursor = 'not-allowed';
                    slot.title = 'Horário já passou';
                } else {
                    slot.style.opacity = '1';
                    slot.style.cursor = 'pointer';
                    slot.title = '';
                }
            });
        }

        function isHourDisabled(hour) {
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentHour = now.getHours();
            const isToday = selectedMsgDate === currentDate;

            return isToday && hour <= currentHour;
        }

        function findNextAvailableHour() {
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const isToday = selectedMsgDate === currentDate;

            if (!isToday) {
                return 8; // If not today, start from 8h
            }

            // Find next available hour from current time
            const currentHour = now.getHours();
            for (let hour = currentHour + 1; hour <= 17; hour++) {
                return hour;
            }

            return null; // No available hours today
        }

        function resetMsgSchedule() {
            console.log('[MSG_SCHEDULE] Resetting schedule...');

            // Reset to TODAY
            const today = new Date();
            selectedMsgDate = today.toISOString().split('T')[0];
            msgCurrentDate = new Date();

            // Update button text
            const display = today.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('selectedDateText').textContent = display;

            // Update availability and select appropriate hour
            updateTimeSlotAvailability();
            const availableHour = findNextAvailableHour() || 12;
            selectMsgTimeSlot(availableHour);
        }

        // Calculate messaging capacity (legacy function for compatibility)
        function calculateMessagingCapacity() {
            console.log('[MSG_CAPACITY] Calculating capacity...');

            // Initialize schedule if not already done
            setTimeout(() => {
                initializeMsgSchedule();
            }, 100);
        }

        // Make functions globally accessible for debugging
        window.addSampleLeads = addSampleLeads;
        window.testUploadWithSampleData = testUploadWithSampleData;
        window.msgProcessedLeads = msgProcessedLeads;
        window.forceOpenFileSelector = forceOpenFileSelector;
        window.debugUploadClick = debugUploadClick;
        window.trocarArquivoMsg = trocarArquivoMsg;
        window.initializeMsgSchedule = initializeMsgSchedule;
        window.selectMsgTimeSlot = selectMsgTimeSlot;
        // Date picker modal variables
        let msgCurrentDate = new Date();
        let msgPickerOpen = false;

        // Toggle date picker dropdown
        function toggleMsgDatePicker() {
            const dropdown = document.getElementById('msgDatePickerDropdown');
            msgPickerOpen = !msgPickerOpen;

            if (msgPickerOpen) {
                dropdown.style.display = 'block';
                renderMsgDatePicker();
                // Close on outside click
                setTimeout(() => {
                    document.addEventListener('click', closeMsgDatePickerOutside);
                }, 100);
            } else {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeMsgDatePickerOutside);
            }
        }

        function closeMsgDatePickerOutside(event) {
            const dropdown = document.getElementById('msgDatePickerDropdown');
            const container = document.querySelector('.date-picker-container');
            const button = document.querySelector('.choose-date-btn');

            if (!container.contains(event.target) && !button.contains(event.target)) {
                dropdown.style.display = 'none';
                msgPickerOpen = false;
                document.removeEventListener('click', closeMsgDatePickerOutside);
            }
        }

        function changeMsgMonth(direction) {
            msgCurrentDate.setMonth(msgCurrentDate.getMonth() + direction);
            renderMsgDatePicker();
        }

        function renderMsgDatePicker() {
            const monthElement = document.getElementById('msgMonthYear');
            const daysElement = document.getElementById('msgDatePickerDays');

            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];

            const year = msgCurrentDate.getFullYear();
            const month = msgCurrentDate.getMonth();

            monthElement.textContent = `${months[month]} ${year}`;

            // Get first day of month
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            let daysHTML = '';

            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                const dateStr = currentDate.toISOString().split('T')[0];
                const isCurrentMonth = currentDate.getMonth() === month;
                const isToday = dateStr === todayStr;
                const isSelected = selectedMsgDate === dateStr;
                const isPast = currentDate < today && !isToday;

                let classes = 'date-picker-day';
                if (!isCurrentMonth) classes += ' other-month';
                if (isToday) classes += ' today';
                if (isSelected) classes += ' selected';
                if (isPast) classes += ' disabled';

                const clickHandler = !isPast ? `onclick="selectMsgDate('${dateStr}')"` : '';

                daysHTML += `<div class="${classes}" ${clickHandler}>${currentDate.getDate()}</div>`;
            }

            daysElement.innerHTML = daysHTML;
        }

        function selectMsgDate(dateStr) {
            selectedMsgDate = dateStr;

            // Update button text
            const date = new Date(dateStr + 'T12:00:00');
            const display = date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('selectedDateText').textContent = display;

            // Update hidden inputs
            document.getElementById('msgStartDate').value = selectedMsgDate;
            document.getElementById('msgScheduleDate').value = selectedMsgDate;

            // Close dropdown
            document.getElementById('msgDatePickerDropdown').style.display = 'none';
            msgPickerOpen = false;
            document.removeEventListener('click', closeMsgDatePickerOutside);

            // Update time slot availability
            updateTimeSlotAvailability();

            // Auto-select appropriate hour if current is disabled
            if (isHourDisabled(selectedMsgHour)) {
                const availableHour = findNextAvailableHour();
                if (availableHour) {
                    selectMsgTimeSlot(availableHour);
                }
            }

            console.log('[MSG_SCHEDULE] Date selected:', selectedMsgDate);
        }

        // Initialize date picker
        function initMsgDatePicker() {
            console.log('[MSG_SCHEDULE] Initializing date picker...');

            // Set default to TODAY (not tomorrow)
            const today = new Date();
            selectedMsgDate = today.toISOString().split('T')[0];
            msgCurrentDate = new Date();

            // Update button text
            const display = today.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('selectedDateText').textContent = display;

            // Update hidden inputs
            document.getElementById('msgStartDate').value = selectedMsgDate;
            document.getElementById('msgScheduleDate').value = selectedMsgDate;
        }

        // Export functions
        window.resetMsgSchedule = resetMsgSchedule;
        window.onMsgDateChange = onMsgDateChange;
        window.updateTimeSlotAvailability = updateTimeSlotAvailability;
        window.toggleMsgDatePicker = toggleMsgDatePicker;
        window.changeMsgMonth = changeMsgMonth;
        window.selectMsgDate = selectMsgDate;
    </script>

    <!-- Campaign Type Selection Modal -->
    <div class="campaign-type-modal" id="campaignTypeModal">
        <div class="campaign-type-content">
            <div class="campaign-type-header">
                <h2>Nova Campanha</h2>
                <p>Qual tipo de campanha você quer criar?</p>
                <button class="modal-close-btn" onclick="closeCampaignTypeModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="campaign-type-options">
                <!-- Opção Ligação -->
                <div class="campaign-type-card" onclick="selectCampaignType('calling')">
                    <div class="type-icon calling">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                    </div>
                    <h3>Ligação</h3>
                    <p>Dispara ligações automáticas com sua assistente de IA</p>
                </div>

                <!-- Opção Mensagem -->
                <div class="campaign-type-card" onclick="selectCampaignType('messaging')">
                    <div class="type-icon messaging">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                        </svg>
                    </div>
                    <h3>Mensagem</h3>
                    <p>Dispara mensagens em massa via WhatsApp</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Messaging Campaign Modal -->
    <div class="messaging-campaign-modal" id="messagingCampaignModal">
        <div class="messaging-campaign-content">
            <!-- Header -->
            <div class="msg-campaign-header">
                <h2 class="msg-campaign-title">Nova Campanha de Mensagem</h2>
                <button class="modal-close-btn" onclick="closeMessagingCampaignModal()" style="position: absolute; top: 1.5rem; right: 1.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Step 1: Informações Básicas -->
            <div class="msg-campaign-step active" id="msgStep1">
                <!-- Nome da Campanha -->
                <div class="form-group">
                    <label>Nome da Campanha</label>
                    <input type="text" id="msgCampaignName" placeholder="Ex: Prospecção Janeiro 2026">
                </div>

                <!-- Seleção de Instância WhatsApp -->
                <div class="form-group">
                    <label>Instância WhatsApp</label>
                    <select id="msgInstanceSelect">
                        <option value="">Selecione a instância...</option>
                    </select>
                </div>

                <!-- Seleção de Intervalo -->
                <div class="form-group">
                    <label>Ritmo de Envio</label>
                    <div class="interval-options">
                        <label class="interval-option">
                            <input type="radio" name="interval" value="1-3">
                            <span class="interval-card risk">
                                <span class="icon">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                    </svg>
                                </span>
                                <span class="title">Rápido</span>
                                <span class="desc">1-3 minutos</span>
                                <span class="warning">Maior risco de bloqueio</span>
                            </span>
                        </label>
                        <label class="interval-option">
                            <input type="radio" name="interval" value="2-4" checked>
                            <span class="interval-card moderate">
                                <span class="icon">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c1.22 0 2.39.24 3.45.69"/>
                                        <path d="m12 8 4-4-4-4"/>
                                        <path d="M8 12h8"/>
                                    </svg>
                                </span>
                                <span class="title">Moderado</span>
                                <span class="desc">2-4 minutos</span>
                                <span class="badge">Recomendado</span>
                            </span>
                        </label>
                        <label class="interval-option">
                            <input type="radio" name="interval" value="3-5">
                            <span class="interval-card safe">
                                <span class="icon">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                        <path d="m9 12 2 2 4-4"/>
                                    </svg>
                                </span>
                                <span class="title">Seguro</span>
                                <span class="desc">3-5 minutos</span>
                                <span class="info">Risco reduzido</span>
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 2: Mensagem -->
            <div class="msg-campaign-step" id="msgStep2">
                <div class="form-group">
                    <label>Mensagem</label>
                    <textarea id="msgTemplate" rows="6" placeholder="Olá {{nome}}, tudo bem?

Sou da empresa XYZ e gostaria de..."></textarea>
                    <div class="form-hint">
                        💡 Use <code>{{nome}}</code> para personalizar com o nome do lead
                    </div>
                </div>
            </div>

            <!-- Step 3: Upload de Planilha -->
            <div class="msg-campaign-step" id="msgStep3">
                <!-- Área de upload -->
                <div class="upload-area" id="msgUploadArea" style="cursor: pointer;">
                    <div class="upload-icon">📎</div>
                    <p>Arraste sua planilha aqui ou clique para selecionar</p>
                    <span class="upload-formats">Formatos aceitos: .xlsx, .xls, .csv</span>
                    <input type="file" id="msgFileInput" accept=".xlsx,.xls,.csv" hidden>
                </div>

                <!-- Seleção de colunas (aparece após upload) -->
                <div class="column-mapping" id="msgColumnMapping" style="display: none;">
                    <div class="form-group">
                        <label>Coluna do Nome</label>
                        <select id="msgNameColumn"></select>
                    </div>
                    <div class="form-group">
                        <label>Coluna do Telefone</label>
                        <select id="msgPhoneColumn"></select>
                    </div>

                    <!-- Preview dos leads -->
                    <div class="leads-preview">
                        <h4>Preview dos Leads</h4>
                        <div id="msgLeadsPreview"></div>
                        <p class="leads-count">Total: <strong id="msgTotalLeads">0</strong> leads</p>
                    </div>
                </div>
            </div>

            <!-- Step 4: Agendamento Visual -->
            <div class="msg-campaign-step" id="msgStep4">
                <!-- Hidden inputs for compatibility -->
                <input type="date" id="msgStartDate" style="display: none;">
                <input type="time" id="msgStartTime" style="display: none;" value="09:00">
                <input type="date" id="msgScheduleDate" style="display: none;">

                <div class="schedule-header">
                    <div class="schedule-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                            <path d="m9 16 2 2 4-4"/>
                        </svg>
                    </div>
                    <div class="schedule-title">
                        <h3>Escolha o Horário da Campanha</h3>
                        <p>Selecione a data e o horário desejado</p>
                    </div>
                    <div class="schedule-actions">
                        <div class="date-picker-container">
                            <button class="choose-date-btn" onclick="toggleMsgDatePicker()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                <span id="selectedDateText">Escolher data</span>
                            </button>

                            <!-- Date Picker Dropdown -->
                            <div class="date-picker-dropdown" id="msgDatePickerDropdown" style="display: none;">
                                <div class="date-picker-content">
                                    <div class="date-picker-header">
                                        <button type="button" onclick="changeMsgMonth(-1)">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="15,18 9,12 15,6"></polyline>
                                            </svg>
                                        </button>
                                        <span id="msgMonthYear">Janeiro 2026</span>
                                        <button type="button" onclick="changeMsgMonth(1)">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <polyline points="9,18 15,12 9,6"></polyline>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="date-picker-weekdays">
                                        <span>DOM</span><span>SEG</span><span>TER</span><span>QUA</span><span>QUI</span><span>SEX</span><span>SÁB</span>
                                    </div>
                                    <div class="date-picker-days" id="msgDatePickerDays"></div>
                                </div>
                            </div>
                        </div>
                        <button class="schedule-restart-btn" onclick="resetMsgSchedule()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                                <path d="M21 3v5h-5"/>
                                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                                <path d="M3 21v-5h5"/>
                            </svg>
                            Reiniciar
                        </button>
                    </div>
                </div>

                <div class="schedule-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M8 12h8"/>
                                <path d="M12 8v8"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">Duração</div>
                            <div class="stat-value" id="msgDuration">1h</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">Total de Mensagens</div>
                            <div class="stat-value" id="msgTotalMessages">128</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12,6 12,12 16,14"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-title">Horário</div>
                            <div class="stat-value" id="msgScheduleTime">12h00 até 13h00</div>
                        </div>
                    </div>
                </div>

                <!-- Time Slots Grid -->
                <div class="schedule-container">
                    <div class="time-slots">
                        <div class="time-slot" data-hour="8">
                            <div class="hour-label">8h00</div>
                        </div>
                        <div class="time-slot" data-hour="9">
                            <div class="hour-label">9h00</div>
                        </div>
                        <div class="time-slot" data-hour="10">
                            <div class="hour-label">10h00</div>
                        </div>
                        <div class="time-slot" data-hour="11">
                            <div class="hour-label">11h00</div>
                        </div>
                        <div class="time-slot selected" data-hour="12">
                            <div class="hour-label">12h00</div>
                        </div>
                        <div class="time-slot" data-hour="13">
                            <div class="hour-label">13h00</div>
                        </div>
                        <div class="time-slot" data-hour="14">
                            <div class="hour-label">14h00</div>
                        </div>
                        <div class="time-slot" data-hour="15">
                            <div class="hour-label">15h00</div>
                        </div>
                        <div class="time-slot" data-hour="16">
                            <div class="hour-label">16h00</div>
                        </div>
                        <div class="time-slot" data-hour="17">
                            <div class="hour-label">17h00</div>
                        </div>
                    </div>

                    <!-- Campaign Block -->
                    <div class="campaign-block" id="msgCampaignBlock">
                        <div class="campaign-info">
                            <span class="campaign-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                    <polyline points="7.5,10.5 7.5,16.5 16.5,16.5 16.5,10.5"/>
                                    <polyline points="12,2 12,8"/>
                                </svg>
                            </span>
                            <span class="campaign-title">Sua Campanha</span>
                        </div>
                        <div class="campaign-stats">
                            <div class="campaign-count" id="msgCampaignCount">128<br><small style="font-size: 0.6em; font-weight: 500; color: rgba(255,255,255,0.7);">leads</small></div>
                            <div class="campaign-duration" id="msgCampaignDuration">7h necessárias</div>
                        </div>
                        <div class="campaign-instruction">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; margin-right: 6px; vertical-align: middle;"><path d="M12 9v2m0 4h.01M12 1a11 11 0 1 0 0 22 11 11 0 0 0 0-22z"/></svg>
                            Campanha terminará às 21h00, fora do horário comercial. Considere iniciar mais cedo.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step Navigation -->
            <div class="step-navigation">
                <div class="step-counter">
                    <span id="currentStep">1</span> de 4
                </div>
                <div class="step-buttons">
                    <button type="button" class="step-btn step-btn-secondary" id="msgPrevBtn" onclick="previousMsgStep()" style="display: none;">
                        Anterior
                    </button>
                    <button type="button" class="step-btn step-btn-primary" id="msgNextBtn" onclick="nextMsgStep()">
                        Próximo
                    </button>
                    <button type="button" class="step-btn step-btn-primary" id="msgCreateBtn" onclick="createMessagingCampaign()" style="display: none;">
                        Criar Campanha
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
