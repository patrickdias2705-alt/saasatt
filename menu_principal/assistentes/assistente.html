<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
   <link rel="shortcut icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
   <link rel="apple-touch-icon" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Assistentes - CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        *::-webkit-scrollbar-track {
            background: rgba(15, 6, 36, 0.5);
            border-radius: 10px;
        }

        *::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #A594FF, #667eea);
            border-radius: 10px;
            border: 2px solid rgba(15, 6, 36, 0.5);
        }

        *::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #667eea, #A594FF);
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Raleway', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0420;
            min-height: 100vh;
            color: #fff;
            padding: 2rem;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(165, 148, 255, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.06) 0%, transparent 50%);
            animation: backgroundFloat 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(3%, 3%); }
        }

        @keyframes pulse {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.5; }
            50% { transform: translate(10%, 10%) scale(1.1); opacity: 0.8; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            animation: fadeInDown 0.6s ease;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ffffff, #A594FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 400;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(15, 6, 36, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 1.2rem;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease both;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 32px rgba(165, 148, 255, 0.3);
            border-color: rgba(165, 148, 255, 0.4);
            background: rgba(15, 6, 36, 0.95);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-icon.primary {
            background: linear-gradient(135deg, #A594FF, #667eea);
            box-shadow: 0 4px 20px rgba(165, 148, 255, 0.4);
        }

        .stat-icon.success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }

        .stat-icon.info {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }

        .stat-icon svg {
            width: 28px;
            height: 28px;
            color: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.35rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: #fff;
            line-height: 1;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .stat-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: rgba(165, 148, 255, 0.15);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 6px;
            font-size: 0.65rem;
            color: #A594FF;
            font-weight: 600;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .stat-ver-mais {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            margin-top: 0.5rem;
            padding: 0.3rem 0.75rem;
            background: transparent;
            border: 1px solid rgba(165, 148, 255, 0.4);
            border-radius: 6px;
            font-size: 0.7rem;
            color: #A594FF;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Raleway', sans-serif;
        }

        .stat-ver-mais:hover {
            background: rgba(165, 148, 255, 0.2);
            border-color: #A594FF;
            transform: translateY(-1px);
        }

        .stat-ver-mais:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stat-ver-mais:disabled:hover {
            transform: none;
        }

        /* Animação de loading para o botão */
        .loading-spinner-small {
            width: 10px;
            height: 10px;
            border: 2px solid rgba(165, 148, 255, 0.2);
            border-top-color: #A594FF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .main-content {
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.12), rgba(102, 126, 234, 0.08));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(165, 148, 255, 0.15);
            animation: fadeInUp 0.6s ease 0.1s both;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .top-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            gap: 24px;
        }

        .section-header h2 {
            font-size: 1.75rem;
            margin-bottom: 6px;
            color: #fff;
        }

        .section-header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
        }

        .create-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 1rem 2.5rem;
            background: linear-gradient(135deg, #A594FF, #667eea);
            border: none;
            border-radius: 1rem;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(165, 148, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .create-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .create-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .create-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 35px rgba(165, 148, 255, 0.6);
        }

        .create-btn svg {
            position: relative;
            z-index: 1;
        }

        .loading, .error, .empty-state {
            text-align: center;
            padding: 60px 24px;
        }

        .loading-spinner {
            width: 56px;
            height: 56px;
            border: 5px solid rgba(165, 148, 255, 0.2);
            border-top-color: #A594FF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error h3, .empty-state h3 {
            margin-bottom: 12px;
            font-size: 1.5rem;
        }

        .assistentes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 28px;
            padding: 8px 0;
        }

        .assistente-card {
            background: linear-gradient(145deg, rgba(15, 5, 30, 0.98), rgba(20, 8, 40, 0.98));
            border: 1.5px solid rgba(165, 148, 255, 0.2);
            border-radius: 18px;
            padding: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .assistente-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.05) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .assistente-card:hover::before {
            opacity: 1;
        }

        .assistente-card:hover {
            transform: translateY(-6px);
            border-color: rgba(165, 148, 255, 0.5);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.7),
                        0 0 40px rgba(165, 148, 255, 0.25);
        }

        .assistente-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 28px;
            background: linear-gradient(135deg, rgba(10, 3, 20, 0.8), rgba(15, 5, 30, 0.7));
            border-bottom: 1.5px solid rgba(165, 148, 255, 0.15);
        }

        .assistente-nome {
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
            flex: 1;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .assistente-status {
            padding: 8px 16px;
            background: rgba(34, 197, 94, 0.2);
            border: 1.5px solid rgba(34, 197, 94, 0.5);
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #4ade80;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        }

        .assistente-status.inativo {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .assistente-body {
            padding: 28px;
        }

        .assistente-profile-photo {
            width: 100%;
            height: 240px;
            min-height: 240px;
            max-height: 240px;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(165, 148, 255, 0.2);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.08), rgba(102, 126, 234, 0.05));
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .assistente-card:hover .assistente-profile-photo {
            border-color: rgba(165, 148, 255, 0.4);
            box-shadow: 0 12px 32px rgba(165, 148, 255, 0.2);
        }

        .assistente-profile-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            position: absolute;
            top: 0;
            left: 0;
        }

        .assistente-info {
            margin-bottom: 20px;
        }

        .info-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #A594FF;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .first-message-text {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.95rem;
            line-height: 1.6;
            padding: 14px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border-left: 3px solid rgba(165, 148, 255, 0.4);
        }

        .prompt-preview {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 20px;
            max-height: 140px;
            overflow-y: auto;
            border: 1px solid rgba(165, 148, 255, 0.2);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .prompt-text {
            font-size: 0.95rem;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.7);
            white-space: pre-wrap;
        }

        .prompt-expand-btn {
            background: transparent;
            border: 1px solid rgba(165, 148, 255, 0.4);
            color: #A594FF;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .prompt-expand-btn:hover {
            background: rgba(165, 148, 255, 0.2);
            border-color: #A594FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(165, 148, 255, 0.3);
        }

        .assistente-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 22px;
            border: 1.5px solid;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.3px;
        }

        .action-btn:hover {
            transform: translateY(-3px);
        }

        .btn-edit {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.35), rgba(37, 99, 235, 0.35));
            border-color: #3b82f6;
            color: #93c5fd;
            box-shadow: 0 10px 28px rgba(59, 130, 246, 0.4), 0 0 30px rgba(59, 130, 246, 0.25);
        }

        .btn-duplicate-icon {
            background: transparent;
            border: none;
            color: rgba(165, 148, 255, 0.6);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-duplicate-icon:hover {
            background: rgba(165, 148, 255, 0.15);
            color: #A594FF;
        }

        .btn-duplicate-icon svg {
            width: 16px;
            height: 16px;
        }

        .action-btn svg {
            stroke-width: 2.5;
            width: 18px;
            height: 18px;
        }

        .btn-delete {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
        }

        .btn-delete:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.35), rgba(220, 38, 38, 0.35));
            border-color: #ef4444;
            color: #fca5a5;
            box-shadow: 0 10px 28px rgba(239, 68, 68, 0.4), 0 0 30px rgba(239, 68, 68, 0.25);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(15, 6, 36, 0.98), rgba(26, 11, 51, 0.98));
            backdrop-filter: blur(24px);
            margin: 40px auto;
            border: 1px solid rgba(165, 148, 255, 0.25);
            border-radius: 24px;
            width: 95%;
            max-width: 1000px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(165, 148, 255, 0.1) inset,
                        0 8px 40px rgba(165, 148, 255, 0.2);
            overflow: hidden;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 32px 40px;
            border-bottom: 1px solid rgba(165, 148, 255, 0.15);
            background: rgba(10, 4, 32, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 40px;
            right: 40px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(165, 148, 255, 0.3), transparent);
        }

        .modal-title {
            font-size: 1.75rem;
            color: #fff;
            font-weight: 600;
        }

        .close {
            color: rgba(255, 255, 255, 0.5);
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
        }

        .close:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.08);
            transform: rotate(90deg) scale(1.1);
        }

        .close:active {
            transform: rotate(90deg) scale(0.95);
        }

        .wizard-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 28px 40px;
            background: rgba(10, 4, 32, 0.4);
            border-bottom: 1px solid rgba(165, 148, 255, 0.15);
            position: relative;
        }

        .wizard-steps::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 40px;
            right: 40px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(165, 148, 255, 0.3), transparent);
        }

        .step-indicator {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.1rem;
            border: 2px solid rgba(165, 148, 255, 0.25);
            color: rgba(255, 255, 255, 0.4);
            background: rgba(10, 4, 32, 0.6);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.3), rgba(102, 126, 234, 0.3));
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .step-indicator.active {
            background: linear-gradient(135deg, #A594FF, #667eea);
            border-color: #A594FF;
            color: white;
            box-shadow: 0 0 30px rgba(165, 148, 255, 0.6),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: scale(1.15);
        }

        .step-indicator.active::before {
            opacity: 1;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.5;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .step-indicator.completed {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(22, 163, 74, 0.3));
            border-color: #22C55E;
            color: transparent;
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .step-indicator.completed::after {
            content: '✓';
            position: absolute;
            font-size: 1.2rem;
            color: #22C55E;
            font-weight: bold;
        }

        .step-line {
            width: 60px;
            height: 3px;
            background: rgba(165, 148, 255, 0.2);
            border-radius: 2px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .step-line::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #22C55E, #16A34A);
            border-radius: 2px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .step-line.completed::before {
            width: 100%;
        }

        .step-line.completed {
            background: rgba(34, 197, 94, 0.3);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        .modal-body {
            padding: 40px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(10, 4, 32, 0.5);
            border-radius: 8px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #A594FF, #667eea);
            border-radius: 8px;
            border: 2px solid rgba(10, 4, 32, 0.3);
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #667eea, #A594FF);
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
            animation: fadeInContent 0.4s ease;
        }

        .form-group {
            margin-bottom: 28px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, #A594FF, #667eea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 16px 20px;
            background: rgba(10, 4, 32, 0.6);
            border: 1.5px solid rgba(165, 148, 255, 0.25);
            border-radius: 14px;
            color: #fff;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .form-group input:hover,
        .form-group textarea:hover,
        .form-group select:hover {
            border-color: rgba(165, 148, 255, 0.4);
            background: rgba(10, 4, 32, 0.8);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #A594FF;
            background: rgba(10, 4, 32, 0.9);
            box-shadow: 0 0 0 4px rgba(165, 148, 255, 0.15),
                        0 8px 24px rgba(165, 148, 255, 0.2);
            transform: translateY(-2px);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 140px;
            line-height: 1.7;
        }

        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23A594FF' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 3rem;
        }

        .form-group select option {
            background: #1a0b33;
            color: #fff;
            padding: 12px;
        }

        .form-helper {
            display: block;
            margin-top: 10px;
            font-size: 0.875rem;
            color: rgba(165, 148, 255, 0.6);
            font-weight: 500;
            line-height: 1.5;
        }

        .voices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        /* Avatars Grid */
        .avatars-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .avatar-card {
            background: rgba(15, 6, 36, 0.6);
            border: 3px solid rgba(165, 148, 255, 0.2);
            border-radius: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .avatar-card:hover {
            transform: translateY(-5px);
            border-color: rgba(165, 148, 255, 0.5);
            box-shadow: 0 8px 24px rgba(165, 148, 255, 0.3);
        }

        .avatar-card.selected {
            border-color: #A594FF;
            background: rgba(165, 148, 255, 0.1);
            box-shadow: 0 0 30px rgba(165, 148, 255, 0.5);
        }

        .avatar-card img {
            width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .avatar-card-check {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 30px;
            height: 30px;
            background: #A594FF;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .avatar-card.selected .avatar-card-check {
            display: flex;
        }

        /* Color Selectors */
        .color-selector-grid {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid rgba(165, 148, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: rgba(165, 148, 255, 0.5);
            box-shadow: 0 0 20px rgba(165, 148, 255, 0.3);
        }

        .color-option.selected {
            border-color: #A594FF;
            border-width: 4px;
            box-shadow: 0 0 20px rgba(165, 148, 255, 0.6);
        }

        .color-option.selected::after {
            content: '✓';
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        /* Eye colors */
        .color-azul { background: #4A90E2; }
        .color-castanho { background: #8B4513; }
        .color-verde { background: #2ECC71; }
        .color-mel { background: #D4AF37; }
        .color-cinza { background: #95A5A6; }

        /* Hair colors */
        .color-loira { background: #F4E04D; }
        .color-morena { background: #6B4423; }
        .color-ruiva { background: #CD5C5C; }
        .color-castanha { background: #654321; }
        .color-preta { background: #1C1C1C; }

        .color-label {
            display: block;
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .color-option-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .voice-card {
            background: linear-gradient(135deg, rgba(10, 4, 32, 0.8), rgba(26, 11, 51, 0.6));
            border: 1.5px solid rgba(165, 148, 255, 0.25);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(8px);
        }

        .voice-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.15) 0%, rgba(102, 126, 234, 0.1) 50%, transparent 100%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .voice-card:hover::before {
            opacity: 1;
        }

        .voice-card:hover {
            border-color: rgba(165, 148, 255, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 12px 32px rgba(165, 148, 255, 0.25);
        }

        .voice-card.selected {
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.25), rgba(102, 126, 234, 0.2));
            border-color: #A594FF;
            border-width: 2px;
            box-shadow: 0 12px 40px rgba(165, 148, 255, 0.4),
                        0 0 30px rgba(165, 148, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: translateY(-5px) scale(1.02);
        }

        .voice-card.selected::before {
            opacity: 1;
        }

        .voice-card > * {
            position: relative;
            z-index: 1;
        }

        .voice-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .voice-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .voice-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .voice-badge.female {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        .voice-badge.male {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .voice-description {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.75rem;
        }

        .voice-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .play-btn {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #A594FF, #667eea);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(165, 148, 255, 0.4);
        }

        .play-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 25px rgba(165, 148, 255, 0.6);
        }

        .play-btn svg {
            width: 14px;
            height: 14px;
            fill: white;
        }

        .play-btn.playing {
            background: linear-gradient(135deg, #22C55E, #16A34A);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }

        .play-btn.playing:hover {
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.6);
        }

        .waveform-mini {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }

        .waveform-bar {
            flex: 1;
            background: rgba(165, 148, 255, 0.4);
            border-radius: 2px;
            transition: all 0.3s;
        }

        .form-actions {
            display: flex;
            gap: 16px;
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid rgba(165, 148, 255, 0.1);
        }

        .btn-cancel, .btn-confirm, .btn-back, .btn-next {
            flex: 1;
            padding: 18px 36px;
            border: none;
            border-radius: 16px;
            font-size: 1.05rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-family: 'Raleway', sans-serif;
        }

        .btn-cancel, .btn-back {
            background: rgba(255, 255, 255, 0.04);
            color: rgba(255, 255, 255, 0.8);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
        }

        .btn-cancel:hover, .btn-back:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.25);
            color: #fff;
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.4);
        }

        .btn-confirm, .btn-next {
            background: linear-gradient(135deg, #A594FF, #667eea);
            color: white;
            border: 1.5px solid rgba(165, 148, 255, 0.5);
            box-shadow: 0 8px 24px rgba(165, 148, 255, 0.35),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-confirm::before, .btn-next::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-confirm:hover::before, .btn-next:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-confirm:hover, .btn-next:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(165, 148, 255, 0.5),
                        0 0 60px rgba(165, 148, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn-confirm:disabled, .btn-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-confirm span, .btn-next span {
            position: relative;
            z-index: 1;
        }

        /* Estilos para os cards na edição (voz e telefone) */
        #editVoiceInfo, #editPhoneInfo {
            transition: all 0.3s ease;
        }

        #editVoiceInfo:hover, #editPhoneInfo:hover {
            border-color: rgba(165, 148, 255, 0.4);
            box-shadow: 0 4px 16px rgba(165, 148, 255, 0.2);
            transform: translateY(-2px);
        }

        #editVoiceInfo button:hover, #editPhoneInfo button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(165, 148, 255, 0.5);
        }

        #editVoiceInfo button:active, #editPhoneInfo button:active {
            transform: translateY(0);
        }

        #editPhoneNumberSelect:focus {
            border-color: rgba(165, 148, 255, 0.6);
            box-shadow: 0 0 0 3px rgba(165, 148, 255, 0.1);
        }

        .notification-popup {
            display: none;
            position: fixed;
            top: 32px;
            right: 32px;
            z-index: 2000;
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-content {
            background: linear-gradient(135deg, #1a0b33 0%, #2d1055 100%);
            border: 1px solid rgba(165, 148, 255, 0.5);
            border-radius: 20px;
            padding: 24px;
            min-width: 360px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8),
                        0 0 40px rgba(165, 148, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 14px;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .notification-icon.success {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .notification-icon.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .notification-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
        }

        .notification-message {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            line-height: 1.6;
        }

        .notification-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .notification-close:hover {
            color: #fff;
        }

        .delete-modal-content {
            background: linear-gradient(135deg, #1a0b33 0%, #2d1055 100%);
            border: 1px solid rgba(239, 68, 68, 0.5);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 520px;
            margin: 10% auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8),
                        0 0 60px rgba(239, 68, 68, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .delete-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 28px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
            animation: pulse-delete 2s ease-in-out infinite;
        }

        @keyframes pulse-delete {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 50px rgba(239, 68, 68, 0.6); }
        }

        .delete-icon svg {
            width: 40px;
            height: 40px;
            color: #ef4444;
        }

        .delete-modal-content h2 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.75rem;
        }

        .delete-assistant-name {
            color: #A594FF;
            font-weight: 600;
            margin: 12px 0;
            font-size: 1.2rem;
        }

        .delete-warning {
            color: rgba(255, 255, 255, 0.7);
            margin: 20px 0 40px;
            font-size: 1.05rem;
        }

        .delete-actions {
            display: flex;
            gap: 16px;
        }

        .btn-delete-cancel, .btn-delete-confirm {
            flex: 1;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-delete-cancel {
            background: rgba(255, 255, 255, 0.06);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-delete-cancel:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-delete-confirm {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-delete-confirm::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-delete-confirm:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-delete-confirm:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.6),
                        0 0 40px rgba(239, 68, 68, 0.4);
            transform: translateY(-2px);
        }

        .btn-delete-confirm span {
            position: relative;
            z-index: 1;
        }

        .method-choice-btn {
            padding: 32px 24px;
            background: rgba(15, 6, 36, 0.6);
            border: 2px solid rgba(165, 148, 255, 0.3);
            border-radius: 18px;
            color: #fff;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }

        .method-choice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .method-choice-btn:hover::before {
            opacity: 1;
        }

        .method-choice-btn:hover {
            background: rgba(165, 148, 255, 0.15);
            border-color: #A594FF;
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(165, 148, 255, 0.4);
        }

        .method-choice-btn svg,
        .method-choice-btn div {
            position: relative;
            z-index: 1;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            padding: 48px;
            background: linear-gradient(135deg, #1a0b33 0%, #2d1055 100%);
            border: 1px solid rgba(165, 148, 255, 0.4);
            border-radius: 28px;
            max-width: 500px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.8),
                        0 0 60px rgba(165, 148, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .loading-content .loading-spinner {
            width: 80px;
            height: 80px;
            border-width: 6px;
            margin: 0 auto 28px;
        }

        .loading-content h3 {
            font-size: 1.5rem;
            margin-bottom: 12px;
            color: #fff;
        }

        .loading-content p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.05rem;
            line-height: 1.6;
        }

        .summary-box {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(165, 148, 255, 0.25);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.3s;
        }

        .summary-box:hover {
            border-color: rgba(165, 148, 255, 0.4);
            box-shadow: 0 4px 16px rgba(165, 148, 255, 0.2);
        }

        .summary-item {
            margin-bottom: 20px;
        }

        .summary-item:last-child {
            margin-bottom: 0;
        }

        .summary-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(165, 148, 255, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 1.05rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }

        /* Modal de Calls */
        .calls-modal-content {
            max-width: 600px;
        }

        .calls-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .call-item {
            padding: 1rem;
            background: rgba(10, 4, 32, 0.6);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .call-item:hover {
            background: rgba(10, 4, 32, 0.8);
            border-color: rgba(165, 148, 255, 0.4);
        }

        .call-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .call-item-name {
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
        }

        .call-item-count {
            font-size: 1.1rem;
            font-weight: 700;
            color: #A594FF;
            padding: 0.2rem 0.6rem;
            background: rgba(165, 148, 255, 0.15);
            border-radius: 0.4rem;
        }

        .call-item-stats {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .stat-mini {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.4rem;
            font-size: 0.75rem;
        }

        .stat-mini-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
        }

        .stat-mini.atendidas .stat-mini-dot {
            background: #10b981;
        }

        .stat-mini.nao-atendidas .stat-mini-dot {
            background: #ef4444;
        }

        .stat-mini-label {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .stat-mini-value {
            color: #fff;
            font-weight: 700;
        }

        .ver-conversas-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            margin-top: 1.25rem;
            background: linear-gradient(135deg, #A594FF, #667eea);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
        }

        .ver-conversas-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(165, 148, 255, 0.4);
        }

        .calls-empty {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.6);
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 20px;
            }

            .assistentes-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .top-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 20px;
            }

            .create-btn {
                align-self: center;
            }

            .modal-content {
                width: 95%;
            }

            .modal-header,
            .modal-body {
                padding: 24px;
            }

            .wizard-steps {
                padding: 20px;
            }

            .step-line {
                width: 30px;
            }

            .voices-grid {
                grid-template-columns: 1fr;
            }

            .delete-actions {
                flex-direction: column;
            }
        }
    
        /* ESTILOS PARA AS ABAS - DESIGN FUTURISTA MELHORADO */
        .modal-tabs {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            background: rgba(10, 4, 32, 0.6);
            border-bottom: 1px solid rgba(165, 148, 255, 0.15);
            position: sticky;
            top: 0;
            z-index: 9;
            backdrop-filter: blur(12px);
        }

        .tab-btn {
            flex: 1;
            padding: 16px 28px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-family: 'Raleway', sans-serif;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.15), rgba(102, 126, 234, 0.15));
            opacity: 0;
            transition: opacity 0.35s ease;
        }

        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 80%;
            height: 2px;
            background: linear-gradient(90deg, #A594FF, #667eea, #A594FF);
            border-radius: 2px;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn:hover {
            color: rgba(255, 255, 255, 0.9);
            border-color: rgba(165, 148, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(165, 148, 255, 0.2);
        }

        .tab-btn:hover::before {
            opacity: 1;
        }

        .tab-btn.active {
            color: #fff;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.25), rgba(102, 126, 234, 0.25));
            border-color: rgba(165, 148, 255, 0.5);
            box-shadow: 0 8px 28px rgba(165, 148, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .tab-btn.active::before {
            opacity: 1;
        }

        .tab-btn.active::after {
            transform: translateX(-50%) scaleX(1);
        }

        .tab-content {
            display: none;
            animation: fadeInContent 0.4s ease;
        }

        @keyframes fadeInContent {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .tool-card {
            background: linear-gradient(135deg, rgba(10, 4, 32, 0.7), rgba(26, 11, 51, 0.5));
            border: 1.5px solid rgba(165, 148, 255, 0.25);
            border-radius: 18px;
            padding: 28px;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            backdrop-filter: blur(8px);
        }

        .tool-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.05), rgba(102, 126, 234, 0.05));
            opacity: 0;
            border-radius: 18px;
            transition: opacity 0.35s ease;
            pointer-events: none;
        }

        .tool-card:hover {
            border-color: rgba(165, 148, 255, 0.5);
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(165, 148, 255, 0.25);
        }

        .tool-card:hover::before {
            opacity: 1;
        }

        .tool-card.enabled {
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.2), rgba(102, 126, 234, 0.15));
            border-color: rgba(165, 148, 255, 0.6);
            box-shadow: 0 8px 32px rgba(165, 148, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .tool-card.enabled::before {
            opacity: 1;
        }

        .tool-card:not(.enabled) .tool-config {
            display: none !important;
        }

        /* Tool Form Styles */
        .tool-form-group {
            margin-bottom: 1.25rem;
        }

        .tool-form-label {
            display: block;
            margin-bottom: 0.65rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .tool-form-select,
        .tool-form-input,
        .tool-form-textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(165, 148, 255, 0.08);
            border: 1.5px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.875rem;
            color: #ffffff;
            font-size: 1rem;
            font-family: 'Raleway', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tool-form-select {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: rgba(165, 148, 255, 0.08);
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23A594FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1.25rem center;
            padding-right: 3rem;
            color: #ffffff !important;
        }

        .tool-form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .tool-form-select:hover,
        .tool-form-input:hover,
        .tool-form-textarea:hover {
            border-color: rgba(165, 148, 255, 0.5);
            background: rgba(165, 148, 255, 0.12);
        }

        .tool-form-select:focus,
        .tool-form-input:focus,
        .tool-form-textarea:focus {
            outline: none;
            border-color: #A594FF;
            box-shadow: 0 0 0 3px rgba(165, 148, 255, 0.2);
            background: rgba(165, 148, 255, 0.15);
        }

        .tool-form-select option {
            background: #1a1135;
            color: #ffffff !important;
            padding: 1rem;
        }

        .tool-form-select option:checked {
            background: #A594FF;
            color: #ffffff !important;
        }

        .tool-form-input::placeholder,
        .tool-form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .tool-card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .tool-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.3), rgba(102, 126, 234, 0.3));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tool-icon svg {
            width: 24px;
            height: 24px;
            color: #A594FF;
        }

        .tool-info h4 {
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 4px;
        }

        .tool-info p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .tool-toggle {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 50px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(165, 148, 255, 0.3);
        }

        .tool-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .tool-card.enabled .tool-toggle {
            background: linear-gradient(135deg, #A594FF, #667eea);
            border-color: #A594FF;
        }

        .tool-card.enabled .tool-toggle::after {
            left: 25px;
            background: #fff;
        }

        .tool-resources {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(165, 148, 255, 0.2);
        }

        .tool-resources h5 {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
        }

        .resource-item svg {
            width: 16px;
            height: 16px;
            color: #A594FF;
        }

        .chat-container {
            background: rgba(10, 4, 32, 0.6);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 16px;
            padding: 24px;
            height: 500px;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            margin-bottom: 20px;
            padding-right: 8px;
            display: flex;
            flex-direction: column;
        }

        .chat-message {
            margin-bottom: 16px;
            padding: 16px;
            border-radius: 12px;
            animation: fadeInUp 0.3s ease;
        }

        .chat-message.ai {
            background: rgba(165, 148, 255, 0.1);
            border: 1px solid rgba(165, 148, 255, 0.3);
        }

        .chat-message.user {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            margin-left: 40px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #A594FF, #667eea);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .message-name {
            font-weight: 600;
            color: #fff;
        }

        .message-time {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.4);
            margin-left: auto;
        }

        .message-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            white-space: pre-line;
            word-wrap: break-word;
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            background: rgba(10, 4, 32, 0.8);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            font-family: 'Raleway', sans-serif;
            resize: none;
            min-height: 50px;
            max-height: 120px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #A594FF;
            box-shadow: 0 0 0 3px rgba(165, 148, 255, 0.2);
        }

        .chat-send-btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, #A594FF, #667eea);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(165, 148, 255, 0.4);
        }

        .chat-send-btn svg {
            width: 20px;
            height: 20px;
        }

        .chat-tip {
            margin-top: 12px;
            padding: 12px 16px;
            background: rgba(165, 148, 255, 0.05);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-tip svg {
            width: 20px;
            height: 20px;
            color: #A594FF;
            flex-shrink: 0;
        }

        .chat-tip p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .typing-dots {
            display: inline-block;
            animation: typingDots 1.4s infinite;
            color: #A594FF;
            font-size: 1.2rem;
            letter-spacing: 3px;
        }

        @keyframes typingDots {
            0%, 20% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        /* ===== FLOW EDITOR STYLES ===== */
        .flow-editor-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 600px;
            background: rgba(10, 4, 32, 0.4);
            border-radius: 12px;
            overflow: hidden;
        }

        .flow-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(15, 6, 36, 0.8);
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .flow-editor-header-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .flow-editor-header-right {
            display: flex;
            gap: 8px;
        }

        .flow-header-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(165, 148, 255, 0.1);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flow-header-btn:hover {
            background: rgba(165, 148, 255, 0.2);
            border-color: #A594FF;
        }

        .flow-header-btn.btn-save-flow {
            background: linear-gradient(135deg, #A594FF, #667eea);
            border-color: #A594FF;
        }

        .flow-editor-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Blocks Palette */
        .flow-blocks-palette {
            width: 280px;
            background: rgba(15, 6, 36, 0.6);
            border-right: 1px solid rgba(165, 148, 255, 0.2);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .flow-blocks-palette.collapsed {
            transform: translateX(-100%);
        }

        .palette-header {
            padding: 16px;
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .palette-header h4 {
            margin: 0;
            color: #fff;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .palette-toggle {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .palette-toggle:hover {
            background: rgba(165, 148, 255, 0.2);
            color: #A594FF;
        }

        .palette-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .palette-section {
            margin-bottom: 24px;
        }

        .palette-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .palette-blocks {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .palette-block {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s ease;
        }

        .palette-block:hover {
            background: rgba(165, 148, 255, 0.1);
            border-color: rgba(165, 148, 255, 0.4);
            transform: translateX(4px);
        }

        .palette-block:active {
            cursor: grabbing;
        }

        .palette-block-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .palette-block-icon svg {
            width: 20px;
            height: 20px;
        }

        .palette-block-info {
            flex: 1;
            min-width: 0;
        }

        .palette-block-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 2px;
        }

        .palette-block-desc {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .palette-loading {
            padding: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
        }

        /* Canvas */
        .flow-canvas-wrapper {
            flex: 1;
            position: relative;
            overflow: auto;
            background: 
                radial-gradient(circle at 20% 30%, rgba(165, 148, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(102, 126, 234, 0.05) 0%, transparent 50%);
        }

        .flow-canvas {
            min-width: 100%;
            min-height: 100%;
            padding: 40px;
            position: relative;
        }

        .flow-start-node {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #A594FF, #667eea);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(165, 148, 255, 0.3);
        }

        .start-node-icon {
            width: 16px;
            height: 16px;
        }

        .flow-blocks-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: flex-start;
        }

        .flow-block-node {
            position: relative;
            min-width: 320px;
            max-width: 400px;
            background: linear-gradient(135deg, rgba(15, 6, 36, 0.95), rgba(26, 11, 51, 0.95));
            border: 2px solid rgba(165, 148, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .flow-block-node:hover {
            border-color: rgba(165, 148, 255, 0.6);
            box-shadow: 0 8px 32px rgba(165, 148, 255, 0.3);
            transform: translateY(-2px);
        }

        .flow-block-node.selected {
            border-color: #A594FF;
            box-shadow: 0 8px 32px rgba(165, 148, 255, 0.5);
        }

        .flow-block-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
        }

        .flow-block-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .flow-block-icon svg {
            width: 20px;
            height: 20px;
        }

        .flow-block-info {
            flex: 1;
            min-width: 0;
        }

        .flow-block-title {
            font-weight: 600;
            color: #fff;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .flow-block-subtitle {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .flow-block-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(165, 148, 255, 0.2);
            color: #A594FF;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .flow-block-content {
            padding: 14px 16px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .flow-block-content.empty {
            color: rgba(255, 255, 255, 0.4);
            font-style: italic;
        }

        .flow-connector-line {
            width: 2px;
            height: 20px;
            background: rgba(165, 148, 255, 0.4);
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .flow-connector-line::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 6px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
            animation: flowDown 1.5s ease-in-out infinite;
        }

        @keyframes flowDown {
            0% {
                top: -6px;
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .flow-connector-line::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #A594FF;
            box-shadow: 0 0 8px rgba(165, 148, 255, 0.6);
        }

        .flow-end-node {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.75rem;
            margin-top: 20px;
        }

        /* Properties Panel */
        .flow-properties-panel {
            width: 350px;
            background: rgba(15, 6, 36, 0.98);
            border-left: 1px solid rgba(165, 148, 255, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
        }

        .properties-header {
            padding: 20px;
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .properties-header h4 {
            margin: 0;
            font-size: 1.1rem;
            color: #fff;
            font-weight: 600;
        }

        .properties-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            border-radius: 6px;
            font-size: 24px;
            line-height: 1;
            transition: all 0.2s ease;
        }

        .properties-close:hover {
            background: rgba(165, 148, 255, 0.2);
            color: #A594FF;
        }

        .properties-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .property-group {
            margin-bottom: 24px;
        }

        .property-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .property-input {
            width: 100%;
            padding: 12px;
            background: rgba(10, 4, 32, 0.6);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
            font-family: 'Raleway', sans-serif;
        }

        .property-input:focus {
            outline: none;
            border-color: #A594FF;
            box-shadow: 0 0 0 3px rgba(165, 148, 255, 0.2);
        }

        .property-textarea {
            min-height: 120px;
            resize: vertical;
        }


        /* Estilos para Botões de Canal */
        .channel-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .channel-btn {
            flex: 1;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            background: rgba(165, 148, 255, 0.1);
            border: 2px solid rgba(165, 148, 255, 0.3);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: 'Raleway', sans-serif;
        }

        .channel-btn:hover {
            background: rgba(165, 148, 255, 0.2);
            border-color: rgba(165, 148, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(165, 148, 255, 0.3);
        }

        .channel-btn svg {
            width: 20px;
            height: 20px;
            color: #A594FF;
            flex-shrink: 0;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Meus Assistentes</h1>
            <p>Gerencie seus assistentes de IA para campanhas de prospecção</p>
        </div>

        <div class="main-content">
            <!-- Stats Dashboard -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Total de Assistentes</div>
                        <div class="stat-value" id="totalAssistentes">0</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon success">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Assistentes Ativos</div>
                        <div class="stat-value">
                            <span id="assistentesAtivos">0</span><span class="stat-badge" id="ativosBadge">Ativos</span>
                        </div>
                    </div>
                </div>

                <div class="stat-card stat-card-clickable" id="callsCard" onclick="abrirModalCalls()" style="cursor: pointer;">
                    <div class="stat-icon info">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Total de Calls</div>
                        <div class="stat-value" id="totalCalls">0</div>
                        <button class="stat-ver-mais" id="verMaisBtn" onclick="event.stopPropagation(); abrirModalCalls();">
                            <span id="verMaisText">Ver mais</span>
                            <div class="loading-spinner-small" id="verMaisLoader" style="display: none;"></div>
                        </button>
                    </div>
                </div>
            </div>

            <div class="top-actions">
                <div class="section-header">
                    <h2>Assistentes Ativos</h2>
                    <p>Configure e monitore seus assistentes de conversação</p>
                </div>
                
                <button class="create-btn" onclick="abrirModalCriar()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    Criar Assistente
                </button>
            </div>

            <div id="contentArea">
                <div id="loadingState" class="loading">
                    <div class="loading-spinner"></div>
                    <h3>Carregando assistentes...</h3>
                    <p>Buscando seus assistentes de IA</p>
                </div>

                <div id="errorState" class="error" style="display: none;">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: #ef4444; margin: 0 auto 20px;">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <h3>Erro ao carregar assistentes</h3>
                    <p id="errorMessage">Não foi possível conectar com o servidor. Tente novamente em alguns instantes.</p>
                    <button onclick="loadAssistentes()" style="margin-top: 24px; padding: 12px 24px; background: linear-gradient(135deg, #7C3AED 0%, #9D7AEA 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s;">
                        Tentar Novamente
                    </button>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <h3>Você não tem assistentes</h3>
                    <p>Crie seu primeiro assistente de IA clicando no botão acima.</p>
                </div>

                <div id="assistentesGrid" class="assistentes-grid" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modais -->

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">Prompt está sendo criado</h3>
            <p id="loadingMessage">Este processo pode levar de 2 a 3 minutos.<br><strong>Não feche esta página!</strong></p>
        </div>
    </div>

    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Criar Novo Assistente</h2>
                <span class="close" onclick="closeCreateModal()">&times;</span>
            </div>

            <div class="wizard-steps">
                <div class="step-indicator active" id="step1Indicator">1</div>
                <div class="step-line" id="line1"></div>
                <div class="step-indicator" id="step2Indicator">2</div>
                <div class="step-line" id="line2"></div>
                <div class="step-indicator" id="step3Indicator">3</div>
                <div class="step-line" id="line3"></div>
                <div class="step-indicator" id="step4Indicator">4</div>
                <div class="step-line" id="line4"></div>
                <div class="step-indicator" id="step4_5Indicator">5</div>
                <div class="step-line" id="line5"></div>
                <div class="step-indicator" id="step5Indicator">6</div>
            </div>

            <div class="modal-body">
                <form id="createForm">
                    <!-- Step 1.1 - Nome -->
                    <div class="wizard-step active" id="wizardStep1_1">
                        <h3 style="margin-bottom: 24px; color: #fff; font-size: 1.5rem;">Nome do Assistente</h3>
                        <div class="form-group">
                            <label>NOME DO ASSISTENTE</label>
                            <input type="text" id="createAssistenteName" placeholder="Ex: Sofia - Vendas" required />
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancel" onclick="closeCreateModal()">Cancelar</button>
                            <button type="button" class="btn-next" onclick="nextSubStep('1_2')">Próximo</button>
                        </div>
                    </div>

                    <!-- Step 1.2 - Primeira Mensagem -->
                    <div class="wizard-step" id="wizardStep1_2">
                        <h3 style="margin-bottom: 24px; color: #fff; font-size: 1.5rem;">Primeira Mensagem</h3>
                        <div class="form-group">
                            <label>PRIMEIRA MENSAGEM</label>
                            <textarea id="createFirstMessage" rows="3" placeholder="Olá! Como posso ajudar você hoje?" required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-back" onclick="previousSubStep('1_1')">Voltar</button>
                            <button type="button" class="btn-next" onclick="nextSubStep('1_3')">Próximo</button>
                        </div>
                    </div>

                    <!-- Step 1.3 - Número de Telefone -->
                    <div class="wizard-step" id="wizardStep1_3">
                        <h3 style="margin-bottom: 24px; color: #fff; font-size: 1.5rem;">Número de Telefone</h3>
                        <div class="form-group">
                            <label>NÚMERO DE TELEFONE</label>
                            <select id="createPhoneNumber" required>
                                <option value="">Carregando números...</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-back" onclick="previousSubStep('1_2')">Voltar</button>
                            <button type="button" class="btn-next" onclick="nextSubStep('2_1')">Próximo</button>
                        </div>
                    </div>

                    <!-- Step 2.1 - Gênero -->
                    <div class="wizard-step" id="wizardStep2_1">
                        <h3 style="margin-bottom: 32px; color: #fff; font-size: 1.5rem; text-align: center;">Escolha o Gênero</h3>
                        <div class="form-group" style="max-width: 700px; margin: 0 auto;">
                            <p style="text-align: center; color: rgba(255,255,255,0.7); font-size: 0.95rem; margin-bottom: 32px;">Selecione o gênero que melhor representa seu assistente</p>
                            <input type="hidden" id="avatarGenero" value="" required>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                                <button type="button" class="method-choice-btn" onclick="selectGender('feminino')">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="8" r="4"/>
                                        <path d="M12 12c-4 0-7 2-7 5v2h14v-2c0-3-3-5-7-5z"/>
                                    </svg>
                                    <div style="font-size: 1.3rem; font-weight: 600; margin-top: 12px;">Feminino</div>
                                    <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6);">Voz e personalidade feminina</div>
                                </button>

                                <button type="button" class="method-choice-btn" onclick="selectGender('masculino')">
                                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="8" r="4"/>
                                        <path d="M12 12c-4 0-7 2-7 5v2h14v-2c0-3-3-5-7-5z"/>
                                    </svg>
                                    <div style="font-size: 1.3rem; font-weight: 600; margin-top: 12px;">Masculino</div>
                                    <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6);">Voz e personalidade masculina</div>
                                </button>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-back" onclick="previousSubStep('1_3')">Voltar</button>
                        </div>
                    </div>

                    <!-- Step 2.2 - Cor dos Olhos -->
                    <div class="wizard-step" id="wizardStep2_2">
                        <h3 style="margin-bottom: 48px; color: #fff; font-size: 1.5rem; text-align: center;">Cor dos Olhos</h3>
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div class="color-selector-grid" style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap;">
                                <div class="color-option-wrapper" style="text-align: center;">
                                    <div class="color-option color-azul" data-color="azul" onclick="selectEyeColor('azul')" style="cursor: pointer;"></div>
                                    <span class="color-label" style="display: block; margin-top: 8px;">Azul</span>
                                </div>
                                <div class="color-option-wrapper" style="text-align: center;">
                                    <div class="color-option color-castanho" data-color="castanho" onclick="selectEyeColor('castanho')" style="cursor: pointer;"></div>
                                    <span class="color-label" style="display: block; margin-top: 8px;">Castanho</span>
                                </div>
                                <div class="color-option-wrapper" style="text-align: center;">
                                    <div class="color-option color-verde" data-color="verde" onclick="selectEyeColor('verde')" style="cursor: pointer;"></div>
                                    <span class="color-label" style="display: block; margin-top: 8px;">Verde</span>
                                </div>
                                <div class="color-option-wrapper" style="text-align: center;">
                                    <div class="color-option color-mel" data-color="mel" onclick="selectEyeColor('mel')" style="cursor: pointer;"></div>
                                    <span class="color-label" style="display: block; margin-top: 8px;">Mel</span>
                                </div>
                                <div class="color-option-wrapper" style="text-align: center;">
                                    <div class="color-option color-cinza" data-color="cinza" onclick="selectEyeColor('cinza')" style="cursor: pointer;"></div>
                                    <span class="color-label" style="display: block; margin-top: 8px;">Cinza</span>
                                </div>
                            </div>
                            <input type="hidden" id="avatarOlhos" />
                        </div>
                        <div class="form-actions" style="margin-top: 48px;">
                            <button type="button" class="btn-back" onclick="previousSubStep('2_1')">Voltar</button>
                        </div>
                    </div>

                    <!-- Step 2.3 - Cor do Cabelo -->
                    <div class="wizard-step" id="wizardStep2_3">
                        <h3 style="margin-bottom: 48px; color: #fff; font-size: 1.5rem; text-align: center;">Cor do Cabelo</h3>
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div class="color-selector-grid" id="hairColorGrid" style="display: flex; justify-content: center; gap: 24px; flex-wrap: wrap;">
                                <!-- Opções serão inseridas dinamicamente -->
                            </div>
                            <input type="hidden" id="avatarCabelo" />
                        </div>
                        <div class="form-actions" style="margin-top: 48px;">
                            <button type="button" class="btn-back" onclick="previousSubStep('2_2')">Voltar</button>
                        </div>
                    </div>

                    <!-- Step 2.4 - Personalidade -->
                    <div class="wizard-step" id="wizardStep2_4">
                        <h3 style="margin-bottom: 32px; color: #fff; font-size: 1.5rem; text-align: center;">Personalidade</h3>
                        <div class="form-group" style="max-width: 600px; margin: 0 auto;">
                            <label style="text-align: center; font-size: 0.95rem; color: rgba(255,255,255,0.8);">Descreva as características do seu assistente</label>
                            <textarea id="avatarPersonalidade" rows="4" placeholder="Ex: Empática, profissional, carismática, amigável..." style="margin-top: 16px;"></textarea>
                        </div>

                        <!-- Pergunta sobre Identidade Visual -->
                        <div class="form-group" style="max-width: 600px; margin: 32px auto 0 auto;">
                            <label style="text-align: center; font-size: 0.95rem; color: rgba(255,255,255,0.8); display: block; margin-bottom: 20px;">
                                Deseja usar a identidade visual da sua empresa?
                            </label>
                            <div style="display: flex; gap: 20px; justify-content: center; align-items: center;">
                                <div onclick="document.querySelector('input[value=sim]').checked=true" style="
                                    display: flex;
                                    align-items: center;
                                    padding: 16px 32px;
                                    background: rgba(255,255,255,0.05);
                                    border: 2px solid rgba(102, 126, 234, 0.3);
                                    border-radius: 12px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    min-width: 150px;
                                    justify-content: center;
                                ">
                                    <input type="radio" name="identidadeVisual" value="sim" style="
                                        width: 18px;
                                        height: 18px;
                                        margin-right: 12px;
                                        cursor: pointer;
                                        accent-color: #667eea;
                                    ">
                                    <span style="color: white; font-weight: 500; font-size: 1rem;">Sim</span>
                                </div>
                                <div onclick="document.querySelector('input[value=nao]').checked=true" style="
                                    display: flex;
                                    align-items: center;
                                    padding: 16px 32px;
                                    background: rgba(255,255,255,0.05);
                                    border: 2px solid rgba(102, 126, 234, 0.3);
                                    border-radius: 12px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    min-width: 150px;
                                    justify-content: center;
                                ">
                                    <input type="radio" name="identidadeVisual" value="nao" style="
                                        width: 18px;
                                        height: 18px;
                                        margin-right: 12px;
                                        cursor: pointer;
                                        accent-color: #667eea;
                                    ">
                                    <span style="color: white; font-weight: 500; font-size: 1rem;">Não</span>
                                </div>
                            </div>
                        </div>

                        <!-- CSS para as caixinhas de identidade visual -->
                        <style>
                            div[onclick*="value=sim"]:hover, div[onclick*="value=nao"]:hover {
                                background: rgba(102, 126, 234, 0.15) !important;
                                border-color: rgba(102, 126, 234, 0.6) !important;
                                transform: translateY(-2px);
                                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
                            }
                        </style>


                        <div class="form-actions">
                            <button type="button" class="btn-back" onclick="previousSubStep('2_3')">Voltar</button>
                            <button type="button" class="btn-next" id="gerarAvatarBtn" onclick="gerarAvatares()">
                                <span id="gerarAvatarText">Gerar Assistente</span>
                                <div class="spinner" id="gerarAvatarLoader" style="display: none;"></div>
                            </button>
                        </div>

                        <!-- Grid de Avatares Gerados -->
                        <div id="avatarsGrid" style="display: none; margin-top: 24px;">
                            <h4 style="color: #fff; margin-bottom: 16px;">Escolha o avatar:</h4>
                            <div class="avatars-container" id="avatarsContainer"></div>
                            <div class="form-actions" style="margin-top: 24px;">
                                <button type="button" class="btn-back" onclick="voltarParaPersonalidade()">Voltar</button>
                                <button type="button" class="btn-next" onclick="nextStep(3)" id="continuarAposAvatar" disabled>Continuar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 - Seleção de Voz -->
                    <div class="wizard-step" id="wizardStep3">
                        <h3 style="margin-bottom: 24px; color: #fff; font-size: 1.5rem;">Seleção de Voz</h3>
                        <div class="form-group">
                            <label>SELECIONE A VOZ DO ASSISTENTE</label>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 16px;">
                                Vozes filtradas pelo gênero selecionado
                            </p>
                            <div class="voices-grid" id="voicesGrid"></div>
                            <input type="hidden" id="selectedVoiceId" value="x6uRgOliu4lpcrqMH3s1" />
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-back" onclick="previousStep(2)">Voltar</button>
                            <button type="button" class="btn-next" onclick="nextStep(4)">Continuar</button>
                        </div>
                    </div>

                    <!-- Step 4 - Criação do Prompt -->
                    <div class="wizard-step" id="wizardStep4">
                        <h3 style="margin-bottom: 24px; color: #fff; font-size: 1.5rem;">Criação do Prompt</h3>
                        <div id="promptMethodChoice">
                            <div class="form-group">
                                <label>COMO DESEJA CRIAR O PROMPT?</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 24px;">
                                    <button type="button" class="method-choice-btn" onclick="selectPromptMethod('manual')">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                        <div style="font-size: 1.2rem; font-weight: 600;">Escrever Prompt</div>
                                        <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); text-align: center;">Escreva manualmente o comportamento do assistente</div>
                                    </button>
                                    
                                    <button type="button" class="method-choice-btn" onclick="selectPromptMethod('ai')">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M12 6v6l4 2"/>
                                        </svg>
                                        <div style="font-size: 1.2rem; font-weight: 600;">Criar com IA</div>
                                        <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6); text-align: center;">Responda perguntas e a IA cria o prompt para você</div>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn-back" onclick="previousStep(3)">Voltar</button>
                            </div>
                        </div>

                        <div id="promptManualForm" style="display: none;">
                            <div class="form-group">
                                <label>PROMPT DO SISTEMA</label>
                                <textarea id="createPrompt" rows="12" placeholder="Defina o comportamento do assistente..." required></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-back" onclick="backToMethodChoice()">Voltar</button>
                                <button type="button" class="btn-next" onclick="goToStep('4_5')">Próximo</button>
                            </div>
                        </div>

                        <div id="promptAIForm" style="display: none; max-height: 60vh; overflow-y: auto; overflow-x: hidden; padding-right: 12px;">
                            <!-- SEÇÃO 1: INFORMAÇÕES DO ASSISTENTE -->
                            <h4 style="color: #A594FF; margin-top: 8px; margin-bottom: 16px; font-size: 1.1rem;">INFORMAÇÕES DO ASSISTENTE</h4>


                            <div class="form-group">
                                <label>Função Principal *</label>
                                <input type="text" id="aiFuncao" placeholder="Ex: Atendimento, Qualificação de Leads, Agendamento..." />
                            </div>

                            <!-- SEÇÃO 2: CONTEXTO DO NEGÓCIO -->
                            <h4 style="color: #A594FF; margin-top: 24px; margin-bottom: 16px; font-size: 1.1rem;">CONTEXTO DO NEGÓCIO</h4>

                            <div class="form-group">
                                <label>1. Nome da empresa *</label>
                                <input type="text" id="aiNomeEmpresa" placeholder="Nome completo da sua empresa" />
                            </div>

                            <div class="form-group">
                                <label>2. Segmento de atuação *</label>
                                <input type="text" id="aiSegmento" placeholder="Ex: Tecnologia, Imobiliária, Advocacia..." />
                            </div>

                            <div class="form-group">
                                <label>3. Principal produto/serviço oferecido *</label>
                                <textarea id="aiProdutoServico" rows="3" placeholder="Descreva detalhadamente o que vocês oferecem"></textarea>
                            </div>

                            <div class="form-group">
                                <label>4. Qual o principal diferencial da empresa? *</label>
                                <textarea id="aiDiferencialEmpresa" rows="3" placeholder="Ex: Única empresa com certificação X, Metodologia própria, 10 anos de experiência..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>5. Resultados típicos que entregam (com números) *</label>
                                <textarea id="aiResultadosTipicos" rows="3" placeholder="Ex: Reduzimos em média 30% dos custos operacionais em 60 dias"></textarea>
                            </div>

                            <!-- SEÇÃO 3: PÚBLICO-ALVO E ORIGEM DOS LEADS -->
                            <h4 style="color: #A594FF; margin-top: 32px; margin-bottom: 16px; font-size: 1.1rem;">PÚBLICO-ALVO E ORIGEM DOS LEADS</h4>

                            <div class="form-group">
                                <label>6. Público/Persona do seu alvo *</label>
                                <textarea id="aiPublicoAlvo" rows="3" placeholder="Ex: CEO, diretor comercial, mães, idade 30-60 anos, casado e etc..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>7. De onde vêm seus leads? (marque todos que se aplicam) *</label>
                                <div id="aiOrigemLeads" style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="origemLeads[]" value="Meta Ads" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Meta Ads</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="origemLeads[]" value="Google Ads" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Google Ads</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="origemLeads[]" value="Instagram/orgânico" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Instagram/orgânico</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="origemLeads[]" value="Indicações" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Indicações</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="origemLeads[]" value="Eventos/feiras" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Eventos/feiras</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="origemLeads[]" value="Prospecção Ativa" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Prospecção Ativa</span>
                                    </label>
                                    <label style="display: flex; align-items: flex-start; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="origemLeads[]" value="Outro" id="origemOutroCheck" style="width: 18px; height: 18px; cursor: pointer; margin-top: 10px;" />
                                        <div style="flex: 1;">
                                            <span style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 8px;">Outro:</span>
                                            <input type="text" id="aiOrigemOutro" placeholder="Especifique" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(165,148,255,0.3); border-radius: 8px; color: #fff; font-size: 0.95rem;" />
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>8. Principais dores do seu cliente ideal *</label>
                                <textarea id="aiDoresCliente" rows="3" placeholder="Ex: Alto custo operacional, processos manuais e demorados, falta de controle de resultados..."></textarea>
                            </div>

                            <!-- SEÇÃO 4: ROTEIRO DE CONVERSA -->
                            <h4 style="color: #A594FF; margin-top: 32px; margin-bottom: 16px; font-size: 1.1rem;">ROTEIRO DE CONVERSA</h4>

                            <div class="form-group">
                                <label>9. Como a IA deve se apresentar? *</label>
                                <textarea id="aiApresentacao" rows="3" placeholder="Ex: Oi [nome]! Aqui é a Mariana da [empresa], está podendo falar um minutinho?"></textarea>
                            </div>

                            <div class="form-group">
                                <label>10. Qual a primeira pergunta para engajar o lead? *</label>
                                <textarea id="aiPrimeiraPergunta" rows="3" placeholder="Ex: Vi que se interessou pelo nosso material sobre X, o que te chamou mais atenção?"></textarea>
                            </div>

                            <!-- SEÇÃO 5: OBJEÇÕES E RESPOSTAS -->
                            <h4 style="color: #A594FF; margin-top: 32px; margin-bottom: 16px; font-size: 1.1rem;">OBJEÇÕES E RESPOSTAS</h4>

                            <div class="form-group">
                                <label>11. Quais as principais objeções e como a IA pode contorná-las... *</label>
                                <textarea id="aiObjecoes" rows="4" placeholder="Liste as principais objeções e as respostas sugeridas"></textarea>
                            </div>

                            <!-- SEÇÃO 6: INFORMAÇÕES TÉCNICAS DO SETOR -->
                            <h4 style="color: #A594FF; margin-top: 32px; margin-bottom: 16px; font-size: 1.1rem;">INFORMAÇÕES TÉCNICAS DO SETOR</h4>

                            <div class="form-group">
                                <label>12. Termos técnicos importantes *</label>
                                <textarea id="aiTermosTecnicos" rows="3" placeholder="Liste os jargões e termos específicos do seu setor que a IA deve conhecer e usar corretamente..."></textarea>
                            </div>

                            <div class="form-group">
                                <label>13. Métricas e benchmarks do setor *</label>
                                <textarea id="aiMetricas" rows="3" placeholder="Ex: Taxa de conversão média do setor: 2-3%, Ticket Médio: R$5.000,00"></textarea>
                            </div>

                            <div class="form-group">
                                <label>14. Principais concorrentes *</label>
                                <textarea id="aiConcorrentes" rows="3" placeholder="Ex: Empresa A, empresa B, empresa C"></textarea>
                            </div>

                            <!-- SEÇÃO 7: PROCESSO DE AGENDAMENTO/QUALIFICAÇÃO -->
                            <h4 style="color: #A594FF; margin-top: 32px; margin-bottom: 16px; font-size: 1.1rem;">PROCESSO DE AGENDAMENTO/QUALIFICAÇÃO</h4>

                            <div class="form-group">
                                <label>15. O que será agendado/qualificado? *</label>
                                <div id="aiTipoAgendamento" style="display: flex; flex-direction: column; gap: 10px; margin-top: 12px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="tipoAgendamento[]" value="Demonstração" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Demonstração</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="tipoAgendamento[]" value="Diagnóstico" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Diagnóstico</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="tipoAgendamento[]" value="Consultoria" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Consultoria</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="tipoAgendamento[]" value="Análise de caso" style="width: 18px; height: 18px; cursor: pointer;" />
                                        <span style="color: rgba(255,255,255,0.9);">Análise de caso</span>
                                    </label>
                                    <label style="display: flex; align-items: flex-start; gap: 12px; font-weight: normal; text-transform: none; font-size: 0.95rem; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;">
                                        <input type="checkbox" name="tipoAgendamento[]" value="Outro" id="tipoAgendamentoOutroCheck" style="width: 18px; height: 18px; cursor: pointer; margin-top: 10px;" />
                                        <div style="flex: 1;">
                                            <span style="color: rgba(255,255,255,0.9); display: block; margin-bottom: 8px;">Outro:</span>
                                            <input type="text" id="aiTipoAgendamentoOutro" placeholder="Especifique" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(165,148,255,0.3); border-radius: 8px; color: #fff; font-size: 0.95rem;" />
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>16. Duração da reunião (Se houver)</label>
                                <input type="text" id="aiDuracaoReuniao" placeholder="Ex: 30 minutos, 1 hora..." />
                            </div>

                            <div class="form-group">
                                <label>17. Como a IA deve propor o agendamento? *</label>
                                <textarea id="aiPropostaAgendamento" rows="3" placeholder="Ex: Que tal agendarmos uma análise gratuita de 30 minutos para eu te mostrar exatamente como podemos ajudar?"></textarea>
                            </div>

                            <!-- SEÇÃO 8: VALORES E CULTURA -->
                            <h4 style="color: #A594FF; margin-top: 32px; margin-bottom: 16px; font-size: 1.1rem;">VALORES E CULTURA</h4>

                            <div class="form-group">
                                <label>18. Missão da empresa *</label>
                                <textarea id="aiMissao" rows="3" placeholder="Porque sua empresa existe? Qual impacto ela quer gerar?"></textarea>
                            </div>

                            <div class="form-group">
                                <label>19. Valores principais (liste até 5) *</label>
                                <textarea id="aiValores" rows="3" placeholder="Ex: Inovação, transparência, excelência, respeito, sustentabilidade"></textarea>
                            </div>

                            <div class="form-group">
                                <label>20. Slogan/Tagline</label>
                                <input type="text" id="aiSlogan" placeholder="Ex: Transformando negócios através da tecnologia" />
                            </div>

                            <!-- SEÇÃO 9: INFORMAÇÕES ADICIONAIS -->
                            <h4 style="color: #A594FF; margin-top: 32px; margin-bottom: 16px; font-size: 1.1rem;">INFORMAÇÕES ADICIONAIS</h4>

                            <div class="form-group">
                                <label>21. Cases de sucesso (descreva 2-3) *</label>
                                <textarea id="aiCasesSucesso" rows="4" placeholder="Ex: Empresa X reduziu até 30% dos custos em 3 meses/Cliente Y aumentou em 40% sua produtividade."></textarea>
                            </div>

                            <div class="form-group">
                                <label>22. Instruções especiais</label>
                                <textarea id="aiInstrucoesEspeciais" rows="3" placeholder="Ex: Sempre mencionar a decisão do STF, nunca prometer resultados específicos, etc"></textarea>
                            </div>

                            <div class="form-group">
                                <label>23. Se houver algo a mais para pontuar, o momento é esse! Fique à vontade...</label>
                                <textarea id="aiInformacoesAdicionais" rows="3" placeholder="Qualquer informação adicional relevante..."></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-back" onclick="backToMethodChoice()">Voltar</button>
                                <button type="button" class="btn-next" id="generatePromptBtn" onclick="generatePromptWithAI()">
                                    <span id="generateBtnText">Gerar Prompt com IA</span>
                                </button>
                            </div>
                        </div>

                        <div id="promptPreviewForm" style="display: none;">
                            <div class="form-group">
                                <label>PROMPT GERADO PELA IA</label>
                                <textarea id="generatedPromptPreview" rows="16"></textarea>
                                <small class="form-helper">Você pode editar antes de continuar</small>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn-back" onclick="backToAIForm()">Voltar</button>
                                <button type="button" class="btn-next" onclick="confirmGeneratedPrompt()">Confirmar e Continuar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4.5 - Success Evaluation -->
                    <div class="wizard-step" id="wizardStep4_5">
                        <h3 style="margin-bottom: 24px; color: #fff; font-size: 1.5rem;">Success Evaluation</h3>
                        <div class="form-group">
                            <label>CRITÉRIO DE AVALIAÇÃO DE SUCESSO</label>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.95rem; margin-bottom: 16px; line-height: 1.6;">
                                Defina o que seria considerado uma chamada bem-sucedida. Exemplos: agendar reunião, coletar dados específicos, qualificar lead, confirmar interesse.
                            </p>
                            <textarea id="createSuccessEvaluation" rows="6" placeholder="Ex: A chamada é considerada um sucesso se a IA conseguir agendar uma demonstração ou diagnóstico com o lead, confirmando data, horário e obtendo confirmação verbal do compromisso."></textarea>
                            <small class="form-helper">Este critério ajudará a avaliar automaticamente se cada chamada atingiu seu objetivo principal.</small>
                        </div>

                        <!-- NOVAS CONFIGURAÇÕES VAPI -->
                        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(165, 148, 255, 0.2);">
                            <h4 style="color: #A594FF; margin-bottom: 20px; font-size: 1.1rem;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                </svg>
                                Configurações Avançadas
                            </h4>
                            
                            <!-- First Message Mode -->
                            <div class="form-group">
                                <label>MODO DE INÍCIO DA CHAMADA</label>
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 12px;">
                                    Define quem fala primeiro quando a chamada é conectada.
                                </p>
                                <select id="createFirstMessageMode" style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(165, 148, 255, 0.3); border-radius: 8px; color: #fff; font-size: 1rem;">
                                    <option value="assistant-speaks-first">Assistente fala primeiro</option>
                                    <option value="assistant-waits-for-user">Assistente aguarda o lead falar</option>
                                </select>
                                <small class="form-helper">Recomendado: "Assistente fala primeiro" para chamadas outbound.</small>
                            </div>

                            <!-- Summary Prompt -->
                            <div class="form-group" style="margin-top: 20px;">
                                <label>PROMPT DE RESUMO DA CHAMADA</label>
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 12px;">
                                    Defina como a IA deve resumir cada chamada. Deixe em branco para desativar o resumo.
                                </p>
                                <textarea id="createSummaryPrompt" rows="5" placeholder="Ex: Faça um resumo em português, breve e executivo. Resuma em poucas linhas a conversa, com detalhes relevantes. Não use tópicos ou quebras de linha.">Faça um resumo em português, breve, executivo e humanizado, resumindo em poucas linhas a reunião com detalhes quando conveniente. É extremamente importante que não quebre nenhuma linha e não faça nenhum tópico. Escreva um texto corrido como: "A reunião iniciou com o cliente falando sobre X, no meio ele comentou Y, demonstrou interesse e parece qualificado. Consegui marcar a reunião no final."</textarea>
                                <small class="form-helper">Este prompt instrui a IA sobre como gerar o resumo após cada chamada.</small>
                            </div>

                            <!-- Enable End Call -->
                            <div class="form-group" style="margin-top: 20px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="createEnableEndCall" style="width: 20px; height: 20px; margin-right: 12px; accent-color: #A594FF;">
                                    <span>PERMITIR ASSISTENTE ENCERRAR CHAMADA</span>
                                </label>
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-top: 8px; margin-left: 32px;">
                                    Quando habilitado, a IA pode encerrar a chamada autonomamente.
                                </p>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-back" onclick="previousStep(4)">Voltar</button>
                            <button type="button" class="btn-next" onclick="nextStep(5)">Próximo</button>
                        </div>
                    </div>

                    <!-- Step 5 - Revisão -->
                    <div class="wizard-step" id="wizardStep5">
                        <h3 style="margin-bottom: 32px; color: #fff; font-size: 1.5rem; text-align: center;">Revise as informações</h3>

                        <!-- Avatar Card estilo currículo -->
                        <div style="max-width: 500px; margin: 0 auto 32px auto; background: rgba(255,255,255,0.05); border-radius: 16px; padding: 32px; text-align: center;">
                            <div style="width: 150px; height: 150px; margin: 0 auto 24px; border-radius: 50%; overflow: hidden; border: 4px solid #A594FF; box-shadow: 0 8px 24px rgba(165,148,255,0.3);">
                                <img id="summaryAvatar" src="" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>

                            <h4 id="summaryNameCard" style="color: #fff; font-size: 1.8rem; margin-bottom: 8px; font-weight: 600;"></h4>
                            <p id="summaryPersonality" style="color: rgba(255,255,255,0.7); font-size: 1rem; margin-bottom: 16px; font-style: italic;"></p>
                        </div>

                        <!-- Informações resumidas -->
                        <div style="max-width: 600px; margin: 0 auto;">
                            <div class="summary-box">
                                <div class="summary-item">
                                    <div class="summary-label">Primeira Mensagem</div>
                                    <div class="summary-value" id="summaryFirstMessage"></div>
                                </div>
                            </div>

                            <div class="summary-box">
                                <div class="summary-item">
                                    <div class="summary-label">Voz Selecionada</div>
                                    <div class="summary-value" id="summaryVoice"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-back" onclick="goToStep('4_5')">Voltar</button>
                            <button type="button" class="btn-confirm" id="saveCreateBtn" onclick="handleCreateAssistantClick(event)">
                                <span id="createBtnText">Criar Assistente</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- EDIÇÃO ANTIGA (MODAL) — DESATIVADA
         A edição agora é feita exclusivamente em `assistente-editor.html` como parte do SaaS (sem duplicação).
    -->
    <div id="editModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Configurações do Assistente</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tab-content active">
                    <form id="editForm">
                        <div class="form-group">
                            <label>NOME DO ASSISTENTE</label>
                            <input type="text" id="editAssistenteName" required />
                        </div>

                        <div class="form-group">
                            <label>PRIMEIRA MENSAGEM</label>
                            <textarea id="editFirstMessage" rows="3" required></textarea>
                        </div>

                        <div class="form-group">
                            <label>NÚMERO DE TELEFONE</label>
                            <input type="hidden" id="editPhoneNumber" />
                            <div id="editPhoneInfo" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: linear-gradient(135deg, rgba(165, 148, 255, 0.15) 0%, rgba(165, 148, 255, 0.05) 100%); border: 1px solid rgba(165, 148, 255, 0.2); border-radius: 12px; margin-bottom: 12px; transition: all 0.3s ease;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 6px;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #A594FF 0%, #8B7BE8 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(165, 148, 255, 0.3);">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <div style="color: white; font-size: 15px; font-weight: 600; margin-bottom: 2px;" id="editCurrentPhoneName">Carregando...</div>
                                            <div style="color: rgba(255, 255, 255, 0.5); font-size: 12px; line-height: 1.4;" id="editCurrentPhoneNumber">-</div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="toggleEditPhoneSelector()" style="padding: 10px 20px; background: linear-gradient(135deg, #A594FF 0%, #8B7BE8 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(165, 148, 255, 0.3); white-space: nowrap;">
                                    Alterar Número
                                </button>
                            </div>
                            <select id="editPhoneNumberSelect" style="display: none; width: 100%; padding: 12px 16px; background: rgba(20, 20, 35, 0.8); border: 1px solid rgba(165, 148, 255, 0.3); border-radius: 8px; color: white; font-size: 14px; outline: none;" required>
                                <option value="">Carregando...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>VOZ DO ASSISTENTE</label>
                            <input type="hidden" id="editSelectedVoiceId" />
                            <div id="editVoiceInfo" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: linear-gradient(135deg, rgba(165, 148, 255, 0.15) 0%, rgba(165, 148, 255, 0.05) 100%); border: 1px solid rgba(165, 148, 255, 0.2); border-radius: 12px; margin-bottom: 12px; transition: all 0.3s ease;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 6px;">
                                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #A594FF 0%, #8B7BE8 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(165, 148, 255, 0.3);">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                                <line x1="8" y1="23" x2="16" y2="23"></line>
                                            </svg>
                                        </div>
                                        <div>
                                            <div style="color: white; font-size: 15px; font-weight: 600; margin-bottom: 2px;" id="editCurrentVoiceName">Carregando...</div>
                                            <div style="color: rgba(255, 255, 255, 0.5); font-size: 12px; line-height: 1.4;" id="editCurrentVoiceDesc">-</div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="toggleEditVoiceSelector()" style="padding: 10px 20px; background: linear-gradient(135deg, #A594FF 0%, #8B7BE8 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(165, 148, 255, 0.3); white-space: nowrap;">
                                    Alterar Voz
                                </button>
                            </div>
                            <div id="editVoicesGrid" class="voices-grid" style="display: none;"></div>
                        </div>

                        <div class="form-group">
                            <label>SUCCESS EVALUATION (CRITÉRIO DE SUCESSO)</label>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 12px; line-height: 1.5;">
                                Define o que seria considerado uma chamada bem-sucedida para este assistente.
                            </p>
                            <textarea id="editSuccessEvaluation" rows="5" placeholder="Ex: A chamada é considerada um sucesso se conseguir agendar uma reunião ou coletar todos os dados necessários."></textarea>
                            <small class="form-helper">Este critério ajuda a avaliar automaticamente o desempenho de cada chamada.</small>
                        </div>

                        <!-- NOVAS CONFIGURAÇÕES VAPI -->
                        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(165, 148, 255, 0.2);">
                            <h4 style="color: #A594FF; margin-bottom: 20px; font-size: 1.1rem;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                </svg>
                                Configurações Avançadas
                            </h4>
                            
                            <!-- First Message Mode -->
                            <div class="form-group">
                                <label>MODO DE INÍCIO DA CHAMADA</label>
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 12px;">
                                    Define quem fala primeiro quando a chamada é conectada.
                                </p>
                                <select id="editFirstMessageMode" style="width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(165, 148, 255, 0.3); border-radius: 8px; color: #fff; font-size: 1rem;">
                                    <option value="assistant-speaks-first">Assistente fala primeiro</option>
                                    <option value="assistant-waits-for-user">Assistente aguarda o lead falar</option>
                                </select>
                                <small class="form-helper">Recomendado: "Assistente fala primeiro" para chamadas outbound.</small>
                            </div>

                            <!-- Summary Prompt -->
                            <div class="form-group" style="margin-top: 20px;">
                                <label>PROMPT DE RESUMO DA CHAMADA</label>
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-bottom: 12px;">
                                    Defina como a IA deve resumir cada chamada. Deixe em branco para desativar o resumo.
                                </p>
                                <textarea id="editSummaryPrompt" rows="5" placeholder="Ex: Faça um resumo em português, breve e executivo. Resuma em poucas linhas a conversa, com detalhes relevantes. Não use tópicos ou quebras de linha.">Faça um resumo em português, breve, executivo e humanizado, resumindo em poucas linhas a reunião com detalhes quando conveniente. É extremamente importante que não quebre nenhuma linha e não faça nenhum tópico. Escreva um texto corrido como: "A reunião iniciou com o cliente falando sobre X, no meio ele comentou Y, demonstrou interesse e parece qualificado. Consegui marcar a reunião no final."</textarea>
                                <small class="form-helper">Este prompt instrui a IA sobre como gerar o resumo após cada chamada.</small>
                            </div>

                            <!-- Enable End Call -->
                            <div class="form-group" style="margin-top: 20px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="editEnableEndCall" style="width: 20px; height: 20px; margin-right: 12px; accent-color: #A594FF;">
                                    <span>PERMITIR ASSISTENTE ENCERRAR CHAMADA</span>
                                </label>
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin-top: 8px; margin-left: 32px;">
                                    Quando habilitado, a IA pode encerrar a chamada autonomamente.
                                </p>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="closeEditModal()" class="btn-cancel">Cancelar</button>
                            <button type="submit" id="saveEditBtn" class="btn-confirm">
                                <span id="editBtnText">Salvar Alterações</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ABA TOOLS -->
                <div id="toolsTab" class="tab-content">
                    <div class="tools-grid">
                        <!-- Tool: Agendamento -->
                        <div class="tool-card" data-tool-id="agendamento">
                            <div class="tool-toggle" onclick="toggleTool(event)"></div>
                            <div class="tool-card-header">
                                <div class="tool-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                </div>
                                <div class="tool-info">
                                    <h4>Agendamento</h4>
                                    <p>Enviar link de agendamento</p>
                                </div>
                            </div>
                            <div class="tool-resources">
                                <h5>Recursos:</h5>
                                <div class="resource-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    <span>Direto pelo Whatsapp da Assistente</span>
                                </div>
                                <div class="resource-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    <span>Confirmação direto nas mensagens</span>
                                </div>
                            </div>
                            <div class="tool-config" style="display: block; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(165, 148, 255, 0.2);">
                                <div class="tool-form-group">
                                    <label class="tool-form-label">Instância:</label>
                                    <select class="tool-form-select tool-instance-select" data-field="instance" onclick="event.stopPropagation();">
                                        <option value="">Carregando instâncias...</option>
                                    </select>
                                </div>
                                <div class="tool-form-group">
                                    <label class="tool-form-label">Link ou Mensagem:</label>
                                    <input type="text" class="tool-form-input" data-field="url" placeholder="Ex: https://calendly.com/seu-link" onclick="event.stopPropagation();">
                                </div>
                            </div>
                        </div>

                        <!-- Tool: Sucesso -->
                        <div class="tool-card" data-tool-id="sucesso" style="display: none;">
                            <div class="tool-toggle" onclick="toggleTool(event)"></div>
                            <div class="tool-card-header">
                                <div class="tool-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                    </svg>
                                </div>
                                <div class="tool-info">
                                    <h4>Sucesso</h4>
                                    <p>Métricas e conversões</p>
                                </div>
                            </div>
                            <div class="tool-resources">
                                <h5>Recursos:</h5>
                                <div class="resource-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    <span>Rastreamento de conversões</span>
                                </div>
                                <div class="resource-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    <span>Análise de performance</span>
                                </div>
                                <div class="resource-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    <span>Relatórios detalhados</span>
                                </div>
                            </div>
                            <div class="tool-config" style="display: block; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(165, 148, 255, 0.2);">
                                <div class="tool-form-group">
                                    <label class="tool-form-label">Link ou Mensagem:</label>
                                    <input type="text" class="tool-form-input" data-field="url" placeholder="Ex: https://seu-webhook.com/sucesso" onclick="event.stopPropagation();">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions" style="margin-top: 24px;">
                        <button type="button" class="btn-confirm" onclick="saveTools()">
                            <span>Salvar Configurações</span>
                        </button>
                    </div>
                </div>

                <!-- ABA EDITOR IA - FLOW EDITOR -->
                <div id="editorTab" class="tab-content">
                    <div class="flow-editor-wrapper">
                        <!-- Header do Flow Editor -->
                        <div class="flow-editor-header">
                            <div class="flow-editor-header-left">
                                <h3 style="margin: 0; color: #fff; font-size: 1.1rem; font-weight: 600;">Editor de Fluxo</h3>
                                <span style="color: rgba(255,255,255,0.5); font-size: 0.85rem;" id="flowEditorStatus">Rascunho</span>
                            </div>
                            <div class="flow-editor-header-right">
                                <button class="flow-header-btn" onclick="flowEditorPreview()" title="Visualizar">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    <span>Visualizar</span>
                                </button>
                                <button class="flow-header-btn" onclick="flowEditorExport()" title="Exportar JSON">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    <span>Exportar</span>
                                </button>
                                <button class="flow-header-btn btn-save-flow" onclick="flowEditorSave()" title="Salvar Flow">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                        <polyline points="7 3 7 8 15 8"></polyline>
                                    </svg>
                                    <span>Salvar</span>
                                </button>
                            </div>
                        </div>

                        <!-- Corpo do Flow Editor -->
                        <div class="flow-editor-body">
                            <!-- Sidebar de Blocks -->
                            <div class="flow-blocks-palette" id="flowBlocksPalette">
                                <div class="palette-header">
                                    <h4>Blocos</h4>
                                    <button class="palette-toggle" onclick="togglePalette()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </button>
                                </div>
                                <div class="palette-content">
                                    <div class="palette-section">
                                        <div class="palette-section-title">Estrutura</div>
                                        <div class="palette-blocks">
                                            <div class="palette-block" draggable="true" data-type="primeira_mensagem" onclick="addFlowBlock('primeira_mensagem')">
                                                <div class="palette-block-icon" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6;">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                                    </svg>
                                                </div>
                                                <div class="palette-block-info">
                                                    <div class="palette-block-name">Primeira Mensagem</div>
                                                    <div class="palette-block-desc">Saudação inicial</div>
                                                </div>
                                            </div>
                                            <div class="palette-block" draggable="true" data-type="texto" onclick="addFlowBlock('texto')">
                                                <div class="palette-block-icon" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                                    </svg>
                                                </div>
                                                <div class="palette-block-info">
                                                    <div class="palette-block-name">Mensagem</div>
                                                    <div class="palette-block-desc">Enviar texto</div>
                                                </div>
                                            </div>
                                            <div class="palette-block" draggable="true" data-type="conectivos" onclick="addFlowBlock('conectivos')">
                                                <div class="palette-block-icon" style="background: rgba(168, 85, 247, 0.2); color: #a855f7;">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                </div>
                                                <div class="palette-block-info">
                                                    <div class="palette-block-name">Caminhos</div>
                                                    <div class="palette-block-desc">Direcionar respostas</div>
                                                </div>
                                            </div>
                                            <div class="palette-block" draggable="true" data-type="aguardar" onclick="addFlowBlock('aguardar')">
                                                <div class="palette-block-icon" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                </div>
                                                <div class="palette-block-info">
                                                    <div class="palette-block-name">Aguardar</div>
                                                    <div class="palette-block-desc">Aguardar resposta</div>
                                                </div>
                                            </div>
                                            <div class="palette-block" draggable="true" data-type="encerrar" onclick="addFlowBlock('encerrar')">
                                                <div class="palette-block-icon" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <line x1="15" y1="9" x2="9" y2="15"></line>
                                                        <line x1="9" y1="9" x2="15" y2="15"></line>
                                                    </svg>
                                                </div>
                                                <div class="palette-block-info">
                                                    <div class="palette-block-name">Encerrar</div>
                                                    <div class="palette-block-desc">Finalizar conversa</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="palette-section">
                                        <div class="palette-section-title">Tools</div>
                                        <div class="palette-blocks" id="flowToolsPalette">
                                            <div class="palette-loading">Carregando tools...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Canvas do Flow -->
                            <div class="flow-canvas-wrapper">
                                <div class="flow-canvas" id="flowCanvas">
                                    <div class="flow-start-node">
                                        <div class="start-node-icon">
                                            <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                            </svg>
                                        </div>
                                        <span>Início</span>
                                    </div>
                                    <div class="flow-blocks-container" id="flowBlocksContainer">
                                        <!-- Blocks serão inseridos aqui via JavaScript -->
                                    </div>
                                    <div class="flow-end-node">
                                        <span>FIM</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Painel de Propriedades -->
                            <div class="flow-properties-panel" id="flowPropertiesPanel" style="display: none;">
                                <div class="properties-header">
                                    <h4>Propriedades</h4>
                                    <button class="properties-close" onclick="closeFlowProperties()">×</button>
                                </div>
                                <div class="properties-content" id="flowPropertiesContent">
                                    <!-- Conteúdo dinâmico -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="delete-modal-content">
            <div class="delete-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
            </div>
            <h2>Excluir Assistente?</h2>
            <p class="delete-assistant-name" id="deleteAssistenteName"></p>
            <p class="delete-warning">Esta ação não pode ser desfeita.</p>
            <div class="delete-actions">
                <button class="btn-delete-cancel" onclick="closeDeleteModal()">Cancelar</button>
                <button class="btn-delete-confirm" id="confirmDeleteBtn" onclick="confirmarExclusao()">
                    <span id="deleteBtnText">Excluir Assistente</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmar Duplicação -->
    <div id="duplicateConfirmModal" class="modal" style="display: none; align-items: center; justify-content: center;">
        <div class="modal-content" style="max-width: 480px; margin: 0;">
            <div class="modal-header" style="padding: 28px 28px 20px;">
                <h2 class="modal-title" style="font-size: 1.4rem; margin: 0;">Duplicar Assistente?</h2>
                <span class="close" onclick="closeDuplicateModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px 32px 32px;">
                <p style="text-align: center; margin-bottom: 20px; font-size: 1rem; line-height: 1.7; color: rgba(255,255,255,0.9);">
                    Você está prestes a duplicar o assistente <strong id="duplicateAssistenteName" style="color: #A594FF;"></strong>.
                </p>
                <p style="text-align: center; color: rgba(255,255,255,0.65); font-size: 0.92rem; margin: 0;">
                    Uma cópia exata será criada com todas as configurações.
                </p>
            </div>
            <div style="display: flex; gap: 12px; padding: 0 28px 28px;">
                <button type="button" class="btn-cancel" onclick="closeDuplicateModal()" style="flex: 1; padding: 14px 24px; font-size: 0.95rem;">
                    Cancelar
                </button>
                <button type="button" class="btn-confirm" onclick="confirmarDuplicacao()" id="confirmDuplicateBtn" style="flex: 1; padding: 14px 24px; font-size: 0.95rem;">
                    <span id="duplicateBtnText">Duplicar</span>
                </button>
            </div>
        </div>
    </div>

    <div id="callsModal" class="modal">
        <div class="modal-content calls-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Resumo de Calls por Assistente</h2>
                <span class="close" onclick="fecharModalCalls()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="callsList" class="calls-list"></div>
                <button class="ver-conversas-btn" onclick="irParaConversas()">Ver todas as conversas</button>
            </div>
        </div>
    </div>

    <!-- Modal: Sem Números Cadastrados -->
    <div id="noNumbersModal" class="modal" style="display: none; align-items: center; justify-content: center;">
        <div class="modal-content" style="max-width: 480px; margin: 0;">
            <div class="modal-header" style="padding: 28px 28px 20px;">
                <h2 class="modal-title" style="font-size: 1.4rem; margin: 0;">Sem Números Cadastrados</h2>
                <span class="close" onclick="closeNoNumbersModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px 32px 32px;">
                <p style="text-align: center; margin-bottom: 20px; font-size: 1rem; line-height: 1.7; color: rgba(255,255,255,0.9);">
                    Para criar um assistente, você precisa primeiro adquirir um número de telefone.
                </p>
                <p style="text-align: center; color: rgba(255,255,255,0.65); font-size: 0.92rem; margin: 0;">
                    Deseja ir para a página de comprar número agora?
                </p>
            </div>
            <div style="display: flex; gap: 12px; padding: 0 28px 28px;">
                <button type="button" class="btn-cancel" onclick="closeNoNumbersModal()" style="flex: 1; padding: 14px 24px; font-size: 0.95rem;">
                    Cancelar
                </button>
                <button type="button" class="btn-confirm" onclick="redirectToNumbers()" style="flex: 1; padding: 14px 24px; font-size: 0.95rem;">
                    Ir para Números
                </button>
            </div>
        </div>
    </div>

    <div id="notificationPopup" class="notification-popup">
        <div class="notification-content">
            <button class="notification-close" onclick="closeNotification()">×</button>
            <div class="notification-header">
                <div class="notification-icon" id="notificationIcon"></div>
                <div class="notification-title" id="notificationTitle"></div>
            </div>
            <div class="notification-message" id="notificationMessage"></div>
        </div>
    </div>

    <script>
        // Classes auxiliares
        class CacheManager {
            constructor() {
                this.cache = new Map();
                this.CACHE_DURATION = 5 * 60 * 1000;
            }
            get(key) {
                const cached = this.cache.get(key);
                if (!cached) return null;
                if (Date.now() - cached.timestamp > this.CACHE_DURATION) {
                    this.cache.delete(key);
                    return null;
                }
                return cached.data;
            }
            set(key, data) {
                this.cache.set(key, { data, timestamp: Date.now() });
            }
            clear() {
                this.cache.clear();
            }
        }

        class RateLimiter {
            constructor() {
                this.lastRequest = 0;
                this.MIN_INTERVAL = 4000;
            }
            async waitIfNeeded() {
                const now = Date.now();
                const timeSinceLastRequest = now - this.lastRequest;
                if (timeSinceLastRequest < this.MIN_INTERVAL) {
                    await new Promise(r => setTimeout(r, this.MIN_INTERVAL - timeSinceLastRequest));
                }
                this.lastRequest = Date.now();
            }
        }

        const cacheManager = new CacheManager();
        const rateLimiter = new RateLimiter();

        // Variáveis globais
        let assistentesData = [];
        let currentEditingAssistente = null;
        let currentDeletingAssistente = null;
        let currentAudio = null;
        let currentPlayingVoice = null;
        let phoneNumbersCache = null;
        let callsData = [];

        const ELEVEN_LABS_VOICES = [
            { voice_id: "x6uRgOliu4lpcrqMH3s1", name: "Flavio Francisco", description: "Voz masculina brasileira profunda", gender: "male", preview_url: "https://storage.googleapis.com/eleven-public-prod/y9Ic1fqPcvfl86Uiywudp3hKFkB3/voices/x6uRgOliu4lpcrqMH3s1/e7825049-298a-4f67-b371-8e470545ed78.mp3" },
            { voice_id: "Eyspt3SYhZzXd1Jd3J8O", name: "Bia", description: "Voz feminina brasileira confiante", gender: "female", preview_url: "https://storage.googleapis.com/eleven-public-prod/custom/voices/Eyspt3SYhZzXd1Jd3J8O/10DoHOyHeulo8zdymIs7.mp3" },
            { voice_id: "33B4UnXyTNbgLmdEDh5P", name: "Keren", description: "Voz feminina brasileira jovem", gender: "female", preview_url: "https://storage.googleapis.com/eleven-public-prod/custom/voices/33B4UnXyTNbgLmdEDh5P/ArnzDsFaz6KDoDcDD8V2.mp3" },
            { voice_id: "OB6x7EbXYlhG4DDTB1XU", name: "Michelle", description: "Voz feminina brasileira jovem", gender: "female", preview_url: "https://storage.googleapis.com/eleven-public-prod/database/user/1xdpbBZ63ZPxrYQDhWxxqsaSUUU2/voices/OB6x7EbXYlhG4DDTB1XU/ni9GKCdT4EnjAoN3abFT.mp3" },
            { voice_id: "nd1z1vC7yrh6u3ZztpCd", name: "Renato", description: "Voz masculina brasileira madura", gender: "male", preview_url: "https://gwjcgzeybqiyqezuswpt.supabase.co/storage/v1/object/public/call-recordings/voice_preview_renato.mp3" },
            { voice_id: "eVXYtPVYB9wDoz9NVTIy", name: "Carla", description: "Voz feminina brasileira jovem", gender: "female", preview_url: "https://gwjcgzeybqiyqezuswpt.supabase.co/storage/v1/object/public/call-recordings/voice_preview_carla.mp3" }
        ];

        // Funções de utilidade
        function getUserData() {
            try {
                const storedData = localStorage.getItem('userData');
                if (!storedData) throw new Error('Dados não encontrados');
                const userData = JSON.parse(storedData);
                if (!userData.tenant_id || !userData.email) throw new Error('Dados incompletos');
                return { 
                    tenantId: userData.tenant_id, 
                    email: userData.email,
                    orgPrivateKey: userData.org_private_key || null
                };
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showNotification('error', 'Sessão Expirada', 'Faça login novamente.');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return null;
            }
        }

        function showNotification(type, title, message) {
            const popup = document.getElementById('notificationPopup');
            const icon = document.getElementById('notificationIcon');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            icon.className = 'notification-icon ' + type;
            icon.textContent = type === 'success' ? '✓' : '✕';
            titleEl.textContent = title;
            messageEl.textContent = message;
            popup.style.display = 'block';
            setTimeout(() => popup.style.display = 'none', 5000);
        }

        function closeNotification() {
            document.getElementById('notificationPopup').style.display = 'none';
        }

        function hideAllContentStates() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('assistentesGrid').style.display = 'none';
        }

        function showLoading() {
            hideAllContentStates();
            document.getElementById('loadingState').style.display = 'block';
        }

        function showError(message) {
            hideAllContentStates();
            const errorState = document.getElementById('errorState');
            const errorMessage = document.getElementById('errorMessage');
            if (message) {
                errorMessage.textContent = message;
            } else {
                errorMessage.textContent = 'Não foi possível conectar com o servidor. Tente novamente em alguns instantes.';
            }
            errorState.style.display = 'block';
        }

        function showEmpty() {
            hideAllContentStates();
            document.getElementById('emptyState').style.display = 'block';
            // Zerar estatísticas
            document.getElementById('totalAssistentes').textContent = '0';
            document.getElementById('assistentesAtivos').textContent = '0';
            document.getElementById('totalCalls').textContent = '0';
            document.getElementById('ativosBadge').textContent = 'Ativos';
        }

        // Funções de carregamento - WEBHOOKS ATUALIZADOS
        async function loadAssistentes() {
            const user = getUserData();
            if (!user) return;

            const cacheKey = 'assistentes_' + user.tenantId;
            const cachedData = cacheManager.get(cacheKey);
            
            if (cachedData) {
                assistentesData = cachedData;
                cachedData.length === 0 ? showEmpty() : renderAssistentes();
                return;
            }

            try {
                showLoading();
                await rateLimiter.waitIfNeeded();

                // WEBHOOK ATUALIZADO - NOVO DOMÍNIO
                const response = await fetch('https://sdr.salesdever.io/webhook/assistentes-saas-att', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        tenant_id: user.tenantId,
                        email: user.email
                    })
                });

                if (response.status === 429) {
                    await new Promise(r => setTimeout(r, 5000));
                    return loadAssistentes();
                }

                if (!response.ok) {
                    let errorMsg = 'Erro ao carregar assistentes';
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.message || errorData.error || errorMsg;
                    } catch (e) {
                        errorMsg = `Erro ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();

                // LOG: Verificar dados recebidos do Supabase
                console.log('🔍 DADOS RECEBIDOS DO WEBHOOK:', data);

                // FILTRAR APENAS ASSISTENTES (ignorar números e outros registros)
                // Assistentes têm o campo 'assistente_id' preenchido
                const apenasAssistentes = Array.isArray(data)
                    ? data.filter(item => item.assistente_id && item.assistente_id !== null)
                    : (data.assistente_id ? [data] : []);

                console.log(`✅ Total de itens recebidos: ${Array.isArray(data) ? data.length : 1}`);
                console.log(`✅ Assistentes filtrados: ${apenasAssistentes.length}`);

                if (apenasAssistentes.length > 0) {
                    apenasAssistentes.forEach((assistente, index) => {
                        console.log(`📋 Assistente ${index + 1}: ${assistente.name} | Status: "${assistente.status}" | success_evaluation: "${assistente.success_evaluation || 'NÃO DEFINIDO'}"`);
                    });
                }

                // Verificar se realmente retornou dados válidos
                if (!apenasAssistentes || apenasAssistentes.length === 0) {
                    assistentesData = [];
                    showEmpty();
                    return;
                }

                assistentesData = apenasAssistentes;
                cacheManager.set(cacheKey, assistentesData);
                renderAssistentes();

            } catch (error) {
                console.error('Erro ao carregar:', error);
                showError(error.message || 'Não foi possível carregar os assistentes. Tente novamente.');
            }
        }

        function renderAssistentes() {
            console.log('🎨 RENDERIZANDO ASSISTENTES. Total:', assistentesData.length);
            console.log('📦 assistentesData completo:', JSON.stringify(assistentesData, null, 2));

            const grid = document.getElementById('assistentesGrid');
            grid.innerHTML = '';
            assistentesData.forEach((a, idx) => {
                console.log(`🔨 Criando card ${idx + 1}/${assistentesData.length}: ${a.name} | status: "${a.status}"`);
                grid.appendChild(createAssistenteCard(a));
            });
            hideAllContentStates();
            grid.style.display = 'grid';
            updateStats(); // Atualizar estatísticas
        }

        function updateStats() {
            // Total de assistentes
            const total = assistentesData.length;
            document.getElementById('totalAssistentes').textContent = total;

            // Assistentes ativos - verifica o campo 'status' do Supabase
            const ativos = assistentesData.filter(a => !a.status || a.status === 'active' || a.status === 'ativo').length;
            document.getElementById('assistentesAtivos').textContent = ativos;

            // Badge para ativos
            const ativosBadge = document.getElementById('ativosBadge');
            ativosBadge.textContent = ativos === 1 ? 'Ativo' : 'Ativos';

            // Total de calls
            const totalCalls = callsData.length;
            document.getElementById('totalCalls').textContent = totalCalls;
        }

        function createAssistenteCard(assistente) {
            const card = document.createElement('div');
            card.className = 'assistente-card';

            // URL da foto de perfil ou placeholder
            const profileUrl = assistente.url_perfil || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(assistente.name || 'AI') + '&background=A594FF&color=fff&size=400';

            // Determinar status
            console.log(`🔍 [${assistente.name}] Status recebido:`, assistente.status);

            // ATENÇÃO: O webhook está retornando 'null' em vez de 'active'/'inactive'
            // Precisa corrigir o webhook do n8n para retornar o campo status corretamente
            if (assistente.status === null || assistente.status === undefined) {
                console.warn(`⚠️ [${assistente.name}] STATUS VEIO COMO NULL! O webhook não está retornando o campo status do Supabase!`);
            }

            // Lê o status: 'active' ou 'inactive'
            const isInativo = assistente.status === 'inactive';
            const statusText = isInativo ? 'Inativo' : 'Ativo';
            const statusClass = isInativo ? 'assistente-status inativo' : 'assistente-status';

            console.log(`✅ [${assistente.name}] Mostrando: ${statusText}`);

            card.innerHTML = `
                <div class="assistente-header">
                    <div class="assistente-nome">${assistente.name || 'Sem nome'}</div>
                    <button class="btn-duplicate-icon" title="Duplicar assistente">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
                <div class="assistente-body">
                    <div class="assistente-profile-photo">
                        <img src="${profileUrl}" alt="${assistente.name || 'Avatar'}"
                             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(assistente.name || 'AI')}&background=A594FF&color=fff&size=400'">
                    </div>
                    <div class="assistente-info">
                        <div class="info-label">Primeira Mensagem</div>
                        <div class="first-message-text">${assistente.first_message || 'Sem mensagem'}</div>
                    </div>
                    <div class="assistente-actions" style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="action-btn btn-edit" onclick="editarAssistente('${assistente.id}')" style="flex: 1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>Editar
                        </button>
                        <button class="action-btn btn-delete" onclick="deletarAssistente('${assistente.id}')" style="flex: 1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>Excluir
                        </button>
                    </div>
                </div>
            `;

            // Adicionar event listener para o botão de duplicar
            const duplicateBtn = card.querySelector('.btn-duplicate-icon');
            if (duplicateBtn) {
                console.log('✅ Botão duplicar encontrado, adicionando listener para:', assistente.id);
                duplicateBtn.addEventListener('click', (e) => {
                    console.log('🖱️ Clique no botão duplicar detectado!');
                    e.preventDefault();
                    e.stopPropagation();
                    duplicarAssistente(assistente.id);
                });
            } else {
                console.error('❌ Botão duplicar NÃO encontrado no card');
            }

            return card;
        }

        async function abrirModalCriar() {
            console.log('🔓 Abrindo modal de criação');

            // renderVoices() será chamado automaticamente ao entrar no Step 3
            document.getElementById('createForm').reset();
            document.getElementById('promptMethodChoice').style.display = 'block';
            document.getElementById('promptManualForm').style.display = 'none';
            document.getElementById('promptAIForm').style.display = 'none';
            document.getElementById('promptPreviewForm').style.display = 'none';
            document.getElementById('createModal').style.display = 'block';
            goToStep(1);

            // Carregar números (vai mostrar popup se não houver)
            await loadPhoneNumbersCreate();

            // GARANTIR que o event listener está registrado no formulário
            const createForm = document.getElementById('createForm');
            if (createForm) {
                // Remover listeners antigos para evitar duplicação
                const newForm = createForm.cloneNode(true);
                createForm.parentNode.replaceChild(newForm, createForm);

                // Registrar o listener no formulário clonado
                newForm.addEventListener('submit', (e) => {
                    console.log('🎯 SUBMIT CAPTURADO - Iniciando criação do assistente');
                    saveNovoAssistente(e);
                });
                console.log('✅ Event listener registrado no modal');

                // FALLBACK: Adicionar listener no botão também
                setTimeout(() => {
                    const btn = document.getElementById('saveCreateBtn');
                    if (btn) {
                        btn.addEventListener('click', (e) => {
                            console.log('🔘 Botão clicado - forçando submit');
                            // Se o botão for clicado, garantir que o form seja submetido
                            const form = document.getElementById('createForm');
                            if (form && e.target.type === 'submit') {
                                console.log('✅ Tipo submit detectado, form vai submeter naturalmente');
                            }
                        });
                        console.log('✅ Listener adicional no botão registrado');
                    }
                }, 100);
            } else {
                console.error('❌ ERRO: Formulário createForm não encontrado!');
            }
        }

        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingAssistente = null;

            // Resetar session ID e canal
            window.currentChangeSessionId = null;
            window.currentChangeChannel = null;

            // Resetar chat - limpar mensagens exceto a inicial e recriar botões
            var messagesContainer = document.getElementById('chatMessages');
            if (messagesContainer) {
                // Manter apenas a primeira mensagem (mensagem inicial da IA)
                var messages = messagesContainer.querySelectorAll('.chat-message');
                for (var i = 1; i < messages.length; i++) {
                    messages[i].remove();
                }

                // Recriar botões de canal na primeira mensagem
                var firstMessage = messagesContainer.querySelector('.chat-message.ai');
                if (firstMessage && !firstMessage.querySelector('.channel-buttons')) {
                    var channelButtonsHtml = '<div class="channel-buttons">' +
                        '<button class="channel-btn" onclick="selectChannel(\'WhatsApp\')">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                        '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>' +
                        '</svg><span>WhatsApp</span></button>' +
                        '<button class="channel-btn" onclick="selectChannel(\'Voz\')">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                        '<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>' +
                        '<path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>' +
                        '<line x1="12" y1="19" x2="12" y2="23"></line>' +
                        '<line x1="8" y1="23" x2="16" y2="23"></line>' +
                        '</svg><span>Voz</span></button>' +
                        '<button class="channel-btn" onclick="selectChannel(\'Ambos\')">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
                        '<circle cx="12" cy="12" r="10"></circle>' +
                        '<circle cx="12" cy="12" r="3"></circle>' +
                        '<line x1="12" y1="1" x2="12" y2="10"></line>' +
                        '<line x1="12" y1="14" x2="12" y2="23"></line>' +
                        '<line x1="4.22" y1="4.22" x2="8.46" y2="8.46"></line>' +
                        '<line x1="15.54" y1="15.54" x2="19.78" y2="19.78"></line>' +
                        '</svg><span>Ambos</span></button>' +
                        '</div>';
                    firstMessage.insertAdjacentHTML('beforeend', channelButtonsHtml);
                }
            }

            // Limpar display do session ID
            var sessionIdElement = document.getElementById('currentSessionId');
            if (sessionIdElement) {
                sessionIdElement.textContent = '';
            }

            // NÃO resetar as abas - manter o estado para quando o modal for reaberto
            // O usuário deve ver a última aba que estava usando
        }

        function closeDeleteModal() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            currentDeletingAssistente = null;
        }

        // Modal: Sem Números Cadastrados
        function showNoNumbersModal() {
            console.log('🚫 Mostrando modal de sem números cadastrados');
            document.getElementById('noNumbersModal').style.display = 'flex';
        }

        function closeNoNumbersModal() {
            console.log('✖️ Fechando modal de sem números');
            document.getElementById('noNumbersModal').style.display = 'none';
        }

        function redirectToNumbers() {
            console.log('➡️ Redirecionando para página de comprar números');
            closeNoNumbersModal();
            window.location.href = '../conexoes/comprar-numero.html';
        }

        // Modal: Duplicar Assistente
        let currentDuplicatingAssistente = null;

        function closeDuplicateModal() {
            console.log('✖️ Fechando modal de duplicação');
            document.getElementById('duplicateConfirmModal').style.display = 'none';
            currentDuplicatingAssistente = null;
        }

        async function duplicarAssistente(assistenteId) {
            console.log('📋 Duplicar assistente chamado. ID:', assistenteId);
            console.log('📋 assistentesData disponível:', assistentesData);

            const assistente = assistentesData.find(a => a.id === assistenteId);
            if (!assistente) {
                console.error('❌ Assistente não encontrado:', assistenteId);
                showNotification('error', 'Erro', 'Assistente não encontrado.');
                return;
            }

            console.log('✅ Assistente encontrado:', assistente);
            currentDuplicatingAssistente = assistente;
            document.getElementById('duplicateAssistenteName').textContent = assistente.name || 'Sem nome';
            document.getElementById('duplicateConfirmModal').style.display = 'flex';
            console.log('✅ Modal de duplicação aberto');
        }

        async function confirmarDuplicacao() {
            if (!currentDuplicatingAssistente) {
                console.error('❌ Nenhum assistente selecionado para duplicação');
                return;
            }

            const btn = document.getElementById('confirmDuplicateBtn');
            const btnText = document.getElementById('duplicateBtnText');
            const originalText = btnText.textContent;

            try {
                btn.disabled = true;
                btnText.textContent = 'Duplicando...';

                console.log('📋 Enviando dados para duplicação:', currentDuplicatingAssistente);

                const response = await fetch('https://sdr.salesdever.io/webhook/duplicar-assistentes-saas-att', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentDuplicatingAssistente)
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                console.log('✅ Resposta do webhook de duplicação:', data);

                showNotification('success', 'Sucesso', 'Assistente duplicado com sucesso!');
                closeDuplicateModal();

                // Recarregar a página
                window.location.reload();

            } catch (error) {
                console.error('❌ Erro ao duplicar assistente:', error);
                showNotification('error', 'Erro', 'Não foi possível duplicar o assistente. Tente novamente.');
            } finally {
                btn.disabled = false;
                btnText.textContent = originalText;
            }
        }

        // Modal de Calls
        function abrirModalCalls() {
            console.log('Abrindo modal de calls...');
            console.log('callsData:', callsData);

            const modal = document.getElementById('callsModal');
            console.log('Modal element:', modal);

            if (!modal) {
                console.error('Modal de calls não encontrado!');
                return;
            }

            renderCallsList();
            modal.style.display = 'block';
            console.log('Modal aberto!');
        }

        function fecharModalCalls() {
            const modal = document.getElementById('callsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function irParaConversas() {
            // Fechar o modal
            fecharModalCalls();

            // Navegar para a página de conversas no menu principal
            // Tenta acessar a função showSection do parent (menu.html)
            if (window.parent && window.parent.showSection) {
                window.parent.showSection('conversas');
            } else {
                // Fallback: se não conseguir acessar o parent, abre em nova aba
                window.open('../conversas/conversas.html', '_blank');
            }
        }

        function renderCallsList() {
            const callsList = document.getElementById('callsList');
            console.log('Renderizando lista de calls...');
            console.log('callsList element:', callsList);

            if (!callsList) {
                console.error('Elemento callsList não encontrado!');
                return;
            }

            if (!callsData || callsData.length === 0) {
                console.log('Sem dados de calls');
                callsList.innerHTML = '<div class="calls-empty">Nenhuma call registrada ainda.</div>';
                return;
            }

            // Agrupar calls por assistente - apenas Atendidas e Não Atendidas
            const callsByAssistant = {};
            callsData.forEach(call => {
                const assistantName = call.assistant_name || call.assistantName || 'Sem nome';

                // Pegar duração da chamada (em segundos) - campo correto do Supabase
                const duration = call.duration_seconds || 0;

                // Debug: mostrar a primeira call para ver a estrutura
                if (Object.keys(callsByAssistant).length === 0) {
                    console.log('Exemplo de call data:', call);
                    console.log('Duração encontrada (duration_seconds):', duration);
                }

                if (!callsByAssistant[assistantName]) {
                    callsByAssistant[assistantName] = {
                        total: 0,
                        atendidas: 0,
                        naoAtendidas: 0
                    };
                }

                callsByAssistant[assistantName].total++;

                // Se duração > 10 segundos = Atendida, senão = Não Atendida
                if (duration > 10) {
                    callsByAssistant[assistantName].atendidas++;
                } else {
                    callsByAssistant[assistantName].naoAtendidas++;
                }
            });

            console.log('Calls agrupadas:', callsByAssistant);

            // Converter para array e ordenar por quantidade
            const sortedCalls = Object.entries(callsByAssistant)
                .sort((a, b) => b[1].total - a[1].total)
                .map(([name, stats]) => ({ name, ...stats }));

            // Renderizar lista
            if (sortedCalls.length === 0) {
                callsList.innerHTML = '<div class="calls-empty">Nenhuma call registrada ainda.</div>';
                return;
            }

            callsList.innerHTML = sortedCalls.map(item => `
                <div class="call-item">
                    <div class="call-item-header">
                        <div class="call-item-name">${item.name}</div>
                        <div class="call-item-count">${item.total}</div>
                    </div>
                    <div class="call-item-stats">
                        <div class="stat-mini atendidas">
                            <div class="stat-mini-dot"></div>
                            <span class="stat-mini-label">Atendidas:</span>
                            <span class="stat-mini-value">${item.atendidas}</span>
                        </div>
                        <div class="stat-mini nao-atendidas">
                            <div class="stat-mini-dot"></div>
                            <span class="stat-mini-label">Não atendidas:</span>
                            <span class="stat-mini-value">${item.naoAtendidas}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            console.log('Lista renderizada com sucesso!');
        }

        // Color Selection Functions
        function selectGender(gender) {
            // Armazenar gênero
            document.getElementById('avatarGenero').value = gender;
            console.log('✓ Gênero selecionado:', gender);

            // Auto-avançar para próximo step após pequeno delay (para feedback visual)
            setTimeout(() => {
                nextSubStep('2_2');
            }, 300);
        }

        function selectEyeColor(color) {
            // Remove selected class from all eye color options
            document.querySelectorAll('.color-selector-grid .color-option').forEach(opt => {
                if (opt.dataset.color === 'azul' || opt.dataset.color === 'castanho' ||
                    opt.dataset.color === 'verde' || opt.dataset.color === 'mel' || opt.dataset.color === 'cinza') {
                    opt.classList.remove('selected');
                }
            });

            // Add selected class to clicked option
            event.target.classList.add('selected');

            // Update hidden input
            document.getElementById('avatarOlhos').value = color;
            console.log('✓ Cor dos olhos selecionada:', color);

            // Renderizar opções de cor de cabelo baseadas no gênero
            renderHairColorOptions();

            // Auto-avançar para próximo step
            setTimeout(() => {
                nextSubStep('2_3');
            }, 300);
        }

        function renderHairColorOptions() {
            const genero = document.getElementById('avatarGenero').value;
            const hairColorGrid = document.getElementById('hairColorGrid');

            if (!hairColorGrid) return;

            // Definir opções baseadas no gênero
            let hairColors = [];
            if (genero === 'masculino') {
                hairColors = [
                    { value: 'loiro', label: 'Loiro', cssClass: 'color-loira' },
                    { value: 'moreno', label: 'Moreno', cssClass: 'color-morena' },
                    { value: 'ruivo', label: 'Ruivo', cssClass: 'color-ruiva' },
                    { value: 'castanho', label: 'Castanho', cssClass: 'color-castanha' },
                    { value: 'preto', label: 'Preto', cssClass: 'color-preta' }
                ];
            } else {
                hairColors = [
                    { value: 'loira', label: 'Loira', cssClass: 'color-loira' },
                    { value: 'morena', label: 'Morena', cssClass: 'color-morena' },
                    { value: 'ruiva', label: 'Ruiva', cssClass: 'color-ruiva' },
                    { value: 'castanha', label: 'Castanha', cssClass: 'color-castanha' },
                    { value: 'preta', label: 'Preta', cssClass: 'color-preta' }
                ];
            }

            // Renderizar opções
            hairColorGrid.innerHTML = hairColors.map(color => `
                <div class="color-option-wrapper" style="text-align: center;">
                    <div class="color-option ${color.cssClass}" data-color="${color.value}" onclick="selectHairColor('${color.value}')" style="cursor: pointer;"></div>
                    <span class="color-label" style="display: block; margin-top: 8px;">${color.label}</span>
                </div>
            `).join('');

            console.log('✓ Opções de cor de cabelo renderizadas para gênero:', genero);
        }

        function selectHairColor(color) {
            // Remove selected class from all hair color options
            document.querySelectorAll('#hairColorGrid .color-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Add selected class to clicked option
            event.target.classList.add('selected');

            // Update hidden input
            document.getElementById('avatarCabelo').value = color;
            console.log('✓ Cor do cabelo selecionada:', color);

            // Auto-avançar para próximo step
            setTimeout(() => {
                nextSubStep('2_4');
            }, 300);
        }

        // Avatar Generation Functions
        let selectedAvatarUrl = '';

        async function gerarAvatares() {
            const btn = document.getElementById('gerarAvatarBtn');
            const text = document.getElementById('gerarAvatarText');
            const loader = document.getElementById('gerarAvatarLoader');

            // Get form data
            const genero = document.getElementById('avatarGenero').value;
            const olhos = document.getElementById('avatarOlhos').value;
            const cabelo = document.getElementById('avatarCabelo').value;
            const personalidade = document.getElementById('avatarPersonalidade').value;

            // Get identidade visual choice
            const identidadeVisual = document.querySelector('input[name="identidadeVisual"]:checked');

            // Validation
            if (!genero) {
                showNotification('error', 'Campo Obrigatório', 'Selecione o gênero.');
                return;
            }

            if (!identidadeVisual) {
                showNotification('error', 'Campo Obrigatório', 'Escolha se deseja usar a identidade visual da empresa.');
                return;
            }

            // Se escolheu usar identidade visual, verificar se tem foto_perfil
            if (identidadeVisual.value === 'sim') {
                const fotoPerfil = localStorage.getItem('foto_perfil');
                if (!fotoPerfil || fotoPerfil === 'null' || fotoPerfil === null) {
                    // Não tem foto, redirecionar para configurações
                    showNotification('warning', 'Foto de Perfil Necessária', 'Para usar a identidade visual da empresa, você precisa primeiro subir uma logotipo nas configurações da conta.');
                    setTimeout(() => {
                        // Abrir modal de configurações do menu principal
                        if (window.parent && window.parent.openModal) {
                            window.parent.openModal('settingsModal');
                        } else {
                            // Se não conseguir abrir o modal, dar instruções
                            showNotification('info', 'Instruções', 'Vá para o menu principal > Configurações e faça upload da logotipo da empresa.');
                        }
                    }, 3000);
                    return;
                }
            }

            // Get user data for tenant_id
            const user = getUserData();
            if (!user) {
                return;
            }

            // Show loading
            btn.disabled = true;
            text.textContent = 'Gerando avatares...';
            loader.style.display = 'block';

            try {
                // Update loading overlay text
                document.getElementById('loadingTitle').textContent = 'Assistente está sendo criado';
                document.getElementById('loadingMessage').innerHTML = 'Este processo pode levar de 2 a 3 minutos.<br><strong>Não feche esta página!</strong>';
                document.getElementById('loadingOverlay').classList.add('active');

                // Prepare webhook payload
                const payload = {
                    genero,
                    corOlhos: olhos,
                    corCabelo: cabelo,
                    personalidade,
                    tenant_id: user.tenantId,
                    email: user.email
                };

                // Se escolheu usar identidade visual, incluir foto_perfil
                if (identidadeVisual.value === 'sim') {
                    const fotoPerfil = localStorage.getItem('foto_perfil');
                    payload.foto_perfil = fotoPerfil;
                    payload.usar_identidade_visual = true;
                } else {
                    payload.usar_identidade_visual = false;
                }

                console.log('🚀 Enviando payload para webhook:', payload);

                // Call webhook
                const response = await fetch('https://sdr.salesdever.io/webhook/gerar-avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('=== STATUS DA RESPOSTA ===');
                console.log('Status HTTP:', response.status);
                console.log('Status Text:', response.statusText);
                console.log('Headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Erro HTTP:', response.status);
                    console.error('Mensagem de erro:', errorText);
                    throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('=== RESPOSTA DO WEBHOOK ===');
                console.log('Resposta completa:', data);
                console.log('Tipo:', typeof data);
                console.log('É array?', Array.isArray(data));

                // Debug detalhado
                if (data.success) {
                    console.log('✓ Success:', data.success);
                    console.log('Total reportado:', data.total);
                    console.log('Array images existe?', !!data.images);
                    console.log('Array images é array?', Array.isArray(data.images));
                    if (data.images) {
                        console.log('Tamanho do array images:', data.images.length);
                        data.images.forEach((img, i) => {
                            console.log(`Imagem ${i + 1}:`, typeof img, img.substring(0, 50) + '...');
                        });
                    }
                }

                // Extrair imagens do novo formato do n8n
                let images = [];

                if (data.success && data.images && Array.isArray(data.images)) {
                    // Novo formato: { success: true, images: ["data:image/png;base64,..."], total: 4 }
                    images = data.images;
                    console.log('✓ Novo formato n8n detectado - Total:', data.total, 'imagens');
                    console.log('✓ Imagens extraídas:', images.length);
                } else if (Array.isArray(data)) {
                    // Fallback: Se vier array direto
                    images = data;
                    console.log('✓ Recebido array direto com', data.length, 'items');
                } else if (data.binary && data.binary.data) {
                    // Fallback: Formato binary object
                    images = [data];
                    console.log('✓ Formato binary object único');
                } else if (data.data) {
                    // Fallback: Formato data
                    if (typeof data.data === 'string') {
                        images = [data];
                        console.log('✓ Formato data (string) único');
                    } else if (Array.isArray(data.data)) {
                        images = data.data;
                        console.log('✓ Formato data (array)');
                    } else {
                        images = [data];
                        console.log('✓ Formato data (object) único');
                    }
                } else {
                    console.warn('⚠️ Formato não reconhecido, tentando extrair valores...');
                    const values = Object.values(data);
                    images = values.filter(item =>
                        item && (
                            (item.binary && item.binary.data) ||
                            item.binary_data ||
                            item.data ||
                            item.url ||
                            (typeof item === 'string' && item.startsWith('data:image'))
                        )
                    );
                    console.log('✓ Extraído', images.length, 'imagens dos valores do objeto');
                }

                console.log('Total de imagens a processar:', images.length);
                console.log('Preview das imagens:', images.map((img, i) => ({
                    index: i,
                    type: typeof img,
                    isDataURI: typeof img === 'string' && img.startsWith('data:'),
                    preview: typeof img === 'string' ? img.substring(0, 50) + '...' : 'object'
                })));

                if (images.length === 0) {
                    console.error('❌ Nenhuma imagem encontrada na resposta');
                    console.error('Estrutura recebida:', JSON.stringify(data, null, 2));
                    throw new Error('Nenhuma imagem foi retornada pelo servidor');
                }

                renderAvatarGrid(images);

                // Hide form, show avatar grid
                document.querySelector('#wizardStep2_4 .form-group').style.display = 'none';
                document.querySelector('#wizardStep2_4 .form-actions').style.display = 'none';
                document.getElementById('avatarsGrid').style.display = 'block';

            } catch (error) {
                console.error('=== ERRO CAPTURADO ===');
                console.error('Tipo do erro:', error.constructor.name);
                console.error('Mensagem:', error.message);
                console.error('Stack:', error.stack);

                showNotification('error', 'Erro', `Não foi possível gerar os avatares. Erro: ${error.message}`);

                btn.disabled = false;
                text.textContent = 'Gerar Assistente';
                loader.style.display = 'none';
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        function renderAvatarGrid(images) {
            const container = document.getElementById('avatarsContainer');
            container.innerHTML = '';

            console.log('=== RENDERIZANDO AVATARES ===');
            console.log('Total de imagens:', images.length);

            if (images.length === 0) {
                container.innerHTML = '<p style="color: white; text-align: center;">Nenhuma imagem foi gerada. Tente novamente.</p>';
                return;
            }

            images.forEach((imageData, index) => {
                console.log(`\n--- Imagem ${index + 1} ---`);
                console.log('Tipo:', typeof imageData);

                // Identificar formato e extrair data URI
                let imgSrc = null;

                if (typeof imageData === 'string') {
                    // Novo formato: string Data URI direta "data:image/png;base64,..."
                    imgSrc = imageData;
                    console.log('✓ Formato: Data URI string (novo formato n8n)');
                    console.log('Preview:', imgSrc.substring(0, 80) + '...');
                } else if (imageData && typeof imageData === 'object') {
                    console.log('Keys do objeto:', Object.keys(imageData));

                    // Formatos alternativos (fallback)
                    if (imageData.binary && imageData.binary.data) {
                        const base64 = imageData.binary.data;
                        const mimeType = imageData.binary.mimeType || 'image/png';
                        imgSrc = base64.startsWith('data:') ? base64 : `data:${mimeType};base64,${base64}`;
                        console.log('✓ Formato: binary.data');
                    } else if (imageData.data && typeof imageData.data === 'string') {
                        const base64 = imageData.data;
                        const mimeType = imageData.mimeType || imageData.mime_type || 'image/png';
                        imgSrc = base64.startsWith('data:') ? base64 : `data:${mimeType};base64,${base64}`;
                        console.log('✓ Formato: data (string)');
                    } else if (imageData.url) {
                        imgSrc = imageData.url;
                        console.log('✓ Formato: url HTTP');
                    }
                }

                if (!imgSrc) {
                    console.error('❌ Não foi possível extrair dados da imagem');
                    console.error('Estrutura recebida:', imageData);
                    // Criar card de erro visível
                    const errorCard = document.createElement('div');
                    errorCard.className = 'avatar-card';
                    errorCard.style.border = '2px solid red';
                    errorCard.style.backgroundColor = 'rgba(255,0,0,0.1)';
                    errorCard.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: white;">
                            <p>❌ Erro ao processar imagem ${index + 1}</p>
                            <small style="color: rgba(255,255,255,0.6);">Verifique o console</small>
                        </div>
                    `;
                    container.appendChild(errorCard);
                    return;
                }

                console.log('✓ imgSrc gerado:', imgSrc.substring(0, 80) + '...');
                console.log('Tamanho total:', imgSrc.length, 'caracteres');

                const avatarCard = document.createElement('div');
                avatarCard.className = 'avatar-card';
                avatarCard.onclick = () => selectAvatar(index, imgSrc);

                avatarCard.innerHTML = `
                    <img src="${imgSrc}" alt="Avatar ${index + 1}"
                         onerror="console.error('❌ Erro ao carregar imagem ${index + 1}'); this.style.border='2px solid red'; this.parentElement.style.backgroundColor='rgba(255,0,0,0.1)';"
                         onload="console.log('✓ Imagem ${index + 1} carregada com sucesso'); this.style.border='2px solid green';" />
                    <div class="avatar-card-check">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                `;

                container.appendChild(avatarCard);
            });

            console.log('=== FIM DA RENDERIZAÇÃO ===\n');
        }

        function selectAvatar(index, imageUrl) {
            // Remove selected from all
            document.querySelectorAll('.avatar-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selected to clicked
            document.querySelectorAll('.avatar-card')[index].classList.add('selected');

            // Store selected avatar
            selectedAvatarUrl = imageUrl;
            console.log(`✓ Avatar ${index + 1} selecionado`);
            console.log('Preview da imagem:', imageUrl.substring(0, 100) + '...');

            // Enable continue button
            document.getElementById('continuarAposAvatar').disabled = false;
        }

        function voltarParaPersonalidade() {
            // Show form again
            document.querySelector('#wizardStep2_4 .form-group').style.display = 'block';
            document.querySelector('#wizardStep2_4 .form-actions').style.display = 'flex';
            document.getElementById('avatarsGrid').style.display = 'none';

            // Reset button
            const btn = document.getElementById('gerarAvatarBtn');
            const text = document.getElementById('gerarAvatarText');
            const loader = document.getElementById('gerarAvatarLoader');

            btn.disabled = false;
            text.textContent = 'Gerar Assistente';
            loader.style.display = 'none';

            // Clear selection
            selectedAvatarUrl = '';
            document.getElementById('continuarAposAvatar').disabled = true;
        }

        // Wizard Navigation
        function nextSubStep(substep) {
            console.log('🔄 nextSubStep chamado para:', substep);

            // VALIDAÇÃO CRÍTICA: Se está saindo do Step 1.3 (Número), BLOQUEAR se não selecionou
            if (substep === '2_1') {
                const phoneSelect = document.getElementById('createPhoneNumber');
                const phoneId = phoneSelect.value;
                const selectedOption = phoneSelect.options[phoneSelect.selectedIndex];
                const selectedText = selectedOption ? selectedOption.text : '';

                console.log('📞 Verificando número selecionado:', phoneId);
                console.log('📋 Texto da opção selecionada:', selectedText);
                console.log('📋 Total de options:', phoneSelect.options.length);

                // BLOQUEAR se não selecionou número
                if (!phoneId || phoneId === '' || phoneId === 'Carregando números...') {
                    console.error('❌ BLOQUEADO - Nenhum número selecionado!');
                    showNotification('error', 'Campo Obrigatório', 'Você precisa selecionar um número de telefone para continuar.');
                    return; // NÃO AVANÇA!
                }

                // BLOQUEAR se selecionou opções inválidas: "Sem número", "Nenhum número", "Erro", "Carregando"
                if (selectedText.includes('Sem número') ||
                    selectedText.includes('Nenhum número') ||
                    selectedText.includes('Erro') ||
                    selectedText.includes('Carregando') ||
                    selectedText.includes('Selecione')) {

                    console.error('❌ BLOQUEADO - Opção inválida selecionada:', selectedText);

                    // Fechar o select
                    phoneSelect.blur();

                    // Mostrar popup customizado com opção de redirecionar
                    setTimeout(() => {
                        showNoNumbersModal();
                    }, 100);

                    return; // NÃO AVANÇA!
                }

                console.log('✅ Número válido selecionado, liberando avanço');
            }

            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.getElementById('wizardStep' + substep).classList.add('active');
        }

        function previousSubStep(substep) {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.getElementById('wizardStep' + substep).classList.add('active');
        }

        function goToStep(step) {
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step-indicator').forEach(s => {
                s.classList.remove('active', 'completed');
            });
            document.querySelectorAll('.step-line').forEach(l => l.classList.remove('completed'));

            // Determine which substep to show
            let substepId = 'wizardStep' + step;
            if (step === 1) substepId = 'wizardStep1_1';
            if (step === 2) substepId = 'wizardStep2_1';

            const wizardElement = document.getElementById(substepId);
            if (!wizardElement) {
                console.error('❌ Wizard step element not found:', substepId);
                return;
            }

            wizardElement.classList.add('active');

            // Determine the correct indicator ID
            let indicatorId = 'step' + step + 'Indicator';
            const indicatorElement = document.getElementById(indicatorId);

            if (!indicatorElement) {
                console.error('❌ Step indicator not found:', indicatorId);
                return;
            }

            indicatorElement.classList.add('active');

            // Mark completed steps - handle both numeric and string steps (like "4_5")
            const stepOrder = [1, 2, 3, 4, '4_5', 5];
            const currentStepIndex = stepOrder.indexOf(step === '4_5' ? '4_5' : parseInt(step));

            for (let i = 0; i < currentStepIndex; i++) {
                const prevStep = stepOrder[i];
                const prevIndicator = document.getElementById('step' + prevStep + 'Indicator');
                if (prevIndicator) {
                    prevIndicator.classList.add('completed');
                }
                const lineElement = document.getElementById('line' + (i + 1));
                if (lineElement) {
                    lineElement.classList.add('completed');
                }
            }

            // Renderizar vozes filtradas ao entrar no Step 3
            if (step === 3) {
                const genero = document.getElementById('avatarGenero')?.value;
                console.log('Entrando no Step 3 - Seleção de Voz');
                console.log('Gênero selecionado:', genero);

                if (genero === 'masculino') {
                    renderVoices('male');
                    console.log('✓ Filtrando apenas vozes MASCULINAS');
                } else if (genero === 'feminino') {
                    renderVoices('female');
                    console.log('✓ Filtrando apenas vozes FEMININAS');
                } else {
                    // Fallback: mostrar todas as vozes se não houver gênero definido
                    console.warn('⚠️ Gênero não definido, mostrando todas as vozes');
                    renderVoices();
                }
            }

            if (step === 5) updateSummary();
        }

        function nextStep(step) {
            const current = step - 1;

            // VALIDAÇÕES POR STEP
            if (current === 1) {
                const name = document.getElementById('createAssistenteName').value.trim();
                const msg = document.getElementById('createFirstMessage').value.trim();
                const phoneId = document.getElementById('createPhoneNumber').value;

                if (!name) {
                    showNotification('error', 'Campo Obrigatório', 'Preencha o nome do assistente.');
                    return;
                }
                if (!msg) {
                    showNotification('error', 'Campo Obrigatório', 'Preencha a primeira mensagem.');
                    return;
                }
                if (!phoneId) {
                    // Verificar se tem números cadastrados
                    if (!phoneNumbersCache || phoneNumbersCache.length === 0) {
                        showNotification('error', 'Sem Números Cadastrados', 'Você precisa adquirir um número de telefone antes de criar um assistente. Vá em "Conexões" → "Comprar Número".');
                    } else {
                        showNotification('error', 'Campo Obrigatório', 'Selecione um número de telefone.');
                    }
                    return;
                }
            } else if (current === 2) {
                // Validar se selecionou gênero e personalidade
                const genero = document.getElementById('avatarGenero')?.value;
                const personalidade = document.getElementById('avatarPersonalidade')?.value;

                if (!genero) {
                    showNotification('error', 'Campo Obrigatório', 'Selecione o gênero do assistente.');
                    return;
                }
                if (!personalidade) {
                    showNotification('error', 'Campo Obrigatório', 'Selecione a personalidade do assistente.');
                    return;
                }
            } else if (current === 3) {
                // Validar se selecionou uma voz
                const voiceId = document.getElementById('selectedVoiceId')?.value;
                if (!voiceId) {
                    showNotification('error', 'Campo Obrigatório', 'Selecione uma voz para o assistente.');
                    return;
                }
            } else if (current === 4) {
                // Validar prompt antes de ir para revisão (step 5)
                const prompt = document.getElementById('createPrompt').value.trim();
                if (!prompt) {
                    showNotification('error', 'Campo Obrigatório', 'Preencha o prompt do sistema (instruções para o assistente).');
                    return;
                }
            }

            goToStep(step);
        }

        function previousStep(step) {
            if (step === 4) {
                // Voltando para step 4 (prompt), mostrar a escolha de método
                document.getElementById('promptMethodChoice').style.display = 'block';
                document.getElementById('promptManualForm').style.display = 'none';
                document.getElementById('promptAIForm').style.display = 'none';
                document.getElementById('promptPreviewForm').style.display = 'none';
            }
            goToStep(step);
        }

        function selectPromptMethod(method) {
            document.getElementById('promptMethodChoice').style.display = 'none';
            if (method === 'manual') {
                document.getElementById('promptManualForm').style.display = 'block';
            } else {
                document.getElementById('promptAIForm').style.display = 'block';
            }
        }

        function backToMethodChoice() {
            document.getElementById('promptMethodChoice').style.display = 'block';
            document.getElementById('promptManualForm').style.display = 'none';
            document.getElementById('promptAIForm').style.display = 'none';
            document.getElementById('promptPreviewForm').style.display = 'none';
        }

        function backToAIForm() {
            document.getElementById('promptAIForm').style.display = 'block';
            document.getElementById('promptPreviewForm').style.display = 'none';
        }

        function confirmGeneratedPrompt() {
            const generatedPrompt = document.getElementById('generatedPromptPreview').value.trim();
            document.getElementById('createPrompt').value = generatedPrompt;
            goToStep('4_5'); // Ir para Success Evaluation após confirmar prompt
        }

        async function generatePromptWithAI() {
            const btn = document.getElementById('generatePromptBtn');
            const txt = document.getElementById('generateBtnText');
            const orig = txt.textContent;

            btn.disabled = true;
            txt.textContent = 'Gerando...';

            try {
                // Get user data for tenant_id
                const user = getUserData();
                if (!user) {
                    btn.disabled = false;
                    txt.textContent = orig;
                    return;
                }

                // Collect checkbox values for origem dos leads
                const origemLeadsChecked = Array.from(document.querySelectorAll('input[name="origemLeads[]"]:checked'))
                    .map(cb => cb.value);

                // Collect checkbox values for tipo de agendamento
                const tipoAgendamentoChecked = Array.from(document.querySelectorAll('input[name="tipoAgendamento[]"]:checked'))
                    .map(cb => cb.value);

                const formData = {
                    'tenant_id': user.tenantId,
                    'Função Principal': document.getElementById('aiFuncao').value.trim(),
                    'Nome da empresa': document.getElementById('aiNomeEmpresa').value.trim(),
                    'Segmento de atuação': document.getElementById('aiSegmento').value.trim(),
                    'Principal produto/serviço oferecido': document.getElementById('aiProdutoServico').value.trim(),
                    'Qual o principal diferencial da empresa?': document.getElementById('aiDiferencialEmpresa').value.trim(),
                    'Principais resultados que os clientes alcançam': document.getElementById('aiResultadosTipicos').value.trim(),
                    'Perfil do público-alvo': document.getElementById('aiPublicoAlvo').value.trim(),
                    'Origem dos leads': origemLeadsChecked.join(', '),
                    'Principais dores do seu cliente ideal': document.getElementById('aiDoresCliente').value.trim(),
                    'Como a IA deve se apresentar?': document.getElementById('aiApresentacao').value.trim(),
                    'Qual a primeira pergunta para engajar o lead?': document.getElementById('aiPrimeiraPergunta').value.trim(),
                    'Principais objeções e como contorná-las': document.getElementById('aiObjecoes').value.trim(),
                    'Termos técnicos do setor': document.getElementById('aiTermosTecnicos').value.trim(),
                    'Métricas ou resultados que ressoam com o público': document.getElementById('aiMetricas').value.trim(),
                    'Principais concorrentes': document.getElementById('aiConcorrentes').value.trim(),
                    'Duração da reunião/atendimento': document.getElementById('aiDuracaoReuniao').value.trim(),
                    'Tipo de agendamento/qualificação': tipoAgendamentoChecked.join(', '),
                    'Como a IA deve propor o agendamento?': document.getElementById('aiPropostaAgendamento').value.trim(),
                    'Missão da empresa': document.getElementById('aiMissao').value.trim(),
                    'Valores principais': document.getElementById('aiValores').value.trim(),
                    'Slogan/Tagline': document.getElementById('aiSlogan').value.trim(),
                    'Cases de sucesso ou depoimentos': document.getElementById('aiCasesSucesso').value.trim(),
                    'Instruções especiais para a IA': document.getElementById('aiInstrucoesEspeciais').value.trim(),
                    'Informações adicionais': document.getElementById('aiInformacoesAdicionais').value.trim()
                };

                if (!formData['Função Principal'] || !formData['Nome da empresa']) {
                    showNotification('error', 'Campos Obrigatórios', 'Preencha ao menos: Função e Empresa.');
                    btn.disabled = false;
                    txt.textContent = orig;
                    return;
                }

                // Update loading overlay text for prompt generation
                document.getElementById('loadingTitle').textContent = 'Prompt está sendo criado';
                document.getElementById('loadingMessage').innerHTML = 'Este processo pode levar de 2 a 3 minutos.<br><strong>Não feche esta página!</strong>';
                document.getElementById('loadingOverlay').classList.add('active');
                await rateLimiter.waitIfNeeded();

                // Updated webhook URL
                const response = await fetch('https://sdr.salesdever.io/webhook/criador-de-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                document.getElementById('loadingOverlay').classList.remove('active');

                if (response.status === 429) throw new Error('Muitas requisições. Aguarde.');
                if (!response.ok) throw new Error('Erro ' + response.status);

                const result = await response.json();
                
                let prompt = '';
                if (Array.isArray(result) && result.length > 0 && result[0].output) {
                    prompt = result[0].output;
                } else {
                    prompt = result.prompt || result.text || result.message || JSON.stringify(result);
                }

                document.getElementById('createPrompt').value = prompt;
                document.getElementById('generatedPromptPreview').value = prompt;
                document.getElementById('promptAIForm').style.display = 'none';
                document.getElementById('promptPreviewForm').style.display = 'block';

                showNotification('success', 'Prompt Gerado!', 'Revise antes de continuar.');

            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loadingOverlay').classList.remove('active');
                showNotification('error', 'Erro', error.message || 'Não foi possível gerar o prompt.');
            } finally {
                btn.disabled = false;
                txt.textContent = orig;
            }
        }

        function updateSummary() {
            const name = document.getElementById('createAssistenteName').value;
            const msg = document.getElementById('createFirstMessage').value;
            const personality = document.getElementById('avatarPersonalidade').value;
            const voiceId = document.getElementById('selectedVoiceId').value;
            const voice = ELEVEN_LABS_VOICES.find(v => v.voice_id === voiceId);

            // Atualizar avatar e nome no card estilo currículo
            document.getElementById('summaryAvatar').src = selectedAvatarUrl || 'https://via.placeholder.com/150';
            document.getElementById('summaryNameCard').textContent = name;
            document.getElementById('summaryPersonality').textContent = personality || 'Sem personalidade definida';

            // Atualizar informações
            document.getElementById('summaryFirstMessage').textContent = msg;
            document.getElementById('summaryVoice').textContent = voice ? voice.name : 'Não selecionada';

            console.log('✓ Summary atualizado');
            console.log('Avatar URL:', selectedAvatarUrl ? selectedAvatarUrl.substring(0, 50) + '...' : 'Nenhum');
        }

        // Vozes
        function renderVoices(filterGender = null) {
            const grid = document.getElementById('voicesGrid');

            // Filtrar vozes por gênero se especificado
            let voices = ELEVEN_LABS_VOICES;
            if (filterGender) {
                voices = ELEVEN_LABS_VOICES.filter(v => v.gender === filterGender);
                console.log(`Filtrando vozes por gênero: ${filterGender}`);
                console.log(`Total de vozes filtradas: ${voices.length}`);
            }

            if (voices.length === 0) {
                grid.innerHTML = '<p style="color: white; text-align: center;">Nenhuma voz disponível para o gênero selecionado.</p>';
                return;
            }

            // Selecionar automaticamente a primeira voz do filtro
            const defaultVoiceId = voices[0].voice_id;
            document.getElementById('selectedVoiceId').value = defaultVoiceId;

            grid.innerHTML = voices.map((v, index) => {
                const hasPreview = v.preview_url && v.preview_url.trim() !== '';
                const buttonDisabled = !hasPreview ? 'disabled' : '';
                const buttonStyle = !hasPreview ? 'opacity: 0.3; cursor: not-allowed;' : '';
                const buttonTitle = !hasPreview ? 'Preview não disponível' : 'Tocar preview';

                return `
                <div class="voice-card ${index === 0 ? 'selected' : ''}" onclick="selectVoice('${v.voice_id}')">
                    <div class="voice-header">
                        <div class="voice-name">${v.name}</div>
                        <div class="voice-badge ${v.gender}">${v.gender === 'female' ? 'F' : 'M'}</div>
                    </div>
                    <div class="voice-description">${v.description}</div>
                    <div class="voice-controls">
                        <button type="button" class="play-btn" ${buttonDisabled} style="${buttonStyle}" title="${buttonTitle}" onclick="event.stopPropagation(); toggleVoice('${v.voice_id}', '${v.preview_url}')" id="playBtn-${v.voice_id}">
                            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <div class="waveform-mini">${Array(20).fill(0).map(() => '<div class="waveform-bar" style="height:' + (Math.random() * 60 + 30) + '%;"></div>').join('')}</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function selectVoice(voiceId) {
            document.querySelectorAll('.voice-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('selectedVoiceId').value = voiceId;
        }

        function selectEditVoice(voiceId) {
            document.querySelectorAll('#editVoicesGrid .voice-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('editSelectedVoiceId').value = voiceId;

            // Atualizar informações da voz selecionada
            const selectedVoice = ELEVEN_LABS_VOICES.find(v => v.voice_id === voiceId);
            if (selectedVoice) {
                document.getElementById('editCurrentVoiceName').textContent = selectedVoice.name;
                document.getElementById('editCurrentVoiceDesc').textContent = selectedVoice.description;
            }
        }

        function renderEditVoices(filterGender = null, currentVoiceId = null) {
            const grid = document.getElementById('editVoicesGrid');

            // Filtrar vozes por gênero se especificado
            let voices = ELEVEN_LABS_VOICES;
            if (filterGender) {
                voices = ELEVEN_LABS_VOICES.filter(v => v.gender === filterGender);
                console.log(`Filtrando vozes na edição por gênero: ${filterGender}`);
                console.log(`Total de vozes filtradas: ${voices.length}`);
            }

            if (voices.length === 0) {
                grid.innerHTML = '<p style="color: white; text-align: center;">Nenhuma voz disponível para o gênero selecionado.</p>';
                return;
            }

            // Se não há voz atual, selecionar a primeira
            if (!currentVoiceId) {
                currentVoiceId = voices[0].voice_id;
                document.getElementById('editSelectedVoiceId').value = currentVoiceId;
            }

            grid.innerHTML = voices.map((v) => {
                const hasPreview = v.preview_url && v.preview_url.trim() !== '';
                const buttonDisabled = !hasPreview ? 'disabled' : '';
                const buttonStyle = !hasPreview ? 'opacity: 0.3; cursor: not-allowed;' : '';
                const buttonTitle = !hasPreview ? 'Preview não disponível' : 'Tocar preview';
                const isSelected = v.voice_id === currentVoiceId;

                return `
                <div class="voice-card ${isSelected ? 'selected' : ''}" onclick="selectEditVoice('${v.voice_id}')">
                    <div class="voice-header">
                        <div class="voice-name">${v.name}</div>
                        <div class="voice-badge ${v.gender}">${v.gender === 'female' ? 'F' : 'M'}</div>
                    </div>
                    <div class="voice-description">${v.description}</div>
                    <div class="voice-controls">
                        <button type="button" class="play-btn" ${buttonDisabled} style="${buttonStyle}" title="${buttonTitle}" onclick="event.stopPropagation(); toggleVoice('${v.voice_id}', '${v.preview_url}')" id="playBtn-${v.voice_id}">
                            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <div class="waveform-mini">${Array(20).fill(0).map(() => '<div class="waveform-bar" style="height:' + (Math.random() * 60 + 30) + '%;"></div>').join('')}</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function toggleEditVoiceSelector() {
            const grid = document.getElementById('editVoicesGrid');
            if (grid.style.display === 'none') {
                grid.style.display = 'grid';
            } else {
                grid.style.display = 'none';
            }
        }

        function toggleEditPhoneSelector() {
            const select = document.getElementById('editPhoneNumberSelect');
            if (select.style.display === 'none') {
                select.style.display = 'block';
                select.focus();
            } else {
                select.style.display = 'none';
            }
        }

        function toggleVoice(voiceId, url) {
            // Verificar se há URL de preview
            if (!url || url.trim() === '') {
                console.warn('Preview não disponível para esta voz');
                return;
            }

            const btn = document.getElementById('playBtn-' + voiceId);

            if (currentAudio && currentPlayingVoice === voiceId) {
                if (currentAudio.paused) {
                    currentAudio.play();
                    btn.classList.add('playing');
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>';
                } else {
                    currentAudio.pause();
                    btn.classList.remove('playing');
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                }
            } else {
                if (currentAudio) {
                    currentAudio.pause();
                    const oldBtn = document.getElementById('playBtn-' + currentPlayingVoice);
                    if (oldBtn) {
                        oldBtn.classList.remove('playing');
                        oldBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                    }
                }
                
                currentAudio = new Audio(url);
                currentPlayingVoice = voiceId;
                currentAudio.play();
                btn.classList.add('playing');
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>';
                
                currentAudio.addEventListener('ended', () => {
                    btn.classList.remove('playing');
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
                });
            }
        }

        // Números de telefone - WEBHOOK ATUALIZADO
        async function preloadPhoneNumbers() {
            const user = getUserData();
            if (!user) return;

            const cacheKey = 'phone_numbers_' + user.tenantId;
            const cached = cacheManager.get(cacheKey);
            
            if (cached) {
                phoneNumbersCache = cached;
                return;
            }

            try {
                await rateLimiter.waitIfNeeded();

                const response = await fetch('https://sdr.salesdever.io/webhook/procura_numeros', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: user.tenantId
                    })
                });

                if (response.status === 429) {
                    await new Promise(r => setTimeout(r, 5000));
                    return preloadPhoneNumbers();
                }

                if (!response.ok) return;

                const data = await response.json();
                phoneNumbersCache = Array.isArray(data) ? data : (data.numbers || []);
                cacheManager.set(cacheKey, phoneNumbersCache);
            } catch (error) {
                console.error('Erro ao pré-carregar números:', error);
            }
        }

        // Calls - buscar total de calls
        async function loadCalls() {
            const user = getUserData();
            if (!user) return;

            // Mostrar loading no botão
            setVerMaisLoading(true);

            const cacheKey = 'calls_' + user.tenantId;
            const cached = cacheManager.get(cacheKey);

            if (cached) {
                callsData = cached;
                updateStats();
                setVerMaisLoading(false);
                return;
            }

            try {
                await rateLimiter.waitIfNeeded();

                const response = await fetch('https://sdr.salesdever.io/webhook/vercalls-saas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: user.tenantId
                    })
                });

                if (response.status === 429) {
                    await new Promise(r => setTimeout(r, 5000));
                    return loadCalls();
                }

                if (!response.ok) {
                    setVerMaisLoading(false);
                    return;
                }

                const data = await response.json();
                callsData = Array.isArray(data) ? data : (data.calls || []);
                cacheManager.set(cacheKey, callsData);
                updateStats();
                setVerMaisLoading(false);
            } catch (error) {
                console.error('Erro ao carregar calls:', error);
                setVerMaisLoading(false);
            }
        }

        // Função para controlar loading do botão "Ver mais"
        function setVerMaisLoading(isLoading) {
            const btn = document.getElementById('verMaisBtn');
            const text = document.getElementById('verMaisText');
            const loader = document.getElementById('verMaisLoader');

            if (!btn || !text || !loader) return;

            if (isLoading) {
                btn.disabled = true;
                text.textContent = 'Carregando...';
                loader.style.display = 'block';
            } else {
                btn.disabled = false;
                text.textContent = 'Ver mais';
                loader.style.display = 'none';
            }
        }

        async function loadPhoneNumbersCreate() {
            const select = document.getElementById('createPhoneNumber');

            console.log('🔍 loadPhoneNumbersCreate iniciado');
            console.log('📦 phoneNumbersCache atual:', phoneNumbersCache);

            // Se já tem cache (array), verificar se está vazio ANTES de popular
            if (Array.isArray(phoneNumbersCache)) {
                console.log('📞 Usando cache de números (array):', phoneNumbersCache.length);

                if (phoneNumbersCache.length === 0) {
                    console.warn('⚠️ ❌ CACHE VAZIO - SEM NÚMEROS CADASTRADOS!');
                    select.innerHTML = '<option value="">Nenhum número cadastrado</option>';

                    // Fechar modal IMEDIATAMENTE
                    console.log('🔒 Fechando modal...');
                    closeCreateModal();

                    // Mostrar popup customizado
                    setTimeout(() => {
                        console.log('💬 Mostrando popup de aviso');
                        showNoNumbersModal();
                    }, 100);
                    return;
                }

                console.log('✅ Cache tem números, populando select');
                populatePhoneSelect(select, phoneNumbersCache, null);
                return;
            }

            try {
                const user = getUserData();
                if (!user) return;

                const cacheKey = 'phone_numbers_' + user.tenantId;
                const cached = cacheManager.get(cacheKey);

                if (cached) {
                    phoneNumbersCache = cached;
                    console.log('📞 Números do cacheManager:', Array.isArray(cached) ? cached.length : 'não é array');

                    if (Array.isArray(cached) && cached.length === 0) {
                        console.warn('⚠️ ❌ CACHE MANAGER VAZIO - SEM NÚMEROS!');
                        select.innerHTML = '<option value="">Nenhum número cadastrado</option>';

                        console.log('🔒 Fechando modal...');
                        closeCreateModal();

                        setTimeout(() => {
                            console.log('💬 Mostrando popup de aviso (cacheManager)');
                            showNoNumbersModal();
                        }, 100);
                        return;
                    }

                    populatePhoneSelect(select, cached, null);
                    return;
                }

                select.innerHTML = '<option value="">Carregando...</option>';
                await rateLimiter.waitIfNeeded();

                const response = await fetch('https://sdr.salesdever.io/webhook/procura_numeros', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: user.tenantId
                    })
                });

                if (response.status === 429) {
                    await new Promise(r => setTimeout(r, 5000));
                    return loadPhoneNumbersCreate();
                }

                if (!response.ok) {
                    select.innerHTML = '<option value="">Erro ao carregar números</option>';
                    throw new Error('Erro ao buscar números');
                }

                const data = await response.json();
                console.log('📡 Resposta do servidor:', data);

                const numbers = Array.isArray(data) ? data : (data.numbers || []);
                phoneNumbersCache = numbers;
                cacheManager.set(cacheKey, numbers);

                console.log('📞 Números carregados do servidor:', Array.isArray(numbers) ? numbers.length : 'não é array');
                console.log('📦 Array de números:', numbers);

                // Verificar se não há números cadastrados
                if (!Array.isArray(numbers) || numbers.length === 0) {
                    console.error('⚠️ ❌ SERVIDOR RETORNOU ARRAY VAZIO OU INVÁLIDO!');
                    select.innerHTML = '<option value="">Nenhum número cadastrado</option>';

                    // Fechar modal primeiro
                    console.log('🔒 Fechando modal...');
                    closeCreateModal();

                    // Mostrar popup customizado perguntando se quer ir para página de números
                    setTimeout(() => {
                        console.log('💬 Mostrando popup de aviso (servidor)');
                        showNoNumbersModal();
                    }, 100);
                    return;
                }

                console.log('✅ Servidor retornou números, populando select');
                populatePhoneSelect(select, numbers, null);
            } catch (error) {
                console.error('Erro:', error);
                if (select.innerHTML === '<option value="">Carregando...</option>') {
                    select.innerHTML = '<option value="">Erro ao carregar números</option>';
                }
                showNotification('error', 'Erro', 'Não foi possível carregar os números.');
            }
        }

        async function loadPhoneNumbers(assistente) {
            const select = document.getElementById('editPhoneNumberSelect');

            console.log('📞 loadPhoneNumbers chamado com assistente:', assistente);
            console.log('number_id_whats:', assistente?.number_id_whats);

            if (phoneNumbersCache) {
                populatePhoneSelect(select, phoneNumbersCache, assistente);
                return;
            }

            try {
                const user = getUserData();
                if (!user) return;

                const cacheKey = 'phone_numbers_' + user.tenantId;
                const cached = cacheManager.get(cacheKey);

                if (cached) {
                    phoneNumbersCache = cached;
                    populatePhoneSelect(select, cached, assistente);
                    return;
                }

                select.innerHTML = '<option value="">Carregando...</option>';
                await rateLimiter.waitIfNeeded();

                const response = await fetch('https://sdr.salesdever.io/webhook/procura_numeros', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: user.tenantId
                    })
                });

                if (response.status === 429) {
                    await new Promise(r => setTimeout(r, 5000));
                    return loadPhoneNumbers(assistente);
                }

                if (!response.ok) {
                    select.innerHTML = '<option value="">Erro ao carregar números</option>';
                    throw new Error('Erro ao buscar números');
                }

                const data = await response.json();
                const numbers = Array.isArray(data) ? data : (data.numbers || []);
                phoneNumbersCache = numbers;
                cacheManager.set(cacheKey, numbers);
                populatePhoneSelect(select, numbers, assistente);
            } catch (error) {
                console.error('Erro:', error);
                if (select.innerHTML === '<option value="">Carregando...</option>') {
                    select.innerHTML = '<option value="">Erro ao carregar números</option>';
                }
                showNotification('error', 'Erro', 'Não foi possível carregar os números.');
            }
        }

        function populatePhoneSelect(selectElement, numbers, assistente) {
            // Identificar se é o select de edição ou criação
            const isEditSelect = selectElement.id === 'editPhoneNumberSelect';

            console.log('📋 populatePhoneSelect:', {
                isEditSelect,
                totalNumbers: numbers?.length,
                assistentePhoneId: assistente?.number_id_whats || assistente?.phone_number_id,
                numbersIds: numbers?.map(n => n.number_id)
            });

            if (numbers && numbers.length > 0) {
                selectElement.innerHTML = '<option value="">Selecione um número</option>';

                let selectedPhone = null;

                numbers.forEach(num => {
                    const option = document.createElement('option');
                    option.value = num.number_id || num.id;
                    option.textContent = (num.number_name || num.name || 'Número') + ' - ' + (num.phone_number || num.number || 'Sem número');

                    // Pré-selecionar o número do assistente
                    if (assistente) {
                        // O assistente tem number_id_whats que deve bater com number_id da tabela numbers_clients
                        const assistentePhoneId = assistente.number_id_whats || assistente.phone_number_id || assistente.number_id || assistente.phoneNumberId;
                        const numId = num.number_id || num.id;

                        console.log('Comparando:', {
                            assistentePhoneId,
                            numId,
                            match: numId === assistentePhoneId
                        });

                        if (numId === assistentePhoneId) {
                            option.selected = true;
                            selectedPhone = num;
                            console.log('✓ Número pré-selecionado:', option.textContent);
                        }
                    }
                    selectElement.appendChild(option);
                });

                // Se for o select de edição, atualizar o card de informações
                if (isEditSelect) {
                    if (selectedPhone) {
                        updateEditPhoneCard(selectedPhone);
                        document.getElementById('editPhoneNumber').value = selectedPhone.number_id || selectedPhone.id;
                    } else {
                        // Se não encontrou, mostrar mensagem de erro ou primeiro número
                        console.warn('⚠️ Número do assistente não encontrado na lista');
                        document.getElementById('editCurrentPhoneName').textContent = 'Número não encontrado';
                        document.getElementById('editCurrentPhoneNumber').textContent = 'Selecione um número válido';
                    }
                }
            } else {
                selectElement.innerHTML = '<option value="">Você não tem números cadastrados</option>';
            }
        }

        function updateEditPhoneCard(phoneData) {
            const phoneName = phoneData.number_name || phoneData.name || 'Número';
            const phoneNumber = phoneData.phone_number || phoneData.number || 'Sem número';

            document.getElementById('editCurrentPhoneName').textContent = phoneName;
            document.getElementById('editCurrentPhoneNumber').textContent = phoneNumber;
        }

        // Adicionar listener para quando o select mudar
        document.addEventListener('DOMContentLoaded', function() {
            const editPhoneSelect = document.getElementById('editPhoneNumberSelect');
            if (editPhoneSelect) {
                editPhoneSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.value) {
                        // Extrair nome e número do texto da opção
                        const fullText = selectedOption.textContent;
                        const parts = fullText.split(' - ');
                        const phoneName = parts[0] || 'Número';
                        const phoneNumber = parts[1] || 'Sem número';

                        document.getElementById('editCurrentPhoneName').textContent = phoneName;
                        document.getElementById('editCurrentPhoneNumber').textContent = phoneNumber;
                        document.getElementById('editPhoneNumber').value = selectedOption.value;

                        // Fechar o select
                        this.style.display = 'none';
                    }
                });
            }
        });

        // Função para chamar diretamente ao clicar no botão
        async function handleCreateAssistantClick(event) {
            console.log('🔘 BOTÃO CRIAR ASSISTENTE CLICADO!');
            console.log('🔄 Chamando saveNovoAssistente...');
            await saveNovoAssistente(event);
        }

        // CRUD - WEBHOOKS ATUALIZADOS COM NOVO DOMÍNIO
        async function saveNovoAssistente(event) {
            console.log('🚀 Função saveNovoAssistente iniciada');
            console.log('📍 Event:', event);

            if (event && event.preventDefault) {
                event.preventDefault();
                console.log('✅ preventDefault executado');
            } else {
                console.warn('⚠️ Event sem preventDefault, continuando...');
            }

            const user = getUserData();
            if (!user) {
                console.error('❌ Usuário não encontrado');
                showNotification('error', 'Erro de Autenticação', 'Faça login novamente.');
                return;
            }
            console.log('✅ Dados do usuário:', user);

            const name = document.getElementById('createAssistenteName').value.trim();
            const msg = document.getElementById('createFirstMessage').value.trim();
            const prompt = document.getElementById('createPrompt').value.trim();
            const phoneId = document.getElementById('createPhoneNumber').value;
            const voiceId = document.getElementById('selectedVoiceId').value;

            console.log('📋 Dados do formulário:');
            console.log('  - Nome:', name);
            console.log('  - Mensagem:', msg);
            console.log('  - Prompt:', prompt ? 'Preenchido' : 'Vazio');
            console.log('  - Phone ID:', phoneId);
            console.log('  - Voice ID:', voiceId);

            // VALIDAÇÃO 1: Verificar se há números cadastrados
            if (!phoneNumbersCache || phoneNumbersCache.length === 0) {
                console.error('❌ Nenhum número cadastrado');
                showNotification('error', 'Sem Números Cadastrados', 'Você precisa adquirir um número de telefone antes de criar um assistente. Vá em "Conexões" → "Comprar Número".');
                return;
            }

            // VALIDAÇÃO 2: Campos obrigatórios básicos
            if (!name) {
                console.error('❌ Nome não preenchido');
                showNotification('error', 'Campo Obrigatório', 'Preencha o nome do assistente.');
                goToStep(1); // Voltar para o step do nome
                return;
            }

            if (!msg) {
                console.error('❌ Primeira mensagem não preenchida');
                showNotification('error', 'Campo Obrigatório', 'Preencha a primeira mensagem.');
                goToStep(1); // Voltar para o step da mensagem
                return;
            }

            if (!phoneId) {
                console.error('❌ Número de telefone não selecionado');
                showNotification('error', 'Campo Obrigatório', 'Selecione um número de telefone para o assistente.');
                goToStep(1); // Voltar para o step do número
                return;
            }

            if (!voiceId) {
                console.error('❌ Voz não selecionada');
                showNotification('error', 'Campo Obrigatório', 'Selecione uma voz para o assistente.');
                goToStep(3); // Voltar para o step da voz
                return;
            }

            if (!prompt) {
                console.error('❌ Prompt não preenchido');
                showNotification('error', 'Campo Obrigatório', 'Preencha o prompt do sistema (instruções para o assistente).');
                goToStep(4); // Voltar para o step do prompt
                return;
            }

            console.log('✅ Todas as validações passaram');

            const btn = document.getElementById('saveCreateBtn');
            const txt = document.getElementById('createBtnText');
            const orig = txt.textContent;
            btn.disabled = true;
            txt.textContent = 'Criando...';

            try {
                await rateLimiter.waitIfNeeded();

                console.log('=== CRIANDO ASSISTENTE ===');
                console.log('Nome:', name);
                console.log('Voice ID selecionado:', voiceId);
                console.log('Avatar selecionado:', selectedAvatarUrl ? 'SIM' : 'NÃO');
                if (selectedAvatarUrl) {
                    console.log('Preview do avatar:', selectedAvatarUrl.substring(0, 100) + '...');
                }

                // Buscar Success Evaluation
                const successEvaluation = document.getElementById('createSuccessEvaluation').value.trim();

                // Buscar novas configurações VAPI
                const firstMessageMode = document.getElementById('createFirstMessageMode')?.value || 'assistant-speaks-first';
                const resumoPrompt = document.getElementById('createSummaryPrompt')?.value.trim() || '';
                const enableEndCall = document.getElementById('createEnableEndCall')?.checked || false;

                const webhookData = {
                    tenant_id: user.tenantId,
                    email: user.email,
                    assistant_name: name,
                    first_message: msg,
                    system_prompt: prompt,
                    phone_number_id: phoneId,
                    voice_id: voiceId,
                    avatar_image: selectedAvatarUrl,
                    success_evaluation: successEvaluation,
                    // Novas configurações VAPI (nomes iguais às colunas do Supabase)
                    first_message_mode: firstMessageMode,
                    resumo_prompt: resumoPrompt,
                    enable_end_call: enableEndCall
                };

                console.log('📤 ENVIANDO PARA WEBHOOK:');
                console.log('URL:', 'https://sdr.salesdever.io/webhook/criar-assistentes-saas-att-');
                console.log('Dados:', JSON.stringify(webhookData, null, 2));

                // WEBHOOK ATUALIZADO - NOVO DOMÍNIO
                const response = await fetch('https://sdr.salesdever.io/webhook/criar-assistentes-saas-att-', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(webhookData)
                });

                console.log('📥 RESPOSTA DO WEBHOOK:', response.status, response.statusText);

                if (response.status === 429) {
                    throw new Error('Muitas requisições. Aguarde alguns segundos e tente novamente.');
                }

                // Aguardar e verificar a resposta real do webhook
                let responseData;
                try {
                    responseData = await response.json();
                } catch (e) {
                    responseData = null;
                }

                if (!response.ok) {
                    let errorMsg = 'Erro ao criar assistente';
                    if (responseData && responseData.message) {
                        errorMsg = responseData.message;
                    } else if (responseData && responseData.error) {
                        errorMsg = responseData.error;
                    } else {
                        errorMsg = `Erro ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                }

                // Verificar se a criação foi bem-sucedida na resposta
                if (responseData && responseData.success === false) {
                    throw new Error(responseData.message || 'Falha ao criar assistente');
                }

                // Somente após confirmar sucesso
                cacheManager.clear();
                closeCreateModal();
                showNotification('success', 'Criado!', 'Assistente criado com sucesso.');
                setTimeout(() => window.location.reload(), 2000);

            } catch (error) {
                console.error('Erro ao criar:', error);
                showNotification('error', 'Erro ao Criar', error.message || 'Não foi possível criar o assistente. Tente novamente.');
            } finally {
                btn.disabled = false;
                txt.textContent = orig;
            }
        }

        async function editarAssistente(assistenteId) {
            const assistente = assistentesData.find(a => a.id === assistenteId);
            if (!assistente) {
                showNotification('error', 'Erro', 'Assistente não encontrado!');
                return;
            }

            // NOVO FLUXO (ÚNICO): abrir em página inteira (sem popup/modal)
            // Guardar o assistente selecionado para a página `assistente-editor.html`
            localStorage.setItem('sd_selected_assistente', JSON.stringify(assistente));
            const idParam = encodeURIComponent(assistente.assistente_id || assistente.id || assistenteId);
            window.location.href = `./assistente-editor.html?assistente_id=${idParam}`;
            return;

            // Fluxo antigo (modal) mantido abaixo por segurança, mas não será mais chamado
            currentEditingAssistente = assistente;

            // LOG para debug - verificar se success_evaluation está vindo do webhook
            console.log('📝 EDITANDO ASSISTENTE:');
            console.log('  - ID:', assistenteId);
            console.log('  - Nome:', assistente.name);
            console.log('  - success_evaluation:', assistente.success_evaluation);
            console.log('  - Objeto completo:', assistente);

            document.getElementById('editAssistenteName').value = assistente.name || '';
            document.getElementById('editFirstMessage').value = assistente.first_message || '';
            document.getElementById('editSuccessEvaluation').value = assistente.success_evaluation || '';

            // Carregar novas configurações VAPI (colunas do Supabase)
            document.getElementById('editFirstMessageMode').value = assistente.first_message_mode || 'assistant-speaks-first';
            document.getElementById('editSummaryPrompt').value = assistente.resumo_prompt || 'Faça um resumo em português, breve, executivo e humanizado, resumindo em poucas linhas a reunião com detalhes quando conveniente. É extremamente importante que não quebre nenhuma linha e não faça nenhum tópico. Escreva um texto corrido como: "A reunião iniciou com o cliente falando sobre X, no meio ele comentou Y, demonstrou interesse e parece qualificado. Consegui marcar a reunião no final."';
            document.getElementById('editEnableEndCall').checked = assistente.enable_end_call === true || assistente.enable_end_call === 'true';
            
            // Log para debug das configurações VAPI
            console.log('📋 Configurações VAPI carregadas do Supabase:');
            console.log('  - first_message_mode:', assistente.first_message_mode);
            console.log('  - resumo_prompt:', assistente.resumo_prompt ? 'Definido' : 'Usando padrão');
            console.log('  - enable_end_call:', assistente.enable_end_call);

            // Carregar voz atual do assistente
            const currentVoiceId = assistente.voice_id || assistente.voice || null;
            document.getElementById('editSelectedVoiceId').value = currentVoiceId || '';

            // Detectar gênero pela voz atual e exibir informações
            let voiceGender = null;
            let currentVoiceName = 'Não selecionada';
            let currentVoiceDesc = 'Nenhuma voz configurada';

            if (currentVoiceId) {
                const currentVoice = ELEVEN_LABS_VOICES.find(v => v.voice_id === currentVoiceId);
                if (currentVoice) {
                    voiceGender = currentVoice.gender;
                    currentVoiceName = currentVoice.name;
                    currentVoiceDesc = currentVoice.description;
                    console.log(`Voz atual: ${currentVoice.name} (${voiceGender})`);
                }
            }

            // Atualizar informações da voz atual
            document.getElementById('editCurrentVoiceName').textContent = currentVoiceName;
            document.getElementById('editCurrentVoiceDesc').textContent = currentVoiceDesc;

            // Preparar vozes filtradas por gênero (mas não mostrar ainda)
            renderEditVoices(voiceGender, currentVoiceId);

            // Garantir que o grid esteja oculto inicialmente
            document.getElementById('editVoicesGrid').style.display = 'none';

            document.getElementById('editModal').style.display = 'block';
            loadPhoneNumbers(assistente);

            // Scroll inicial do chat para mostrar a mensagem de boas-vindas
            setTimeout(function() {
                var messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, 100);
        }

        async function saveAssistenteEdit(event) {
            event.preventDefault();
            if (!currentEditingAssistente) return;

            const user = getUserData();
            if (!user) return;

            const name = document.getElementById('editAssistenteName').value.trim();
            const msg = document.getElementById('editFirstMessage').value.trim();
            const prompt = currentEditingAssistente.prompt_voz || currentEditingAssistente.prompt || '';
            const phoneId = document.getElementById('editPhoneNumber').value;
            const voiceId = document.getElementById('editSelectedVoiceId').value;

            if (!name || !msg || !phoneId) {
                showNotification('error', 'Campos Obrigatórios', 'Preencha todos os campos.');
                return;
            }

            const btn = document.getElementById('saveEditBtn');
            const txt = document.getElementById('editBtnText');
            const orig = txt.textContent;
            btn.disabled = true;
            txt.textContent = 'Salvando...';

            try {
                await rateLimiter.waitIfNeeded();

                // Verificar se o número foi alterado
                const originalPhoneId = currentEditingAssistente.phone_number_id || currentEditingAssistente.number_id;
                const numeroFoiAlterado = phoneId !== originalPhoneId;

                // Verificar se a voz foi alterada
                const originalVoiceId = currentEditingAssistente.voice_id || currentEditingAssistente.voice;
                const vozFoiAlterada = voiceId && voiceId !== originalVoiceId;

                console.log('🔍 Verificação de alterações:');
                console.log('Número original:', originalPhoneId);
                console.log('Número novo:', phoneId);
                console.log('Número foi alterado?', numeroFoiAlterado);
                console.log('Voz original:', originalVoiceId);
                console.log('Voz nova:', voiceId);
                console.log('Voz foi alterada?', vozFoiAlterada);

                // Buscar Success Evaluation
                const successEvaluation = document.getElementById('editSuccessEvaluation').value.trim();

                // Buscar novas configurações VAPI
                const firstMessageMode = document.getElementById('editFirstMessageMode')?.value || 'assistant-speaks-first';
                const resumoPrompt = document.getElementById('editSummaryPrompt')?.value.trim() || '';
                const enableEndCall = document.getElementById('editEnableEndCall')?.checked || false;

                // Preparar dados para o webhook
                const webhookData = {
                    tenant_id: user.tenantId,
                    email: user.email,
                    assistant_id: currentEditingAssistente.assistente_id || currentEditingAssistente.id,
                    number_id: phoneId,
                    phone_number_id: phoneId,
                    assistant_name: name,
                    first_message: msg,
                    system_prompt: prompt,
                    success_evaluation: successEvaluation,
                    // Novas configurações VAPI (nomes iguais às colunas do Supabase)
                    first_message_mode: firstMessageMode,
                    resumo_prompt: resumoPrompt,
                    enable_end_call: enableEndCall
                };

                // Adicionar voice_id apenas se foi alterado
                if (vozFoiAlterada) {
                    webhookData.voice_id = voiceId;
                    console.log('✓ Incluindo voice_id no webhook:', voiceId);
                }

                // WEBHOOK 1: Sempre enviar para o webhook principal de edição
                const response = await fetch('https://sdr.salesdever.io/webhook/editar-assistentes-saas-att', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(webhookData)
                });

                if (response.status === 429) {
                    throw new Error('Muitas requisições. Aguarde alguns segundos e tente novamente.');
                }

                // Aguardar e verificar a resposta real do webhook
                let responseData;
                try {
                    responseData = await response.json();
                } catch (e) {
                    responseData = null;
                }

                if (!response.ok) {
                    let errorMsg = 'Erro ao editar assistente';
                    if (responseData && responseData.message) {
                        errorMsg = responseData.message;
                    } else if (responseData && responseData.error) {
                        errorMsg = responseData.error;
                    } else {
                        errorMsg = `Erro ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                }

                // Verificar se a edição foi bem-sucedida na resposta
                if (responseData && responseData.success === false) {
                    throw new Error(responseData.message || 'Falha ao editar assistente');
                }

                // WEBHOOK 2: Se o número foi alterado, enviar também para o webhook de números
                if (numeroFoiAlterado) {
                    console.log('📞 Número foi alterado! Enviando para webhook de edição de números...');

                    try {
                        await rateLimiter.waitIfNeeded();

                        const responseNumero = await fetch('https://sdr.salesdever.io/webhook/editar-numero-assistentes-saas', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...webhookData,
                                old_phone_number_id: originalPhoneId,
                                new_phone_number_id: phoneId
                            })
                        });

                        if (responseNumero.ok) {
                            console.log('✅ Webhook de número enviado com sucesso!');
                        } else {
                            console.warn('⚠️ Webhook de número falhou, mas continuando...', responseNumero.status);
                        }
                    } catch (errorNumero) {
                        // Não falhar a operação se o segundo webhook falhar
                        console.error('❌ Erro ao enviar webhook de número (não crítico):', errorNumero);
                    }
                }

                // Marcar sessão como concluída se houver uma sessão ativa
                if (window.currentChangeSessionId) {
                    try {
                        await fetch('https://sdr.salesdever.io/webhook/concluir-sessao-edicao', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: window.currentChangeSessionId,
                                tenant_id: user.tenantId,
                                change_completed: true,
                                completed_at: new Date().toISOString()
                            })
                        });
                    } catch (error) {
                        console.error('Erro ao marcar sessão como concluída:', error);
                    }
                }

                // Somente após confirmar sucesso
                cacheManager.clear();
                closeEditModal();
                showNotification('success', 'Salvo!', 'Alterações salvas com sucesso.');
                setTimeout(() => window.location.reload(), 2000);

            } catch (error) {
                console.error('Erro ao editar:', error);
                showNotification('error', 'Erro ao Salvar', error.message || 'Não foi possível salvar as alterações. Tente novamente.');
            } finally {
                btn.disabled = false;
                txt.textContent = orig;
            }
        }

        function deletarAssistente(assistenteId) {
            const assistente = assistentesData.find(a => a.id === assistenteId);
            if (!assistente) {
                showNotification('error', 'Erro', 'Assistente não encontrado!');
                return;
            }

            currentDeletingAssistente = assistente;
            document.getElementById('deleteAssistenteName').textContent = assistente.name || 'Sem nome';
            document.getElementById('deleteConfirmModal').style.display = 'block';
        }

        async function confirmarExclusao() {
            if (!currentDeletingAssistente) return;

            const user = getUserData();
            if (!user) return;

            const btn = document.getElementById('confirmDeleteBtn');
            const txt = document.getElementById('deleteBtnText');
            const orig = txt.textContent;
            btn.disabled = true;
            txt.textContent = 'Excluindo...';

            try {
                await rateLimiter.waitIfNeeded();

                // WEBHOOK ATUALIZADO - NOVO DOMÍNIO
                const response = await fetch('https://sdr.salesdever.io/webhook/excluir-assistentes-saas-att', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenant_id: user.tenantId,
                        email: user.email,
                        assistant_id: currentDeletingAssistente.assistente_id || currentDeletingAssistente.id
                    })
                });

                if (response.status === 429) {
                    throw new Error('Muitas requisições. Aguarde alguns segundos e tente novamente.');
                }

                // Aguardar e verificar a resposta real do webhook
                let responseData;
                try {
                    responseData = await response.json();
                } catch (e) {
                    responseData = null;
                }

                if (!response.ok) {
                    let errorMsg = 'Erro ao excluir assistente';
                    if (responseData && responseData.message) {
                        errorMsg = responseData.message;
                    } else if (responseData && responseData.error) {
                        errorMsg = responseData.error;
                    } else {
                        errorMsg = `Erro ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                }

                // Verificar se a exclusão foi bem-sucedida na resposta
                if (responseData && responseData.success === false) {
                    throw new Error(responseData.message || 'Falha ao excluir assistente');
                }

                // Somente após confirmar sucesso
                cacheManager.clear();
                closeDeleteModal();
                showNotification('success', 'Excluído!', 'Assistente excluído com sucesso.');
                setTimeout(() => window.location.reload(), 2000);

            } catch (error) {
                console.error('Erro ao excluir:', error);
                showNotification('error', 'Erro ao Excluir', error.message || 'Não foi possível excluir o assistente. Tente novamente.');
            } finally {
                btn.disabled = false;
                txt.textContent = orig;
            }
        }

        // Event listeners
        window.onclick = function(event) {
            // Só fecha se clicar EXATAMENTE no fundo do modal (overlay escuro)
            // NÃO fecha se clicar em elementos dentro do modal-content
            const modals = document.querySelectorAll('.modal');
            modals.forEach(function(modal) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        window.addEventListener('load', () => {
            // Fazer as 3 requisições em paralelo ao carregar a página
            Promise.all([
                loadAssistentes(),
                preloadPhoneNumbers(),
                loadCalls()
            ]).catch(error => {
                console.error('Erro ao carregar dados iniciais:', error);
            });

            const editForm = document.getElementById('editForm');
            const createForm = document.getElementById('createForm');

            if (editForm) {
                editForm.addEventListener('submit', saveAssistenteEdit);
                console.log('✅ Event listener de EDIÇÃO registrado');
            } else {
                console.error('❌ Formulário de edição não encontrado');
            }

            if (createForm) {
                createForm.addEventListener('submit', (e) => {
                    console.log('🎯 Submit do formulário de criação disparado');
                    saveNovoAssistente(e);
                });
                console.log('✅ Event listener de CRIAÇÃO registrado');
            } else {
                console.error('❌ Formulário de criação não encontrado');
            }

            // Adicionar listener direto no botão como backup
            const saveCreateBtn = document.getElementById('saveCreateBtn');
            if (saveCreateBtn) {
                saveCreateBtn.addEventListener('click', (e) => {
                    console.log('🔘 Botão "Criar Assistente" clicado diretamente');
                });
                console.log('✅ Event listener do BOTÃO registrado');
            } else {
                console.error('❌ Botão "Criar Assistente" não encontrado');
            }
        });
    
        // FUNÇÕES PARA AS ABAS - ADICIONADO (somente dentro do modal)
        function switchTab(event, tabName) {
            // Remover active de todos os botões e conteúdos
            document.querySelectorAll('.tab-btn').forEach(function(btn) { btn.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(content) { content.classList.remove('active'); });

            // Adicionar active ao botão clicado
            event.target.classList.add('active');

            // Adicionar active ao conteúdo correto
            var activeTabContent = {
                'assistente': 'assistenteTab',
                'tools': 'toolsTab',
                'editor': 'editorTab'
            };

            document.getElementById(activeTabContent[tabName]).classList.add('active');

            // Se for a tab do editor, inicializar flow editor
            if (tabName === 'editor') {
                setTimeout(() => {
                    initFlowEditor();
                }, 100);
            }

            // Se for a tab de tools, resetar e carregar instâncias primeiro e depois o estado das tools
            if (tabName === 'tools') {
                resetAllTools();
                loadInstances().then(() => {
                    setTimeout(() => loadToolsState(), 500);
                });
            }
        }

        // Gerar um Session ID (12 caracteres alfanuméricos)
        function generateShortSessionId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 12; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Formatar resposta da IA preservando parágrafos
        function formatAIResponse(text) {
            if (!text) return '';

            // Escapar HTML para segurança
            var div = document.createElement('div');
            div.textContent = text;
            var escapedText = div.innerHTML;

            // Converter quebras de linha duplas em parágrafos
            escapedText = escapedText.replace(/\n\n/g, '\n\n');

            return escapedText;
        }

        // Inicializar uma nova sessão do editor
        async function initializeEditorSession() {
            // Gerar novo session ID
            window.currentChangeSessionId = generateShortSessionId();
            window.currentChangeChannel = null;

            // Atualizar exibição do session ID
            var sessionIdElement = document.getElementById('currentSessionId');
            if (sessionIdElement) {
                sessionIdElement.textContent = window.currentChangeSessionId;
            }

            // Criar registro da sessão no Supabase via webhook
            try {
                var user = getUserData();
                if (!user || !currentEditingAssistente) return;

                await fetch('https://sdr.salesdever.io/webhook/criar-sessao-edicao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: window.currentChangeSessionId,
                        tenant_id: user.tenantId,
                        email: user.email,
                        assistant_id: currentEditingAssistente.assistente_id || currentEditingAssistente.id,
                        assistant_name: currentEditingAssistente.name,
                        change_completed: false,
                        created_at: new Date().toISOString()
                    })
                });
            } catch (error) {
                console.error('Erro ao criar sessão:', error);
            }
        }

        // Selecionar canal (WhatsApp, Voz ou Ambos)
        async function selectChannel(channel) {
            // Salvar canal selecionado
            window.currentChangeChannel = channel;

            // Remover botões da tela
            var channelButtons = document.querySelector('.channel-buttons');
            if (channelButtons) {
                channelButtons.remove();
            }

            // Adicionar mensagem do usuário no chat
            var messagesContainer = document.getElementById('chatMessages');
            var timeStr = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            var userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            userMessage.innerHTML = '<div class="message-header">' +
                '<div class="message-avatar">VC</div>' +
                '<div class="message-name">Você</div>' +
                '<div class="message-time">' + timeStr + '</div>' +
                '</div>' +
                '<div class="message-content">' + channel + '</div>';
            messagesContainer.appendChild(userMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Adicionar indicador de digitação
            var typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-message ai';
            typingIndicator.id = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="message-header">' +
                '<div class="message-avatar">IA</div>' +
                '<div class="message-name">Editor IA</div>' +
                '<div class="message-time">digitando...</div>' +
                '</div>' +
                '<div class="message-content"><span class="typing-dots">●●●</span></div>';
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Enviar mensagem para a IA
            try {
                var user = getUserData();
                var sessionId = window.currentChangeSessionId || generateShortSessionId();
                window.currentChangeSessionId = sessionId;
                var assistantName = currentEditingAssistente ? currentEditingAssistente.name : 'Assistente';

                var response = await fetch('https://sdr.salesdever.io/webhook/f2060b9a-a6e3-48e3-b94d-abbe898fe1d0/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'sendMessage',
                        sessionId: sessionId,
                        chatInput: channel,
                        change_channel: channel,
                        tenant_id: user ? user.tenantId : null,
                        email: user ? user.email : null,
                        assistant_id: currentEditingAssistente ? (currentEditingAssistente.assistente_id || currentEditingAssistente.id) : null,
                        assistant_name: assistantName
                    })
                });

                // Remover indicador de digitação
                var typing = document.getElementById('typing-indicator');
                if (typing) typing.remove();

                if (!response.ok) {
                    throw new Error('Erro ao enviar mensagem para o chat');
                }

                var data = await response.json();
                var aiResponse = data.output || data.message || data.mensagem || 'Desculpe, não consegui processar sua mensagem.';

                // Adicionar resposta da IA
                var aiTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                var aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message ai';
                aiMessage.innerHTML = '<div class="message-header">' +
                    '<div class="message-avatar">IA</div>' +
                    '<div class="message-name">Editor IA</div>' +
                    '<div class="message-time">' + aiTime + '</div>' +
                    '</div>' +
                    '<div class="message-content">' + formatAIResponse(aiResponse) + '</div>';
                messagesContainer.appendChild(aiMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Erro no chat:', error);

                // Remover indicador de digitação
                var typing = document.getElementById('typing-indicator');
                if (typing) typing.remove();

                // Mostrar mensagem de erro
                var aiTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                var errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message ai';
                errorMessage.innerHTML = '<div class="message-header">' +
                    '<div class="message-avatar">IA</div>' +
                    '<div class="message-name">Editor IA</div>' +
                    '<div class="message-time">' + aiTime + '</div>' +
                    '</div>' +
                    '<div class="message-content" style="color: rgba(255, 87, 108, 0.8);">Desculpe, ocorreu um erro ao processar sua mensagem. Tente novamente.</div>';
                messagesContainer.appendChild(errorMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        async function toggleTool(event) {
            // Prevenir propagação do evento para não interferir com outros cliques
            event.stopPropagation();

            // Encontrar o card pai mais próximo
            const card = event.target.closest('.tool-card');
            if (!card) return;

            // Verificar estado ANTES do toggle
            const wasEnabled = card.classList.contains('enabled');

            // Toggle do estado enabled
            card.classList.toggle('enabled');

            // Mostrar ou esconder os campos de configuração quando a tool é ativada/desativada
            const configDiv = card.querySelector('.tool-config');
            if (configDiv) {
                if (card.classList.contains('enabled')) {
                    configDiv.style.display = 'block';
                } else {
                    configDiv.style.display = 'none';

                    // Se estava ativa e agora foi desativada, chamar webhook
                    if (wasEnabled) {
                        await deactivateTool(card);
                    }
                }
            }
        }

        async function deactivateTool(card) {
            try {
                const toolId = card.getAttribute('data-tool-id');
                const toolRowId = card.getAttribute('data-row-id');
                const toolName = card.querySelector('.tool-info h4').textContent;
                const tenantId = localStorage.getItem('tenant_id');
                const orgPrivateKey = localStorage.getItem('org_private_key');
                const assistantId = currentEditingAssistente?.assistente_id || currentEditingAssistente?.assistant_id || null;

                // Coletar dados dos campos antes de desativar
                const instanceInput = card.querySelector('[data-field="instance"]');
                const urlInput = card.querySelector('[data-field="url"]');

                const payload = {
                    id: toolRowId,
                    tenant_id: tenantId,
                    org_private_key: orgPrivateKey,
                    assistant_id: assistantId,
                    tool_type: toolId,
                    tool_name: toolName,
                    instance: instanceInput ? instanceInput.value.trim() : '',
                    url_or_message: urlInput ? urlInput.value.trim() : '',
                    timestamp: new Date().toISOString()
                };

                console.log('🔴 Desativando tool:', payload);

                const response = await fetch('https://sdr.salesdever.io/webhook/destativar-tools', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    console.warn('⚠️ Erro ao desativar tool:', response.status);
                    return;
                }

                const result = await response.json();
                console.log('✅ Tool desativada com sucesso:', result);
                showNotification('success', 'Tool Desativada', `${toolName} foi desativada com sucesso!`);

            } catch (error) {
                console.error('❌ Erro ao desativar tool:', error);
            }
        }

        function resetAllTools() {
            console.log('🔄 Resetando todas as tools...');
            // Resetar todos os cards de tools
            document.querySelectorAll('.tool-card').forEach(function(card) {
                // Desativar a tool
                card.classList.remove('enabled');
                card.querySelector('.tool-config').style.display = 'none';

                // Limpar campos
                const urlInput = card.querySelector('[data-field="url"]');
                const instanceInput = card.querySelector('[data-field="instance"]');

                if (urlInput) {
                    urlInput.value = '';
                }

                if (instanceInput) {
                    instanceInput.value = '';
                }

                // Remover ID da row
                card.removeAttribute('data-row-id');
            });
            console.log('✅ Todas as tools resetadas');
        }

        async function loadToolsState() {
            try {
                const tenantId = localStorage.getItem('tenant_id');
                const orgPrivateKey = localStorage.getItem('org_private_key');
                const assistantId = currentEditingAssistente?.assistente_id || currentEditingAssistente?.assistant_id || null;

                console.log('🔍 Buscando estado das tools para assistente:', assistantId);

                const response = await fetch('https://sdr.salesdever.io/webhook/ver-tools', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        org_private_key: orgPrivateKey,
                        assistant_id: assistantId
                    })
                });

                if (!response.ok) {
                    console.warn('⚠️ Erro ao buscar tools:', response.status);
                    return;
                }

                const toolsData = await response.json();
                console.log('📦 Tools recebidas:', toolsData);

                // Processar dados das tools (pode vir em diferentes formatos)
                let tools = [];
                if (Array.isArray(toolsData)) {
                    tools = toolsData;
                } else if (toolsData.tools && Array.isArray(toolsData.tools)) {
                    tools = toolsData.tools;
                } else if (toolsData.data && Array.isArray(toolsData.data)) {
                    tools = toolsData.data;
                }

                console.log('✅ Tools recebidas do webhook:', tools);

                // IMPORTANTE: Filtrar apenas tools desta assistente específica
                const currentAssistantId = currentEditingAssistente?.assistente_id || currentEditingAssistente?.assistant_id || null;
                console.log('🔍 ID da assistente atual:', currentAssistantId);

                // Atualizar estado de cada tool card
                tools.forEach(function(tool) {
                    const toolAssistantId = tool.assistant_id || tool.assistente_id || null;

                    // FILTRO: Só processa se for da assistente atual
                    if (toolAssistantId !== currentAssistantId) {
                        console.log(`  ⏭️ Ignorando tool de outra assistente (assistant_id: ${toolAssistantId})`);
                        return; // Pula esta tool
                    }

                    const toolType = tool.tool_type || tool.toolType || tool.type;
                    const isActive = tool.is_active === true || tool.is_active === 'true' || tool.isActive === true;
                    const toolUrl = tool.tool_url || tool.url_or_message || tool.url || '';
                    const instanceName = tool.instancia || tool.instance || tool.instance_name || tool.instanceName || '';
                    const toolRowId = tool.id || tool.tool_id || null;

                    console.log(`  ✅ Tool da assistente ${currentAssistantId}: ${toolType}, Ativo: ${isActive}, ID: ${toolRowId}, Instância: "${instanceName}"`);

                    // Buscar o card correspondente
                    const card = document.querySelector(`.tool-card[data-tool-id="${toolType}"]`);
                    if (card) {
                        // Armazenar o ID da row no card para usar depois
                        if (toolRowId) {
                            card.setAttribute('data-row-id', toolRowId);
                            console.log(`    ✓ ID da row armazenado: ${toolRowId}`);
                        }

                        // Ativar/desativar tool
                        if (isActive) {
                            card.classList.add('enabled');
                            card.querySelector('.tool-config').style.display = 'block';
                        } else {
                            card.classList.remove('enabled');
                            card.querySelector('.tool-config').style.display = 'none';
                        }

                        // Preencher campos
                        const urlInput = card.querySelector('[data-field="url"]');
                        const instanceInput = card.querySelector('[data-field="instance"]');

                        if (urlInput) {
                            urlInput.value = toolUrl;
                            console.log(`    ✓ URL preenchida: ${toolUrl}`);
                        }

                        if (instanceInput && instanceName) {
                            console.log(`    ✓ Tentando selecionar instância: "${instanceName}"`);

                            // Tentar encontrar a opção que corresponde ao instanceName
                            let optionFound = false;
                            Array.from(instanceInput.options).forEach(option => {
                                if (option.value === instanceName || option.textContent === instanceName) {
                                    instanceInput.value = option.value;
                                    optionFound = true;
                                    console.log(`    ✓ Instância selecionada com sucesso: "${option.value}"`);
                                }
                            });

                            if (!optionFound) {
                                console.warn(`    ⚠️ Instância "${instanceName}" não encontrada nas opções!`);
                                const options = Array.from(instanceInput.options).map(opt => `${opt.value} (${opt.textContent})`);
                                console.log(`    ✓ Opções disponíveis:`, options);
                            }
                        }
                    }
                });

                console.log('✅ Estado das tools carregado com sucesso!');

            } catch (error) {
                console.error('❌ Erro ao carregar estado das tools:', error);
            }
        }

        async function loadInstances() {
            try {
                // Buscar dados do usuário do localStorage
                const tenantId = localStorage.getItem('tenant_id');
                const orgPrivateKey = localStorage.getItem('org_private_key');

                console.log('🔍 Buscando instâncias com:', { tenantId, orgPrivateKey });

                const response = await fetch('https://sdr.salesdever.io/webhook/saas-buscar-instancias', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        org_private_key: orgPrivateKey
                    })
                });

                console.log('📡 Status da resposta:', response.status);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                console.log('📦 Dados recebidos (completo):', data);
                console.log('📦 Tipo de dados:', typeof data);

                // Extrair array de instâncias (pode estar em diferentes formatos)
                let instances = [];

                if (Array.isArray(data)) {
                    instances = data;
                } else if (data.instances && Array.isArray(data.instances)) {
                    instances = data.instances;
                } else if (data.data && Array.isArray(data.data)) {
                    instances = data.data;
                } else if (typeof data === 'object') {
                    // Se for um objeto, tentar converter para array
                    instances = Object.values(data);
                }

                console.log('✅ Instâncias processadas:', instances);
                console.log('📊 Quantidade de instâncias:', instances.length);

                // Atualizar todos os selects de instância
                document.querySelectorAll('.tool-instance-select').forEach(function(select) {
                    select.innerHTML = '<option value="">Selecione uma instância</option>';

                    if (instances.length > 0) {
                        instances.forEach(function(instance, index) {
                            console.log(`  Instância ${index}:`, instance);

                            const option = document.createElement('option');

                            // Tentar diferentes campos para valor e texto
                            option.value = instance.instance_name || instance.instanceName || instance.name || instance.id || instance.Instance || instance;
                            option.textContent = instance.instance_name || instance.instanceName || instance.name || instance.id || instance.Instance || `Instância ${index + 1}`;

                            select.appendChild(option);
                        });

                        console.log('✅ Instâncias carregadas com sucesso!');
                    } else {
                        console.warn('⚠️ Nenhuma instância encontrada');
                        select.innerHTML = '<option value="">Nenhuma instância disponível</option>';
                    }
                });

            } catch (error) {
                console.error('❌ Erro ao carregar instâncias:', error);
                document.querySelectorAll('.tool-instance-select').forEach(function(select) {
                    select.innerHTML = '<option value="">Erro ao carregar instâncias</option>';
                });
            }
        }

        async function saveTools() {
            const toolsData = [];
            const enabledToolNames = [];

            // Processar apenas as tools ATIVAS
            document.querySelectorAll('.tool-card.enabled').forEach(function(card) {
                const toolId = card.getAttribute('data-tool-id');
                const toolName = card.querySelector('.tool-info h4').textContent;

                // Coletar dados dos campos de configuração
                const instanceInput = card.querySelector('[data-field="instance"]');
                const urlInput = card.querySelector('[data-field="url"]');

                const toolConfig = {
                    tool_type: toolId,
                    tool_name: toolName,
                    is_active: true,
                    instance: instanceInput ? instanceInput.value.trim() : '',
                    url_or_message: urlInput ? urlInput.value.trim() : ''
                };

                toolsData.push(toolConfig);
                enabledToolNames.push(toolName);
            });

            // Validar se há pelo menos uma tool ativa
            if (toolsData.length === 0) {
                showNotification('error', 'Nenhuma tool ativa', 'Por favor, ative pelo menos uma tool antes de salvar.');
                return;
            }

            // Validar se as tools têm os campos preenchidos
            let hasEmptyFields = false;
            let emptyToolName = '';

            toolsData.forEach(function(tool) {
                // Para agendamento, validar instância e URL
                if (tool.tool_type === 'agendamento') {
                    if (!tool.instance || !tool.url_or_message) {
                        hasEmptyFields = true;
                        emptyToolName = tool.tool_name;
                    }
                } else {
                    // Para outras tools, validar apenas URL
                    if (!tool.url_or_message) {
                        hasEmptyFields = true;
                        emptyToolName = tool.tool_name;
                    }
                }
            });

            if (hasEmptyFields) {
                showNotification('error', 'Campos obrigatórios', `Por favor, preencha todos os campos da tool "${emptyToolName}".`);
                return;
            }

            // Enviar para o webhook
            try {
                const tenantId = localStorage.getItem('tenant_id');
                const orgPrivateKey = localStorage.getItem('org_private_key');
                const assistantId = currentEditingAssistente?.assistente_id || currentEditingAssistente?.assistant_id || null;

                const payload = {
                    tenant_id: tenantId,
                    org_private_key: orgPrivateKey,
                    assistant_id: assistantId,
                    total_tools: toolsData.length,
                    ambas: toolsData.length === 2,
                    tools: toolsData,
                    timestamp: new Date().toISOString()
                };

                console.log('💾 Salvando tools:', payload);

                const response = await fetch('https://sdr.salesdever.io/webhook/adiciona-tool', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Erro ao enviar dados para o webhook');
                }

                const result = await response.json();

                const successMessage = enabledToolNames.length > 0
                    ? `Configurações salvas! Tools ativas: ${enabledToolNames.join(', ')}`
                    : 'Configurações salvas! Todas as tools estão desativadas.';

                showNotification('success', 'Tools Atualizadas!', successMessage);
                console.log('✅ Resposta do webhook:', result);

            } catch (error) {
                console.error('❌ Erro ao salvar tools:', error);
                showNotification('error', 'Erro ao salvar', 'Não foi possível salvar as configurações. Tente novamente.');
            }
        }

        // ===== FLOW EDITOR - VARIÁVEIS GLOBAIS =====
        let flowBlocks = [];
        let flowPromptMaster = '';
        let selectedFlowBlockId = null;
        let availableVapiTools = [];
        let flowEditorInitialized = false;

        // ===== FLOW EDITOR - INICIALIZAÇÃO =====
        function initFlowEditor() {
            if (flowEditorInitialized) return;
            flowEditorInitialized = true;
            
            loadVapiTools();
            loadFlowFromAssistant();
            setupFlowEditorDragDrop();
        }

        // ===== FLOW EDITOR - CARREGAR TOOLS DO VAPI-TOOLS-MANAGER =====
        async function loadVapiTools() {
            try {
                const tenantId = localStorage.getItem('tenant_id');
                if (!tenantId) {
                    console.warn('⚠️ Tenant ID não encontrado');
                    return;
                }

                // Buscar tools do vapi-tools-manager
                // Preferir mesma origem da página, com override opcional via localStorage:
                // localStorage.setItem('vapi_tools_manager_url', 'https://seu-dominio.com')
                const configuredBaseUrl = (localStorage.getItem('vapi_tools_manager_url') || '').trim();
                const origin =
                    (typeof window !== 'undefined' && window.location && window.location.origin) ? window.location.origin : '';
                const baseUrl = configuredBaseUrl || origin;

                // Se estivermos em file:// (origin "null") ou sem baseUrl válida, usar fallback direto.
                if (!baseUrl || baseUrl === 'null' || (typeof window !== 'undefined' && window.location && window.location.protocol === 'file:')) {
                    await loadVapiToolsFallback();
                    return;
                }

                const response = await fetch(`${baseUrl.replace(/\/$/, '')}/api/tools/${tenantId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.warn('⚠️ Erro ao buscar tools:', response.status);
                    // Fallback: tentar webhook alternativo
                    await loadVapiToolsFallback();
                    return;
                }

                const data = await response.json();
                if (data.success && data.tools) {
                    availableVapiTools = data.tools.filter(tool => tool.is_active !== false);
                    renderVapiToolsPalette();
                    console.log('✅ Tools VAPI carregadas:', availableVapiTools);
                }
            } catch (error) {
                console.error('❌ Erro ao carregar tools VAPI:', error);
                // Fallback
                await loadVapiToolsFallback();
            }
        }

        // Fallback: buscar tools via webhook existente
        async function loadVapiToolsFallback() {
            try {
                const tenantId = localStorage.getItem('tenant_id');
                const orgPrivateKey = localStorage.getItem('org_private_key');
                
                const response = await fetch('https://sdr.salesdever.io/webhook/ver-tools', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        org_private_key: orgPrivateKey
                    })
                });

                if (!response.ok) return;

                const toolsData = await response.json();
                let tools = [];
                
                if (Array.isArray(toolsData)) {
                    tools = toolsData;
                } else if (toolsData.tools && Array.isArray(toolsData.tools)) {
                    tools = toolsData.tools;
                }

                // Mapear tools para formato do flow editor
                availableVapiTools = tools
                    .filter(tool => tool.is_active !== false)
                    .map(tool => ({
                        id: tool.id || tool.tool_id,
                        name: tool.tool_name || tool.name,
                        type: tool.tool_type || tool.type,
                        description: tool.prompt_instructions || tool.description || '',
                        config: {
                            instancia: tool.instancia || tool.instance,
                            file_url: tool.file_url || tool.url,
                            mensagem: tool.url_or_message || tool.mensagem
                        }
                    }));

                renderVapiToolsPalette();
                console.log('✅ Tools carregadas (fallback):', availableVapiTools);
            } catch (error) {
                console.error('❌ Erro no fallback de tools:', error);
            }
        }

        // Renderizar tools na palette
        function renderVapiToolsPalette() {
            const container = document.getElementById('flowToolsPalette');
            if (!container) return;

            if (availableVapiTools.length === 0) {
                container.innerHTML = '<div class="palette-loading">Nenhuma tool cadastrada</div>';
                return;
            }

            container.innerHTML = availableVapiTools.map(tool => {
                const iconColor = getToolIconColor(tool.type);
                return `
                    <div class="palette-block" draggable="true" data-type="tool" data-tool-id="${tool.id}" onclick="addFlowToolBlock('${tool.id}')">
                        <div class="palette-block-icon" style="background: ${iconColor.bg}; color: ${iconColor.color};">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            </svg>
                        </div>
                        <div class="palette-block-info">
                            <div class="palette-block-name">${tool.name}</div>
                            <div class="palette-block-desc">${tool.type}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getToolIconColor(type) {
            const colors = {
                'mensagem': { bg: 'rgba(59, 130, 246, 0.2)', color: '#3b82f6' },
                'documento': { bg: 'rgba(251, 191, 36, 0.2)', color: '#fbbf24' },
                'encerramento': { bg: 'rgba(239, 68, 68, 0.2)', color: '#ef4444' }
            };
            return colors[type] || { bg: 'rgba(165, 148, 255, 0.2)', color: '#A594FF' };
        }

        // ===== FLOW EDITOR - ADICIONAR BLOCOS =====
        function addFlowBlock(type) {
            const block = createFlowBlock(type);
            flowBlocks.push(block);
            renderFlowBlocks();
            selectFlowBlock(block.id);
        }

        function addFlowToolBlock(toolId) {
            const tool = availableVapiTools.find(t => t.id === toolId);
            if (!tool) return;

            const block = createFlowBlock('tool', tool);
            flowBlocks.push(block);
            renderFlowBlocks();
            selectFlowBlock(block.id);
        }

        function createFlowBlock(type, tool = null) {
            const id = `block_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            const defaultContent = {
                'primeira_mensagem': 'Olá! Sou a assistente virtual. Como posso ajudar?',
                'texto': 'Digite sua mensagem aqui...',
                'conectivos': 'Para onde direcionar o lead?',
                'aguardar': 'Aguardar resposta',
                'encerrar': 'Encerrar conversa',
                'tool': tool ? tool.name : 'Tool'
            };

            const block = {
                id: id,
                type: type,
                content: defaultContent[type] || '',
                toolId: tool ? tool.id : null,
                toolName: tool ? tool.name : null,
                toolType: tool ? tool.type : null,
                timeout: type === 'aguardar' ? 30 : null,
                routes: type === 'conectivos' ? [
                    {
                        id: `route_${Date.now()}_1`,
                        label: '✓ Caminho positivo',
                        color: '#22c55e',
                        keywords: ['sim', 'pode', 'claro'],
                        response: '',
                        destinationType: 'continue'
                    },
                    {
                        id: `route_${Date.now()}_2`,
                        label: '✗ Caminho negativo',
                        color: '#ef4444',
                        keywords: ['não', 'ocupado'],
                        response: '',
                        destinationType: 'continue'
                    }
                ] : null,
                fallback: type === 'conectivos' ? {
                    label: '? Não entendi',
                    response: '',
                    destinationType: 'loop'
                } : null
            };

            return block;
        }

        // ===== FLOW EDITOR - RENDERIZAR BLOCOS =====
        function renderFlowBlocks() {
            const container = document.getElementById('flowBlocksContainer');
            if (!container) return;

            if (flowBlocks.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: rgba(255,255,255,0.5);">Adicione blocos arrastando da paleta ao lado</div>';
                return;
            }

            container.innerHTML = flowBlocks.map((block, index) => {
                const typeInfo = getFlowBlockTypeInfo(block.type);
                const isSelected = block.id === selectedFlowBlockId;
                
                return `
                    <div class="flow-connector-line"></div>
                    <div class="flow-block-node ${isSelected ? 'selected' : ''}" 
                         onclick="selectFlowBlock('${block.id}')" 
                         data-block-id="${block.id}">
                        <div class="flow-block-header">
                            <div class="flow-block-icon" style="background: ${typeInfo.bgColor}; color: ${typeInfo.color};">
                                ${typeInfo.icon}
                            </div>
                            <div class="flow-block-info">
                                <div class="flow-block-title">${typeInfo.label}</div>
                                ${block.toolName ? `<div class="flow-block-subtitle">${block.toolName}</div>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="flow-block-number">${index + 1}</div>
                                <button onclick="deleteFlowBlock('${block.id}'); event.stopPropagation();" 
                                        style="width: 24px; height: 24px; border: none; background: rgba(239,68,68,0.2); color: #ef4444; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;"
                                        onmouseover="this.style.background='rgba(239,68,68,0.3)'"
                                        onmouseout="this.style.background='rgba(239,68,68,0.2)'"
                                        title="Excluir bloco">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="flow-block-content ${!block.content ? 'empty' : ''}">
                            ${block.content || 'Clique para configurar...'}
                        </div>
                    </div>
                `;
            }).join('') + '<div class="flow-connector-line"></div>';
        }

        function getFlowBlockTypeInfo(type) {
            const types = {
                'primeira_mensagem': {
                    label: 'Primeira Mensagem',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
                    color: '#8b5cf6',
                    bgColor: 'rgba(139, 92, 246, 0.2)'
                },
                'texto': {
                    label: 'Mensagem',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
                    color: '#10b981',
                    bgColor: 'rgba(16, 185, 129, 0.2)'
                },
                'conectivos': {
                    label: 'Caminhos',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
                    color: '#a855f7',
                    bgColor: 'rgba(168, 85, 247, 0.2)'
                },
                'aguardar': {
                    label: 'Aguardar',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
                    color: '#fbbf24',
                    bgColor: 'rgba(251, 191, 36, 0.2)'
                },
                'encerrar': {
                    label: 'Encerrar',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
                    color: '#ef4444',
                    bgColor: 'rgba(239, 68, 68, 0.2)'
                },
                'tool': {
                    label: 'Tool',
                    icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',
                    color: '#A594FF',
                    bgColor: 'rgba(165, 148, 255, 0.2)'
                }
            };
            return types[type] || types['texto'];
        }

        // ===== FLOW EDITOR - SELEÇÃO E PROPRIEDADES =====
        function selectFlowBlock(blockId) {
            selectedFlowBlockId = blockId;
            renderFlowBlocks();
            openFlowProperties(blockId);
        }

        function openFlowProperties(blockId) {
            const block = flowBlocks.find(b => b.id === blockId);
            if (!block) return;

            const panel = document.getElementById('flowPropertiesPanel');
            const content = document.getElementById('flowPropertiesContent');
            if (!panel || !content) return;

            const typeInfo = getFlowBlockTypeInfo(block.type);
            
            if (block.type === 'conectivos') {
                content.innerHTML = `
                    <div class="property-group">
                        <label class="property-label">Título do Conectivo</label>
                        <input type="text" class="property-input" value="${block.content || ''}" 
                               onchange="updateFlowBlock('${blockId}', 'content', this.value)">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Variável a Analisar</label>
                        <input type="text" class="property-input" value="{{ultima_resposta}}" 
                               placeholder="{{ultima_resposta}}">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Rotas</label>
                        <div id="flowRoutesList"></div>
                        <button class="flow-header-btn" onclick="addFlowRoute('${blockId}')" style="margin-top: 12px; width: 100%;">
                            + Adicionar Rota
                        </button>
                        <button class="flow-header-btn" onclick="saveSingleBlock('${blockId}')" style="margin-top: 8px; width: 100%; background: rgba(34,197,94,0.2); color: #22c55e; border: 1px solid rgba(34,197,94,0.3);">
                            💾 Salvar Bloco Agora
                        </button>
                    </div>
                `;
                renderFlowRoutes(blockId);
            } else if (block.type === 'tool') {
                const tool = availableVapiTools.find(t => t.id === block.toolId);
                content.innerHTML = `
                    <div class="property-group">
                        <label class="property-label">Tool</label>
                        <input type="text" class="property-input" value="${block.toolName || ''}" disabled>
                    </div>
                    <div class="property-group">
                        <label class="property-label">Descrição/Instruções</label>
                        <textarea class="property-input property-textarea" 
                                  onchange="updateFlowBlock('${blockId}', 'content', this.value)">${block.content || ''}</textarea>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="property-group">
                        <label class="property-label">Conteúdo</label>
                        <textarea class="property-input property-textarea" 
                                  onchange="updateFlowBlock('${blockId}', 'content', this.value)">${block.content || ''}</textarea>
                    </div>
                    ${block.type === 'aguardar' ? `
                        <div class="property-group">
                            <label class="property-label">Timeout (segundos)</label>
                            <input type="number" class="property-input" value="${block.timeout || 30}" 
                                   onchange="updateFlowBlock('${blockId}', 'timeout', parseInt(this.value))">
                        </div>
                    ` : ''}
                `;
            }

            panel.style.display = 'flex';
        }

        function closeFlowProperties() {
            const panel = document.getElementById('flowPropertiesPanel');
            if (panel) panel.style.display = 'none';
            selectedFlowBlockId = null;
            renderFlowBlocks();
        }

        function updateFlowBlock(blockId, property, value) {
            const block = flowBlocks.find(b => b.id === blockId);
            if (block) {
                block[property] = value;
                console.log(`✅ [FlowEditor] Bloco ${blockId} atualizado: ${property} = ${value}`);
                
                // Se for um bloco de caminhos e editar conteúdo, salvar automaticamente após delay
                if (block.type === 'conectivos' && property === 'content') {
                    console.log(`💾 [FlowEditor] Bloco ${blockId} é conectivos, agendando salvamento automático...`);
                    clearTimeout(window._saveBlockContentTimeout);
                    window._saveBlockContentTimeout = setTimeout(() => {
                        console.log(`💾 [FlowEditor] Salvando bloco ${blockId} automaticamente após edição de conteúdo`);
                        saveSingleBlock(blockId);
                    }, 1500); // Salvar após 1.5 segundos de inatividade
                }
                
                renderFlowBlocks();
            }
        }

        function renderFlowRoutes(blockId) {
            const block = flowBlocks.find(b => b.id === blockId);
            if (!block) {
                console.warn('⚠️ [FlowEditor] Bloco não encontrado:', blockId);
                return;
            }
            
            console.log('🔍 [FlowEditor] renderFlowRoutes para bloco:', blockId, {
                type: block.type,
                content: block.content,
                routes: block.routes,
                routesCount: block.routes ? block.routes.length : 0,
                routesIsArray: Array.isArray(block.routes),
                fallback: block.fallback,
                block_completo: block
            });
            
            // ⚠️ IMPORTANTE: Para blocos de caminhos/conectivos, routes DEVE ser um array
            if (block.type === 'conectivos' || block.type === 'caminhos') {
                if (!block.routes || !Array.isArray(block.routes) || block.routes.length === 0) {
                    console.error('❌ [FlowEditor] PROBLEMA: Bloco de caminhos sem routes!', {
                        blockId: blockId,
                        blockType: block.type,
                        hasRoutes: !!block.routes,
                        routesType: typeof block.routes,
                        routesIsArray: Array.isArray(block.routes),
                        routesLength: block.routes ? block.routes.length : 0
                    });
            const container = document.getElementById('flowRoutesList');
                    if (container) {
                        container.innerHTML = '<p style="color: #ef4444; padding: 12px;">⚠️ Erro: Routes não foram carregadas. Verifique o console.</p>';
                    }
                    return;
                }
            } else {
                // Para outros tipos de blocos, não precisa de routes
                if (!block.routes || block.routes.length === 0) {
                    const container = document.getElementById('flowRoutesList');
                    if (container) {
                        container.innerHTML = '<p style="color: #999; padding: 12px;">Nenhuma rota configurada</p>';
                    }
                    return;
                }
            }

            const container = document.getElementById('flowRoutesList');
            if (!container) {
                console.warn('⚠️ [FlowEditor] Container flowRoutesList não encontrado');
                return;
            }

            console.log('✅ [FlowEditor] Renderizando', block.routes.length, 'routes');

            let routesHtml = block.routes.map((route, index) => {
                const borderColor = route.color || '#6b7280';
                return `
                <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; border: 2px solid ${borderColor};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <input type="text" class="property-input" value="${route.label || ''}" 
                               onchange="updateFlowRoute('${blockId}', '${route.id}', 'label', this.value)"
                               style="flex: 1; margin-right: 8px;">
                        <button onclick="deleteFlowRoute('${blockId}', '${route.id}')" 
                                style="padding: 6px 12px; background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; cursor: pointer;">
                            Excluir
                        </button>
                    </div>
                    <input type="text" class="property-input" value="${(route.keywords || []).join(', ')}" 
                           placeholder="Palavras-chave (separadas por vírgula)"
                           onchange="updateFlowRoute('${blockId}', '${route.id}', 'keywords', this.value.split(',').map(k => k.trim()).filter(k => k))"
                           style="margin-bottom: 8px;">
                    <textarea class="property-input" rows="2" placeholder="Resposta automática (opcional)"
                              onchange="updateFlowRoute('${blockId}', '${route.id}', 'response', this.value)">${route.response || ''}</textarea>
                    ${route.gotoBlockId ? `<div style="margin-top: 8px; font-size: 12px; color: #999;">→ Vai para: ${route.gotoBlockId}</div>` : ''}
                </div>
            `;
            }).join('');
            
            // Adicionar fallback se existir
            if (block.fallback) {
                routesHtml += `
                <div style="padding: 12px; background: rgba(107,114,128,0.1); border-radius: 8px; margin-bottom: 8px; border: 2px dashed #6b7280;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #6b7280;">Fallback: ${block.fallback.label || 'Não entendi'}</strong>
                        <button onclick="deleteFlowRoute('${blockId}', 'fallback')" 
                                style="padding: 6px 12px; background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; cursor: pointer;">
                            Excluir
                        </button>
                    </div>
                    <textarea class="property-input" rows="2" placeholder="Resposta do fallback"
                              onchange="updateFlowRoute('${blockId}', 'fallback', 'response', this.value)">${block.fallback.response || ''}</textarea>
                    ${block.fallback.gotoBlockId ? `<div style="margin-top: 8px; font-size: 12px; color: #999;">→ Volta para: ${block.fallback.gotoBlockId}</div>` : ''}
                </div>
                `;
            }
            
            container.innerHTML = routesHtml;
        }

        function addFlowRoute(blockId) {
            const block = flowBlocks.find(b => b.id === blockId);
            if (!block) return;

            const route = {
                id: `route_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                label: 'Nova Rota',
                color: '#6b7280',
                keywords: [],
                response: '',
                destinationType: 'continue'
            };

            if (!block.routes) block.routes = [];
            block.routes.push(route);
            renderFlowRoutes(blockId);
        }

        function updateFlowRoute(blockId, routeId, property, value) {
            const block = flowBlocks.find(b => b.id === blockId);
            if (!block || !block.routes) {
                console.warn('⚠️ [FlowEditor] updateFlowRoute: Bloco não encontrado ou sem routes:', blockId);
                return;
            }

            // Tentar encontrar a route por id primeiro, depois por routeKey
            let route = block.routes.find(r => r.id === routeId);
            if (!route) {
                // Se não encontrou por id, tentar por routeKey
                route = block.routes.find(r => r.routeKey === routeId);
            }
            
            if (route) {
                route[property] = value;
                console.log(`✅ [FlowEditor] Route atualizada: block=${blockId}, route=${routeId}, property=${property}`, route);
                
                // Salvar o bloco automaticamente após um pequeno delay (debounce)
                clearTimeout(window._saveBlockTimeout);
                window._saveBlockTimeout = setTimeout(() => {
                    console.log(`💾 [FlowEditor] Salvando bloco ${blockId} automaticamente após edição de route`);
                    saveSingleBlock(blockId);
                }, 1000); // Salvar após 1 segundo de inatividade
            } else if (routeId === 'fallback') {
                // Se for fallback, atualizar diretamente no objeto block.fallback
                const block = flowBlocks.find(b => b.id === blockId);
                if (block && block.fallback) {
                    block.fallback[property] = value;
                    console.log(`✅ [FlowEditor] Fallback atualizado: block=${blockId}, property=${property}`, block.fallback);
                    
                    // Salvar o bloco automaticamente
                    clearTimeout(window._saveBlockTimeout);
                    window._saveBlockTimeout = setTimeout(() => {
                        console.log(`💾 [FlowEditor] Salvando bloco ${blockId} automaticamente após edição de fallback`);
                        saveSingleBlock(blockId);
                    }, 1000);
                }
            } else {
                console.error('❌ [FlowEditor] Route não encontrada para atualizar:', {
                    blockId,
                    routeId,
                    availableRoutes: block.routes.map(r => ({ id: r.id, routeKey: r.routeKey }))
                });
            }
        }
        
        async function saveSingleBlock(blockId) {
            const block = flowBlocks.find(b => b.id === blockId);
            if (!block) {
                console.warn('⚠️ [FlowEditor] Bloco não encontrado para salvar:', blockId);
                return;
            }
            
            // 🔍 DEBUG: Verificar estado do bloco ANTES de processar
            console.log('🔍 [DEBUG] ===== INÍCIO saveSingleBlock =====');
            console.log('🔍 [DEBUG] Block ID:', blockId);
            console.log('🔍 [DEBUG] Block encontrado:', block);
            console.log('🔍 [DEBUG] Block.type:', block.type);
            console.log('🔍 [DEBUG] Block.routes existe?', !!block.routes);
            console.log('🔍 [DEBUG] Block.routes é array?', Array.isArray(block.routes));
            console.log('🔍 [DEBUG] Block.routes length:', block.routes ? block.routes.length : 0);
            console.log('🔍 [DEBUG] Block.routes completo:', block.routes);
            console.log('🔍 [DEBUG] Block.fallback existe?', !!block.fallback);
            console.log('🔍 [DEBUG] Block.fallback completo:', block.fallback);
            console.log('🔍 [DEBUG] É tipo conectivos?', block.type === 'conectivos');
            console.log('🔍 [DEBUG] ===== FIM DEBUG INICIAL =====');
            
            try {
                const assistantId = currentEditingAssistente?.assistente_id || currentEditingAssistente?.assistant_id || null;
                if (!assistantId) {
                    console.warn('⚠️ [FlowEditor] Nenhum assistente selecionado');
                    return;
                }

                const tenantId = localStorage.getItem('tenant_id');
                if (!tenantId) {
                    console.warn('⚠️ [FlowEditor] Tenant ID não encontrado');
                    return;
                }

                // Buscar flow_id primeiro
                const flowResponse = await fetch(`/api/flows/by-assistant/${encodeURIComponent(assistantId)}?tenant_id=${encodeURIComponent(tenantId)}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!flowResponse.ok) {
                    throw new Error('Erro ao buscar flow');
                }

                const flowData = await flowResponse.json();
                const flowId = flowData.flow?.id;
                
                if (!flowId) {
                    throw new Error('Flow não encontrado');
                }

                // Mapear tipo de volta para o formato do banco
                let blockType = block.type;
                if (blockType === 'texto') blockType = 'mensagem';
                if (blockType === 'conectivos') blockType = 'caminhos';
                if (blockType === 'tool') blockType = 'ferramenta';

                // Preparar dados do bloco
                const blockData = {
                    block_key: block.id,
                    block_type: blockType,
                    content: block.content || '',
                    order_index: 0,
                    position_x: 0,
                    position_y: 0,
                };

                // Campos opcionais
                if (block.timeout) blockData.timeout_seconds = block.timeout;
                if (block.toolType) blockData.tool_type = block.toolType;
                if (block.tool_config) blockData.tool_config = block.tool_config;

                // ⭐ NOVO: Se o bloco é do tipo "caminhos" (conectivos), incluir routes_data (JSONB)
                console.log('🔍 [DEBUG] Verificando se deve incluir routes_data...');
                console.log('🔍 [DEBUG] block.type === "conectivos"?', block.type === 'conectivos');
                console.log('🔍 [DEBUG] block.type valor real:', block.type);
                
                if (block.type === 'conectivos') {
                    console.log('✅ [DEBUG] Entrou no IF de conectivos!');
                    const routesData = [];
                    
                    // Adicionar routes normais se existirem
                    console.log('🔍 [DEBUG] Verificando block.routes...');
                    console.log('🔍 [DEBUG] block.routes existe?', !!block.routes);
                    console.log('🔍 [DEBUG] block.routes.length:', block.routes ? block.routes.length : 'N/A');
                    
                    if (block.routes && Array.isArray(block.routes) && block.routes.length > 0) {
                        console.log(`✅ [DEBUG] Processando ${block.routes.length} routes normais`);
                        block.routes.forEach((route, index) => {
                            let routeKey = route.routeKey;
                            if (!routeKey) {
                                if (route.id && typeof route.id === 'string' && route.id.includes('_')) {
                                    routeKey = route.id;
                                } else {
                                    routeKey = `${block.id}_route_${index + 1}`;
                                }
                            }
                            
                            routesData.push({
                                route_key: routeKey,
                                label: route.label || '',
                                ordem: route.ordem !== undefined ? route.ordem : (index + 1),
                                cor: route.color || '#6b7280',
                                keywords: Array.isArray(route.keywords) ? route.keywords : [],
                                response: route.response || '',
                                destination_type: route.destinationType || 'continuar',
                                destination_block_key: route.gotoBlockId || null,
                                max_loop_attempts: 2,
                                is_fallback: false
                            });
                        });
                    }
                    
                    // Adicionar fallback se existir
                    if (block.fallback) {
                        const fallbackRouteKey = block.fallback.routeKey || `fallback_${block.id}`;
                        routesData.push({
                            route_key: fallbackRouteKey,
                            label: block.fallback.label || 'Não entendi',
                            ordem: block.fallback.ordem !== undefined ? block.fallback.ordem : 999,
                            cor: '#6b7280',
                            keywords: [],
                            response: block.fallback.response || '',
                            destination_type: block.fallback.destinationType || 'loop',
                            destination_block_key: block.fallback.gotoBlockId || null,
                            max_loop_attempts: 2,
                            is_fallback: true
                        });
                    }
                    
                    console.log('🔍 [DEBUG] Total de routes preparadas para routes_data:', routesData.length);
                    console.log('🔍 [DEBUG] routes_data preparado:', routesData);
                    
                    if (routesData.length > 0) {
                        // ⭐ SALVAR EM routes_data (JSONB), NÃO em routes separado
                        blockData.routes_data = routesData;
                        console.log(`✅ [FlowEditor] Salvando bloco ${block.id} (${blockType}) com ${routesData.length} routes em routes_data:`, routesData.map(r => ({ route_key: r.route_key, label: r.label, is_fallback: r.is_fallback })));
                    } else {
                        console.warn(`⚠️ [FlowEditor] Bloco ${block.id} é do tipo 'caminhos' mas não tem routes nem fallback!`);
                        console.warn('🔍 [DEBUG] Estado do bloco quando não tem routes:', {
                            hasRoutes: !!block.routes,
                            routesLength: block.routes ? block.routes.length : 0,
                            hasFallback: !!block.fallback,
                            blockType: block.type
                        });
                        // ⭐ IMPORTANTE: Se não tem routes, salvar array vazio para limpar routes_data antigas
                        blockData.routes_data = [];
                    }
                } else {
                    console.warn(`⚠️ [DEBUG] Bloco ${block.id} NÃO é do tipo 'conectivos'! Tipo atual: ${block.type}`);
                }

        // Log do payload completo antes de enviar
        console.log(`📤 [FlowEditor] Enviando PATCH para /api/flows/${flowId}/blocks/${block.id}:`, {
            block_key: blockData.block_key,
            block_type: blockData.block_type,
            routes_data_count: blockData.routes_data ? blockData.routes_data.length : 0,
            routes_data: blockData.routes_data || [],
            has_routes_old: !!blockData.routes // ⚠️ DEPRECATED
        });

                // Salvar o bloco via PATCH
                const saveResponse = await fetch(`/api/flows/${flowId}/blocks/${block.id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(blockData)
                });

                if (!saveResponse.ok) {
                    const errorText = await saveResponse.text();
                    console.error('❌ [FlowEditor] Erro ao salvar bloco:', {
                        status: saveResponse.status,
                        statusText: saveResponse.statusText,
                        errorText: errorText
                    });
                    
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { detail: errorText || 'Erro desconhecido' };
                    }
                    
                    showNotification('error', 'Erro ao salvar', errorData.detail || 'Não foi possível salvar o bloco');
                    return;
                }

        const result = await saveResponse.json();
        const routesCount = result.routes_data_count || result.routes_saved || 0;
        console.log(`✅ [FlowEditor] Bloco ${block.id} salvo com sucesso. Routes em routes_data: ${routesCount}`, result);
        
        if (routesCount > 0) {
            showNotification('success', 'Bloco Salvo', `${routesCount} route(s) salva(s) em routes_data com sucesso!`);
        }
                
            } catch (error) {
                console.error('❌ [FlowEditor] Erro ao salvar bloco individual:', error);
            }
        }

        function deleteFlowRoute(blockId, routeId) {
            const block = flowBlocks.find(b => b.id === blockId);
            if (!block || !block.routes) return;

            block.routes = block.routes.filter(r => r.id !== routeId);
            renderFlowRoutes(blockId);
        }

        function deleteFlowBlock(blockId) {
            if (confirm('Tem certeza que deseja excluir este bloco?')) {
                flowBlocks = flowBlocks.filter(b => b.id !== blockId);
                if (selectedFlowBlockId === blockId) {
                    closeFlowProperties();
                }
                renderFlowBlocks();
            }
        }

        // ===== FLOW EDITOR - DRAG & DROP =====
        function setupFlowEditorDragDrop() {
            // Implementar drag & drop básico
            const palette = document.getElementById('flowBlocksPalette');
            const canvas = document.getElementById('flowCanvas');

            if (!palette || !canvas) return;

            // Drag start
            palette.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('palette-block')) {
                    const type = e.target.getAttribute('data-type');
                    const toolId = e.target.getAttribute('data-tool-id');
                    e.dataTransfer.setData('block-type', type);
                    if (toolId) e.dataTransfer.setData('tool-id', toolId);
                    e.dataTransfer.effectAllowed = 'copy';
                }
            });

            // Drop
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });

            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('block-type');
                const toolId = e.dataTransfer.getData('tool-id');

                if (type === 'tool' && toolId) {
                    addFlowToolBlock(toolId);
                } else if (type) {
                    addFlowBlock(type);
                }
            });
        }

        // ===== FLOW EDITOR - SALVAR/CARREGAR =====
        async function flowEditorSave() {
            try {
                const assistantId = currentEditingAssistente?.assistente_id || currentEditingAssistente?.assistant_id || null;
                if (!assistantId) {
                    showNotification('error', 'Erro', 'Nenhum assistente selecionado');
                    return;
                }

                const tenantId = localStorage.getItem('tenant_id');
                if (!tenantId) {
                    showNotification('error', 'Erro', 'Tenant ID não encontrado');
                    return;
                }

                // Buscar flow_id primeiro
                const flowResponse = await fetch(`/api/flows/by-assistant/${encodeURIComponent(assistantId)}?tenant_id=${encodeURIComponent(tenantId)}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!flowResponse.ok) {
                    throw new Error('Erro ao buscar flow');
                }

                const flowData = await flowResponse.json();
                const flowId = flowData.flow?.id;
                
                if (!flowId) {
                    throw new Error('Flow não encontrado');
                }

                // Converter blocos e routes para o formato da API
                const blocks = flowBlocks.map((block, index) => {
                    // Mapear tipo de volta para o formato do banco
                    let blockType = block.type;
                    if (blockType === 'texto') blockType = 'mensagem';
                    if (blockType === 'conectivos') blockType = 'caminhos';
                    if (blockType === 'tool') blockType = 'ferramenta';

                    return {
                        block_key: block.id,
                        block_type: blockType,
                        content: block.content || '',
                        order_index: index,
                        position_x: 100,
                        position_y: index * 150,
                        next_block_key: null, // TODO: implementar conexões
                        variable_name: blockType === 'aguardar' ? '{{ultima_resposta}}' : null,
                        timeout_seconds: block.timeout || null,
                        tool_type: block.toolType || null,
                        tool_config: {},
                        end_metadata: {}
                    };
                });

                // Converter routes para o formato da API
                const routes = [];
                flowBlocks.forEach(block => {
                    if (block.type === 'conectivos' && block.routes) {
                        console.log(`🔍 [FlowEditor] Processando blocos de caminhos: ${block.id}, routes:`, block.routes);
                        console.log(`📋 [FlowEditor] Bloco ${block.id} tem ${block.routes.length} routes para processar`);
                        
                        block.routes.forEach((route, index) => {
                            // Usar routeKey se existir (preserva o route_key original do banco)
                            // Caso contrário, tentar usar route.id se for um route_key válido
                            // Senão, gerar um novo baseado no block_key
                            let routeKey = route.routeKey;
                            if (!routeKey) {
                                // Se route.id parece ser um route_key (começa com block_key), usar ele
                                if (route.id && typeof route.id === 'string' && route.id.includes('_')) {
                                    routeKey = route.id;
                                    console.log(`⚠️ [FlowEditor] Route sem routeKey, usando route.id como routeKey: ${routeKey}`);
                                } else {
                                    routeKey = `${block.id}_route_${index + 1}`;
                                    console.log(`⚠️ [FlowEditor] Route sem routeKey, gerando novo: ${routeKey}`);
                                }
                            }
                            
                            const routeData = {
                                block_key: block.id, // CAM001, etc.
                                route_key: routeKey, // Preserva route_key original ou gera novo
                                label: route.label || '',
                                ordem: route.ordem !== undefined ? route.ordem : (index + 1), // Usar ordem preservada ou índice
                                cor: route.color || '#6b7280',
                                keywords: Array.isArray(route.keywords) ? route.keywords : [],
                                response: route.response || '',
                                destination_type: route.destinationType || 'continuar',
                                destination_block_key: route.gotoBlockId || null,
                                max_loop_attempts: 2,
                                is_fallback: route.isFallback || false
                            };
                            
                            console.log(`  ✅ Route preparada [${index + 1}/${block.routes.length}]:`, {
                                block_key: routeData.block_key,
                                route_key: routeData.route_key,
                                label: routeData.label,
                                ordem: routeData.ordem,
                                keywords_count: routeData.keywords.length,
                                has_response: !!routeData.response
                            });
                            routes.push(routeData);
                        });
                    } else if (block.type === 'conectivos' && !block.routes) {
                        console.warn(`⚠️ [FlowEditor] Bloco de caminhos ${block.id} não tem routes!`);
                    }
                    
                    // Adicionar fallback se existir
                    if (block.type === 'conectivos' && block.fallback) {
                        const fallbackRouteKey = block.fallback.routeKey || 
                                                `fallback_${block.id}`;
                        console.log(`🔍 [FlowEditor] Adicionando fallback para bloco ${block.id}:`, block.fallback);
                        routes.push({
                            block_key: block.id,
                            route_key: fallbackRouteKey,
                            label: block.fallback.label || 'Não entendi',
                            ordem: block.fallback.ordem !== undefined ? block.fallback.ordem : 999,
                            cor: '#6b7280',
                            keywords: [],
                            response: block.fallback.response || '',
                            destination_type: block.fallback.destinationType || 'loop',
                            destination_block_key: block.fallback.gotoBlockId || null,
                            max_loop_attempts: 2,
                            is_fallback: true
                        });
                    }
                });

                console.log('💾 [FlowEditor] Salvando:', {
                    flow_id: flowId,
                    blocks: blocks.length,
                    routes: routes.length,
                    routes_detail: routes.map(r => ({
                        block_key: r.block_key,
                        route_key: r.route_key,
                        label: r.label
                    }))
                });

                // Salvar via API
                const saveResponse = await fetch('/api/flows/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        flow_id: flowId,
                        blocks: blocks,
                        routes: routes
                    })
                });

                if (!saveResponse.ok) {
                    const errorText = await saveResponse.text();
                    console.error('❌ [FlowEditor] Erro ao salvar:', {
                        status: saveResponse.status,
                        statusText: saveResponse.statusText,
                        errorText: errorText
                    });
                    
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { detail: errorText || 'Erro desconhecido' };
                    }
                    
                    throw new Error(errorData.detail || 'Erro ao salvar flow');
                }

                const result = await saveResponse.json();
                console.log('✅ [FlowEditor] Flow salvo com sucesso:', result);
                
                if (result.success) {
                    showNotification('success', 'Flow Salvo!', `Flow salvo com sucesso! Versão ${result.version || 'N/A'}`);
                } else {
                    console.error('❌ [FlowEditor] Salvamento retornou success=false:', result);
                    showNotification('error', 'Erro ao salvar', result.error || 'Erro desconhecido ao salvar');
                }
            } catch (error) {
                console.error('❌ Erro ao salvar flow:', error);
                showNotification('error', 'Erro ao salvar', error.message || 'Não foi possível salvar o flow. Tente novamente.');
            }
        }

        async function loadFlowFromAssistant() {
            try {
                const assistantId = currentEditingAssistente?.assistente_id || currentEditingAssistente?.assistant_id || null;
                if (!assistantId) return;

                const tenantId = localStorage.getItem('tenant_id');
                if (!tenantId) {
                    console.warn('⚠️ Tenant ID não encontrado');
                    return;
                }

                // Usar a API nova do backend
                const response = await fetch(`/api/flows/by-assistant/${encodeURIComponent(assistantId)}?tenant_id=${encodeURIComponent(tenantId)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.error('❌ Erro ao carregar flow:', response.status, response.statusText);
                    return;
                }

                const data = await response.json();
                console.log('✅ [FlowEditor] Dados recebidos:', {
                    blocks: data.blocks?.length || 0,
                    routes: data.routes?.length || 0,  // ⚠️ DEPRECATED: Routes agora em routes_data
                    flow: data.flow?.id
                });
                
                // 🔍 DEBUG CRÍTICO: Verificar CAM001 especificamente logo após receber da API
                if (data.blocks && data.blocks.length > 0) {
                    const cam001Block = data.blocks.find(b => b.block_key === 'CAM001');
                    if (cam001Block) {
                        console.log('🔍 [DEBUG] ===== CAM001 RECEBIDO DA API (RAW) =====');
                        console.log('  - block_key:', cam001Block.block_key);
                        console.log('  - block_type:', cam001Block.block_type);
                        console.log('  - content:', cam001Block.content);
                        console.log('  - has_routes_data_property:', 'routes_data' in cam001Block);
                        console.log('  - routes_data:', cam001Block.routes_data);
                        console.log('  - routes_data_type:', typeof cam001Block.routes_data);
                        console.log('  - routes_data_is_array:', Array.isArray(cam001Block.routes_data));
                        console.log('  - routes_data_length:', cam001Block.routes_data?.length);
                        console.log('  - TODAS propriedades:', Object.keys(cam001Block));
                        console.log('  - routes_data RAW JSON:', JSON.stringify(cam001Block.routes_data, null, 2));
                        console.log('🔍 [DEBUG] ===== FIM CAM001 RAW =====');
                    } else {
                        console.warn('⚠️ [DEBUG] CAM001 NÃO encontrado nos blocos recebidos!');
                        console.warn('Blocos disponíveis:', data.blocks.map(b => ({ block_key: b.block_key, block_type: b.block_type })));
                    }
                    
                    // Verificar todos os blocos de caminhos
                    const caminhosBlocks = data.blocks.filter(b => b.block_type === 'caminhos');
                    console.log('🔍 [DEBUG] Total de blocos caminhos:', caminhosBlocks.length);
                    caminhosBlocks.forEach(block => {
                        console.log(`🔍 [DEBUG] Bloco ${block.block_key}:`, {
                            has_routes_data: 'routes_data' in block,
                            routes_data_length: block.routes_data?.length || 0,
                            routes_data_type: typeof block.routes_data
                        });
                    });
                }
                
                // 🔍 DEBUG CRÍTICO: Verificar se blocos têm routes_data
                if (data.blocks) {
                    console.log('🔍 [DEBUG] Total de blocos recebidos:', data.blocks.length);
                    const caminhosBlocks = data.blocks.filter(b => b.block_type === 'caminhos');
                    console.log('🔍 [DEBUG] Blocos de caminhos encontrados:', caminhosBlocks.length);
                    
                    if (caminhosBlocks.length === 0) {
                        console.warn('⚠️ [DEBUG] NENHUM bloco de caminhos encontrado! Blocos disponíveis:', 
                                   data.blocks.map(b => ({ block_key: b.block_key, block_type: b.block_type })));
                    }
                    
                    caminhosBlocks.forEach(block => {
                        console.log(`🔍 [DEBUG] ===== BLOCO ${block.block_key} COMPLETO =====`);
                        console.log(`  - block_key:`, block.block_key);
                        console.log(`  - block_type:`, block.block_type);
                        console.log(`  - content:`, block.content);
                        console.log(`  - has_routes_data_property:`, 'routes_data' in block);
                        console.log(`  - routes_data:`, block.routes_data);
                        console.log(`  - routes_data_type:`, typeof block.routes_data);
                        console.log(`  - routes_data_is_array:`, Array.isArray(block.routes_data));
                        console.log(`  - routes_data_length:`, block.routes_data?.length);
                        console.log(`  - TODAS propriedades:`, Object.keys(block));
                        console.log(`  - routes_data RAW:`, JSON.stringify(block.routes_data, null, 2));
                        console.log(`🔍 [DEBUG] ===== FIM BLOCO ${block.block_key} =====`);
                    });
                } else {
                    console.error('❌ [DEBUG] data.blocks é null ou undefined!');
                }

                // ⭐ NOVO: SEMPRE usar routes_data dos blocos (JSONB) - NÃO usar routes separadas
                if (data.blocks) {
                    // ⭐ SEMPRE usar routes_data se existir (mesmo que vazio ou null)
                    // Verificar se algum bloco tem a propriedade routes_data definida
                    const hasAnyRoutesDataField = data.blocks.some(b => {
                        // Verificar se a propriedade existe (mesmo que seja null ou array vazio)
                        return 'routes_data' in b;
                    });
                    
                    if (hasAnyRoutesDataField) {
                        console.log('✅ [FlowEditor] Usando routes_data (JSONB) dos blocos');
                        // Converter blocos diretamente (routes_data já está no bloco)
                        flowBlocks = convertDbToFlowBlocks(data.blocks, {}); // Passar objeto vazio, routes vêm de routes_data
                    } else if (data.routes && data.routes.length > 0) {
                        console.log('⚠️ [FlowEditor] Usando routes separadas (deprecated) - migre para routes_data');
                        // Código antigo para compatibilidade
                        // Associar routes aos blocos corretos
                        // Criar mapa block_id (UUID) -> block_key (string como CAM001)
                        const blockIdToKey = {};
                        data.blocks.forEach(block => {
                            if (block.id && block.block_key) {
                                blockIdToKey[block.id] = block.block_key;
                            }
                        });
                    
                    console.log('🔍 [DEBUG loadFlowFromAssistant] Mapeamento blockIdToKey:', blockIdToKey);
                    console.log('🔍 [DEBUG loadFlowFromAssistant] Total de blocos:', data.blocks.length);
                    console.log('🔍 [DEBUG loadFlowFromAssistant] Total de routes:', data.routes.length);

                    // Criar mapa block_key -> routes
                    const routesByBlockKey = {};
                    let routesSemBlockKey = 0;
                    data.routes.forEach(route => {
                        const blockId = route.block_id;
                        const blockKey = blockIdToKey[blockId];
                        
                        // 🔍 DEBUG: Verificar mapeamento
                        if (!blockKey) {
                            routesSemBlockKey++;
                            console.warn(`⚠️ [DEBUG] Route ${route.route_key} tem block_id ${blockId} mas não encontrou block_key no mapeamento!`);
                            console.warn(`  - Route completa:`, route);
                            console.warn(`  - Block IDs disponíveis:`, Object.keys(blockIdToKey));
                        }
                        
                        if (blockKey) {
                            if (!routesByBlockKey[blockKey]) {
                                routesByBlockKey[blockKey] = [];
                            }
                            routesByBlockKey[blockKey].push({
                                id: route.id || route.route_key, // UUID do banco (para identificar)
                                routeKey: route.route_key || route.id, // route_key original (para salvar)
                                label: route.label || '',
                                keywords: route.keywords || [],
                                response: route.response || '',
                                destinationType: route.destination_type || 'continue',
                                gotoBlockId: route.destination_block_key || null,
                                color: route.cor || '#6b7280',
                                isFallback: route.is_fallback || false,
                                ordem: route.ordem || 0 // Preservar ordem para salvar corretamente
                            });
                        }
                    });
                    
                    // 🔍 DEBUG CRÍTICO: Verificar mapeamento antes de converter
                    console.log('🔍 [DEBUG loadFlowFromAssistant] ===== VERIFICAÇÃO CRÍTICA =====');
                    console.log('🔍 [DEBUG] blockIdToKey:', blockIdToKey);
                    console.log('🔍 [DEBUG] Routes por block_key:', Object.keys(routesByBlockKey).map(key => ({
                        block_key: key,
                        routes_count: routesByBlockKey[key].length,
                        routes: routesByBlockKey[key].map(r => ({ route_key: r.routeKey, label: r.label }))
                    })));
                    console.log('🔍 [DEBUG] Routes sem block_key encontrado:', routesSemBlockKey);
                    
                    // Verificar especificamente o bloco CAM001
                    const camBlockFromDb = data.blocks.find(b => b.block_key === 'CAM001');
                    if (camBlockFromDb) {
                        console.log('[DEBUG] 🔍 Bloco CAM001 do banco COMPLETO:', {
                            id: camBlockFromDb.id,
                            block_key: camBlockFromDb.block_key,
                            block_type: camBlockFromDb.block_type,
                            content: camBlockFromDb.content,
                            has_routes_data: 'routes_data' in camBlockFromDb,
                            routes_data: camBlockFromDb.routes_data,
                            routes_data_type: typeof camBlockFromDb.routes_data,
                            routes_data_length: camBlockFromDb.routes_data?.length,
                            todas_propriedades: Object.keys(camBlockFromDb)
                        });
                        console.log('🔍 [DEBUG] blockIdToKey[camBlockFromDb.id]:', blockIdToKey[camBlockFromDb.id]);
                        console.log('🔍 [DEBUG] routesByBlockKey["CAM001"]:', routesByBlockKey['CAM001']);
                        console.log('🔍 [DEBUG] routesByBlockKey tem key "CAM001"?', 'CAM001' in routesByBlockKey);
                    } else {
                        console.warn('⚠️ [DEBUG] Bloco CAM001 não encontrado nos blocos recebidos!');
                        console.warn('Blocos disponíveis:', data.blocks.map(b => b.block_key));
                    }
                    console.log('🔍 [DEBUG] ===== FIM VERIFICAÇÃO CRÍTICA =====');

                    // Converter blocos e associar routes (método antigo)
                    flowBlocks = convertDbToFlowBlocks(data.blocks, routesByBlockKey);
                } else {
                    // Sem routes nem routes_data
                    console.log('⚠️ [FlowEditor] Nenhuma route encontrada (nem routes_data nem routes separadas)');
                    flowBlocks = convertDbToFlowBlocks(data.blocks, {});
                }
                    
                    // 🔍 DEBUG: Verificar resultado final após conversão
                    const camBlock = flowBlocks.find(b => b.id === 'CAM001' || b.type === 'conectivos');
                    if (camBlock) {
                        console.log('🔍 [DEBUG loadFlowFromAssistant] Bloco CAM001 após conversão:', {
                            id: camBlock.id,
                            type: camBlock.type,
                            hasRoutes: !!camBlock.routes,
                            routesIsArray: Array.isArray(camBlock.routes),
                            routesLength: camBlock.routes ? camBlock.routes.length : 0,
                            routes: camBlock.routes,
                            hasFallback: !!camBlock.fallback,
                            fallback: camBlock.fallback
                        });
                    } else {
                        console.warn('⚠️ [DEBUG] Bloco CAM001 não encontrado após conversão!');
                        console.warn('Blocos disponíveis:', flowBlocks.map(b => ({ id: b.id, type: b.type })));
                    }
                    
                    flowPromptMaster = data.flow?.prompt_base || '';
                    renderFlowBlocks();
                } else {
                    console.warn('⚠️ [FlowEditor] Nenhum bloco encontrado');
                }
            } catch (error) {
                console.error('❌ Erro ao carregar flow:', error);
            }
        }

        function convertDbToFlowBlocks(dbBlocks, routesByBlockKey = {}) {
            // Converter estrutura do banco para formato do editor
            console.log('🔍 [DEBUG convertDbToFlowBlocks] Iniciando conversão...');
            console.log('🔍 [DEBUG convertDbToFlowBlocks] Total de blocos:', dbBlocks.length);
            
            return dbBlocks.map(block => {
                const blockKey = block.block_key || block.id;
                
                // 🔍 DEBUG: Log completo do bloco do banco
                if (block.block_type === 'caminhos') {
                    console.log('[FlowEditor] 🔍 Bloco do banco:', {
                        block_key: block.block_key,
                        block_type: block.block_type,
                content: block.content,
                        routes_data: block.routes_data,
                        routes_data_type: typeof block.routes_data,
                        routes_data_length: block.routes_data?.length,
                        has_routes_data_property: 'routes_data' in block
                    });
                }
                
                // ⭐ NOVO: Ler routes_data diretamente do bloco (JSONB) - SEMPRE PRIORIDADE 1
                let routesData = [];
                if (block.block_type === 'caminhos') {
                    // 🔍 DEBUG CRÍTICO: Verificar routes_data antes de processar
                    console.log(`[FlowEditor] 🔍 Bloco do banco:`, {
                        block_key: block.block_key,
                        block_type: block.block_type,
                        content: block.content,
                        routes_data: block.routes_data,
                        routes_data_type: typeof block.routes_data,
                        routes_data_length: block.routes_data?.length,
                        has_routes_data_property: 'routes_data' in block
                    });
                    
                    // ⭐ PRIORIDADE 1: routes_data (JSONB) - SEMPRE usar se a propriedade existir
                    if ('routes_data' in block && block.routes_data !== null && block.routes_data !== undefined) {
                        if (Array.isArray(block.routes_data)) {
                            routesData = block.routes_data;
                            console.log(`✅ [DEBUG convertDbToFlowBlocks] Bloco ${blockKey} tem routes_data (JSONB):`, routesData.length, 'routes');
                            console.log(`🔍 [DEBUG convertDbToFlowBlocks] Routes_data completo:`, JSON.stringify(routesData, null, 2));
                        } else if (typeof block.routes_data === 'string') {
                            // ⚠️ Se for string, tentar fazer parse
                            try {
                                routesData = JSON.parse(block.routes_data);
                                console.log(`✅ [DEBUG convertDbToFlowBlocks] Bloco ${blockKey} routes_data era string, parseado com sucesso:`, routesData.length, 'routes');
                            } catch (e) {
                                console.error(`❌ [DEBUG convertDbToFlowBlocks] Erro ao parsear routes_data string:`, e);
                                routesData = [];
                            }
                        } else {
                            console.warn(`⚠️ [DEBUG convertDbToFlowBlocks] Bloco ${blockKey} tem routes_data mas não é array nem string:`, typeof block.routes_data, block.routes_data);
                            routesData = [];
                        }
                    } else {
                        console.warn(`⚠️ [DEBUG convertDbToFlowBlocks] Bloco ${blockKey} não tem routes_data válido. Valor:`, block.routes_data);
                        routesData = [];
                    }
                    // ⚠️ FALLBACK: routesByBlockKey (tabela separada) - APENAS se routes_data não existir como propriedade
                    if (!('routes_data' in block) && routesByBlockKey && Object.keys(routesByBlockKey).length > 0) {
                        let blockRoutes = routesByBlockKey[blockKey] || [];
                        // Tentar por block.id também
                        if (blockRoutes.length === 0 && block.id && block.id !== blockKey) {
                            blockRoutes = routesByBlockKey[block.id] || [];
                        }
                        // Converter formato antigo para novo
                        if (blockRoutes.length > 0) {
                            console.log(`⚠️ [DEBUG convertDbToFlowBlocks] Bloco ${blockKey} usando routesByBlockKey (deprecated):`, blockRoutes.length, 'routes');
                            routesData = blockRoutes.map(r => ({
                                route_key: r.routeKey || r.id,
                                label: r.label || '',
                                ordem: r.ordem || 0,
                                cor: r.color || '#6b7280',
                                keywords: r.keywords || [],
                                response: r.response || '',
                                destination_type: r.destinationType || 'continuar',
                                destination_block_key: r.gotoBlockId || null,
                                max_loop_attempts: 2,
                                is_fallback: r.isFallback || false
                            }));
                            // Adicionar fallback se existir
                            if (block.fallback) {
                                routesData.push({
                                    route_key: block.fallback.routeKey || `fallback_${blockKey}`,
                                    label: block.fallback.label || 'Não entendi',
                                    ordem: 999,
                                    cor: '#6b7280',
                                    keywords: [],
                                    response: block.fallback.response || '',
                                    destination_type: block.fallback.destinationType || 'loop',
                                    destination_block_key: block.fallback.gotoBlockId || null,
                                    max_loop_attempts: 2,
                                    is_fallback: true
                                });
                            }
                        }
                    }
                    
                    console.log(`🔍 [DEBUG convertDbToFlowBlocks] Bloco ${blockKey} (caminhos):`);
                    console.log(`  - routes_data (JSONB):`, routesData.length, 'routes');
                    console.log(`  - routes_data completo:`, routesData);
                }
                
                // Separar fallback das routes normais e converter para formato do canvas
                // ⭐ IMPORTANTE: Routes normais (is_fallback = false)
                const normalRoutes = routesData
                    .filter(r => !r.is_fallback || r.is_fallback === false)
                    .map(route => ({
                        id: route.route_key || route.id || `route_${Math.random()}`,
                        routeKey: route.route_key || route.id || `route_${Math.random()}`,
                        label: route.label || '',
                        ordem: route.ordem || 0,
                        color: route.cor || '#6b7280',
                        keywords: Array.isArray(route.keywords) ? route.keywords : [],
                        response: route.response || '',
                        destinationType: route.destination_type || 'continuar',
                        gotoBlockId: route.destination_block_key || null,
                        maxLoopAttempts: route.max_loop_attempts || 2,
                        isFallback: false
                    }));
                
                // ⭐ IMPORTANTE: Fallback (is_fallback = true)
                const fallbackRoute = routesData.find(r => r.is_fallback === true);
                const fallback = fallbackRoute ? {
                    routeKey: fallbackRoute.route_key || `fallback_${blockKey}`,
                    label: fallbackRoute.label || 'Não entendi',
                    response: fallbackRoute.response || '',
                    destinationType: fallbackRoute.destination_type || 'loop',
                    gotoBlockId: fallbackRoute.destination_block_key || null,
                    maxLoopAttempts: fallbackRoute.max_loop_attempts || 2,
                    ordem: fallbackRoute.ordem || 999
                } : null;
                
                // 🔍 DEBUG: Verificar conversão de routes
                if (block.block_type === 'caminhos') {
                    console.log(`[FlowEditor] 🔍 Bloco caminhos convertido:`, {
                        id: blockKey,
                        content: block.content,
                        routes_count: normalRoutes.length,
                        routes: normalRoutes,
                        has_fallback: !!fallback,
                        fallback: fallback
                    });
                }

                // Mapear block_type para o formato do editor
                let type = block.block_type;
                if (type === 'mensagem') type = 'texto';
                if (type === 'caminhos') type = 'conectivos';
                if (type === 'ferramenta') type = 'tool';

                // ⭐ CRÍTICO: Para blocos de caminhos, routes DEVE ser sempre um array (nunca null)
                const result = {
                    id: blockKey,
                    type: type,
                    content: block.content || '',  // "TESTE TRIGGER OK" = pergunta do bloco caminhos
                toolId: block.tool_type ? block.id : null,
                toolName: block.tool_type || null,
                toolType: block.tool_type || null,
                timeout: block.timeout_seconds || null,
                    routes: block.block_type === 'caminhos' ? normalRoutes : null, // ⭐ SEMPRE array para caminhos (mesmo que vazio)
                    fallback: block.block_type === 'caminhos' ? fallback : null  // Fallback apenas para caminhos
                };
                
                // ⚠️ GARANTIR que routes é sempre array para caminhos
                if (block.block_type === 'caminhos') {
                    if (!Array.isArray(result.routes)) {
                        console.error(`❌ [DEBUG] ERRO CRÍTICO: Bloco ${blockKey} deveria ter routes como array mas tem:`, typeof result.routes, result.routes);
                        result.routes = normalRoutes; // Forçar array
                    }
                    
                    // Log final para verificar
                    console.log(`[FlowEditor] ✅ Bloco ${blockKey} convertido:`, {
                        id: result.id,
                        type: result.type,
                        content: result.content,
                        routes_count: result.routes ? result.routes.length : 0,
                        routes_is_array: Array.isArray(result.routes),
                        has_fallback: !!result.fallback
                    });
                }
                
                // 🔍 DEBUG: Verificar resultado final
                if (block.block_type === 'caminhos') {
                    console.log(`🔍 [DEBUG convertDbToFlowBlocks] Resultado FINAL para ${blockKey}:`);
                    console.log(`  - Type: ${result.type}`);
                    console.log(`  - Content: ${result.content}`);
                    console.log(`  - Routes no result:`, result.routes ? result.routes.length : 0);
                    console.log(`  - Routes é array?`, Array.isArray(result.routes));
                    console.log(`  - Routes completo:`, JSON.stringify(result.routes, null, 2));
                    console.log(`  - Fallback:`, JSON.stringify(result.fallback, null, 2));
                    
                    // ⚠️ AVISO se não tem routes mas tinha routes_data
                    if (routesData.length > 0 && (!result.routes || result.routes.length === 0)) {
                        console.error(`❌ [DEBUG] PROBLEMA: Bloco ${blockKey} tinha ${routesData.length} routes em routes_data mas result.routes está vazio!`);
                        console.error(`  - routesData:`, JSON.stringify(routesData, null, 2));
                        console.error(`  - normalRoutes:`, JSON.stringify(normalRoutes, null, 2));
                        console.error(`  - result.routes:`, result.routes);
                    } else if (routesData.length > 0 && result.routes && result.routes.length > 0) {
                        console.log(`✅ [DEBUG] Bloco ${blockKey} convertido com sucesso: ${result.routes.length} routes + ${result.fallback ? '1 fallback' : 'sem fallback'}`);
                    }
                }
                
                // Preservar routeKey no fallback também
                if (fallback && !fallback.routeKey) {
                    fallback.routeKey = `fallback_${blockKey}`;
                }
                
                return result;
            });
        }

        function generateFlowExportJson() {
            // Gerar JSON no formato esperado pela IA
            return {
                version: '1.0',
                flow_id: currentEditingAssistente?.assistente_id || null,
                assistente_id: currentEditingAssistente?.assistente_id || null,
                flow_type: 'whatsapp',
                exported_at: new Date().toISOString(),
                prompt_master: flowPromptMaster || '',
                blocks: flowBlocks.map((block, index) => ({
                    key: block.id,
                    index: index,
                    type: block.type,
                    tool_type: block.toolType || undefined,
                    content: block.content,
                    timeout: block.timeout || undefined
                })),
                conectivos: flowBlocks
                    .filter(b => b.type === 'conectivos' && b.routes)
                    .map(block => ({
                        block_key: block.id,
                        label: block.content,
                        analyze_variable: '{{ultima_resposta}}',
                        routes: block.routes.map(route => ({
                            label: route.label,
                            keywords: route.keywords,
                            response: route.response || null,
                            destination: {
                                type: route.destinationType,
                                target_block_key: route.gotoBlockId || undefined
                            }
                        })),
                        fallback: block.fallback ? {
                            label: block.fallback.label,
                            response: block.fallback.response || null,
                            destination: {
                                type: block.fallback.destinationType,
                                target_block_key: block.fallback.gotoBlockId || undefined
                            }
                        } : null
                    }))
            };
        }

        function flowEditorPreview() {
            const json = generateFlowExportJson();
            const preview = JSON.stringify(json, null, 2);
            alert('Preview do Flow:\n\n' + preview.substring(0, 2000) + '...');
        }

        function flowEditorExport() {
            const json = generateFlowExportJson();
            const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flow_${currentEditingAssistente?.name || 'assistente'}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function togglePalette() {
            const palette = document.getElementById('flowBlocksPalette');
            if (palette) {
                palette.classList.toggle('collapsed');
            }
        }

        // Inicializar quando a aba for aberta
        async function sendChatMessage() {
            var input = document.getElementById('chatInput');
            var message = input.value.trim();
            
            if (!message) return;
            
            var messagesContainer = document.getElementById('chatMessages');
            var now = new Date();
            var timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            // Adicionar mensagem do usuário
            var userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            userMessage.innerHTML = '<div class="message-header">' +
                '<div class="message-avatar">VC</div>' +
                '<div class="message-name">Você</div>' +
                '<div class="message-time">' + timeStr + '</div>' +
                '</div>' +
                '<div class="message-content">' + message + '</div>';
            messagesContainer.appendChild(userMessage);
            
            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Adicionar indicador de digitação
            var typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-message ai';
            typingIndicator.id = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="message-header">' +
                '<div class="message-avatar">IA</div>' +
                '<div class="message-name">Editor IA</div>' +
                '<div class="message-time">digitando...</div>' +
                '</div>' +
                '<div class="message-content"><span class="typing-dots">●●●</span></div>';
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Enviar para o webhook do n8n
            try {
                var user = getUserData();
                // SessionId único e curto por alteração (8 caracteres)
                var sessionId = window.currentChangeSessionId || generateShortSessionId();
                window.currentChangeSessionId = sessionId;
                var assistantName = currentEditingAssistente ? currentEditingAssistente.name : 'Assistente';
                
                var response = await fetch('https://sdr.salesdever.io/webhook/f2060b9a-a6e3-48e3-b94d-abbe898fe1d0/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'sendMessage',
                        sessionId: sessionId,
                        chatInput: message,
                        change_channel: window.currentChangeChannel || 'Não especificado',
                        tenant_id: user ? user.tenantId : null,
                        email: user ? user.email : null,
                        assistant_id: currentEditingAssistente ? (currentEditingAssistente.assistente_id || currentEditingAssistente.id) : null,
                        assistant_name: assistantName
                    })
                });
                
                // Remover indicador de digitação
                var typing = document.getElementById('typing-indicator');
                if (typing) typing.remove();
                
                if (!response.ok) {
                    throw new Error('Erro ao enviar mensagem para o chat');
                }
                
                var data = await response.json();
                var aiResponse = data.output || data.message || data.mensagem || 'Desculpe, não consegui processar sua mensagem.';

                // Adicionar resposta da IA
                var aiTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                var aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message ai';
                aiMessage.innerHTML = '<div class="message-header">' +
                    '<div class="message-avatar">IA</div>' +
                    '<div class="message-name">Editor IA</div>' +
                    '<div class="message-time">' + aiTime + '</div>' +
                    '</div>' +
                    '<div class="message-content">' + formatAIResponse(aiResponse) + '</div>';
                messagesContainer.appendChild(aiMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
            } catch (error) {
                console.error('Erro no chat:', error);
                
                // Remover indicador de digitação
                var typing = document.getElementById('typing-indicator');
                if (typing) typing.remove();
                
                // Mostrar mensagem de erro
                var aiTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                var errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message ai';
                errorMessage.innerHTML = '<div class="message-header">' +
                    '<div class="message-avatar">IA</div>' +
                    '<div class="message-name">Editor IA</div>' +
                    '<div class="message-time">' + aiTime + '</div>' +
                    '</div>' +
                    '<div class="message-content" style="color: rgba(255, 87, 108, 0.8);">Desculpe, ocorreu um erro ao processar sua mensagem. Tente novamente.</div>';
                messagesContainer.appendChild(errorMessage);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // Event listener para Enter no chat
        document.addEventListener('DOMContentLoaded', function() {
            var chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });

</script>
</body>
</html>
