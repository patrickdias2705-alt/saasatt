<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
    <link rel="shortcut icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
    <link rel="apple-touch-icon" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversas - Salesdever</title>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Raleway', sans-serif;
        }

        body {
            background: #0a0420;
            min-height: 100vh;
            color: #ffffff;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(165, 148, 255, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.06) 0%, transparent 50%);
            animation: backgroundFloat 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(3%, 3%); }
        }

        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        /* ========== SIDEBAR ESQUERDA ========== */
        .conversations-sidebar {
            width: 420px;
            min-width: 300px;
            max-width: 600px;
            background: linear-gradient(180deg, rgba(15, 10, 35, 0.85), rgba(10, 5, 25, 0.9));
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(165, 148, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .resize-handle {
            position: absolute;
            right: -3px;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            background: transparent;
            transition: background 0.3s ease;
            z-index: 100;
        }

        .resize-handle:hover,
        .resize-handle.resizing {
            background: rgba(165, 148, 255, 0.5);
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .sidebar-header-content {
            flex: 1;
        }

        .sidebar-title {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ffffff, #A594FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-subtitle {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
        }

        .reload-btn {
            background: transparent;
            border: 1px solid rgba(165, 148, 255, 0.2);
            color: rgba(165, 148, 255, 0.7);
            padding: 0.4rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .reload-btn:hover {
            background: rgba(165, 148, 255, 0.15);
            border-color: rgba(165, 148, 255, 0.4);
            color: #A594FF;
            transform: scale(1.05);
        }

        .reload-btn.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .reload-icon {
            transition: transform 0.3s;
            stroke: currentColor;
        }

        .reload-btn.loading .reload-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        .filters-container {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .search-container {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-box {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: #ffffff;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: rgba(165, 148, 255, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .filter-button {
            width: 42px;
            height: 42px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .filter-button:hover {
            background: rgba(165, 148, 255, 0.15);
            border-color: rgba(165, 148, 255, 0.3);
        }

        .filter-button.active {
            background: rgba(165, 148, 255, 0.2);
            border-color: rgba(165, 148, 255, 0.4);
        }

        .filter-button svg {
            width: 20px;
            height: 20px;
            stroke: rgba(255, 255, 255, 0.7);
            transition: all 0.3s ease;
        }

        .filter-button:hover svg,
        .filter-button.active svg {
            stroke: #A594FF;
        }

        .filter-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: linear-gradient(135deg, rgba(25, 20, 50, 0.98), rgba(15, 10, 35, 0.98));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 1rem;
            padding: 0.75rem;
            min-width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .filter-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .filter-section {
            margin-bottom: 1rem;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-section-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-section-title svg {
            width: 14px;
            height: 14px;
            stroke: rgba(255, 255, 255, 0.5);
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-option {
            padding: 0.6rem 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-option:hover {
            background: rgba(165, 148, 255, 0.1);
            border-color: rgba(165, 148, 255, 0.3);
            color: #ffffff;
        }

        .filter-option.active {
            background: rgba(165, 148, 255, 0.2);
            border-color: rgba(165, 148, 255, 0.4);
            color: #A594FF;
            font-weight: 600;
        }

        .filter-option-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .instance-filter {
            display: none;
        }

        .tags-filter {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tag-chip {
            padding: 0.4rem 1rem;
            background: rgba(165, 148, 255, 0.15);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 2rem;
            color: #A594FF;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tag-chip:hover {
            background: rgba(165, 148, 255, 0.25);
            border-color: rgba(165, 148, 255, 0.5);
        }

        .tag-chip.active {
            background: linear-gradient(135deg, #A594FF, #667eea);
            border-color: #A594FF;
            color: #ffffff;
        }

        .tag-chip.novo { border-color: rgba(34, 197, 94, 0.5); color: #22C55E; }
        .tag-chip.importante { border-color: rgba(239, 68, 68, 0.5); color: #EF4444; }
        .tag-chip.suporte { border-color: rgba(251, 146, 60, 0.5); color: #FB923C; }
        .tag-chip.resolvido { border-color: rgba(59, 130, 246, 0.5); color: #3B82F6; }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .conversation-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(165, 148, 255, 0.3);
            transform: translateY(-2px);
        }

        .conversation-item.active {
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.2), rgba(102, 126, 234, 0.15));
            border-color: rgba(165, 148, 255, 0.5);
        }

        .conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid rgba(165, 148, 255, 0.3);
            object-fit: cover;
            flex-shrink: 0;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .conversation-name {
            font-size: 1rem;
            font-weight: 700;
            color: #ffffff;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-time {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
        }

        .conversation-preview {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 0.5rem;
        }

        .conversation-tags {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .mini-tag {
            padding: 0.2rem 0.6rem;
            background: rgba(165, 148, 255, 0.2);
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: #A594FF;
        }

        .mini-tag.novo { background: rgba(34, 197, 94, 0.2); color: #22C55E; }
        .mini-tag.importante { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
        .mini-tag.suporte { background: rgba(251, 146, 60, 0.2); color: #FB923C; }

        .conversation-menu-btn {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .conversation-item:hover .conversation-menu-btn {
            opacity: 1;
        }

        .conversation-menu-btn:hover {
            background: rgba(165, 148, 255, 0.3);
        }

        .conversation-menu-btn::before {
            content: '⋮';
            font-size: 1.1rem;
            color: #ffffff;
        }

        .context-menu {
            position: fixed;
            background: linear-gradient(135deg, rgba(25, 20, 50, 0.98), rgba(15, 10, 35, 0.98));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.75rem;
            padding: 0.5rem 0;
            min-width: 180px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .context-menu-item:hover {
            background: rgba(165, 148, 255, 0.15);
        }

        .tags-submenu {
            position: fixed;
            background: linear-gradient(135deg, rgba(25, 20, 50, 0.98), rgba(15, 10, 35, 0.98));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.75rem;
            padding: 0.5rem 0;
            min-width: 160px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            display: none;
        }

        .tags-submenu.active {
            display: block;
        }

        .tags-submenu-item {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .tags-submenu-item:hover {
            background: rgba(165, 148, 255, 0.15);
        }

        .tags-submenu-item.novo { color: #22C55E; }
        .tags-submenu-item.importante { color: #EF4444; }
        .tags-submenu-item.suporte { color: #FB923C; }
        .tags-submenu-item.resolvido { color: #3B82F6; }

        /* ========== CHAT CONTAINER ========== */
        .chat-container {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            background: rgba(10, 5, 25, 0.5);
        }

        .chat-header {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, rgba(15, 10, 35, 0.9), rgba(10, 5, 25, 0.85));
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chat-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: 2px solid rgba(165, 148, 255, 0.5);
            object-fit: cover;
            flex-shrink: 0;
        }

        .chat-user-info {
            flex: 1;
        }

        .chat-user-info h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .chat-user-meta {
            display: flex;
            gap: 1.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .chat-user-meta span {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-width: 0;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 85%;
            min-width: 0;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.lead {
            align-self: flex-start;
        }

        .message.agent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(165, 148, 255, 0.3);
            object-fit: cover;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            min-width: 0;
            max-width: 100%;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .message.agent .message-header {
            flex-direction: row-reverse;
            text-align: right;
        }

        .message-sender {
            font-size: 0.9rem;
            font-weight: 700;
            color: #A594FF;
        }

        .message.agent .message-sender {
            color: #667eea;
        }

        .message-time {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 1.25rem;
            font-size: 0.95rem;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
        }

        .message.lead .message-bubble {
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.15), rgba(102, 126, 234, 0.1));
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-top-left-radius: 0.25rem;
        }

        .message.agent .message-bubble {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-top-right-radius: 0.25rem;
        }

        /* ========== SEPARADORES DE DATA ========== */
        .date-separator {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
            width: 100%;
        }

        .date-separator-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(165, 148, 255, 0.3), transparent);
        }

        .date-separator-label {
            padding: 0.5rem 1.25rem;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.15), rgba(102, 126, 234, 0.1));
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 1.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .message-input-container {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, rgba(15, 10, 35, 0.9), rgba(10, 5, 25, 0.85));
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(165, 148, 255, 0.2);
        }

        .message-input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.5rem;
            color: #ffffff;
            font-size: 0.95rem;
            resize: none;
            max-height: 150px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: rgba(165, 148, 255, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .send-button {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #A594FF, #667eea);
            border: none;
            border-radius: 1.5rem;
            color: #ffffff;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(165, 148, 255, 0.3);
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(165, 148, 255, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ========== SIDEBAR DIREITA ========== */
        .lead-info-sidebar {
            width: 380px;
            min-width: 280px;
            max-width: 600px;
            background: linear-gradient(180deg, rgba(15, 10, 35, 0.85), rgba(10, 5, 25, 0.9));
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(165, 148, 255, 0.2);
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
            position: relative;
            flex-shrink: 0;
        }

        .resize-handle-right {
            position: absolute;
            left: -3px;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            background: transparent;
            transition: background 0.3s ease;
            z-index: 100;
        }

        .resize-handle-right:hover,
        .resize-handle-right.resizing {
            background: rgba(165, 148, 255, 0.5);
        }

        .lead-profile {
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .lead-profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid rgba(165, 148, 255, 0.5);
            margin: 0 auto 1rem;
            object-fit: cover;
        }

        .lead-profile-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .lead-profile-phone {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .lead-status-badge {
            display: inline-block;
            padding: 0.5rem 1.5rem;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.15));
            border: 1px solid rgba(34, 197, 94, 0.5);
            border-radius: 2rem;
            color: #22C55E;
            font-size: 0.85rem;
            font-weight: 700;
        }

        .ia-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 1.5rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .ia-toggle-btn.active {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.15));
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: #22C55E;
        }

        .ia-toggle-btn.active:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(22, 163, 74, 0.2));
            border-color: rgba(34, 197, 94, 0.6);
            transform: scale(1.02);
        }

        .ia-toggle-btn.blocked {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.15));
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #EF4444;
        }

        .ia-toggle-btn.blocked:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.2));
            border-color: rgba(239, 68, 68, 0.6);
            transform: scale(1.02);
        }

        .ia-toggle-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .ia-toggle-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lead-info-section {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #A594FF, #667eea);
            border-radius: 2px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-icon {
            width: 36px;
            height: 36px;
            background: rgba(165, 148, 255, 0.15);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .info-icon svg {
            stroke: #A594FF;
        }

        .info-text {
            flex: 1;
        }

        .info-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 0.95rem;
            color: #ffffff;
            font-weight: 600;
        }

        .tags-management {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag-badge {
            padding: 0.5rem 1rem;
            background: rgba(165, 148, 255, 0.2);
            border: 1px solid rgba(165, 148, 255, 0.4);
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #A594FF;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tag-badge:hover {
            opacity: 0.8;
        }

        .tag-remove {
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .tag-remove:hover {
            color: #fff;
        }

        .tag-badge.novo { background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #22C55E; }
        .tag-badge.importante { background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); color: #EF4444; }
        .tag-badge.suporte { background: rgba(251, 146, 60, 0.2); border-color: rgba(251, 146, 60, 0.4); color: #FB923C; }
        .tag-badge.resolvido { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); color: #3B82F6; }

        .notes-textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: #ffffff;
            font-size: 0.9rem;
            resize: vertical;
            line-height: 1.6;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 3rem;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .empty-state p {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #A594FF;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== MODAL VISÃO DETALHADA ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(25, 20, 50, 0.98), rgba(15, 10, 35, 0.98));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 1.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 2rem;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff, #A594FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            color: #fff;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: rotate(90deg);
        }

        .modal-section {
            margin-bottom: 2rem;
        }

        .modal-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #A594FF, #667eea);
            border-radius: 2px;
        }

        .modal-info-grid {
            display: grid;
            gap: 1rem;
        }

        .modal-info-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .modal-info-icon {
            width: 40px;
            height: 40px;
            background: rgba(165, 148, 255, 0.15);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .modal-info-icon svg {
            stroke: #A594FF;
        }

        .modal-info-text {
            flex: 1;
        }

        .modal-info-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.25rem;
        }

        .modal-info-value {
            font-size: 1rem;
            color: #ffffff;
            font-weight: 600;
        }

        .modal-summary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.8);
            max-height: 500px;
            overflow-y: auto;
        }

        .modal-summary::-webkit-scrollbar {
            width: 8px;
        }

        .modal-summary::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .modal-summary::-webkit-scrollbar-thumb {
            background: rgba(165, 148, 255, 0.5);
            border-radius: 10px;
        }

        .modal-summary::-webkit-scrollbar-thumb:hover {
            background: rgba(165, 148, 255, 0.7);
        }

        .modal-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .modal-tag {
            padding: 0.5rem 1rem;
            background: rgba(165, 148, 255, 0.2);
            border: 1px solid rgba(165, 148, 255, 0.4);
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #A594FF;
        }

        .modal-tag.novo { background: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.4); color: #22C55E; }
        .modal-tag.importante { background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); color: #EF4444; }
        .modal-tag.suporte { background: rgba(251, 146, 60, 0.2); border-color: rgba(251, 146, 60, 0.4); color: #FB923C; }
        .modal-tag.resolvido { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4); color: #3B82F6; }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(165, 148, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(165, 148, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar Esquerda -->
        <div class="conversations-sidebar" id="conversationsSidebar">
            <div class="resize-handle" id="resizeHandleLeft"></div>
            
            <div class="sidebar-header">
                <div class="sidebar-header-content">
                    <h1 class="sidebar-title">Conversas</h1>
                    <p class="sidebar-subtitle">Gerenciamento de leads e conversas</p>
                </div>
                <button class="reload-btn" onclick="reloadConversations()">
                    <svg class="reload-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 12C22 17.52 17.52 22 12 22C6.48 22 3.11 16.44 3.11 16.44M3.11 16.44H7.63M3.11 16.44V21.44M2 12C2 6.48 6.44 2 12 2C18.67 2 22 7.56 22 7.56M22 7.56V2.56M22 7.56H17.56" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>

            <div class="filters-container">
                <div class="search-container">
                    <div class="search-wrapper">
                        <input type="text" class="search-box" placeholder="Buscar conversas..." id="searchBox">
                        
                        <button class="filter-button" id="filterButton">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 4.5H21M3 9.5H21M3 14.5H21M3 19.5H21" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="filter-dropdown" id="filterDropdown">
                        <div class="filter-section">
                            <div class="filter-section-title">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7 7H17M7 12H17M7 17H17" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                                Tags
                            </div>
                            <div class="filter-options" id="tagFilterOptions">
                                <div class="filter-option active" data-filter="todos">
                                    <div class="filter-option-icon" style="width: 8px; height: 8px; background: rgba(165, 148, 255, 0.5); border-radius: 50%;"></div>
                                    Todos
                                </div>
                                <div class="filter-option" data-filter="novo">
                                    <div class="filter-option-icon" style="width: 8px; height: 8px; background: #22C55E; border-radius: 50%;"></div>
                                    Novo
                                </div>
                                <div class="filter-option" data-filter="importante">
                                    <div class="filter-option-icon" style="width: 8px; height: 8px; background: #EF4444; border-radius: 50%;"></div>
                                    Importante
                                </div>
                                <div class="filter-option" data-filter="suporte">
                                    <div class="filter-option-icon" style="width: 8px; height: 8px; background: #FB923C; border-radius: 50%;"></div>
                                    Suporte
                                </div>
                                <div class="filter-option" data-filter="resolvido">
                                    <div class="filter-option-icon" style="width: 8px; height: 8px; background: #3B82F6; border-radius: 50%;"></div>
                                    Resolvido
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-section">
                            <div class="filter-section-title">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M8 2V5M16 2V5M3.5 9.09H20.5M21 8.5V17C21 20 19.5 22 16 22H8C4.5 22 3 20 3 17V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M15.6947 13.7H15.7037M15.6947 16.7H15.7037M11.9955 13.7H12.0045M11.9955 16.7H12.0045M8.29431 13.7H8.30329M8.29431 16.7H8.30329" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Instância
                            </div>
                            <div class="filter-options" id="instanceFilterOptions">
                                <div class="filter-option active" data-instance="todas">
                                    Todas as Instâncias
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <select class="instance-filter" id="instanceFilter" style="display: none;">
                    <option value="todas">Todas as Instâncias</option>
                </select>
            </div>

            <div class="conversations-list" id="conversationsList"></div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-header" style="display: none;" id="chatHeader">
                <img src="" alt="Avatar" class="chat-avatar" id="chatAvatar">
                <div class="chat-user-info">
                    <h2 id="chatUserName">Nome do Lead</h2>
                    <div class="chat-user-meta">
                        <span style="display: flex; align-items: center; gap: 0.3rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8.5 19H8C4 19 2 18 2 13V8C2 4 4 2 8 2H16C20 2 22 4 22 8V13C22 17 20 19 16 19H15.5C15.19 19 14.89 19.15 14.7 19.4L13.2 21.4C12.54 22.28 11.46 22.28 10.8 21.4L9.3 19.4C9.14 19.18 8.77 19 8.5 19Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span id="chatTotalMessages">0</span> mensagens
                        </span>
                        <span style="display: flex; align-items: center; gap: 0.3rem;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 2V5M16 2V5M3.5 9.09H20.5M21 8.5V17C21 20 19.5 22 16 22H8C4.5 22 3 20 3 17V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span id="chatCreatedDate">--/--/----</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8.5 19H8C4 19 2 18 2 13V8C2 4 4 2 8 2H16C20 2 22 4 22 8V13C22 17 20 19 16 19H15.5C15.19 19 14.89 19.15 14.7 19.4L13.2 21.4C12.54 22.28 11.46 22.28 10.8 21.4L9.3 19.4C9.14 19.18 8.77 19 8.5 19Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <h3>Selecione uma conversa</h3>
                    <p>Escolha uma conversa na lista para visualizar as mensagens</p>
                </div>
            </div>

            <div class="message-input-container" style="display: none;" id="messageInputContainer">
                <div class="message-input-wrapper">
                    <textarea class="message-input" id="messageInput" placeholder="Digite sua mensagem..." rows="1"></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        <span id="sendButtonText">Enviar</span>
                        <span id="sendButtonLoading" style="display: none;" class="loading-spinner"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar Direita -->
        <div class="lead-info-sidebar" id="leadInfoSidebar">
            <div class="resize-handle-right" id="resizeHandleRight"></div>
            
            <div class="lead-profile">
                <img src="" alt="Avatar" class="lead-profile-avatar" id="leadAvatar">
                <h3 class="lead-profile-name" id="leadName">Nome do Lead</h3>
                <p class="lead-profile-phone" id="leadPhone">+55 (00) 00000-0000</p>
                <button class="ia-toggle-btn active" id="iaToggleBtn" onclick="toggleIABlock()">
                    <span class="ia-toggle-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 22H15C20 22 22 20 22 15V9C22 4 20 2 15 2H9C4 2 2 4 2 9V15C2 20 4 22 9 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M9 10C10.1046 10 11 9.10457 11 8C11 6.89543 10.1046 6 9 6C7.89543 6 7 6.89543 7 8C7 9.10457 7.89543 10 9 10Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M2.67004 18.9501L7.60004 15.6401C8.39004 15.1101 9.53004 15.1701 10.24 15.7801L10.57 16.0701C11.35 16.7401 12.61 16.7401 13.39 16.0701L17.55 12.5001C18.33 11.8301 19.59 11.8301 20.37 12.5001L22 13.9001" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    <span id="iaToggleBtnText">IA Ativa</span>
                </button>
            </div>

            <div class="lead-info-section">
                <h4 class="section-title">Informações Gerais</h4>
                <div class="info-item">
                    <div class="info-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 2V5M16 2V5M3.5 9.09H20.5M21 8.5V17C21 20 19.5 22 16 22H8C4.5 22 3 20 3 17V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="info-text">
                        <div class="info-label">Data de Criação</div>
                        <div class="info-value" id="leadCreatedAt">--</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8.5 19H8C4 19 2 18 2 13V8C2 4 4 2 8 2H16C20 2 22 4 22 8V13C22 17 20 19 16 19H15.5C15.19 19 14.89 19.15 14.7 19.4L13.2 21.4C12.54 22.28 11.46 22.28 10.8 21.4L9.3 19.4C9.14 19.18 8.77 19 8.5 19Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="info-text">
                        <div class="info-label">Total de Mensagens</div>
                        <div class="info-value" id="leadTotalMessages">--</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="info-text">
                        <div class="info-label">Última Atualização</div>
                        <div class="info-value" id="leadUpdatedAt">--</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21.97 18.33C21.97 18.69 21.89 19.06 21.72 19.42C21.55 19.78 21.33 20.12 21.04 20.44C20.55 20.98 20.01 21.37 19.4 21.62C18.8 21.87 18.15 22 17.45 22C16.43 22 15.34 21.76 14.19 21.27C13.04 20.78 11.89 20.12 10.75 19.29C9.6 18.45 8.51 17.52 7.47 16.49C6.44 15.45 5.51 14.36 4.68 13.22C3.86 12.08 3.2 10.94 2.72 9.81C2.24 8.67 2 7.58 2 6.54C2 5.86 2.12 5.21 2.36 4.61C2.6 4 2.98 3.44 3.51 2.94C4.15 2.31 4.85 2 5.59 2C5.87 2 6.15 2.06 6.4 2.18C6.66 2.3 6.89 2.48 7.07 2.74L9.39 6.01C9.57 6.26 9.7 6.49 9.79 6.71C9.88 6.92 9.93 7.13 9.93 7.32C9.93 7.56 9.86 7.8 9.72 8.03C9.59 8.26 9.4 8.5 9.16 8.74L8.4 9.53C8.29 9.64 8.24 9.77 8.24 9.93C8.24 10.01 8.25 10.08 8.27 10.16C8.3 10.24 8.33 10.3 8.35 10.36C8.53 10.69 8.84 11.12 9.28 11.64C9.73 12.16 10.21 12.69 10.73 13.22C11.27 13.75 11.79 14.24 12.32 14.69C12.84 15.13 13.27 15.43 13.61 15.61C13.66 15.63 13.72 15.66 13.79 15.69C13.87 15.72 13.95 15.73 14.04 15.73C14.21 15.73 14.34 15.67 14.45 15.56L15.21 14.81C15.46 14.56 15.7 14.37 15.93 14.25C16.16 14.11 16.39 14.04 16.64 14.04C16.83 14.04 17.03 14.08 17.25 14.17C17.47 14.26 17.7 14.39 17.95 14.56L21.26 16.91C21.52 17.09 21.7 17.3 21.81 17.55C21.91 17.8 21.97 18.05 21.97 18.33Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10"/>
                        </svg>
                    </div>
                    <div class="info-text">
                        <div class="info-label">Instância WhatsApp</div>
                        <div class="info-value" id="leadInstance">--</div>
                    </div>
                </div>
            </div>

            <div class="lead-info-section">
                <h4 class="section-title">Tags</h4>
                <div class="tags-management" id="leadTags"></div>
            </div>

            <div class="lead-info-section">
                <h4 class="section-title">Resumo da IA</h4>
                <textarea class="notes-textarea" id="leadNotes" placeholder="Nenhum resumo disponível..." readonly></textarea>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="viewDetailsMenuItem">
            <span class="icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15.58 12C15.58 13.98 13.98 15.58 12 15.58C10.02 15.58 8.42004 13.98 8.42004 12C8.42004 10.02 10.02 8.42 12 8.42C13.98 8.42 15.58 10.02 15.58 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 20.27C15.53 20.27 18.82 18.19 21.11 14.59C22.01 13.18 22.01 10.81 21.11 9.4C18.82 5.8 15.53 3.72 12 3.72C8.46997 3.72 5.17997 5.8 2.88997 9.4C1.98997 10.81 1.98997 13.18 2.88997 14.59C5.17997 18.19 8.46997 20.27 12 20.27Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </span>
            <span>Visão Detalhada</span>
        </div>
        <div class="context-menu-item" id="addTagMenuItem">
            <span class="icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4.16989 15.3L8.69989 19.83C10.5599 21.69 13.5799 21.69 15.4499 19.83L19.8399 15.44C21.6999 13.58 21.6999 10.56 19.8399 8.69005L15.2999 4.17005C14.3499 3.22005 13.0399 2.71005 11.6999 2.78005L6.69989 3.02005C4.69989 3.11005 3.10989 4.70005 3.00989 6.69005L2.76989 11.69C2.70989 13.04 3.21989 14.35 4.16989 15.3Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9.5 12C10.8807 12 12 10.8807 12 9.5C12 8.11929 10.8807 7 9.5 7C8.11929 7 7 8.11929 7 9.5C7 10.8807 8.11929 12 9.5 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </span>
            <span>Adicionar Tag</span>
        </div>
    </div>

    <!-- Tags Submenu -->
    <div class="tags-submenu" id="tagsSubmenu">
        <div class="tags-submenu-item novo" data-tag="novo">Novo</div>
        <div class="tags-submenu-item importante" data-tag="importante">Importante</div>
        <div class="tags-submenu-item suporte" data-tag="suporte">Suporte</div>
        <div class="tags-submenu-item resolvido" data-tag="resolvido">Resolvido</div>
    </div>

    <!-- Modal Visão Detalhada -->
    <div class="modal-overlay" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Visão Detalhada do Lead</h2>
                <button class="modal-close" onclick="closeDetailsModal()">×</button>
            </div>

            <div class="modal-section">
                <h3 class="modal-section-title">Informações Gerais</h3>
                <div class="modal-info-grid">
                    <div class="modal-info-item">
                        <div class="modal-info-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M20.5901 22C20.5901 18.13 16.7402 15 12.0002 15C7.26015 15 3.41016 18.13 3.41016 22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="modal-info-text">
                            <div class="modal-info-label">Nome</div>
                            <div class="modal-info-value" id="modalName">--</div>
                        </div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21.97 18.33C21.97 18.69 21.89 19.06 21.72 19.42C21.55 19.78 21.33 20.12 21.04 20.44C20.55 20.98 20.01 21.37 19.4 21.62C18.8 21.87 18.15 22 17.45 22C16.43 22 15.34 21.76 14.19 21.27C13.04 20.78 11.89 20.12 10.75 19.29C9.6 18.45 8.51 17.52 7.47 16.49C6.44 15.45 5.51 14.36 4.68 13.22C3.86 12.08 3.2 10.94 2.72 9.81C2.24 8.67 2 7.58 2 6.54C2 5.86 2.12 5.21 2.36 4.61C2.6 4 2.98 3.44 3.51 2.94C4.15 2.31 4.85 2 5.59 2C5.87 2 6.15 2.06 6.4 2.18C6.66 2.3 6.89 2.48 7.07 2.74L9.39 6.01C9.57 6.26 9.7 6.49 9.79 6.71C9.88 6.92 9.93 7.13 9.93 7.32C9.93 7.56 9.86 7.8 9.72 8.03C9.59 8.26 9.4 8.5 9.16 8.74L8.4 9.53C8.29 9.64 8.24 9.77 8.24 9.93C8.24 10.01 8.25 10.08 8.27 10.16C8.3 10.24 8.33 10.3 8.35 10.36C8.53 10.69 8.84 11.12 9.28 11.64C9.73 12.16 10.21 12.69 10.73 13.22C11.27 13.75 11.79 14.24 12.32 14.69C12.84 15.13 13.27 15.43 13.61 15.61C13.66 15.63 13.72 15.66 13.79 15.69C13.87 15.72 13.95 15.73 14.04 15.73C14.21 15.73 14.34 15.67 14.45 15.56L15.21 14.81C15.46 14.56 15.7 14.37 15.93 14.25C16.16 14.11 16.39 14.04 16.64 14.04C16.83 14.04 17.03 14.08 17.25 14.17C17.47 14.26 17.7 14.39 17.95 14.56L21.26 16.91C21.52 17.09 21.7 17.3 21.81 17.55C21.91 17.8 21.97 18.05 21.97 18.33Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10"/>
                            </svg>
                        </div>
                        <div class="modal-info-text">
                            <div class="modal-info-label">Telefone</div>
                            <div class="modal-info-value" id="modalPhone">--</div>
                        </div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 2V5M16 2V5M3.5 9.09H20.5M21 8.5V17C21 20 19.5 22 16 22H8C4.5 22 3 20 3 17V8.5C3 5.5 4.5 3.5 8 3.5H16C19.5 3.5 21 5.5 21 8.5Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="modal-info-text">
                            <div class="modal-info-label">Data de Criação</div>
                            <div class="modal-info-value" id="modalCreatedAt">--</div>
                        </div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8.5 19H8C4 19 2 18 2 13V8C2 4 4 2 8 2H16C20 2 22 4 22 8V13C22 17 20 19 16 19H15.5C15.19 19 14.89 19.15 14.7 19.4L13.2 21.4C12.54 22.28 11.46 22.28 10.8 21.4L9.3 19.4C9.14 19.18 8.77 19 8.5 19Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="modal-info-text">
                            <div class="modal-info-label">Total de Mensagens</div>
                            <div class="modal-info-value" id="modalTotalMessages">--</div>
                        </div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="modal-info-text">
                            <div class="modal-info-label">Última Atualização</div>
                            <div class="modal-info-value" id="modalUpdatedAt">--</div>
                        </div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21.97 18.33C21.97 18.69 21.89 19.06 21.72 19.42C21.55 19.78 21.33 20.12 21.04 20.44C20.55 20.98 20.01 21.37 19.4 21.62C18.8 21.87 18.15 22 17.45 22C16.43 22 15.34 21.76 14.19 21.27C13.04 20.78 11.89 20.12 10.75 19.29C9.6 18.45 8.51 17.52 7.47 16.49C6.44 15.45 5.51 14.36 4.68 13.22C3.86 12.08 3.2 10.94 2.72 9.81C2.24 8.67 2 7.58 2 6.54C2 5.86 2.12 5.21 2.36 4.61C2.6 4 2.98 3.44 3.51 2.94C4.15 2.31 4.85 2 5.59 2C5.87 2 6.15 2.06 6.4 2.18C6.66 2.3 6.89 2.48 7.07 2.74L9.39 6.01C9.57 6.26 9.7 6.49 9.79 6.71C9.88 6.92 9.93 7.13 9.93 7.32C9.93 7.56 9.86 7.8 9.72 8.03C9.59 8.26 9.4 8.5 9.16 8.74L8.4 9.53C8.29 9.64 8.24 9.77 8.24 9.93C8.24 10.01 8.25 10.08 8.27 10.16C8.3 10.24 8.33 10.3 8.35 10.36C8.53 10.69 8.84 11.12 9.28 11.64C9.73 12.16 10.21 12.69 10.73 13.22C11.27 13.75 11.79 14.24 12.32 14.69C12.84 15.13 13.27 15.43 13.61 15.61C13.66 15.63 13.72 15.66 13.79 15.69C13.87 15.72 13.95 15.73 14.04 15.73C14.21 15.73 14.34 15.67 14.45 15.56L15.21 14.81C15.46 14.56 15.7 14.37 15.93 14.25C16.16 14.11 16.39 14.04 16.64 14.04C16.83 14.04 17.03 14.08 17.25 14.17C17.47 14.26 17.7 14.39 17.95 14.56L21.26 16.91C21.52 17.09 21.7 17.3 21.81 17.55C21.91 17.8 21.97 18.05 21.97 18.33Z" stroke="currentColor" stroke-width="1.5" stroke-miterlimit="10"/>
                            </svg>
                        </div>
                        <div class="modal-info-text">
                            <div class="modal-info-label">Instância WhatsApp</div>
                            <div class="modal-info-value" id="modalInstance">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-section">
                <h3 class="modal-section-title">Tags</h3>
                <div class="modal-tags" id="modalTags">
                    <!-- Tags serão inseridas aqui -->
                </div>
            </div>

            <div class="modal-section">
                <h3 class="modal-section-title">Resumo da IA</h3>
                <div class="modal-summary" id="modalSummary">
                    Nenhum resumo disponível
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== DEBUG MODE ==========
        const DEBUG = true;
        function log(...args) {
            if (DEBUG) console.log(...args);
        }

        // ========== VARIÁVEIS GLOBAIS ==========
        let conversations = [];
        let currentConversation = null;
        let currentFilter = 'todos';
        let currentInstance = 'todas';
        let userData = null;
        let contextMenuTarget = null;

        // ========== RESIZE HANDLERS ==========
        let isResizing = false;
        let resizingElement = null;

        function setupResize(handleId, sidebarId, isRight = false) {
            const handle = document.getElementById(handleId);
            const sidebar = document.getElementById(sidebarId);
            
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isResizing = true;
                resizingElement = sidebar;
                handle.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing || resizingElement !== sidebar) return;
                
                e.preventDefault();
                
                if (isRight) {
                    const newWidth = window.innerWidth - e.clientX;
                    if (newWidth >= 280 && newWidth <= 600) {
                        sidebar.style.width = newWidth + 'px';
                    }
                } else {
                    const newWidth = e.clientX;
                    if (newWidth >= 300 && newWidth <= 600) {
                        sidebar.style.width = newWidth + 'px';
                    }
                }
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizingElement = null;
                    handle.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // ========== INICIALIZAÇÃO ==========
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 Inicializando aplicação...');
            
            loadUserData();
            loadConversations();
            setupEventListeners();
            setupResize('resizeHandleLeft', 'conversationsSidebar', false);
            setupResize('resizeHandleRight', 'leadInfoSidebar', true);
            
            log('✅ Aplicação inicializada');
        });

        // ========== CARREGAR DADOS DO USUÁRIO ==========
        function loadUserData() {
            try {
                const storedData = localStorage.getItem('userData');
                if (storedData) {
                    const parsed = JSON.parse(storedData);
                    userData = {
                        tenant_id: parsed?.user?.tenant_id || parsed?.tenant_id,
                        email: parsed?.user?.email || parsed?.email,
                        id: parsed?.user?.id || parsed?.id
                    };
                    log('✅ Dados do usuário carregados:', userData);
                } else {
                    console.error('❌ Dados do usuário não encontrados');
                    alert('Sessão expirada. Faça login novamente.');
                }
            } catch (error) {
                console.error('❌ Erro ao carregar dados do usuário:', error);
            }
        }

        // ========== CARREGAR CONVERSAS ==========
        async function loadConversations() {
            if (!userData || !userData.tenant_id) {
                console.error('❌ tenant_id não encontrado');
                return;
            }

            try {
                log('📡 Buscando conversas...');
                
                const response = await fetch('https://sdr.salesdever.io/webhook/get-conversas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: userData.tenant_id
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                // Tentar ler o texto da resposta primeiro
                const responseText = await response.text();
                log('📥 Resposta recebida (primeiros 200 chars): ' + responseText.substring(0, 200));

                let data = [];

                // Se a resposta estiver vazia, não é um erro - apenas não há conversas ainda
                if (!responseText || responseText.trim() === '') {
                    log('📭 Resposta vazia - conta nova sem conversas');
                    conversations = [];
                    populateInstanceFilter();
                    renderConversations();
                    return;
                }

                // Tentar parsear JSON
                try {
                    data = JSON.parse(responseText);
                } catch (jsonError) {
                    console.warn('⚠️ Resposta não é JSON válido, tratando como sem conversas');
                    conversations = [];
                    populateInstanceFilter();
                    renderConversations();
                    return;
                }

                if (Array.isArray(data) && data.length === 1 && Array.isArray(data[0])) {
                    conversations = [];
                } else {
                    conversations = Array.isArray(data) ? data : [];
                }

                log(`✅ ${conversations.length} conversas recebidas do webhook`);

                // Log cada conversa
                conversations.forEach((conv, idx) => {
                    log(`\n${idx + 1}. ${conv.nome} (${conv.id})`);
                    log(`   Telefone: ${conv.telefone}`);
                    log(`   Mensagens: ${conv.mensagens ? conv.mensagens.length : 0}`);
                    log(`   Instância: ${conv.instancia || 'Não informada'}`);
                    log(`   Foto: ${conv.profile_picture ? 'SIM' : 'NÃO (será gerada)'}`);
                });

                // Popular select de instâncias
                populateInstanceFilter();

                renderConversations();
            } catch (error) {
                console.error('❌ Erro ao carregar conversas:', error);
                // Só mostrar erro se for realmente um problema de rede ou servidor
                if (error.message.includes('HTTP') || error.message.includes('fetch') || error.message.includes('network')) {
                    alert('Erro ao carregar conversas. Tente novamente.');
                } else {
                    log('📭 Tratando como conta sem conversas');
                    conversations = [];
                    populateInstanceFilter();
                    renderConversations();
                }
            }
        }

        // ========== POPULAR SELECT DE INSTÂNCIAS ==========
        function populateInstanceFilter() {
            const container = document.getElementById('instanceFilterOptions');
            const instances = new Set();
            
            conversations.forEach(conv => {
                if (conv.instancia && conv.instancia.trim() !== '') {
                    instances.add(conv.instancia);
                }
            });
            
            // Manter opção "Todas"
            container.innerHTML = `
                <div class="filter-option active" data-instance="todas">
                    Todas as Instâncias
                </div>
            `;
            
            // Adicionar instâncias únicas
            Array.from(instances).sort().forEach(instance => {
                const option = document.createElement('div');
                option.className = 'filter-option';
                option.dataset.instance = instance;
                option.textContent = instance;
                container.appendChild(option);
            });
            
            // Adicionar event listeners
            container.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', () => {
                    container.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    currentInstance = option.dataset.instance;
                    log(`📱 Filtro de instância alterado para: ${currentInstance}`);
                    renderConversations();
                    document.getElementById('filterButton').classList.add('active');
                });
            });
            
            log(`📱 ${instances.size} instâncias únicas encontradas`);
        }

        // ========== RECARREGAR CONVERSAS ==========
        async function reloadConversations() {
            const reloadBtn = document.querySelector('.reload-btn');
            if (reloadBtn) {
                reloadBtn.classList.add('loading');
            }

            try {
                await loadConversations();
                
                // Se há uma conversa selecionada, atualizar
                if (currentConversation) {
                    const updated = conversations.find(c => c.id === currentConversation.id);
                    if (updated) {
                        selectConversation(updated);
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao recarregar:', error);
            } finally {
                setTimeout(() => {
                    if (reloadBtn) {
                        reloadBtn.classList.remove('loading');
                    }
                }, 500);
            }
        }

        // ========== GERAR AVATAR ÚNICO ==========
        function getUniqueAvatar(conv) {
            // Se tem foto de perfil válida, usar
            if (conv.profile_picture && conv.profile_picture.startsWith('http')) {
                return conv.profile_picture;
            }
            
            // Gerar avatar único baseado no ID + número
            const displayName = conv.nome && conv.nome !== conv.telefone ? conv.nome : conv.telefone;
            const seed = `${conv.id}-${conv.telefone}`.replace(/[^a-zA-Z0-9]/g, '');
            
            // Cores diferentes para cada lead
            const colors = [
                'A594FF', '667eea', '3B82F6', '22C55E', 
                'FB923C', 'EF4444', '8B5CF6', '06B6D4'
            ];
            
            // Escolher cor baseada no hash do seed
            const colorIndex = seed.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
            const bgColor = colors[colorIndex];
            
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=${bgColor}&color=fff&size=128&seed=${seed}`;
        }

        // ========== FORMATAÇÃO DE DATA/HORÁRIO COMO WHATSAPP ==========
        function formatarDataHorarioWhatsApp(data) {
            if (!data) return '--:--';

            const dataConversa = new Date(data);
            if (isNaN(dataConversa.getTime())) return '--:--';

            const agora = new Date();
            const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
            const ontem = new Date(hoje.getTime() - 24 * 60 * 60 * 1000);
            const dataConversaDia = new Date(dataConversa.getFullYear(), dataConversa.getMonth(), dataConversa.getDate());

            // Mesmo dia - mostrar apenas horário
            if (dataConversaDia.getTime() === hoje.getTime()) {
                return dataConversa.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            }

            // Ontem
            if (dataConversaDia.getTime() === ontem.getTime()) {
                return 'ontem';
            }

            // Calcular início da semana atual (domingo)
            const diaHojeSemana = hoje.getDay(); // 0 = domingo, 1 = segunda, etc.
            const inicioSemanaAtual = new Date(hoje.getTime() - (diaHojeSemana * 24 * 60 * 60 * 1000));

            // Se a conversa foi nesta semana (depois do domingo desta semana), mostrar dia da semana
            if (dataConversaDia.getTime() >= inicioSemanaAtual.getTime()) {
                const diasSemana = ['domingo', 'segunda-feira', 'terça-feira', 'quarta-feira', 'quinta-feira', 'sexta-feira', 'sábado'];
                return diasSemana[dataConversa.getDay()];
            }

            // Mais de uma semana - mostrar data completa DD/MM/AAAA
            return dataConversa.toLocaleDateString('pt-BR');
        }

        // ========== EXTRAIR ÚLTIMA MENSAGEM COMPLETA ==========
        function getLastMessage(conv) {
            let todasMensagens = [];

            // Extrair todas as mensagens independente do formato
            if (conv.mensagensAgrupadas) {
                const grupos = Object.values(conv.mensagensAgrupadas);
                grupos.forEach(grupo => {
                    if (grupo.mensagens && Array.isArray(grupo.mensagens)) {
                        todasMensagens = todasMensagens.concat(grupo.mensagens);
                    }
                });
            } else if (conv.mensagens && Array.isArray(conv.mensagens)) {
                todasMensagens = conv.mensagens;
            }

            // Encontrar a mensagem mais recente
            if (todasMensagens.length > 0) {
                let mensagemMaisRecente = null;
                let dataMaisRecente = new Date(0);

                todasMensagens.forEach(msg => {
                    let msgData = null;

                    if (msg.dataHora) {
                        msgData = new Date(msg.dataHora);
                    } else if (msg.timestamp) {
                        msgData = new Date(msg.timestamp);
                    } else if (msg.created_at) {
                        msgData = new Date(msg.created_at);
                    }

                    if (msgData && !isNaN(msgData.getTime()) && msgData > dataMaisRecente) {
                        dataMaisRecente = msgData;
                        mensagemMaisRecente = msg;
                    }
                });

                return mensagemMaisRecente;
            }

            return null;
        }

        // ========== EXTRAIR DATA DA ÚLTIMA MENSAGEM ==========
        function getLastMessageDate(conv) {
            const lastMsg = getLastMessage(conv);

            if (lastMsg) {
                return lastMsg.dataHora || lastMsg.timestamp || lastMsg.created_at;
            }

            // Fallback
            return conv.ultimaAtualizacao || conv.created_at;
        }

        // ========== RENDERIZAR CONVERSAS ==========
        function renderConversations() {
            const container = document.getElementById('conversationsList');

            const filtered = filterConversations();

            console.log(`\n[DEBUG ORDENAÇÃO] ========== Ordenando ${filtered.length} conversas ==========`);

            // Ordenar por ultimaAtualizacao - MAIS RECENTE PRIMEIRO
            filtered.sort((a, b) => {
                const dateA = a.ultimaAtualizacao ? new Date(a.ultimaAtualizacao) : new Date(0);
                const dateB = b.ultimaAtualizacao ? new Date(b.ultimaAtualizacao) : new Date(0);

                const timeA = isNaN(dateA.getTime()) ? 0 : dateA.getTime();
                const timeB = isNaN(dateB.getTime()) ? 0 : dateB.getTime();

                return timeB - timeA; // Mais recente primeiro (DECRESCENTE)
            });

            // Debug: Mostrar ordem final
            console.log('[DEBUG ORDENAÇÃO] Ordem final (por ultimaAtualizacao):');
            filtered.slice(0, 10).forEach((conv, idx) => {
                const data = conv.ultimaAtualizacao ? new Date(conv.ultimaAtualizacao) : null;
                const dataStr = data ? data.toLocaleString('pt-BR') : 'N/A';
                const hora = data ? data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '--:--';
                console.log(`  ${idx + 1}. ${conv.nome.padEnd(30)} | ${hora} | ${dataStr}`);
            });
            console.log('[DEBUG ORDENAÇÃO] ========================================\n');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.5);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📭</div>
                        <p>Nenhuma conversa encontrada</p>
                    </div>
                `;
                return;
            }

            // Usar DocumentFragment para melhor performance
            const fragment = document.createDocumentFragment();

            filtered.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.dataset.convId = conv.id;
                item.dataset.convPhone = conv.telefone;

                if (currentConversation && currentConversation.id === conv.id) {
                    item.classList.add('active');
                }

                const displayName = conv.nome && conv.nome !== conv.telefone ? conv.nome : conv.telefone;
                const avatarUrl = getUniqueAvatar(conv);

                // Calcular horário de ultimaAtualizacao usando formatação WhatsApp
                let time = formatarDataHorarioWhatsApp(conv.ultimaAtualizacao);

                console.log(`[HORÁRIO] ${conv.nome}: ${time} (de ultimaAtualizacao: ${conv.ultimaAtualizacao})`);

                const tags = conv.tags && conv.tags.length > 0 ? conv.tags : [];
                const tagsHTML = tags.length > 0 ?
                    tags.slice(0, 2).map(tag => `<span class="mini-tag ${tag}">${tag}</span>`).join('') :
                    '';

                item.innerHTML = `
                    <img src="${avatarUrl}" alt="${displayName}" class="conversation-avatar" onerror="this.src='https://ui-avatars.com/api/?name=U&background=A594FF&color=fff'">
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <span class="conversation-name" title="${displayName}">${displayName}</span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span class="conversation-time">${time}</span>
                                <div class="conversation-menu-btn"></div>
                            </div>
                        </div>
                        <div class="conversation-preview">${conv.preview || 'Sem mensagens'}</div>
                        ${tagsHTML ? `<div class="conversation-tags">${tagsHTML}</div>` : ''}
                    </div>
                `;

                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('conversation-menu-btn')) {
                        selectConversation(conv);
                    }
                });

                const menuBtn = item.querySelector('.conversation-menu-btn');
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showContextMenu(e, conv);
                });

                fragment.appendChild(item);
            });

            // Renderizar tudo de uma vez
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        // ========== FILTRAR CONVERSAS ==========
        function filterConversations() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            return conversations.filter(conv => {
                const matchesSearch = !searchTerm || 
                                     conv.nome.toLowerCase().includes(searchTerm) ||
                                     conv.telefone.toLowerCase().includes(searchTerm) ||
                                     (conv.preview && conv.preview.toLowerCase().includes(searchTerm));

                const matchesTag = currentFilter === 'todos' || 
                                  (conv.tags && conv.tags.includes(currentFilter));

                const matchesInstance = currentInstance === 'todas' || 
                                       conv.instancia === currentInstance;

                return matchesSearch && matchesTag && matchesInstance;
            });
        }

        // ========== SELECIONAR CONVERSA ==========
        function selectConversation(conv) {
            log(`\n✅ Selecionando: ${conv.nome}`);
            log(`   ID: ${conv.id}`);
            log(`   Telefone: ${conv.telefone}`);

            // Detectar formato de mensagens
            let messagesData;
            let totalMensagens = 0;

            if (conv.mensagensAgrupadas) {
                // Novo formato com mensagens agrupadas
                messagesData = { mensagensAgrupadas: conv.mensagensAgrupadas };
                totalMensagens = Object.values(conv.mensagensAgrupadas).reduce(
                    (sum, grupo) => sum + (grupo.mensagens?.length || 0), 0
                );
                log(`   Mensagens agrupadas: ${totalMensagens} mensagens em ${Object.keys(conv.mensagensAgrupadas).length} grupos`);
            } else {
                // Formato antigo com array de mensagens
                if (!conv.mensagens || !Array.isArray(conv.mensagens)) {
                    conv.mensagens = [];
                }
                messagesData = conv.mensagens;
                totalMensagens = conv.mensagens.length;
                log(`   Mensagens: ${totalMensagens}`);

                // Mostrar primeiras 3 mensagens (apenas no formato antigo)
                if (conv.mensagens.length > 0) {
                    log(`   Primeiras mensagens:`);
                    conv.mensagens.slice(0, 3).forEach((msg, idx) => {
                        log(`   ${idx + 1}. [${msg.tipo}] ${msg.texto.substring(0, 40)}...`);
                    });
                }
            }

            currentConversation = conv;

            const displayName = conv.nome && conv.nome !== conv.telefone ? conv.nome : conv.telefone;
            const avatarUrl = getUniqueAvatar(conv);

            document.getElementById('chatAvatar').src = avatarUrl;
            document.getElementById('chatUserName').textContent = displayName;
            document.getElementById('chatTotalMessages').textContent = totalMensagens;

            const createdDate = conv.created_at ? new Date(conv.created_at).toLocaleDateString('pt-BR') : '--/--/----';
            document.getElementById('chatCreatedDate').textContent = createdDate;

            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('messageInputContainer').style.display = 'block';

            renderMessages(messagesData);
            updateLeadInfo(conv);

            document.getElementById('leadInfoSidebar').style.display = 'block';
            renderConversations();
        }

        // ========== RENDERIZAR MENSAGENS ==========
        function renderMessages(messagesData) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            // Verificar se é o novo formato com mensagensAgrupadas
            const isGroupedFormat = messagesData && typeof messagesData === 'object' && messagesData.mensagensAgrupadas;

            // Se for formato antigo (array), converter para o novo formato
            let mensagensAgrupadas;
            if (isGroupedFormat) {
                mensagensAgrupadas = messagesData.mensagensAgrupadas;
            } else {
                // Formato antigo - mostrar tudo como "Hoje" para compatibilidade
                if (!messagesData || !Array.isArray(messagesData) || messagesData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">💬</div>
                            <h3>Nenhuma mensagem</h3>
                            <p>Inicie a conversa enviando uma mensagem</p>
                        </div>
                    `;
                    return;
                }

                mensagensAgrupadas = {
                    'Hoje': {
                        label: 'Hoje',
                        mensagens: messagesData
                    }
                };
            }

            // Verificar se há mensagens
            const totalMensagens = Object.values(mensagensAgrupadas).reduce((sum, grupo) => sum + (grupo.mensagens?.length || 0), 0);

            if (totalMensagens === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💬</div>
                        <h3>Nenhuma mensagem</h3>
                        <p>Inicie a conversa enviando uma mensagem</p>
                    </div>
                `;
                return;
            }

            log(`💬 Renderizando ${totalMensagens} mensagens agrupadas para ${currentConversation.nome}`);

            const displayName = currentConversation.nome && currentConversation.nome !== currentConversation.telefone ?
                               currentConversation.nome : currentConversation.telefone;

            const leadAvatarUrl = getUniqueAvatar(currentConversation);

            // Ordenar os grupos por data (mais antiga primeiro - como WhatsApp)
            const gruposOrdenados = Object.entries(mensagensAgrupadas).sort((a, b) => {
                const dataA = a[1].data ? new Date(a[1].data) : new Date(0);
                const dataB = b[1].data ? new Date(b[1].data) : new Date(0);
                return dataA - dataB; // Mais antiga primeiro
            });

            // Renderizar cada grupo de mensagens
            gruposOrdenados.forEach(([key, grupo]) => {
                if (!grupo.mensagens || grupo.mensagens.length === 0) return;

                console.log(`\n[DEBUG MENSAGENS] ========== Grupo: ${grupo.label} ==========`);

                // Criar separador de data
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'date-separator';
                dateSeparator.innerHTML = `
                    <div class="date-separator-line"></div>
                    <span class="date-separator-label">${grupo.label}</span>
                    <div class="date-separator-line"></div>
                `;
                container.appendChild(dateSeparator);

                // Ordenar mensagens do grupo por dataHora (mais antiga primeiro - como WhatsApp)
                const mensagensOrdenadas = [...grupo.mensagens].sort((a, b) => {
                    const dataA = a.dataHora ? new Date(a.dataHora) : new Date(0);
                    const dataB = b.dataHora ? new Date(b.dataHora) : new Date(0);
                    return dataA - dataB; // Mais antiga primeiro
                });

                // Renderizar mensagens do grupo
                mensagensOrdenadas.forEach((msg, idx) => {
                    // DEBUG: Verificar campos da mensagem
                    console.log(`[DEBUG MENSAGENS] Msg ${idx + 1}:`, {
                        tipo: msg.tipo,
                        remetente: msg.remetente,
                        texto: msg.texto?.substring(0, 50) + '...',
                        hora: msg.hora,
                        horaExibida: msg.hora || '--:--',
                        dataHora: msg.dataHora,
                        fromMe: msg.fromMe,
                        from: msg.from,
                        to: msg.to
                    });

                    // Avisar se hora estiver faltando
                    if (!msg.hora) {
                        console.warn(`[DEBUG MENSAGENS] ⚠️ Mensagem ${idx + 1} sem campo 'hora'!`);
                    }

                    // Verificar e corrigir o tipo da mensagem se necessário
                    let tipoMensagem = msg.tipo;

                    // Se o tipo não está definido, tentar determinar pelo campo fromMe ou remetente
                    if (!tipoMensagem || (tipoMensagem !== 'lead' && tipoMensagem !== 'agent')) {
                        if (msg.fromMe === true || msg.fromMe === 'true') {
                            tipoMensagem = 'agent';
                        } else if (msg.fromMe === false || msg.fromMe === 'false') {
                            tipoMensagem = 'lead';
                        } else if (msg.remetente && msg.remetente.toLowerCase().includes('agent')) {
                            tipoMensagem = 'agent';
                        } else {
                            tipoMensagem = 'lead'; // Default
                        }
                        console.warn(`[DEBUG MENSAGENS] ⚠️ Tipo corrigido de "${msg.tipo}" para "${tipoMensagem}"`);
                    }

                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${tipoMensagem}`;

                    const avatarUrl = tipoMensagem === 'lead' ? leadAvatarUrl :
                                     'https://ui-avatars.com/api/?name=Agent&background=667eea&color=fff';

                    messageDiv.innerHTML = `
                        <img src="${avatarUrl}" alt="Avatar" class="message-avatar">
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">${msg.remetente}</span>
                                <span class="message-time">${msg.hora || '--:--'}</span>
                            </div>
                            <div class="message-bubble">${msg.texto}</div>
                        </div>
                    `;

                    container.appendChild(messageDiv);
                });

                console.log(`[DEBUG MENSAGENS] Total: ${grupo.mensagens.length} mensagens renderizadas\n`);
            });

            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // ========== ATUALIZAR INFO DO LEAD ==========
        function updateLeadInfo(conv) {
            const displayName = conv.nome && conv.nome !== conv.telefone ? conv.nome : conv.telefone;
            const avatarUrl = getUniqueAvatar(conv);

            document.getElementById('leadAvatar').src = avatarUrl;
            document.getElementById('leadName').textContent = displayName;
            document.getElementById('leadPhone').textContent = conv.telefone || 'Não informado';

            document.getElementById('leadCreatedAt').textContent = conv.created_at ?
                new Date(conv.created_at).toLocaleDateString('pt-BR') : '--';
            document.getElementById('leadTotalMessages').textContent = conv.totalMensagens || 0;
            document.getElementById('leadUpdatedAt').textContent = conv.ultimaAtualizacao ?
                new Date(conv.ultimaAtualizacao).toLocaleString('pt-BR') : '--';
            document.getElementById('leadInstance').textContent = conv.instancia || 'Não informada';

            // Atualizar botão de bloqueio/desbloqueio de IA
            const isBlocked = conv.block === true;
            updateIAToggleButton(isBlocked);

            const tagsContainer = document.getElementById('leadTags');
            const tags = conv.tags && conv.tags.length > 0 ?
                        conv.tags.filter(tag => tag && tag.trim() !== '') :
                        [];

            if (tags.length === 0) {
                tagsContainer.innerHTML = '<div style="color: rgba(255, 255, 255, 0.5); font-size: 0.9rem; padding: 0.5rem;">Nenhuma tag</div>';
            } else {
                tagsContainer.innerHTML = tags.map(tag =>
                    `<div class="tag-badge ${tag}" onclick="removeTag('${tag}')">
                        ${tag}
                        <span class="tag-remove">×</span>
                    </div>`
                ).join('');
            }

            // Formatar e exibir resumo da IA
            const notesTextarea = document.getElementById('leadNotes');
            notesTextarea.value = formatAISummary(conv.resumo);
        }

        // ========== FORMATAÇÃO DO RESUMO DA IA ==========
        function formatAISummary(resumo) {
            if (!resumo || resumo.trim() === '') {
                return 'Nenhum resumo disponível';
            }

            try {
                // Tentar fazer parse do JSON
                const data = typeof resumo === 'string' ? JSON.parse(resumo) : resumo;

                // Verificar se tem a estrutura esperada
                if (!data.lead_summary) {
                    return resumo; // Retornar texto original se não for o formato esperado
                }

                const summary = data.lead_summary;
                let formatted = '';

                // Informações do Lead
                if (summary.lead_info) {
                    const info = summary.lead_info;
                    formatted += '👤 INFORMAÇÕES DO LEAD\n';
                    formatted += '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n';
                    if (info.name) formatted += `Nome: ${info.name}\n`;
                    if (info.phone) formatted += `Telefone: ${info.phone}\n`;
                    if (info.email) formatted += `Email: ${info.email}\n`;
                    if (info.company) formatted += `Empresa: ${info.company}\n`;
                    if (info.status) formatted += `Status: ${info.status}\n`;
                    formatted += '\n';
                }

                // Conversas
                if (summary.conversations && summary.conversations.length > 0) {
                    formatted += `💬 HISTÓRICO DE CONVERSAS (${summary.conversations.length})\n`;
                    formatted += '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';

                    summary.conversations.forEach((conv, index) => {
                        formatted += `📞 Conversa #${conv.id || index + 1}\n`;
                        formatted += `Origem: ${conv.source || 'N/A'}\n`;
                        if (conv.start_time) formatted += `Início: ${conv.start_time}\n`;
                        if (conv.end_time) formatted += `Fim: ${conv.end_time}\n`;
                        formatted += `\n📝 Resumo:\n${conv.summary || 'Sem resumo'}\n`;

                        if (conv.key_points && conv.key_points.length > 0) {
                            formatted += `\n🔑 Pontos-chave:\n`;
                            conv.key_points.forEach(point => {
                                formatted += `  • ${point}\n`;
                            });
                        }

                        formatted += '\n' + '─'.repeat(50) + '\n\n';
                    });
                }

                return formatted.trim();

            } catch (e) {
                // Se não for JSON válido, retornar o texto original
                return resumo;
            }
        }

        function formatAISummaryHTML(resumo) {
            if (!resumo || resumo.trim() === '') {
                return '<div style="color: rgba(255, 255, 255, 0.5);">Nenhum resumo disponível</div>';
            }

            try {
                // Tentar fazer parse do JSON
                const data = typeof resumo === 'string' ? JSON.parse(resumo) : resumo;

                // Verificar se tem a estrutura esperada
                if (!data.lead_summary) {
                    return `<div style="white-space: pre-wrap;">${resumo}</div>`; // Retornar texto original
                }

                const summary = data.lead_summary;
                let html = '';

                // Informações do Lead
                if (summary.lead_info) {
                    const info = summary.lead_info;
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1rem; font-weight: 700; color: #A594FF; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                INFORMAÇÕES DO LEAD
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.03); border-left: 3px solid #A594FF; padding: 1rem; border-radius: 0.5rem;">
                                ${info.name ? `<div style="margin-bottom: 0.5rem;"><strong>Nome:</strong> ${info.name}</div>` : ''}
                                ${info.phone ? `<div style="margin-bottom: 0.5rem;"><strong>Telefone:</strong> ${info.phone}</div>` : ''}
                                ${info.email ? `<div style="margin-bottom: 0.5rem;"><strong>Email:</strong> ${info.email}</div>` : ''}
                                ${info.company ? `<div style="margin-bottom: 0.5rem;"><strong>Empresa:</strong> ${info.company}</div>` : ''}
                                ${info.status ? `<div><strong>Status:</strong> <span style="color: #22C55E; text-transform: uppercase; font-weight: 600;">${info.status}</span></div>` : ''}
                            </div>
                        </div>
                    `;
                }

                // Conversas
                if (summary.conversations && summary.conversations.length > 0) {
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1rem; font-weight: 700; color: #A594FF; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                HISTÓRICO DE CONVERSAS (${summary.conversations.length})
                            </div>
                    `;

                    summary.conversations.forEach((conv, index) => {
                        html += `
                            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1rem; border: 1px solid rgba(165, 148, 255, 0.2);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <div style="font-size: 0.95rem; font-weight: 700; color: white;">
                                        📞 Conversa #${conv.id || index + 1}
                                    </div>
                                    <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; background: rgba(165, 148, 255, 0.2); padding: 0.25rem 0.75rem; border-radius: 1rem;">
                                        ${conv.source || 'N/A'}
                                    </div>
                                </div>

                                ${conv.start_time || conv.end_time ? `
                                    <div style="display: flex; gap: 1.5rem; margin-bottom: 1rem; font-size: 0.85rem; color: rgba(255, 255, 255, 0.6);">
                                        ${conv.start_time ? `<div>⏰ Início: ${conv.start_time}</div>` : ''}
                                        ${conv.end_time ? `<div>⏱️ Fim: ${conv.end_time}</div>` : ''}
                                    </div>
                                ` : ''}

                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.8rem; font-weight: 600; color: #A594FF; margin-bottom: 0.5rem;">📝 RESUMO</div>
                                    <div style="font-size: 0.9rem; line-height: 1.6; color: rgba(255, 255, 255, 0.85); background: rgba(0, 0, 0, 0.2); padding: 0.75rem; border-radius: 0.5rem;">
                                        ${conv.summary || 'Sem resumo'}
                                    </div>
                                </div>

                                ${conv.key_points && conv.key_points.length > 0 ? `
                                    <div>
                                        <div style="font-size: 0.8rem; font-weight: 600; color: #A594FF; margin-bottom: 0.5rem;">🔑 PONTOS-CHAVE</div>
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                            ${conv.key_points.map(point => `
                                                <div style="display: flex; align-items: start; gap: 0.5rem; font-size: 0.85rem; line-height: 1.5;">
                                                    <span style="color: #22C55E; font-weight: 700; flex-shrink: 0;">•</span>
                                                    <span style="color: rgba(255, 255, 255, 0.8);">${point}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });

                    html += '</div>';
                }

                return html;

            } catch (e) {
                // Se não for JSON válido, retornar o texto original
                return `<div style="white-space: pre-wrap;">${resumo}</div>`;
            }
        }

        // ========== CONTEXT MENU ==========
        function showContextMenu(e, conv) {
            e.preventDefault();
            
            contextMenuTarget = conv;
            const menu = document.getElementById('contextMenu');
            
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            menu.classList.add('active');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
            document.getElementById('tagsSubmenu').classList.remove('active');
            contextMenuTarget = null;
        }

        function showTagsSubmenu(e) {
            const submenu = document.getElementById('tagsSubmenu');
            const menuRect = document.getElementById('contextMenu').getBoundingClientRect();
            
            submenu.style.left = menuRect.right + 'px';
            submenu.style.top = menuRect.top + 'px';
            submenu.classList.add('active');
        }

        // ========== MODAL VISÃO DETALHADA ==========
        function showDetailsModal() {
            if (!contextMenuTarget) return;
            
            const conv = contextMenuTarget;
            
            log(`👁️ Abrindo visão detalhada para: ${conv.nome}`);
            
            // Preencher informações
            const displayName = conv.nome && conv.nome !== conv.telefone ? conv.nome : conv.telefone;
            document.getElementById('modalName').textContent = displayName;
            document.getElementById('modalPhone').textContent = conv.telefone || 'Não informado';
            document.getElementById('modalCreatedAt').textContent = conv.created_at ? 
                new Date(conv.created_at).toLocaleDateString('pt-BR') : '--';
            document.getElementById('modalTotalMessages').textContent = conv.totalMensagens || 
                (conv.mensagens ? conv.mensagens.length : 0);
            document.getElementById('modalUpdatedAt').textContent = conv.ultimaAtualizacao ? 
                new Date(conv.ultimaAtualizacao).toLocaleString('pt-BR') : '--';
            document.getElementById('modalInstance').textContent = conv.instancia || 'Não informada';
            
            // Tags
            const tags = conv.tags && conv.tags.length > 0 ? 
                        conv.tags.filter(tag => tag && tag.trim() !== '') : 
                        [];
            
            if (tags.length === 0) {
                document.getElementById('modalTags').innerHTML = '<div style="color: rgba(255, 255, 255, 0.5); font-size: 0.9rem;">Nenhuma tag</div>';
            } else {
                document.getElementById('modalTags').innerHTML = tags.map(tag => 
                    `<div class="modal-tag ${tag}">${tag}</div>`
                ).join('');
            }
            
            // Summary/Resumo - Formatar em HTML
            document.getElementById('modalSummary').innerHTML = formatAISummaryHTML(conv.resumo);

            // Mostrar modal
            document.getElementById('detailsModal').classList.add('active');
            hideContextMenu();
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        // Fechar modal ao clicar fora
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('detailsModal');
            if (e.target === modal) {
                closeDetailsModal();
            }
        });

        // ========== ADICIONAR TAG ==========
        async function addTag(tag) {
            if (!contextMenuTarget || !userData) return;
            
            const conv = contextMenuTarget;
            
            log(`🏷️ Adicionando tag "${tag}" ao lead ${conv.id}`);
            
            try {
                const currentTags = conv.tags || [];
                if (currentTags.includes(tag)) {
                    alert('Esta tag já foi adicionada');
                    hideContextMenu();
                    return;
                }

                const updatedTags = [...currentTags, tag];
                
                log(`📤 Enviando para webhook: tenant_id=${userData.tenant_id}, numero=${conv.telefone}, tags=${updatedTags.join(',')}`);

                const response = await fetch('https://sdr.salesdever.io/webhook/atualizar-tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: userData.tenant_id,
                        numero: conv.telefone,
                        tags: updatedTags
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                log('✅ Tag adicionada com sucesso');

                conv.tags = updatedTags;
                renderConversations();
                
                if (currentConversation && currentConversation.id === conv.id) {
                    updateLeadInfo(conv);
                }

                hideContextMenu();
            } catch (error) {
                console.error('❌ Erro ao adicionar tag:', error);
                alert('Erro ao adicionar tag. Tente novamente.');
            }
        }

        // ========== REMOVER TAG ==========
        async function removeTag(tagToRemove) {
            if (!currentConversation || !userData) return;
            
            log(`🗑️ Removendo tag "${tagToRemove}" do lead ${currentConversation.id}`);
            
            try {
                const currentTags = currentConversation.tags || [];
                const updatedTags = currentTags.filter(t => t !== tagToRemove);
                
                // Permitir array vazio - SEM forçar "novo"
                
                log(`📤 Enviando para webhook: tenant_id=${userData.tenant_id}, numero=${currentConversation.telefone}, tags=${updatedTags.length > 0 ? updatedTags.join(',') : '[]'}`);

                const response = await fetch('https://sdr.salesdever.io/webhook/atualizar-tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: userData.tenant_id,
                        numero: currentConversation.telefone,
                        tags: updatedTags
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                log('✅ Tag removida com sucesso');

                currentConversation.tags = updatedTags;
                
                // Atualizar no array de conversas
                const convIndex = conversations.findIndex(c => c.id === currentConversation.id);
                if (convIndex !== -1) {
                    conversations[convIndex].tags = updatedTags;
                }
                
                renderConversations();
                updateLeadInfo(currentConversation);
            } catch (error) {
                console.error('❌ Erro ao remover tag:', error);
                alert('Erro ao remover tag. Tente novamente.');
            }
        }

        // ========== TOGGLE BLOQUEIO/DESBLOQUEIO DE IA ==========
        async function toggleIABlock() {
            if (!currentConversation || !userData) return;

            const btn = document.getElementById('iaToggleBtn');
            const btnText = document.getElementById('iaToggleBtnText');

            // Desabilitar botão durante a requisição
            btn.disabled = true;

            const isCurrentlyBlocked = currentConversation.block === true;
            const newBlockStatus = !isCurrentlyBlocked;

            log(`${newBlockStatus ? '🚫 Bloqueando' : '✅ Desbloqueando'} IA Agent para ${currentConversation.telefone}`);

            try {
                const endpoint = newBlockStatus
                    ? 'https://sdr.salesdever.io/webhook/block-ia-agent'
                    : 'https://sdr.salesdever.io/webhook/unblock-ia-agent';

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: userData.tenant_id,
                        numero: currentConversation.telefone
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                log(`✅ Status de bloqueio atualizado: ${newBlockStatus}`);

                // Atualizar status local
                currentConversation.block = newBlockStatus;

                // Atualizar no array de conversas
                const convIndex = conversations.findIndex(c => c.id === currentConversation.id);
                if (convIndex !== -1) {
                    conversations[convIndex].block = newBlockStatus;
                }

                // Atualizar UI do botão
                updateIAToggleButton(newBlockStatus);

            } catch (error) {
                console.error('❌ Erro ao alternar bloqueio de IA:', error);
                alert('Erro ao atualizar status de bloqueio. Tente novamente.');
            } finally {
                btn.disabled = false;
            }
        }

        // ========== ATUALIZAR UI DO BOTÃO DE IA ==========
        function updateIAToggleButton(isBlocked) {
            const btn = document.getElementById('iaToggleBtn');
            const btnText = document.getElementById('iaToggleBtnText');

            if (isBlocked) {
                btn.classList.remove('active');
                btn.classList.add('blocked');
                btnText.textContent = 'IA Bloqueada';
            } else {
                btn.classList.remove('blocked');
                btn.classList.add('active');
                btnText.textContent = 'IA Ativa';
            }
        }

        // ========== ENVIAR MENSAGEM ==========
        async function sendMessage() {
            if (!currentConversation) {
                alert('Selecione uma conversa primeiro');
                return;
            }

            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) {
                alert('Digite uma mensagem');
                return;
            }

            const button = document.getElementById('sendButton');
            const buttonText = document.getElementById('sendButtonText');
            const buttonLoading = document.getElementById('sendButtonLoading');

            try {
                button.disabled = true;
                buttonText.style.display = 'none';
                buttonLoading.style.display = 'inline-block';

                log('📤 Enviando mensagem...');

                const response = await fetch('https://sdr.salesdever.io/webhook/enviar-mensagens-saas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: userData.tenant_id,
                        phone: currentConversation.telefone,
                        message: message,
                        conversation: currentConversation
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                log('✅ Mensagem enviada');

                const newMessage = {
                    tipo: 'agent',
                    remetente: 'Você',
                    texto: message,
                    hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                    telefone: currentConversation.telefone
                };

                if (!currentConversation.mensagens) {
                    currentConversation.mensagens = [];
                }
                currentConversation.mensagens.push(newMessage);
                currentConversation.totalMensagens = currentConversation.mensagens.length;
                
                renderMessages(currentConversation.mensagens);

                input.value = '';
                input.style.height = 'auto';

            } catch (error) {
                console.error('❌ Erro ao enviar mensagem:', error);
                alert('Erro ao enviar mensagem. Tente novamente.');
            } finally {
                button.disabled = false;
                buttonText.style.display = 'inline';
                buttonLoading.style.display = 'none';
            }
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            document.getElementById('searchBox').addEventListener('input', renderConversations);
            
            // Botão de filtro
            const filterButton = document.getElementById('filterButton');
            const filterDropdown = document.getElementById('filterDropdown');
            
            filterButton.addEventListener('click', (e) => {
                e.stopPropagation();
                filterDropdown.classList.toggle('active');
                filterButton.classList.toggle('active');
            });
            
            // Fechar dropdown ao clicar fora
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.filter-dropdown') && !e.target.closest('.filter-button')) {
                    filterDropdown.classList.remove('active');
                }
            });
            
            // Filtros de tag
            document.querySelectorAll('#tagFilterOptions .filter-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('#tagFilterOptions .filter-option').forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    currentFilter = option.dataset.filter;
                    log(`🏷️ Filtro alterado para: ${currentFilter}`);
                    renderConversations();
                    filterButton.classList.add('active');
                });
            });

            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu') && !e.target.closest('.conversation-menu-btn')) {
                    hideContextMenu();
                }
            });

            document.getElementById('viewDetailsMenuItem').addEventListener('click', showDetailsModal);
            document.getElementById('addTagMenuItem').addEventListener('click', showTagsSubmenu);
            document.getElementById('addTagMenuItem').addEventListener('mouseenter', showTagsSubmenu);

            document.querySelectorAll('.tags-submenu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tag = item.dataset.tag;
                    addTag(tag);
                });
            });
        }
    </script>
</body>
</html>
