<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
    <link rel="shortcut icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
    <link rel="apple-touch-icon" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contatos - SalesDever</title>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Raleway', sans-serif;
        }

        body {
            background: #0a0420;
            min-height: 100vh;
            color: #ffffff;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(165, 148, 255, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.06) 0%, transparent 50%);
            animation: backgroundFloat 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(3%, 3%); }
        }

        /* Header */
        header {
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
            background: linear-gradient(135deg, rgba(15, 10, 35, 0.85), rgba(10, 5, 25, 0.9));
            backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 40;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            position: relative;
            z-index: 1;
        }

        .header-content {
            padding: 2rem 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff, #A594FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.875rem;
            margin: 1.5rem 0;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 0.875rem;
            padding: 0.75rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 95px;
            min-width: 0;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(165, 148, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .stat-card:hover {
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.1) 0%, rgba(102, 126, 234, 0.08) 100%);
            border-color: rgba(165, 148, 255, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(165, 148, 255, 0.2);
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        .stat-card.webhooks-card {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3) 0%, rgba(139, 92, 246, 0.2) 100%);
            border: 2px solid rgba(168, 85, 247, 0.6);
            box-shadow: 0 4px 24px rgba(168, 85, 247, 0.3);
            position: relative;
            overflow: visible;
        }

        .stat-card.webhooks-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #A855F7, #8B5CF6, #7C3AED);
            border-radius: 0.875rem 0.875rem 0 0;
        }

        .stat-card.webhooks-card:hover {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.4) 0%, rgba(139, 92, 246, 0.3) 100%);
            border-color: rgba(168, 85, 247, 0.8);
            box-shadow: 0 8px 35px rgba(168, 85, 247, 0.5);
            transform: translateY(-6px);
        }

        .stat-card.webhooks-card .stat-label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 700;
        }

        .stat-card.webhooks-card .stat-icon {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.4), rgba(139, 92, 246, 0.3));
            border-radius: 0.5rem;
            padding: 0.35rem;
        }

        .webhook-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.3rem 0.75rem;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(168, 85, 247, 0.5);
            border-radius: 2rem;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #E9D5FF;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .stat-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stat-icon {
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
            flex-shrink: 0;
        }

        .stat-icon svg {
            width: 100%;
            height: 100%;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #ffffff;
            line-height: 1;
            margin-bottom: 0.8rem;
        }

        .stat-subtext {
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.4);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Filtros */
        .filters-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2.5rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.75rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 0;
        }

        .filter-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .filter-input,
        .filter-select {
            padding: 0.75rem 0.9rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.9rem;
            color: white;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .filter-input {
            width: 100%;
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: #A594FF;
            box-shadow: 0 0 0 4px rgba(165, 148, 255, 0.2);
        }

        .filter-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23A594FF' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 3rem;
            width: 100%;
        }

        .filter-select:hover,
        .filter-input:hover {
            border-color: rgba(165, 148, 255, 0.6);
        }

        .filter-select option {
            background: #0a0420;
            color: #ffffff;
            padding: 1rem;
        }

        /* Calendário Customizado */
        .date-picker-wrapper {
            position: relative;
        }

        .date-display {
            padding: 0.75rem 0.9rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.9rem;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .date-display:hover {
            border-color: rgba(165, 148, 255, 0.6);
        }

        .date-display.active {
            border-color: #A594FF;
            box-shadow: 0 0 0 4px rgba(165, 148, 255, 0.2);
        }

        .calendar-popup {
            display: none;
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            background: linear-gradient(135deg, #1a0e35 0%, #0f0825 100%);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            z-index: 100;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            min-width: 320px;
        }

        .calendar-popup.show {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
        }

        .calendar-month {
            font-size: 1rem;
            font-weight: 700;
            color: #A594FF;
        }

        .calendar-instruction {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: rgba(165, 148, 255, 0.1);
            border-radius: 0.5rem;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(165, 148, 255, 0.2);
            color: #A594FF;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav-btn:hover {
            background: rgba(165, 148, 255, 0.3);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .calendar-weekday {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            padding: 0.5rem 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day:hover:not(.disabled):not(.other-month) {
            background: rgba(165, 148, 255, 0.3);
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #A594FF, #667eea);
            font-weight: 700;
        }

        .calendar-day.in-range {
            background: rgba(165, 148, 255, 0.2);
        }

        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .calendar-day.other-month {
            opacity: 0.2;
        }

        .calendar-day.today {
            border: 2px solid #A594FF;
        }

        .date-range-display {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(165, 148, 255, 0.2);
        }

        .date-range-item {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            text-align: center;
        }

        .date-range-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
        }

        .calendar-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .calendar-btn {
            flex: 1;
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-btn-clear {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendar-btn-clear:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .calendar-btn-apply {
            background: linear-gradient(135deg, #A594FF, #667eea);
            color: white;
            border: none;
        }

        .calendar-btn-apply:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(165, 148, 255, 0.4);
        }

        @media (max-width: 1400px) {
            .filters-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 0.6rem;
            }
        }

        @media (max-width: 1200px) {
            .filters-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 0.5rem;
            }

            .filter-label {
                font-size: 0.75rem;
            }

            .filter-input,
            .filter-select {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 900px) {
            .filters-section {
                padding: 1.5rem;
            }

            .filters-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 0.5rem;
            }

            .filter-label {
                font-size: 0.7rem;
            }

            .filter-input,
            .filter-select {
                padding: 0.65rem 0.85rem;
                font-size: 0.8rem;
            }

            .webhooks-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .btn-new-webhook {
                width: 100%;
                justify-content: center;
            }
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #A594FF, #667eea);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(165, 148, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(165, 148, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(165, 148, 255, 0.5);
        }

        /* Tabela */
        .table-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 1rem;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #ffffff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(165, 148, 255, 0.05);
        }

        th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(165, 148, 255, 0.1);
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background: rgba(165, 148, 255, 0.08);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .badge-inbound {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.15) 100%);
            color: #3B82F6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-outbound {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.25) 0%, rgba(34, 197, 94, 0.15) 100%);
            color: #22C55E;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .badge-success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.25) 0%, rgba(34, 197, 94, 0.15) 100%);
            color: #22C55E;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .badge-failed {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.25) 0%, rgba(239, 68, 68, 0.15) 100%);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Avatar Circle */
        .contact-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #A594FF, #667eea);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
            margin-right: 0.75rem;
            vertical-align: middle;
            border: 2px solid rgba(165, 148, 255, 0.3);
        }

        .contact-name-cell {
            display: flex;
            align-items: center;
        }

        /* Accordion para player de áudio */
        .call-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem;
            border: 1px solid rgba(165, 148, 255, 0.2);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .call-item-header {
            padding: 1.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .call-item-header:hover {
            background: rgba(165, 148, 255, 0.05);
        }

        .call-audio-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            padding: 0 1.5rem;
        }

        .call-audio-content.expanded {
            max-height: 400px;
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        .play-recording-btn {
            color: #A594FF;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .play-recording-btn:hover {
            color: #8B77E8;
            transform: translateX(3px);
        }

        .btn-view {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.2), rgba(165, 148, 255, 0.3));
            border: 1px solid rgba(165, 148, 255, 0.4);
            border-radius: 0.5rem;
            color: #A594FF;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view:hover {
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.3), rgba(165, 148, 255, 0.4));
            transform: scale(1.05);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(180deg, #1a0e35 0%, #0f0825 100%);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 1.5rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff, #A594FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .modal-meta {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
            transform: scale(1.05);
        }

        .btn-end-interaction {
            padding: 0.65rem 1.25rem;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.95));
            border: 1px solid rgba(239, 68, 68, 0.6);
            border-radius: 0.65rem;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
        }

        .btn-end-interaction:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 1), rgba(220, 38, 38, 1));
            border-color: rgba(239, 68, 68, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-end-interaction:active {
            transform: translateY(0);
        }

        .btn-end-interaction:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(165, 148, 255, 0.4);
            border-radius: 3px;
        }

        /* Player de Áudio */
        .audio-section {
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.1) 0%, rgba(102, 126, 234, 0.05) 100%);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .audio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .audio-title {
            font-size: 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }


        .audio-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .play-btn {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #A594FF, #667eea);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            box-shadow: 0 4px 16px rgba(165, 148, 255, 0.3);
        }

        .play-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 24px rgba(165, 148, 255, 0.5);
        }

        .waveform {
            flex: 1;
            height: 80px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 0.75rem;
            display: flex;
            align-items: flex-end;
            padding: 0.5rem;
            gap: 2px;
            cursor: pointer;
            border: 1px solid rgba(165, 148, 255, 0.2);
        }

        .wave-bar {
            flex: 1;
            min-width: 2px;
            background: linear-gradient(180deg, #A594FF, #667eea);
            border-radius: 2px;
            transition: all 0.2s ease;
            opacity: 0.4;
        }

        .wave-bar.active {
            opacity: 1;
            box-shadow: 0 0 8px rgba(165, 148, 255, 0.6);
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.5rem;
        }

        /* Info Sections */
        .info-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .info-title {
            font-size: 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .info-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .info-value {
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
        }

        .transcript-content {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.8;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        /* Loading & Empty */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(165, 148, 255, 0.2);
            border-top-color: #A594FF;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Webhook Modal Styles */
        .webhook-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0 2rem;
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
        }

        .webhook-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .webhook-tab svg {
            opacity: 0.7;
        }

        .webhook-tab.active {
            color: #A594FF;
            border-bottom-color: #A594FF;
        }

        .webhook-tab:hover:not(.active) {
            color: rgba(255, 255, 255, 0.9);
        }

        .webhook-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .webhook-tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Webhook Config */
        .webhook-config-section {
            padding: 1.5rem 0;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-label {
            display: block;
            font-size: 0.95rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.75rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #A594FF;
            box-shadow: 0 0 0 4px rgba(165, 148, 255, 0.2);
        }

        .form-hint {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.5rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(165, 148, 255, 0.2);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-label:hover {
            border-color: rgba(165, 148, 255, 0.4);
            background: rgba(165, 148, 255, 0.05);
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #A594FF;
            cursor: pointer;
        }

        /* Event Cards - novo estilo */
        .event-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .event-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(165, 148, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .event-card:hover {
            border-color: rgba(165, 148, 255, 0.4);
            background: rgba(165, 148, 255, 0.05);
        }

        .event-card.selected {
            border-color: #22C55E;
            background: rgba(34, 197, 94, 0.1);
        }

        .event-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .event-card-icon {
            width: 40px;
            height: 40px;
            background: rgba(165, 148, 255, 0.2);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #A594FF;
        }

        .event-card.selected .event-card-icon {
            background: rgba(34, 197, 94, 0.2);
            color: #22C55E;
        }

        .event-card-check {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(165, 148, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .event-card.selected .event-card-check {
            background: #22C55E;
            border-color: #22C55E;
        }

        .event-card-check svg {
            width: 14px;
            height: 14px;
            stroke: white;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .event-card.selected .event-card-check svg {
            opacity: 1;
        }

        .event-card-title {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .event-card-description {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
        }

        /* Event Type Cards - Escolha principal Ligação/Mensagens */
        .event-type-card {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(165, 148, 255, 0.3);
            border-radius: 1.25rem;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .event-type-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.1) 0%, rgba(102, 126, 234, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .event-type-card:hover {
            border-color: rgba(165, 148, 255, 0.6);
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(165, 148, 255, 0.2);
        }

        .event-type-card:hover::before {
            opacity: 1;
        }

        .event-type-card.selected {
            border-color: #A594FF;
            background: rgba(165, 148, 255, 0.15);
            box-shadow: 0 8px 32px rgba(165, 148, 255, 0.3);
        }

        .event-type-card.selected::before {
            opacity: 1;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.2) 0%, rgba(102, 126, 234, 0.1) 100%);
        }

        .event-type-icon {
            width: 64px;
            height: 64px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-bottom: 1.25rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .event-type-check {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 28px;
            height: 28px;
            border: 2px solid rgba(165, 148, 255, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.3);
        }

        .event-type-card.selected .event-type-check {
            background: #A594FF;
            border-color: #A594FF;
            box-shadow: 0 4px 12px rgba(165, 148, 255, 0.4);
        }

        .event-type-check svg {
            width: 16px;
            height: 16px;
            stroke: white;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .event-type-card.selected .event-type-check svg {
            opacity: 1;
        }

        .event-type-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.75rem;
        }

        .event-type-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .event-type-badge {
            display: inline-block;
            padding: 0.4rem 0.9rem;
            background: rgba(165, 148, 255, 0.2);
            border: 1px solid rgba(165, 148, 255, 0.3);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #A594FF;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-type-card.selected .event-type-badge {
            background: rgba(165, 148, 255, 0.3);
            border-color: #A594FF;
            color: #ffffff;
        }

        /* Webhooks header */
        .webhooks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 2rem;
        }

        .webhooks-header-text {
            flex: 1;
        }

        .webhooks-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
        }

        .webhooks-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            margin: 0;
        }

        .btn-new-webhook {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #A594FF, #667eea);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(165, 148, 255, 0.3);
        }

        .btn-new-webhook:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(165, 148, 255, 0.5);
        }

        .btn-new-webhook svg {
            flex-shrink: 0;
        }

        /* Webhook list styles */
        .webhook-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .webhook-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 1rem;
            padding: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1.25rem;
            transition: all 0.3s ease;
        }

        .webhook-item:hover {
            border-color: rgba(165, 148, 255, 0.4);
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.1), rgba(165, 148, 255, 0.05));
        }

        .webhook-item-info {
            flex: 1;
            min-width: 0;
        }

        .webhook-item-url {
            font-size: 0.95rem;
            font-weight: 600;
            color: #A594FF;
            margin-bottom: 0.5rem;
            word-break: break-all;
            line-height: 1.4;
        }

        .webhook-item-meta {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.25rem;
        }

        .webhook-item-events {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.75rem;
        }

        .webhook-event-badge {
            padding: 0.25rem 0.65rem;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 2rem;
            font-size: 0.7rem;
            font-weight: 600;
            color: #22C55E;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            white-space: nowrap;
        }

        .webhook-event-badge svg {
            flex-shrink: 0;
        }

        .webhook-item-actions {
            display: flex;
            flex-direction: row;
            gap: 0.5rem;
            flex-shrink: 0;
            align-items: center;
        }

        .webhook-action-btn {
            padding: 0.6rem 1rem;
            border: 1px solid rgba(165, 148, 255, 0.3);
            background: rgba(0, 0, 0, 0.3);
            color: #A594FF;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
            min-width: 120px;
        }

        .webhook-action-btn:hover {
            background: rgba(165, 148, 255, 0.2);
            border-color: rgba(165, 148, 255, 0.5);
            transform: translateY(-1px);
        }

        .webhook-action-btn.edit {
            background: rgba(30, 27, 75, 0.6);
            color: rgba(165, 148, 255, 0.9);
            border: 1px solid rgba(165, 148, 255, 0.25);
        }

        .webhook-action-btn.edit:hover {
            background: rgba(40, 37, 85, 0.7);
            border-color: rgba(165, 148, 255, 0.4);
            transform: translateY(-1px);
        }

        .webhook-action-btn.delete {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .webhook-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            transform: translateY(-1px);
        }

        .webhook-action-btn.test {
            background: rgba(34, 197, 94, 0.1);
            color: #22C55E;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .webhook-action-btn.test:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
            transform: translateY(-1px);
        }

        .webhook-action-btn.test:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .webhook-action-btn.test:disabled:hover {
            transform: none;
        }

        @media (max-width: 768px) {
            .webhook-item {
                flex-direction: column;
                align-items: stretch;
            }

            .webhook-item-actions {
                width: 100%;
            }

            .webhook-action-btn {
                flex: 1;
                justify-content: center;
            }
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-test-webhook,
        .btn-save-webhook {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-test-webhook {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(165, 148, 255, 0.3);
        }

        .btn-test-webhook:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(165, 148, 255, 0.5);
        }

        .btn-save-webhook {
            background: linear-gradient(135deg, #A594FF, #667eea);
            color: white;
            box-shadow: 0 4px 20px rgba(165, 148, 255, 0.4);
        }

        .btn-save-webhook:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(165, 148, 255, 0.6);
        }

        /* Webhook Logs */
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(165, 148, 255, 0.2);
        }

        .logs-stats {
            display: flex;
            gap: 2rem;
        }

        .log-stat {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .log-stat-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .log-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ffffff;
        }

        .log-stat.success .log-stat-value {
            color: #22C55E;
        }

        .log-stat.failed .log-stat-value {
            color: #EF4444;
        }

        .btn-refresh {
            padding: 0.75rem 1.25rem;
            background: rgba(30, 27, 75, 0.6);
            border: 1px solid rgba(165, 148, 255, 0.25);
            border-radius: 0.5rem;
            color: rgba(165, 148, 255, 0.9);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-refresh:hover {
            background: rgba(40, 37, 85, 0.7);
            border-color: rgba(165, 148, 255, 0.4);
            transform: translateY(-1px);
        }

        .btn-refresh.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-refresh.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .logs-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
        }

        /* Webhook Stats */
        .stats-grid-webhook {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card-webhook {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-card-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.3), rgba(165, 148, 255, 0.15));
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #A594FF;
        }

        .stat-card-content {
            flex: 1;
        }

        .stat-card-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
        }

        .stat-card-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #ffffff;
        }

        .chart-section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 1rem;
            padding: 2rem;
        }

        /* Responsivo */
        @media (max-width: 1200px) {
            .stats-grid {
                gap: 0.75rem;
            }

            .stat-card {
                padding: 0.65rem;
                min-height: 90px;
            }

            .stat-value {
                font-size: 2rem;
            }
        }

        @media (max-width: 900px) {
            .filters-section {
                flex-wrap: wrap;
            }

            .stats-grid {
                gap: 0.625rem;
            }

            .stat-card {
                padding: 0.6rem;
                min-height: 85px;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .stat-label {
                font-size: 0.6rem;
            }

            .stat-subtext {
                font-size: 0.55rem;
            }
        }

        @media (max-width: 768px) {
            .hide-mobile {
                display: none !important;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            .stats-grid {
                gap: 0.5rem;
            }

            .modal-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .modal-header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .btn-end-interaction {
                flex: 1;
                justify-content: center;
                font-size: 0.8rem;
                padding: 0.6rem 1rem;
            }

            .stat-card {
                padding: 0.5rem;
                min-height: 80px;
            }

            .stat-value {
                font-size: 1.6rem;
            }

            .stat-icon {
                width: 1.25rem;
                height: 1.25rem;
            }
        }

        /* ==================== POPUP CUSTOMIZADO ==================== */
        .custom-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 4, 32, 0.8);
            backdrop-filter: blur(8px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease;
        }

        .custom-popup-overlay.active {
            display: flex;
        }

        .custom-popup {
            background: linear-gradient(135deg, #1a1535 0%, #0f0a2e 100%);
            border: 1px solid rgba(165, 148, 255, 0.2);
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 420px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: popupSlideIn 0.3s ease;
        }

        @keyframes popupSlideIn {
            from {
                transform: translateY(-20px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .custom-popup-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }

        .custom-popup-icon.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            border: 2px solid rgba(16, 185, 129, 0.4);
        }

        .custom-popup-icon.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border: 2px solid rgba(239, 68, 68, 0.4);
        }

        .custom-popup-icon.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1));
            border: 2px solid rgba(245, 158, 11, 0.4);
        }

        .custom-popup-icon.info {
            background: linear-gradient(135deg, rgba(165, 148, 255, 0.2), rgba(139, 92, 246, 0.1));
            border: 2px solid rgba(165, 148, 255, 0.4);
        }

        .custom-popup-icon svg {
            width: 40px;
            height: 40px;
        }

        .custom-popup-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.75rem;
        }

        .custom-popup-message {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            margin-bottom: 2rem;
            white-space: pre-line;
        }

        .custom-popup-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            border: none;
            border-radius: 10px;
            padding: 0.875rem 2.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .custom-popup-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .custom-popup-btn:active {
            transform: translateY(0);
        }

        #popupBtnContainer {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .custom-popup-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .custom-popup-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            box-shadow: none;
        }

        .custom-popup-btn.danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.95));
            border: 1px solid rgba(239, 68, 68, 0.6);
            color: white;
        }

        .custom-popup-btn.danger:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 1), rgba(220, 38, 38, 1));
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
        }
    </style>
</head>
<body>

<!-- Header -->
<header>
    <div class="container">
        <div class="header-content">
            <h1 class="page-title">Gerenciamento de Contatos e Webhooks</h1>
        </div>
    </div>
</header>

<main class="container" style="padding: 1rem 1.5rem 2rem 1.5rem;">

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Total de Contatos</span>
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-subtext">Todos os períodos</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Inbound</span>
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        <polyline points="15 9 20 4 15 4 15 9"></polyline>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="statInbound">0</div>
            <div class="stat-subtext">Chamadas recebidas</div>
        </div>

        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-label">Outbound</span>
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        <polyline points="15 4 20 9 15 9 15 4"></polyline>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="statOutbound">0</div>
            <div class="stat-subtext">Chamadas realizadas</div>
        </div>

        <div class="stat-card webhooks-card clickable" onclick="openWebhooksManager()">
            <div class="stat-header">
                <span class="stat-label">Configurações de Webhook</span>
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <circle cx="12" cy="15" r="3"></circle>
                        <path d="M12 12v1m0 4v1m3-3h-1m-4 0H9"></path>
                    </svg>
                </div>
            </div>
            <div class="stat-value" id="statWebhooks">0</div>
            <div class="webhook-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"></path>
                </svg>
                Ver Configurações
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
        <div class="filters-grid">
            <div class="filter-group">
                <label class="filter-label">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Buscar
                </label>
                <input type="text" class="filter-input" id="filterSearch" placeholder="Nome, Assistente..." oninput="applyFilters()">
            </div>

            <div class="filter-group">
                <label class="filter-label">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>
                    Tipo
                </label>
                <select class="filter-select" id="filterType" onchange="applyFilters()">
                    <option value="all">Todas</option>
                    <option value="inbound">Entrada</option>
                    <option value="outbound">Saída</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Período
                </label>
                <div class="date-picker-wrapper">
                    <div class="date-display" id="dateDisplay" onclick="toggleCalendar()">
                        <span id="dateDisplayText">Selecione</span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="calendar-popup" id="calendarPopup">
                        <div class="calendar-instruction" id="calendarInstruction">
                            Selecione a data inicial e depois a data final do período
                        </div>
                        <div class="calendar-header">
                            <div class="calendar-month" id="calendarMonth">Janeiro 2025</div>
                            <div class="calendar-nav">
                                <button class="calendar-nav-btn" onclick="changeMonth(-1)">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="15 18 9 12 15 6"></polyline>
                                    </svg>
                                </button>
                                <button class="calendar-nav-btn" onclick="changeMonth(1)">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="calendar-weekdays">
                            <div class="calendar-weekday">Dom</div>
                            <div class="calendar-weekday">Seg</div>
                            <div class="calendar-weekday">Ter</div>
                            <div class="calendar-weekday">Qua</div>
                            <div class="calendar-weekday">Qui</div>
                            <div class="calendar-weekday">Sex</div>
                            <div class="calendar-weekday">Sáb</div>
                        </div>
                        <div class="calendar-days" id="calendarDays"></div>
                        <div class="date-range-display">
                            <div class="date-range-item">
                                <div class="date-range-label">Início</div>
                                <div id="rangeStartDisplay">-</div>
                            </div>
                            <div class="date-range-item">
                                <div class="date-range-label">Fim</div>
                                <div id="rangeEndDisplay">-</div>
                            </div>
                        </div>
                        <div class="calendar-actions">
                            <button class="calendar-btn calendar-btn-clear" onclick="clearDateRange()">Limpar</button>
                            <button class="calendar-btn calendar-btn-apply" onclick="applyDateRange()">Aplicar</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Status
                </label>
                <select class="filter-select" id="filterSuccess" onchange="applyFilters()">
                    <option value="all">Todos</option>
                    <option value="true">Sucesso</option>
                    <option value="false">Falha</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Webhook
                </label>
                <select class="filter-select" id="filterWebhook" onchange="applyFilters()">
                    <option value="all">Todos</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Campanha
                </label>
                <select class="filter-select" id="filterCampaign" onchange="applyFilters()">
                    <option value="all">Todas</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Tabela -->
    <div class="table-container">
        <div class="table-header">
            <h2 class="table-title">Lista de Contatos</h2>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>Tipo</th>
                    <th>Status</th>
                    <th style="text-align: right;">Ações</th>
                </tr>
            </thead>
            <tbody id="contactsTableBody">
                <tr>
                    <td colspan="5" class="loading">
                        <div class="spinner"></div>
                        <p style="color: rgba(255, 255, 255, 0.6);">Carregando contatos...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</main>

<!-- Modal: Contact Details -->
<div id="modalContactDetail" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h3 class="modal-title" id="modalContactName">Detalhes do Contato</h3>
                <div class="modal-meta">
                    <span id="modalContactPhone">-</span>
                    <span id="modalContactDate">-</span>
                </div>
            </div>
            <div class="modal-header-actions">
                <button class="btn-end-interaction" onclick="endInteraction()" id="btnEndInteraction">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    Encerrar Interação
                </button>
                <button class="close-btn" onclick="closeModal('modalContactDetail')">×</button>
            </div>
        </div>
        <div class="modal-body" id="contactDetailContent"></div>
    </div>
</div>

<!-- Modal: Webhooks Manager -->
<div id="modalWebhooks" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <div>
                <h3 class="modal-title">Gerenciamento de Webhooks</h3>
                <p style="color: rgba(255, 255, 255, 0.6); margin-top: 0.5rem;">Configure webhooks para receber notificações automáticas</p>
            </div>
            <button class="close-btn" onclick="closeModal('modalWebhooks')">×</button>
        </div>

        <!-- Tabs -->
        <div class="webhook-tabs">
            <button class="webhook-tab active" onclick="switchWebhookTab('webhooks')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                Meus Webhooks
            </button>
            <button class="webhook-tab" onclick="switchWebhookTab('config')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Configuração
            </button>
            <button class="webhook-tab" onclick="switchWebhookTab('logs')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Logs
            </button>
        </div>

        <div class="modal-body">
            <!-- Tab: Meus Webhooks -->
            <div id="webhookTabWebhooks" class="webhook-tab-content active">
                <div class="webhooks-header">
                    <div class="webhooks-header-text">
                        <h3 class="webhooks-title">Webhooks Configurados</h3>
                        <p class="webhooks-subtitle">Gerencie seus webhooks ativos</p>
                    </div>
                    <button class="btn-new-webhook" onclick="switchWebhookTab('config')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Novo Webhook
                    </button>
                </div>

                <div class="webhook-list" id="webhooksList">
                    <div class="empty-state" style="padding: 3rem 2rem;">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="rgba(165, 148, 255, 0.3)" stroke-width="1.5" style="margin-bottom: 1.5rem;">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                            <line x1="12" y1="22.08" x2="12" y2="12"></line>
                        </svg>
                        <h3 style="color: rgba(255, 255, 255, 0.8); font-size: 1.1rem; margin-bottom: 0.5rem;">Nenhum webhook configurado</h3>
                        <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.9rem;">Clique em "Novo Webhook" para criar sua primeira integração</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Configuração -->
            <div id="webhookTabConfig" class="webhook-tab-content">
                <div class="webhook-config-section">
                    <div class="form-group">
                        <label class="form-label">Nome do Webhook</label>
                        <input type="text" id="webhookName" class="form-input" placeholder="Ex: Notificação de vendas, Integração CRM, etc.">
                        <p class="form-hint">Nome para identificar facilmente este webhook</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">URL do Webhook</label>
                        <input type="url" id="webhookUrl" class="form-input" placeholder="https://seu-dominio.com/webhook">
                        <p class="form-hint">Endpoint que receberá as notificações em tempo real</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Assistente</label>
                        <select id="webhookAssistant" class="filter-select" style="width: 100%;">
                            <option value="">Carregando assistentes...</option>
                        </select>
                        <p class="form-hint">Selecione o assistente para este webhook</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tipo de Evento</label>
                        <p class="form-hint" style="margin-bottom: 1rem;">Escolha se deseja receber eventos de ligações ou mensagens</p>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <!-- Card Ligação -->
                            <div class="event-type-card" id="eventTypeCall" onclick="selectEventType('call')">
                                <div class="event-type-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                    </svg>
                                </div>
                                <div class="event-type-check">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                                <h4 class="event-type-title">Ligação</h4>
                                <p class="event-type-description">Receba notificações sobre eventos de ligações telefônicas</p>
                                <div class="event-type-badge">3 tipos de eventos</div>
                            </div>

                            <!-- Card Mensagens -->
                            <div class="event-type-card" id="eventTypeMessage" onclick="selectEventType('message')">
                                <div class="event-type-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                </div>
                                <div class="event-type-check">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                                <h4 class="event-type-title">Mensagens</h4>
                                <p class="event-type-description">Receba notificações quando mensagens forem recebidas</p>
                                <div class="event-type-badge">Evento único</div>
                            </div>
                        </div>

                        <input type="hidden" id="webhookEventTypeModal" value="">
                    </div>

                    <!-- Opções de Ligação (oculto inicialmente) -->
                    <div class="form-group" id="callEventOptionsModal" style="display: none; opacity: 0; transform: translateY(-10px); transition: opacity 0.3s ease, transform 0.3s ease;">
                        <label class="form-label">Evento de Ligação (selecione apenas um)</label>
                        <div class="event-cards">
                            <div class="event-card" id="eventSuccess" onclick="toggleEventCard('eventSuccess')">
                                <div class="event-card-header">
                                    <div class="event-card-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </div>
                                    <div class="event-card-check">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                </div>
                                <div class="event-card-title">Ligação com sucesso</div>
                                <div class="event-card-description">Notifica quando uma ligação é completada com sucesso</div>
                            </div>

                            <div class="event-card" id="eventFailed" onclick="toggleEventCard('eventFailed')">
                                <div class="event-card-header">
                                    <div class="event-card-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="15" y1="9" x2="9" y2="15"></line>
                                            <line x1="9" y1="9" x2="15" y2="15"></line>
                                        </svg>
                                    </div>
                                    <div class="event-card-check">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                </div>
                                <div class="event-card-title">Ligação sem sucesso</div>
                                <div class="event-card-description">Notifica quando uma ligação falha ou não é atendida</div>
                            </div>

                            <div class="event-card" id="eventEnded" onclick="toggleEventCard('eventEnded')">
                                <div class="event-card-header">
                                    <div class="event-card-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                            <line x1="2" y1="2" x2="22" y2="22"></line>
                                        </svg>
                                    </div>
                                    <div class="event-card-check">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                </div>
                                <div class="event-card-title">Ligação finalizada</div>
                                <div class="event-card-description">Notifica em qualquer finalização (inclui sucesso E falha)</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-save-webhook" onclick="saveWebhookConfig()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            Criar Webhook
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab: Logs -->
            <div id="webhookTabLogs" class="webhook-tab-content">
                <div class="logs-header">
                    <div class="logs-stats">
                        <div class="log-stat">
                            <span class="log-stat-label">Total Enviados</span>
                            <span class="log-stat-value" id="logsTotalSent">0</span>
                        </div>
                        <div class="log-stat success">
                            <span class="log-stat-label">Sucesso</span>
                            <span class="log-stat-value" id="logsSuccess">0</span>
                        </div>
                        <div class="log-stat failed">
                            <span class="log-stat-label">Falhas</span>
                            <span class="log-stat-value" id="logsFailed">0</span>
                        </div>
                    </div>
                    <button class="btn-refresh" onclick="refreshWebhookLogs()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                        </svg>
                        Atualizar
                    </button>
                </div>

                <div class="logs-container" id="webhookLogsContainer">
                    <div class="empty-state">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">📋</div>
                        <p style="color: rgba(255, 255, 255, 0.6);">Nenhum log de webhook disponível</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Popup Customizado -->
<div id="customPopup" class="custom-popup-overlay">
    <div class="custom-popup">
        <div class="custom-popup-icon" id="popupIcon">
            <!-- Ícone será inserido dinamicamente -->
        </div>
        <h3 class="custom-popup-title" id="popupTitle">Título</h3>
        <p class="custom-popup-message" id="popupMessage">Mensagem</p>
        <div id="popupBtnContainer">
            <button class="custom-popup-btn" id="popupBtn" onclick="closeCustomPopup()">OK</button>
        </div>
    </div>
</div>

<!-- Modal de Edição de Webhook -->
<div id="editWebhookModal" class="custom-popup-overlay">
    <div class="custom-popup" style="max-width: 600px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="font-size: 1.5rem; font-weight: 700; color: #ffffff; margin: 0;">Editar Webhook</h3>
            <button onclick="closeEditModal()" style="background: none; border: none; color: rgba(255, 255, 255, 0.6); cursor: pointer; font-size: 1.5rem; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">×</button>
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label class="form-label">Nome do Webhook</label>
            <input type="text" id="editWebhookName" class="form-input" placeholder="Nome do webhook">
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label class="form-label">URL do Webhook</label>
            <input type="url" id="editWebhookUrl" class="form-input" placeholder="https://...">
        </div>

        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label class="form-label">Assistente</label>
            <select id="editWebhookAssistant" class="filter-select" style="width: 100%;">
                <option value="">Carregando...</option>
            </select>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
            <button class="custom-popup-btn secondary" onclick="closeEditModal()">Cancelar</button>
            <button class="custom-popup-btn" onclick="saveEditWebhook()">Salvar</button>
        </div>
    </div>
</div>

<script>
    // ==================== CONFIGURAÇÃO ====================
    const API_BASE = 'https://sdr.salesdever.io/webhook';
    let currentAudio = null;
    let audioInterval = null;

    // Estado da aplicação
    let state = {
        contacts: [],
        groupedContacts: [], // Contatos agrupados por número
        filteredContacts: [],
        webhooks: [], // Webhooks carregados
        campaigns: [], // Campanhas carregadas
        filters: {
            search: '',
            type: 'all',
            success: 'all',
            dateStart: null,
            dateEnd: null,
            webhook: 'all',
            campaign: 'all'
        },
        calendar: {
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedStart: null,
            selectedEnd: null,
            isOpen: false
        }
    };

    // ==================== FUNÇÕES UTILITÁRIAS ====================
    function getTenantId() {
        const tenantId = localStorage.getItem('tenant_id');
        if (!tenantId) {
            console.warn('⚠️ tenant_id não encontrado no localStorage');
        }
        return tenantId;
    }

    function formatPhone(phone) {
        if (!phone) return '-';
        const cleaned = phone.replace(/\D/g, '');
        if (cleaned.startsWith('55') && cleaned.length === 13) {
            return `+55 (${cleaned.slice(2, 4)}) ${cleaned.slice(4, 9)}-${cleaned.slice(9)}`;
        }
        return phone;
    }

    function formatDuration(seconds) {
        if (!seconds) return '0s';
        const totalSeconds = Math.floor(seconds);
        const minutes = Math.floor(totalSeconds / 60);
        const secs = totalSeconds % 60;
        return minutes > 0 ? `${minutes}min ${secs}s` : `${secs}s`;
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function formatDate(date, includeTime = false) {
        if (!date) return '-';

        // Handle timestamp (number) or date string
        let d;
        if (typeof date === 'number') {
            // If it's a timestamp in seconds (10 digits), convert to milliseconds
            d = date.toString().length === 10 ? new Date(date * 1000) : new Date(date);
        } else {
            d = new Date(date);
        }

        // Check if date is valid
        if (isNaN(d.getTime())) {
            console.warn('Invalid date:', date);
            return '-';
        }

        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();

        if (includeTime) {
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }
        return `${day}/${month}/${year}`;
    }

    function sanitize(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    function getInitials(name) {
        if (!name) return '?';
        const parts = name.trim().split(' ');
        if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
        return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    function normalizePhone(phone) {
        if (!phone) return '';
        return phone.replace(/\D/g, '');
    }

    // ==================== CALENDÁRIO CUSTOMIZADO ====================
    function toggleCalendar() {
        const popup = document.getElementById('calendarPopup');
        const display = document.getElementById('dateDisplay');

        state.calendar.isOpen = !state.calendar.isOpen;

        if (state.calendar.isOpen) {
            popup.classList.add('show');
            display.classList.add('active');

            // Resetar instrução ao abrir
            if (state.calendar.selectedEnd) {
                updateCalendarInstruction('✓ Período selecionado! Clique em APLICAR para filtrar');
            } else if (state.calendar.selectedStart) {
                updateCalendarInstruction('Agora selecione a data final do período');
            } else {
                updateCalendarInstruction('Selecione a data inicial e depois a data final do período');
            }

            renderCalendar();
        } else {
            popup.classList.remove('show');
            display.classList.remove('active');
        }
    }

    function renderCalendar() {
        const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

        const { currentMonth, currentYear, selectedStart, selectedEnd } = state.calendar;

        document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const prevLastDay = new Date(currentYear, currentMonth, 0);

        const firstDayIndex = firstDay.getDay();
        const lastDateIndex = lastDay.getDate();
        const prevLastDate = prevLastDay.getDate();

        const daysContainer = document.getElementById('calendarDays');
        daysContainer.innerHTML = '';

        // Dias do mês anterior
        for (let i = firstDayIndex; i > 0; i--) {
            const day = prevLastDate - i + 1;
            const btn = createDayButton(day, true, currentYear, currentMonth - 1);
            daysContainer.appendChild(btn);
        }

        // Dias do mês atual
        for (let day = 1; day <= lastDateIndex; day++) {
            const btn = createDayButton(day, false, currentYear, currentMonth);
            daysContainer.appendChild(btn);
        }

        // Dias do próximo mês
        const totalCells = daysContainer.children.length;
        const remainingCells = 42 - totalCells; // 6 semanas * 7 dias
        for (let day = 1; day <= remainingCells; day++) {
            const btn = createDayButton(day, true, currentYear, currentMonth + 1);
            daysContainer.appendChild(btn);
        }

        updateRangeDisplay();
    }

    function createDayButton(day, isOtherMonth, year, month) {
        const btn = document.createElement('button');
        btn.className = 'calendar-day';
        btn.textContent = day;

        if (isOtherMonth) {
            btn.classList.add('other-month');
        }

        const date = new Date(year, month, day);
        date.setHours(0, 0, 0, 0);

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (!isOtherMonth && date.getTime() === today.getTime()) {
            btn.classList.add('today');
        }

        // Verificar se está selecionado
        const { selectedStart, selectedEnd } = state.calendar;

        if (selectedStart) {
            const startTime = selectedStart.getTime();
            const dateTime = date.getTime();

            if (dateTime === startTime) {
                btn.classList.add('selected');
            }

            if (selectedEnd) {
                const endTime = selectedEnd.getTime();

                if (dateTime === endTime && startTime !== endTime) {
                    btn.classList.add('selected');
                }

                // Verificar se está no range (entre início e fim)
                if (dateTime > startTime && dateTime < endTime) {
                    btn.classList.add('in-range');
                }
            }
        }

        btn.onclick = () => selectDate(new Date(year, month, day));

        return btn;
    }

    function selectDate(date) {
        const { selectedStart, selectedEnd } = state.calendar;

        // Normalizar data para meia-noite
        date.setHours(0, 0, 0, 0);

        if (!selectedStart || (selectedStart && selectedEnd)) {
            // Primeira seleção ou resetar seleção (se já tinha as duas selecionadas)
            state.calendar.selectedStart = new Date(date);
            state.calendar.selectedEnd = null;
            console.log('📅 Data INICIAL selecionada:', formatDate(date));
            console.log('💡 Agora selecione a data FINAL do período');

            // Atualizar instrução
            updateCalendarInstruction('Agora selecione a data final do período');
        } else {
            // Segunda seleção
            if (date.getTime() < selectedStart.getTime()) {
                // Data selecionada é anterior à inicial, inverter
                state.calendar.selectedEnd = new Date(selectedStart);
                state.calendar.selectedStart = new Date(date);
                console.log('📅 Período selecionado (invertido) - Início:', formatDate(date), 'Fim:', formatDate(selectedStart));
                console.log('✅ Período completo! Clique em APLICAR para filtrar');
            } else if (date.getTime() === selectedStart.getTime()) {
                // Mesma data, apenas um dia
                state.calendar.selectedEnd = new Date(date);
                console.log('📅 Mesmo dia selecionado:', formatDate(date));
                console.log('✅ Período completo! Clique em APLICAR para filtrar');
            } else {
                // Data posterior, range normal
                state.calendar.selectedEnd = new Date(date);
                console.log('📅 Período selecionado - Início:', formatDate(selectedStart), 'Fim:', formatDate(date));
                console.log('✅ Período completo! Clique em APLICAR para filtrar');
            }

            // Atualizar instrução
            updateCalendarInstruction('✓ Período selecionado! Clique em APLICAR para filtrar');
        }

        // Apenas re-renderizar o calendário, NÃO fechar
        renderCalendar();
    }

    function updateCalendarInstruction(text) {
        const instruction = document.getElementById('calendarInstruction');
        if (instruction) {
            instruction.textContent = text;
            instruction.style.background = state.calendar.selectedEnd
                ? 'rgba(34, 197, 94, 0.2)'
                : 'rgba(165, 148, 255, 0.1)';
            instruction.style.color = state.calendar.selectedEnd
                ? '#22C55E'
                : 'rgba(255, 255, 255, 0.6)';
        }
    }

    function changeMonth(delta) {
        state.calendar.currentMonth += delta;

        if (state.calendar.currentMonth > 11) {
            state.calendar.currentMonth = 0;
            state.calendar.currentYear++;
        } else if (state.calendar.currentMonth < 0) {
            state.calendar.currentMonth = 11;
            state.calendar.currentYear--;
        }

        renderCalendar();
    }

    function updateRangeDisplay() {
        const { selectedStart, selectedEnd } = state.calendar;

        document.getElementById('rangeStartDisplay').textContent =
            selectedStart ? formatDate(selectedStart) : '-';
        document.getElementById('rangeEndDisplay').textContent =
            selectedEnd ? formatDate(selectedEnd) : '-';
    }

    function clearDateRange() {
        state.calendar.selectedStart = null;
        state.calendar.selectedEnd = null;
        state.filters.dateStart = null;
        state.filters.dateEnd = null;
        document.getElementById('dateDisplayText').textContent = 'Selecione o período';
        updateCalendarInstruction('Selecione a data inicial e depois a data final do período');
        renderCalendar();
        toggleCalendar(); // Fechar após limpar
        applyFilters(); // Aplicar filtros sem data
    }

    function applyDateRange() {
        const { selectedStart, selectedEnd } = state.calendar;

        // Validar se selecionou pelo menos a data inicial
        if (!selectedStart) {
            showPopup('warning', 'Seleção incompleta', 'Por favor, selecione pelo menos a data inicial do período');
            return;
        }

        // Se não selecionou a data final, usar a mesma data inicial
        const finalEndDate = selectedEnd || selectedStart;

        state.filters.dateStart = selectedStart;
        state.filters.dateEnd = finalEndDate;

        // Atualizar o texto exibido
        const text = selectedEnd && selectedStart.getTime() !== selectedEnd.getTime()
            ? `${formatDate(selectedStart)} - ${formatDate(selectedEnd)}`
            : formatDate(selectedStart);

        document.getElementById('dateDisplayText').textContent = text;

        console.log('📅 Período aplicado:', {
            inicio: formatDate(selectedStart),
            fim: formatDate(finalEndDate)
        });

        // Fechar calendário e aplicar filtros
        toggleCalendar();
        applyFilters();
    }

    // Removido: Não fechar calendário ao clicar fora
    // O usuário deve clicar em "Aplicar" ou "Limpar" para fechar

    // ==================== AGRUPAMENTO POR NÚMERO ====================
    function groupContactsByPhone(contacts) {
        const grouped = {};

        contacts.forEach(contact => {
            const phone = normalizePhone(contact.client_phone || contact.phone_number || contact.phone);

            if (!phone) return;

            if (!grouped[phone]) {
                grouped[phone] = {
                    phone: phone,
                    calls: [],
                    totalCalls: 0,
                    successCalls: 0,
                    failedCalls: 0,
                    totalDuration: 0,
                    lastCall: null,
                    name: contact.assistant_name || contact.lead_name || contact.name || 'Contato'
                };
            }

            grouped[phone].calls.push(contact);
            grouped[phone].totalCalls++;

            if (contact.success_evaluation === true) {
                grouped[phone].successCalls++;
            } else {
                grouped[phone].failedCalls++;
            }

            grouped[phone].totalDuration += (contact.duration_seconds || contact.duration || 0);

            const timestamp = contact.started_at || contact.created_at || contact.date;
            let callDate;
            if (typeof timestamp === 'number') {
                // If it's a timestamp in seconds (10 digits), convert to milliseconds
                callDate = timestamp.toString().length === 10 ? new Date(timestamp * 1000) : new Date(timestamp);
            } else {
                callDate = new Date(timestamp);
            }

            if (!grouped[phone].lastCall || callDate > new Date(grouped[phone].lastCall)) {
                grouped[phone].lastCall = callDate;
                grouped[phone].name = contact.assistant_name || contact.lead_name || contact.name || grouped[phone].name;
            }
        });

        // Converter objeto em array e ordenar por data da última chamada
        return Object.values(grouped).sort((a, b) => {
            return new Date(b.lastCall) - new Date(a.lastCall);
        });
    }

    // ==================== API CALLS ====================
    async function fetchContacts() {
        try {
            const tenantId = getTenantId();
            console.log('🔍 Buscando contatos com tenant_id:', tenantId);

            const response = await fetch(`${API_BASE}/procura_contatos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tenant_id: tenantId })
            });

            console.log('📡 Response status:', response.status);

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const data = await response.json();
            console.log('📦 Dados recebidos:', data);
            console.log('📊 Total de registros:', Array.isArray(data) ? data.length : 'Não é array');

            return data;
        } catch (error) {
            console.error('❌ Erro ao buscar contatos:', error);
            return null;
        }
    }

    // ==================== CARREGAR WEBHOOKS E CAMPANHAS PARA FILTROS ====================
    async function loadWebhooksForFilter() {
        try {
            const tenantId = getTenantId();
            console.log('🔄 Carregando webhooks para filtro...');

            const response = await fetch(`${API_BASE}/procura_webhooks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tenant_id: tenantId })
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const data = await response.json();
            console.log('📦 Webhooks recebidos:', data);

            // Extrair webhooks do formato de resposta
            let webhooks = [];
            if (Array.isArray(data)) {
                webhooks = data;
            } else if (data.webhooks && Array.isArray(data.webhooks)) {
                webhooks = data.webhooks;
            } else if (data.data && Array.isArray(data.data)) {
                webhooks = data.data;
            }

            state.webhooks = webhooks;

            // Popular dropdown
            const selectWebhook = document.getElementById('filterWebhook');
            selectWebhook.innerHTML = '<option value="all">Todos</option>';

            webhooks.forEach(webhook => {
                const webhookPath = webhook.webhook_path || webhook.path;
                const webhookName = webhook.webhook_name || webhook.name || `Webhook ${webhookPath}`;

                // Criar option com o webhook_path como value e o webhook_name como texto
                if (webhookPath) {
                    const option = document.createElement('option');
                    option.value = webhookPath;
                    option.textContent = webhookName;
                    selectWebhook.appendChild(option);
                }
            });

            console.log('✅ Webhooks carregados para filtro:', webhooks.length);
        } catch (error) {
            console.error('❌ Erro ao carregar webhooks para filtro:', error);
        }
    }

    async function loadCampaignsForFilter() {
        try {
            const tenantId = getTenantId();
            console.log('🔄 Carregando campanhas para filtro...');

            const response = await fetch(`${API_BASE}/procura_campanhas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tenant_id: tenantId })
            });

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const data = await response.json();
            console.log('📦 Campanhas recebidas:', data);

            // Extrair campanhas do formato de resposta
            let campaigns = [];
            if (Array.isArray(data)) {
                campaigns = data;
            } else if (data.campaigns && Array.isArray(data.campaigns)) {
                campaigns = data.campaigns;
            } else if (data.data && Array.isArray(data.data)) {
                campaigns = data.data;
            }

            state.campaigns = campaigns;

            // Popular dropdown
            const selectCampaign = document.getElementById('filterCampaign');
            selectCampaign.innerHTML = '<option value="all">Todas</option>';

            campaigns.forEach(campaign => {
                const campaignId = campaign._id || campaign.id || campaign.campaign_id;
                const campaignName = campaign.name || campaign.nome_campanha || campaign.campaign_name || `Campanha ${campaignId}`;

                // Criar option com o código como value e o nome como texto
                const option = document.createElement('option');
                option.value = campaignId;
                option.textContent = campaignName;
                selectCampaign.appendChild(option);
            });

            console.log('✅ Campanhas carregadas para filtro:', campaigns.length);
        } catch (error) {
            console.error('❌ Erro ao carregar campanhas para filtro:', error);
        }
    }

    // ==================== INICIALIZAÇÃO ====================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('🚀 Iniciando aplicação...');
        console.log('🔑 tenant_id:', localStorage.getItem('tenant_id'));
        console.log('📍 API Base:', API_BASE);

        if (!localStorage.getItem('tenant_id')) {
            console.warn('⚠️ ATENÇÃO: tenant_id não encontrado no localStorage!');
        }

        await loadData();
        await loadWebhooks(); // Carregar webhooks ao iniciar a página
        await loadWebhooksForFilter(); // Carregar webhooks para os filtros
        await loadCampaignsForFilter(); // Carregar campanhas para os filtros
        console.log('✅ Webhooks e campanhas carregados na inicialização');
    });

    async function loadData() {
        const data = await fetchContacts();

        if (!data) {
            console.error('❌ Nenhum dado retornado');
            state.contacts = [];
            state.filteredContacts = [];
            renderContactsTable();
            return;
        }

        console.log('🔧 Processando dados...');

        // Detectar formato da resposta
        if (Array.isArray(data)) {
            console.log('✅ Formato: Array direto');
            state.contacts = data;
        } else if (data.contacts && Array.isArray(data.contacts)) {
            console.log('✅ Formato: Objeto com propriedade contacts');
            state.contacts = data.contacts;
        } else if (typeof data === 'object' && !Array.isArray(data)) {
            console.log('✅ Formato: Objeto único, convertendo para array');
            state.contacts = [data];
        } else {
            console.error('❌ Formato não reconhecido:', typeof data);
            state.contacts = [];
        }

        // Normalizar call_type
        state.contacts = state.contacts.map(contact => {
            let normalizedType = contact.call_type || null;

            // Converter "outboundPhoneCall" -> "outbound" e "inboundPhoneCall" -> "inbound"
            if (normalizedType === 'outboundPhoneCall') {
                normalizedType = 'outbound';
            } else if (normalizedType === 'inboundPhoneCall') {
                normalizedType = 'inbound';
            }

            return {
                ...contact,
                call_type: normalizedType
            };
        });

        console.log('✅ Total de contatos carregados:', state.contacts.length);

        // Agrupar contatos por número de telefone
        state.groupedContacts = groupContactsByPhone(state.contacts);
        state.filteredContacts = state.groupedContacts;

        console.log('📞 Contatos agrupados por número:', state.groupedContacts.length);

        // Calcular estatísticas usando os campos corretos do webhook
        // IMPORTANTE: Só contar chamadas que têm call_type definido
        const total = state.contacts.length;
        const uniqueContacts = state.groupedContacts.length;
        const inbound = state.contacts.filter(c => c.call_type === 'inbound').length;
        const outbound = state.contacts.filter(c => c.call_type === 'outbound').length;

        console.log('📊 Estatísticas:', { total, uniqueContacts, inbound, outbound });
        console.log('⚠️ Contatos sem call_type:', state.contacts.filter(c => !c.call_type).length);

        // Atualizar stats (agora mostra contatos únicos)
        document.getElementById('statTotal').textContent = uniqueContacts;
        document.getElementById('statInbound').textContent = inbound;
        document.getElementById('statOutbound').textContent = outbound;
        document.getElementById('statWebhooks').textContent = '0';

        renderContactsTable();
    }

    // ==================== RENDERIZAÇÃO ====================
    function renderContactsTable() {
        const tbody = document.getElementById('contactsTableBody');

        console.log('🎨 Renderizando tabela com', state.filteredContacts.length, 'contatos agrupados');

        if (state.filteredContacts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">📭</div>
                        <div style="color: rgba(255, 255, 255, 0.6); margin-bottom: 0.5rem;">Nenhum contato encontrado</div>
                        <div style="color: rgba(255, 255, 255, 0.4); font-size: 0.9rem;">Ajuste os filtros para ver mais resultados</div>
                    </td>
                </tr>
            `;
            return;
        }

        console.log('📋 Exemplo de contato agrupado:', state.filteredContacts[0]);

        tbody.innerHTML = state.filteredContacts.map((contact, index) => {
            const name = contact.name;
            const phone = contact.phone;
            const totalCalls = contact.totalCalls;
            const successCalls = contact.successCalls;
            const failedCalls = contact.failedCalls;

            // Determinar o tipo de chamada predominante
            const inboundCount = contact.calls.filter(c => c.call_type === 'inbound').length;
            const outboundCount = contact.calls.filter(c => c.call_type === 'outbound').length;

            // Se não houver nenhuma chamada com tipo definido, usar null
            let predominantType = null;
            if (inboundCount > 0 || outboundCount > 0) {
                predominantType = inboundCount > outboundCount ? 'inbound' : 'outbound';
            }

            // Determinar status predominante
            const successRate = (successCalls / totalCalls) * 100;
            const hasMoreSuccess = successCalls > failedCalls;

            if (index === 0) {
                console.log('🔍 Mapeamento do primeiro contato agrupado:', {
                    name, phone, totalCalls, successCalls, failedCalls, predominantType
                });
            }

            return `
                <tr>
                    <td>
                        <div class="contact-name-cell">
                            <div class="contact-avatar">${getInitials(name)}</div>
                            <div style="display: flex; flex-direction: column;">
                                <span style="font-weight: 600;">${sanitize(name)}</span>
                                <span style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.5);">
                                    ${totalCalls} ${totalCalls === 1 ? 'ligação' : 'ligações'}
                                </span>
                            </div>
                        </div>
                    </td>
                    <td style="color: rgba(255, 255, 255, 0.8);">${formatPhone(phone)}</td>
                    <td>
                        ${predominantType ? `
                            <span class="badge badge-${predominantType}">
                                ${predominantType === 'inbound' ? 'ENTRADA' : 'SAÍDA'}
                            </span>
                        ` : '<span style="color: rgba(255, 255, 255, 0.4); font-size: 0.85rem;">-</span>'}
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            <span class="badge badge-${hasMoreSuccess ? 'success' : 'failed'}">
                                ${hasMoreSuccess ? '✓ Sucesso' : '✗ Falha'}
                            </span>
                            <span style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.5);">
                                ${successCalls} sucesso / ${failedCalls} falha
                            </span>
                        </div>
                    </td>
                    <td style="text-align: right;">
                        <button class="btn-view" onclick='viewGroupedContactDetail(${JSON.stringify(contact).replace(/'/g, "&#39;")})'>
                            Ver detalhes
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        console.log('✅ Tabela renderizada com sucesso');
    }

    // ==================== FILTROS ====================
    function applyFilters() {
        const searchTerm = document.getElementById('filterSearch').value.toLowerCase().trim();
        const filterType = document.getElementById('filterType').value;
        const filterSuccess = document.getElementById('filterSuccess').value;
        const filterWebhook = document.getElementById('filterWebhook').value;
        const filterCampaign = document.getElementById('filterCampaign').value;
        const { dateStart, dateEnd } = state.filters;

        console.log('🔍 Aplicando filtros:', { searchTerm, filterType, filterSuccess, filterWebhook, filterCampaign, dateStart, dateEnd });

        state.filteredContacts = state.groupedContacts.filter(contact => {
            // Filtro de busca unificado (nome, assistente, número)
            if (searchTerm) {
                const name = (contact.name || '').toLowerCase();
                const phone = normalizePhone(contact.phone);

                // Buscar também nos nomes dos assistentes de todas as chamadas
                const assistantNames = contact.calls
                    .map(c => (c.assistant_name || '').toLowerCase())
                    .join(' ');

                const matchesSearch = name.includes(searchTerm) ||
                                    phone.includes(searchTerm.replace(/\D/g, '')) ||
                                    assistantNames.includes(searchTerm);

                if (!matchesSearch) return false;
            }

            // Filtro por tipo de chamada
            if (filterType !== 'all') {
                const hasType = contact.calls.some(call => call.call_type === filterType);
                if (!hasType) return false;
            }

            // Filtro por status
            if (filterSuccess !== 'all') {
                const isSuccess = filterSuccess === 'true';
                const hasSuccessMatch = isSuccess ? contact.successCalls > 0 : contact.failedCalls > 0;
                if (!hasSuccessMatch) return false;
            }

            // Filtro por webhook
            if (filterWebhook !== 'all') {
                const hasWebhook = contact.calls.some(call => {
                    let origem = call.origem || '';

                    // LOG para debug
                    console.log('🔍 Debug filtro webhook:', {
                        origem_original: call.origem,
                        origem_tipo: typeof origem,
                        filterWebhook: filterWebhook,
                        contactName: contact.name
                    });

                    // Se origem é um objeto com webhook_path, extrair o valor
                    if (typeof origem === 'object' && origem.webhook_path) {
                        origem = origem.webhook_path;
                        console.log('✅ Extraiu webhook_path do objeto:', origem);
                    }

                    // Comparar origem com o webhook_path selecionado
                    const match = origem === filterWebhook;
                    console.log(match ? '✅ Match encontrado!' : '❌ Não deu match', { origem, filterWebhook });
                    return match;
                });
                if (!hasWebhook) return false;
            }

            // Filtro por campanha
            if (filterCampaign !== 'all') {
                const hasCampaign = contact.calls.some(call => {
                    let origem = call.origem || '';

                    // Se origem é um objeto, não é campanha
                    if (typeof origem === 'object') {
                        return false;
                    }

                    // Se origem é string e só números, é uma campanha
                    if (typeof origem === 'string' && /^\d+$/.test(origem)) {
                        return origem === filterCampaign;
                    }

                    // Se origem é número direto
                    if (typeof origem === 'number') {
                        return origem.toString() === filterCampaign;
                    }

                    return false;
                });
                if (!hasCampaign) return false;
            }

            // Filtro por data
            if (dateStart || dateEnd) {
                const lastCallDate = new Date(contact.lastCall);
                lastCallDate.setHours(0, 0, 0, 0);

                if (dateStart) {
                    const start = new Date(dateStart);
                    start.setHours(0, 0, 0, 0);
                    if (lastCallDate < start) return false;
                }

                if (dateEnd) {
                    const end = new Date(dateEnd);
                    end.setHours(23, 59, 59, 999);
                    if (lastCallDate > end) return false;
                }
            }

            return true;
        });

        console.log('✅ Filtros aplicados. Resultados:', state.filteredContacts.length);
        renderContactsTable();
    }

    // ==================== MODAIS ====================
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    // Variáveis globais para armazenar dados do contato atual
    let currentContactPhone = null;
    let currentContactData = null;

    function endInteraction() {
        console.log('🎯 endInteraction CHAMADA!');
        console.log('📱 Telefone na variável global:', currentContactPhone);

        if (!currentContactPhone) {
            console.warn('⚠️ Nenhum telefone selecionado');
            showPopup('warning', 'Atenção', 'Nenhum contato selecionado.');
            return;
        }

        console.log('✅ Mostrando popup de confirmação...');

        // Usar popup customizado de confirmação
        showConfirmPopup(
            'Encerrar Interação',
            `Tem certeza que deseja encerrar a interação com este lead?\n\nNúmero: ${currentContactPhone}\n\nIsso irá remover o contato de todas as campanhas ativas.`,
            () => {
                console.log('✅ CALLBACK DO CONFIRMAR EXECUTADO!');
                executeEndInteraction();
            }
        );
    }

    async function executeEndInteraction() {
        console.log('🔄 executeEndInteraction CHAMADA!');
        console.log('📞 Telefone atual:', currentContactPhone);

        const btn = document.getElementById('btnEndInteraction');
        console.log('🔘 Botão encontrado:', btn);

        if (!btn) {
            console.error('❌ Botão não encontrado!');
            showPopup('error', 'Erro', 'Botão não encontrado. Tente novamente.');
            return;
        }

        const originalText = btn.innerHTML;

        // Desabilitar botão e mostrar loading
        btn.disabled = true;
        btn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                <circle cx="12" cy="12" r="10"></circle>
            </svg>
            Processando...
        `;

        console.log('🔄 Iniciando requisição para encerrar interação...');

        try {
            // Obter tenant_id do localStorage
            const tenantId = getTenantId();

            // Construir payload completo com todas as informações
            const payload = {
                tenant_id: tenantId,
                phone: currentContactPhone,
                contact_name: currentContactData?.name || 'Desconhecido',
                contact_info: {
                    name: currentContactData?.name || 'Desconhecido',
                    phone: currentContactPhone,
                    total_calls: currentContactData?.totalCalls || 0,
                    success_calls: currentContactData?.successCalls || 0,
                    failed_calls: currentContactData?.failedCalls || 0,
                    last_call_date: currentContactData?.lastCallDate || null
                },
                last_call: currentContactData?.lastCall ? {
                    call_id: currentContactData.lastCall.call_id || currentContactData.lastCall._id,
                    assistant_id: currentContactData.lastCall.assistant_id || currentContactData.lastCall.assistente_id,
                    assistant_name: currentContactData.lastCall.assistant_name || currentContactData.lastCall.assistente_name,
                    campaign_id: currentContactData.lastCall.campaign_id || currentContactData.lastCall.campanha_id,
                    campaign_name: currentContactData.lastCall.campaign_name || currentContactData.lastCall.campanha_name,
                    webhook_name: currentContactData.lastCall.webhook_name,
                    status: currentContactData.lastCall.status,
                    duration: currentContactData.lastCall.duration,
                    started_at: currentContactData.lastCall.started_at,
                    ended_at: currentContactData.lastCall.ended_at
                } : null,
                action: 'encerrar_interacao',
                timestamp: new Date().toISOString(),
                user_agent: navigator.userAgent
            };

            console.log('📤 Payload completo sendo enviado:', JSON.stringify(payload, null, 2));

            const response = await fetch('https://sdr.salesdever.io/webhook/encerra-interacao', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            console.log('📥 Resposta recebida:', response.status, response.statusText);

            if (response.ok || response.status === 200) {
                let responseData = {};
                try {
                    responseData = await response.json();
                } catch (e) {
                    console.log('⚠️ Resposta não é JSON, mas requisição foi bem sucedida');
                }
                console.log('✅ Resposta do webhook:', responseData);

                showPopup('success', 'Sucesso!', 'A interação com este lead foi encerrada com sucesso.');

                // Fechar modal após 2 segundos
                setTimeout(() => {
                    closeModal('modalContactDetail');
                }, 2000);
            } else {
                let errorData = { message: 'Erro desconhecido' };
                try {
                    errorData = await response.json();
                } catch (e) {
                    console.log('⚠️ Erro não retornou JSON');
                }
                console.error('❌ Erro na resposta:', response.status, errorData);
                throw new Error(errorData.message || `Erro ${response.status}: ${response.statusText}`);
            }
        } catch (error) {
            console.error('❌ ERRO DETALHADO:', error);
            console.error('❌ Tipo do erro:', error.name);
            console.error('❌ Mensagem:', error.message);
            console.error('❌ Stack:', error.stack);
            showPopup('error', 'Erro', `Não foi possível encerrar a interação.\n\n${error.message}`);
        } finally {
            // Restaurar botão
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
            console.log('🔚 Processo finalizado');
        }
    }

    function viewGroupedContactDetail(groupedContact) {
        console.log('👁️ Abrindo detalhes do contato agrupado:', groupedContact);

        const name = groupedContact.name;
        const phone = groupedContact.phone;
        const totalCalls = groupedContact.totalCalls;
        const successCalls = groupedContact.successCalls;
        const failedCalls = groupedContact.failedCalls;
        const calls = groupedContact.calls;

        // Armazenar telefone e dados completos do contato atual para uso no botão "Encerrar Interação"
        currentContactPhone = phone;
        currentContactData = {
            name: name,
            phone: phone,
            totalCalls: totalCalls,
            successCalls: successCalls,
            failedCalls: failedCalls,
            calls: calls,
            lastCallDate: calls.length > 0 ? (calls[0].started_at || calls[0].created_at) : null,
            // Extrair informações adicionais da última chamada, se disponível
            lastCall: calls.length > 0 ? calls[0] : null
        };

        // Ordenar chamadas por data (mais recente primeiro)
        calls.sort((a, b) => {
            const timestampA = a.started_at || a.created_at;
            const timestampB = b.started_at || b.created_at;

            let dateA, dateB;

            // Handle timestamp A
            if (typeof timestampA === 'number') {
                dateA = timestampA.toString().length === 10 ? new Date(timestampA * 1000) : new Date(timestampA);
            } else {
                dateA = new Date(timestampA);
            }

            // Handle timestamp B
            if (typeof timestampB === 'number') {
                dateB = timestampB.toString().length === 10 ? new Date(timestampB * 1000) : new Date(timestampB);
            } else {
                dateB = new Date(timestampB);
            }

            return dateB - dateA;
        });

        // Atualizar header do modal
        document.getElementById('modalContactName').textContent = name;
        document.getElementById('modalContactPhone').textContent = '📱 ' + formatPhone(phone);
        document.getElementById('modalContactDate').textContent = `📊 ${totalCalls} ${totalCalls === 1 ? 'ligação' : 'ligações'} no total`;

        // Construir conteúdo com resumo e lista de chamadas
        let content = `
            <div class="info-section" style="margin-bottom: 2rem;">
                <div class="info-title">📊 Resumo do Contato</div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Total de Ligações</div>
                        <div class="info-value">${totalCalls}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Ligações com Sucesso</div>
                        <div class="info-value" style="color: #22C55E;">${successCalls}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Ligações com Falha</div>
                        <div class="info-value" style="color: #EF4444;">${failedCalls}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Taxa de Sucesso</div>
                        <div class="info-value">${((successCalls / totalCalls) * 100).toFixed(0)}%</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Duração Total</div>
                        <div class="info-value">${formatDuration(groupedContact.totalDuration)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Última Chamada</div>
                        <div class="info-value">${formatDate(groupedContact.lastCall, true)}</div>
                    </div>
                </div>
            </div>

            <div class="info-section">
                <div class="info-title">📋 Histórico de Ligações</div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
        `;

        // Adicionar cada chamada com sanfona
        calls.forEach((call, index) => {
            const callType = call.call_type || null;
            const duration = call.duration_seconds || call.duration || 0;
            const success = call.success_evaluation === true;
            const createdAt = call.started_at || call.created_at;
            const recordingUrl = call.gravacao_baixada || call.gravacao_url || call.recording_url;
            const assistantName = call.assistant_name || 'Assistente IA';
            const callId = `call-${index}`;

            // Numeração invertida: primeira chamada (mais recente) tem o número total, última (mais antiga) tem #1
            const callNumber = calls.length - index;

            content += `
                <div class="call-item" id="${callId}">
                    <div class="call-item-header" ${recordingUrl ? `onclick="toggleAudioPlayer('${callId}', '${recordingUrl}')"` : ''}>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-size: 0.95rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                                    Ligação #${callNumber} - ${assistantName}
                                </div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">
                                    📅 ${formatDate(createdAt, true)}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                ${callType ? `
                                    <span class="badge badge-${callType}">
                                        ${callType === 'inbound' ? 'ENTRADA' : 'SAÍDA'}
                                    </span>
                                ` : ''}
                                <span class="badge badge-${success ? 'success' : 'failed'}">
                                    ${success ? '✓ Sucesso' : '✗ Falha'}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center; font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">
                            <span>⏱️ ${formatDuration(duration)}</span>
                            ${recordingUrl ? `
                                <span class="play-recording-btn">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                    </svg>
                                    Ouvir gravação
                                </span>
                            ` : '<span style="color: rgba(255, 255, 255, 0.4);">Sem gravação</span>'}
                        </div>
                    </div>
                    ${recordingUrl ? `
                        <div class="call-audio-content" id="${callId}-audio">
                            <div class="audio-section" style="margin: 0; border: none; background: transparent; padding: 0;">
                                <div class="audio-controls">
                                    <button class="play-btn" id="${callId}-playBtn">▶</button>
                                    <div class="waveform" id="${callId}-waveform"></div>
                                </div>
                                <div class="time-display">
                                    <span id="${callId}-currentTime">00:00</span>
                                    <span id="${callId}-totalTime">00:00</span>
                                </div>
                                <audio id="${callId}-audioPlayer" style="display: none;" src="${recordingUrl}"></audio>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        content += `
                </div>
            </div>
        `;

        document.getElementById('contactDetailContent').innerHTML = content;
        document.getElementById('modalContactDetail').classList.add('show');
    }

    function toggleAudioPlayer(callId, url) {
        const audioContent = document.getElementById(`${callId}-audio`);
        const isExpanded = audioContent.classList.contains('expanded');

        // Fechar todos os outros players
        document.querySelectorAll('.call-audio-content.expanded').forEach(el => {
            if (el.id !== `${callId}-audio`) {
                el.classList.remove('expanded');
                const audio = el.querySelector('audio');
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }
                const playBtn = el.querySelector('.play-btn');
                if (playBtn) playBtn.textContent = '▶';
            }
        });

        // Toggle do player atual
        if (isExpanded) {
            audioContent.classList.remove('expanded');
            const audio = document.getElementById(`${callId}-audioPlayer`);
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
            const playBtn = document.getElementById(`${callId}-playBtn`);
            if (playBtn) playBtn.textContent = '▶';
        } else {
            audioContent.classList.add('expanded');
            // Configurar player se ainda não foi configurado
            setTimeout(() => {
                const audio = document.getElementById(`${callId}-audioPlayer`);
                if (audio && !audio.dataset.initialized) {
                    setupAudioPlayerById(callId, url);
                    audio.dataset.initialized = 'true';
                }
            }, 100);
        }
    }

    function setupAudioPlayerById(callId, url) {
        const audio = document.getElementById(`${callId}-audioPlayer`);
        const playBtn = document.getElementById(`${callId}-playBtn`);
        const waveform = document.getElementById(`${callId}-waveform`);
        const currentTimeEl = document.getElementById(`${callId}-currentTime`);
        const totalTimeEl = document.getElementById(`${callId}-totalTime`);

        if (!audio || !playBtn || !waveform) return;

        // Gerar waveform
        waveform.innerHTML = '';
        for (let i = 0; i < 40; i++) {
            const height = Math.random() * 60 + 20;
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            bar.style.height = height + '%';
            waveform.appendChild(bar);
        }

        // Quando o áudio carregar
        audio.addEventListener('loadedmetadata', () => {
            totalTimeEl.textContent = formatTime(audio.duration);
        });

        // Play/Pause
        playBtn.onclick = (e) => {
            e.stopPropagation();
            if (audio.paused) {
                audio.play();
                playBtn.textContent = '⏸';
                startTimeUpdate();
            } else {
                audio.pause();
                playBtn.textContent = '▶';
                clearInterval(audioInterval);
            }
        };

        // Quando terminar
        audio.addEventListener('ended', () => {
            playBtn.textContent = '▶';
            clearInterval(audioInterval);
            audio.currentTime = 0;
            updateWaveform(0);
        });

        // Click no waveform
        waveform.onclick = (e) => {
            e.stopPropagation();
            const rect = waveform.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audio.currentTime = audio.duration * percent;
            updateWaveform(percent);
        };

        function startTimeUpdate() {
            audioInterval = setInterval(() => {
                currentTimeEl.textContent = formatTime(audio.currentTime);
                const percent = audio.currentTime / audio.duration;
                updateWaveform(percent);
            }, 100);
        }

        function updateWaveform(percent) {
            const bars = waveform.querySelectorAll('.wave-bar');
            const activeCount = Math.floor(bars.length * percent);
            bars.forEach((bar, i) => {
                if (i < activeCount) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }
    }

    function viewContactDetail(contact) {
        console.log('👁️ Abrindo detalhes do contato:', contact);

        // Mapear campos usando a estrutura correta do webhook
        const name = contact.assistant_name || contact.lead_name || 'Assistente IA';
        const phone = contact.client_phone || contact.phone_number || '-';
        const callType = contact.call_type || null; // Já normalizado
        const duration = contact.duration_seconds || contact.duration || 0;
        const success = contact.success_evaluation === true;
        const createdAt = contact.started_at || contact.created_at;
        const endedAt = contact.ended_at;
        const recordingUrl = contact.gravacao_baixada || contact.gravacao_url || contact.recording_url;
        const transcript = contact.transcript;
        const summary = contact.summary;
        const callId = contact.vapi_call_id || contact.id || '-';
        const cost = contact.cost || 0;
        const status = contact.status || 'ended';
        const assistantPhone = contact.phone_number_ass || '-';

        // Atualizar header do modal
        document.getElementById('modalContactName').textContent = name;
        document.getElementById('modalContactPhone').textContent = '📱 ' + formatPhone(phone);
        document.getElementById('modalContactDate').textContent = '📅 ' + formatDate(createdAt, true);

        // Construir conteúdo
        let content = '';

        // Player de áudio
        if (recordingUrl) {
            content += `
                <div class="audio-section">
                    <div class="audio-header">
                        <div class="audio-title">🎵 Gravação da Chamada</div>
                    </div>
                    <div class="audio-controls">
                        <button class="play-btn" id="playBtn">▶</button>
                        <div class="waveform" id="waveform"></div>
                    </div>
                    <div class="time-display">
                        <span id="currentTime">00:00</span>
                        <span id="totalTime">00:00</span>
                    </div>
                    <audio id="audioPlayer" style="display: none;" src="${recordingUrl}"></audio>
                </div>
            `;
        }

        // Informações principais
        content += `
            <div class="info-section">
                <div class="info-title">ℹ️ Informações da Chamada</div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Tipo</div>
                        <div class="info-value">${callType === 'inbound' ? 'Entrada' : 'Saída'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Duração</div>
                        <div class="info-value">${formatDuration(duration)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value">${success ? '✓ Sucesso' : '✗ Falha'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Custo</div>
                        <div class="info-value">$${cost.toFixed(4)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Telefone Assistente</div>
                        <div class="info-value">${formatPhone(assistantPhone)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Horário Início</div>
                        <div class="info-value">${formatDate(createdAt, true)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Horário Fim</div>
                        <div class="info-value">${formatDate(endedAt, true)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ID da Chamada</div>
                        <div class="info-value" style="font-size: 0.7rem; font-family: monospace;">${callId}</div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('contactDetailContent').innerHTML = content;
        document.getElementById('modalContactDetail').classList.add('show');

        // Configurar player de áudio
        if (recordingUrl) {
            setTimeout(() => setupAudioPlayer(recordingUrl), 100);
        }
    }

    // ==================== PLAYER DE ÁUDIO ====================
    function setupAudioPlayer(url) {
        const audio = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const waveform = document.getElementById('waveform');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');

        if (!audio || !playBtn || !waveform) return;

        // Resetar player
        if (currentAudio) {
            currentAudio.pause();
            currentAudio.currentTime = 0;
            clearInterval(audioInterval);
        }

        currentAudio = audio;

        // Gerar waveform (40 barras)
        waveform.innerHTML = '';
        for (let i = 0; i < 40; i++) {
            const height = Math.random() * 60 + 20;
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            bar.style.height = height + '%';
            waveform.appendChild(bar);
        }

        // Quando o áudio carregar
        audio.addEventListener('loadedmetadata', () => {
            totalTimeEl.textContent = formatTime(audio.duration);
        });

        // Play/Pause
        playBtn.onclick = () => {
            if (audio.paused) {
                audio.play();
                playBtn.textContent = '⏸';
                startTimeUpdate();
            } else {
                audio.pause();
                playBtn.textContent = '▶';
                clearInterval(audioInterval);
            }
        };

        // Quando terminar
        audio.addEventListener('ended', () => {
            playBtn.textContent = '▶';
            clearInterval(audioInterval);
            audio.currentTime = 0;
            updateWaveform(0);
        });

        // Click no waveform
        waveform.onclick = (e) => {
            const rect = waveform.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            audio.currentTime = audio.duration * percent;
            updateWaveform(percent);
        };

        function startTimeUpdate() {
            audioInterval = setInterval(() => {
                currentTimeEl.textContent = formatTime(audio.currentTime);
                const percent = audio.currentTime / audio.duration;
                updateWaveform(percent);
            }, 100);
        }

        function updateWaveform(percent) {
            const bars = waveform.querySelectorAll('.wave-bar');
            const activeCount = Math.floor(bars.length * percent);
            bars.forEach((bar, i) => {
                if (i < activeCount) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }
    }

    function downloadAudio(url) {
        const a = document.createElement('a');
        a.href = url;
        a.download = `gravacao_${Date.now()}.mp3`;
        a.click();
    }

    // ==================== EXPORTAÇÃO ====================
    function exportCSV() {
        if (state.filteredContacts.length === 0) {
            showPopup('warning', 'Sem dados', 'Nenhum contato para exportar');
            return;
        }

        const headers = ['Nome', 'Telefone', 'Email', 'Tipo', 'Duração', 'Status', 'Data'];
        const rows = state.filteredContacts.map(c => {
            const name = c.lead_name || c.name || c.contact_name || '';
            const phone = c.phone_number || c.phone || c.contact_phone || '';
            const email = c.email || c.contact_email || '';
            const type = c.call_type || c.type || '';
            const duration = formatDuration(c.duration || c.call_duration || 0);
            const success = (c.success_valuation || c.success || c.is_success) ? 'Sucesso' : 'Falha';
            const date = formatDate(c.created_at || c.call_date || c.date, true);

            return [name, phone, email, type, duration, success, date];
        });

        const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `contatos_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();

        console.log('✅ CSV exportado com sucesso');
    }

    // ==================== WEBHOOKS ====================
    function openWebhooksManager() {
        document.getElementById('modalWebhooks').classList.add('show');
        switchWebhookTab('webhooks'); // Abrir na aba de Meus Webhooks por padrão
        refreshWebhookLogs(); // Carregar logs automaticamente
    }

    // ==================== WEBHOOK MANAGEMENT ====================
    let selectedEvents = [];

    // ==================== POPUP CUSTOMIZADO ====================
    function showPopup(type, title, message) {
        const overlay = document.getElementById('customPopup');
        const icon = document.getElementById('popupIcon');
        const titleEl = document.getElementById('popupTitle');
        const messageEl = document.getElementById('popupMessage');
        const btnContainer = document.getElementById('popupBtnContainer');

        // Limpar classes anteriores
        icon.className = 'custom-popup-icon';

        // Definir ícone e classe baseado no tipo
        let iconSVG = '';
        switch(type) {
            case 'success':
                icon.classList.add('success');
                iconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>`;
                break;
            case 'error':
                icon.classList.add('error');
                iconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>`;
                break;
            case 'warning':
                icon.classList.add('warning');
                iconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>`;
                break;
            case 'info':
                icon.classList.add('info');
                iconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="#A594FF" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>`;
                break;
        }

        icon.innerHTML = iconSVG;
        titleEl.textContent = title;
        messageEl.textContent = message;

        // Resetar para apenas um botão OK
        btnContainer.innerHTML = '<button class="custom-popup-btn" onclick="closeCustomPopup()">OK</button>';

        overlay.classList.add('active');
    }

    function closeCustomPopup() {
        const overlay = document.getElementById('customPopup');
        overlay.classList.remove('active');
    }

    // Função para popup de confirmação
    function showConfirmPopup(title, message, onConfirm) {
        const overlay = document.getElementById('customPopup');
        const icon = document.getElementById('popupIcon');
        const titleEl = document.getElementById('popupTitle');
        const messageEl = document.getElementById('popupMessage');
        const btnContainer = document.getElementById('popupBtnContainer');

        // Limpar classes anteriores
        icon.className = 'custom-popup-icon warning';

        // Ícone de aviso
        icon.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>`;

        titleEl.textContent = title;
        messageEl.textContent = message;

        // Criar botões de confirmação
        btnContainer.innerHTML = `
            <button class="custom-popup-btn secondary" onclick="closeCustomPopup()">Cancelar</button>
            <button class="custom-popup-btn danger" id="confirmBtn">Confirmar</button>
        `;

        // Adicionar evento ao botão de confirmar
        document.getElementById('confirmBtn').onclick = () => {
            closeCustomPopup();
            onConfirm();
        };

        overlay.classList.add('active');
    }

    // Fechar popup ao clicar fora dele
    document.addEventListener('click', function(e) {
        const overlay = document.getElementById('customPopup');
        if (e.target === overlay) {
            closeCustomPopup();
        }
    });

    // Selecionar tipo de evento (Ligação ou Mensagens)
    function selectEventType(type) {
        // Remover seleção de todos os cards de tipo
        document.querySelectorAll('.event-type-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Marcar o card selecionado
        const selectedCard = type === 'call' ?
            document.getElementById('eventTypeCall') :
            document.getElementById('eventTypeMessage');
        selectedCard.classList.add('selected');

        // Atualizar campo hidden
        document.getElementById('webhookEventTypeModal').value = type;

        // Controlar exibição dos cards de ligação
        const callOptions = document.getElementById('callEventOptionsModal');

        if (type === 'call') {
            // Mostrar opções de ligação com animação
            callOptions.style.display = 'block';
            setTimeout(() => {
                callOptions.style.opacity = '1';
                callOptions.style.transform = 'translateY(0)';
            }, 10);
        } else {
            // Ocultar opções e limpar seleção
            callOptions.style.opacity = '0';
            callOptions.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                callOptions.style.display = 'none';
            }, 300);

            // Limpar seleção de cards de ligação
            selectedEvents = [];
            document.querySelectorAll('.event-card').forEach(card => card.classList.remove('selected'));
        }

        console.log('📞 Tipo de evento selecionado:', type);
    }

    function toggleEventCard(eventId) {
        // Desmarcar todos os cards primeiro
        document.querySelectorAll('.event-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Marcar apenas o card clicado
        const card = document.getElementById(eventId);
        card.classList.add('selected');

        // Atualizar array de eventos selecionados (apenas UM evento)
        const eventMap = {
            'eventSuccess': 'success',
            'eventFailed': 'failed',
            'eventEnded': 'ended'
        };

        const eventType = eventMap[eventId];
        selectedEvents = [eventType]; // Substituir, não adicionar

        console.log('📋 Evento selecionado:', selectedEvents[0]);
    }

    function switchWebhookTab(tabName) {
        // Remover active de todas as abas e conteúdos
        document.querySelectorAll('.webhook-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.webhook-tab-content').forEach(content => content.classList.remove('active'));

        // Adicionar active na aba e conteúdo selecionados
        event?.target?.classList.add('active') || document.querySelector(`.webhook-tab[onclick*="${tabName}"]`)?.classList.add('active');
        document.getElementById(`webhookTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');

        // Carregar dados específicos da aba
        if (tabName === 'webhooks') {
            loadWebhooks();
        } else if (tabName === 'logs') {
            refreshWebhookLogs();
        } else if (tabName === 'config') {
            // Limpar formulário ao abrir configuração
            document.getElementById('webhookUrl').value = '';
            document.getElementById('webhookAssistant').value = '';
            selectedEvents = [];
            document.querySelectorAll('.event-card').forEach(card => card.classList.remove('selected'));

            // Carregar assistentes e números (agora em uma única função)
            loadAssistants();
        }
    }

    async function loadAssistants() {
        const tenantId = getTenantId();
        const assistantSelect = document.getElementById('webhookAssistant');

        console.log('🔄 Carregando assistentes...');

        try {
            const response = await fetch(`${API_BASE}/procura_assistentes_webhooks_envios`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tenant_id: tenantId })
            });

            const data = await response.json();

            // Log completo para debug
            console.log('📦 Resposta completa da API:', data);
            console.log('📦 É array?', Array.isArray(data));

            // A API retorna um ARRAY com objetos (apenas assistentes)
            let items = Array.isArray(data) ? data : [];

            // Filtrar apenas assistentes (ignorar números)
            const assistants = items.filter(item => {
                // Se tem assistente_id ou name (e NÃO tem number_name), é uma ASSISTENTE
                return (item.assistente_id || item.name) && !item.number_name;
            });

            console.log(`✅ Total de assistentes: ${assistants.length}`);

            // Popular select de assistentes
            if (assistants.length > 0) {
                assistantSelect.innerHTML = '<option value="">Selecione um assistente</option>';
                assistants.forEach(assistant => {
                    const option = document.createElement('option');
                    option.value = assistant.assistente_id || assistant.assistant_id || assistant.id;
                    const name = assistant.name || assistant.assistant_name || `Assistente ${option.value}`;
                    option.textContent = name;
                    assistantSelect.appendChild(option);
                    console.log(`👤 Assistente adicionado: ${name}`);
                });
            } else {
                assistantSelect.innerHTML = '<option value="">Nenhum assistente disponível</option>';
            }
        } catch (error) {
            console.error('❌ Erro ao carregar assistentes:', error);
            assistantSelect.innerHTML = '<option value="">Erro ao carregar assistentes</option>';
        }
    }

    async function saveWebhookConfig() {
        const name = document.getElementById('webhookName').value.trim();
        const url = document.getElementById('webhookUrl').value;
        const assistantId = document.getElementById('webhookAssistant').value;
        const tenantId = getTenantId();
        const eventType = document.getElementById('webhookEventTypeModal').value;

        if (!name) {
            showPopup('warning', 'Campo obrigatório', 'Por favor, insira um nome para o webhook');
            return;
        }

        if (!url) {
            showPopup('warning', 'Campo obrigatório', 'Por favor, insira uma URL de webhook');
            return;
        }

        if (!assistantId) {
            showPopup('warning', 'Campo obrigatório', 'Por favor, selecione um assistente');
            return;
        }

        if (!eventType) {
            showPopup('warning', 'Campo obrigatório', 'Por favor, selecione o tipo de evento (Ligação ou Mensagens)');
            return;
        }

        // LOG DETALHADO para debug
        console.log('🔍 DEBUG - Valores capturados:', {
            eventType: eventType,
            selectedEvents: selectedEvents,
            selectedEventsLength: selectedEvents.length
        });

        // Validar e construir configuração baseado no tipo de evento
        let statusToSend = null;

        if (eventType === 'call') {
            if (selectedEvents.length === 0) {
                showPopup('warning', 'Campo obrigatório', 'Por favor, selecione um tipo de ligação (sem sucesso, com sucesso ou finalizada)');
                return;
            }

            const selectedCallType = selectedEvents[0]; // 'success', 'failed', ou 'ended'
            console.log('🔍 DEBUG - Tipo de ligação selecionado:', selectedCallType);

            // Determinar o status correto baseado na seleção
            if (selectedCallType === 'ended') {
                // Ligação finalizada: envia "call_ended"
                statusToSend = 'call_ended';
            } else if (selectedCallType === 'success') {
                // Ligação com sucesso
                statusToSend = 'call_success';
            } else if (selectedCallType === 'failed') {
                // Ligação sem sucesso
                statusToSend = 'call_failed';
            }

            console.log('✅ Status definido para ligação:', statusToSend);
        } else if (eventType === 'message') {
            // Mensagens
            statusToSend = 'message_received';
            console.log('✅ Status definido para mensagem:', statusToSend);
        }

        // Construir payload
        const config = {
            tenant_id: tenantId,
            name_webhook: name,
            url_webhook: url,
            assistente_id: assistantId,
            status: statusToSend  // SEMPRE envia o status correto
        };

        console.log('💾 ===== PAYLOAD FINAL QUE SERÁ ENVIADO =====');
        console.log(JSON.stringify(config, null, 2));
        console.log('============================================');

        try {
            const response = await fetch(`${API_BASE}/cria_webhooks_envios`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });

            const data = await response.json();

            if (response.ok) {
                console.log('✅ Webhook criado com sucesso:', data);
                showPopup('success', 'Webhook criado!', 'Webhook configurado com sucesso!');

                // Limpar formulário
                document.getElementById('webhookName').value = '';
                document.getElementById('webhookUrl').value = '';
                document.getElementById('webhookAssistant').value = '';
                document.getElementById('webhookEventTypeModal').value = '';
                document.getElementById('callEventOptionsModal').style.display = 'none';
                selectedEvents = [];
                // Limpar seleção de cards de tipo de evento
                document.querySelectorAll('.event-type-card').forEach(card => card.classList.remove('selected'));
                // Limpar seleção de cards de ligação
                document.querySelectorAll('.event-card').forEach(card => card.classList.remove('selected'));

                // Voltar para aba de webhooks e recarregar lista
                switchWebhookTab('webhooks');
                loadWebhooks(); // Recarregar a lista de webhooks
            } else {
                console.error('❌ Erro ao criar webhook:', data);
                showPopup('error', 'Erro ao criar webhook', data.message || 'Erro desconhecido');
            }
        } catch (error) {
            console.error('❌ Erro ao criar webhook:', error);
            showPopup('error', 'Erro ao criar webhook', 'Verifique o console para mais detalhes');
        }
    }

    async function loadWebhooks() {
        const tenantId = getTenantId();
        console.log('🔄 Carregando webhooks configurados...');

        try {
            const response = await fetch(`${API_BASE}/procura_webhooks_envios`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tenant_id: tenantId })
            });

            const data = await response.json();

            // Log completo para debug
            console.log('📦 Resposta completa da API de webhooks:', data);
            console.log('📦 Tipo de data:', typeof data);
            console.log('📦 Keys de data:', Object.keys(data));

            // Tentar diferentes estruturas de resposta
            let webhooks = null;

            if (Array.isArray(data)) {
                // Se data já é um array
                webhooks = data;
                console.log('📋 Webhooks encontrados diretamente no array:', webhooks);
            } else if (data.webhooks && Array.isArray(data.webhooks)) {
                // Se está em data.webhooks
                webhooks = data.webhooks;
                console.log('📋 Webhooks encontrados em data.webhooks:', webhooks);
            } else if (data.data && Array.isArray(data.data)) {
                // Se está em data.data
                webhooks = data.data;
                console.log('📋 Webhooks encontrados em data.data:', webhooks);
            } else if (data.data && data.data.webhooks && Array.isArray(data.data.webhooks)) {
                // Se está em data.data.webhooks
                webhooks = data.data.webhooks;
                console.log('📋 Webhooks encontrados em data.data.webhooks:', webhooks);
            }

            if (response.ok && webhooks && webhooks.length > 0) {
                console.log('✅ Total de webhooks recebidos da API:', webhooks.length);
                console.log('📋 LISTA COMPLETA DE WEBHOOKS ANTES DE FILTRAR:');
                webhooks.forEach((wh, idx) => {
                    console.log(`  ${idx + 1}. ${wh.name_webhook || 'Sem nome'} (ID: ${wh._id || wh.id})`);
                    console.log('     Status:', wh.status);
                    console.log('     URL:', wh.url_webhook);
                    console.log('     Assistente ID:', wh.assistente_id);
                });

                // FILTRAR webhooks inválidos ou vazios
                const validWebhooks = webhooks.filter(wh => {
                    // Webhook é válido se tem pelo menos ID e algum dado relevante
                    const hasId = wh._id || wh.id;
                    const hasName = wh.name_webhook && wh.name_webhook.trim() !== '';
                    const hasUrl = wh.url_webhook && wh.url_webhook.trim() !== '' && wh.url_webhook !== '-';
                    const hasAssistant = wh.assistente_id || wh.assistant_id;

                    const isValid = hasId && (hasName || hasUrl || hasAssistant);

                    if (!isValid) {
                        console.warn('⚠️ Webhook inválido removido:', wh);
                    }

                    return isValid;
                });

                console.log('✅ Total de webhooks VÁLIDOS após filtrar:', validWebhooks.length);

                if (validWebhooks.length > 0) {
                    // Enriquecer webhooks com nomes das assistentes
                    await enrichWebhooksWithAssistantNames(validWebhooks);

                    renderWebhooks(validWebhooks);
                    // Atualizar contador no stat box
                    document.getElementById('statWebhooks').textContent = validWebhooks.length;
                } else {
                    console.log('📭 Nenhum webhook válido após filtrar');
                    renderWebhooks([]);
                    document.getElementById('statWebhooks').textContent = '0';
                }
            } else {
                console.log('📭 Nenhum webhook encontrado ou array vazio');
                renderWebhooks([]);
                // Atualizar contador para 0
                document.getElementById('statWebhooks').textContent = '0';
            }
        } catch (error) {
            console.error('❌ Erro ao carregar webhooks:', error);
            renderWebhooks([]);
            document.getElementById('statWebhooks').textContent = '0';
        }
    }

    // Função para enriquecer webhooks com nomes das assistentes e números
    async function enrichWebhooksWithAssistantNames(webhooks) {
        const tenantId = getTenantId();

        try {
            // Buscar assistentes e números em paralelo
            const [assistantsResponse, numbersResponse] = await Promise.all([
                fetch(`${API_BASE}/procura_assistentes_webhooks_envios`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tenant_id: tenantId })
                }),
                fetch(`${API_BASE}/procura_numeros`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tenant_id: tenantId })
                })
            ]);

            const assistantsData = await assistantsResponse.json();
            const numbersData = await numbersResponse.json();

            console.log('📞 Dados de números recebidos:', numbersData);
            console.log('👥 Dados de assistentes recebidos:', assistantsData);

            // Processar assistentes
            let assistants = null;
            if (Array.isArray(assistantsData)) {
                assistants = assistantsData;
            } else if (assistantsData.assistants && Array.isArray(assistantsData.assistants)) {
                assistants = assistantsData.assistants;
            } else if (assistantsData.data && Array.isArray(assistantsData.data)) {
                assistants = assistantsData.data;
            } else if (assistantsData.data && assistantsData.data.assistants && Array.isArray(assistantsData.data.assistants)) {
                assistants = assistantsData.data.assistants;
            }

            // Processar números
            let numbers = null;
            if (Array.isArray(numbersData)) {
                numbers = numbersData;
            } else if (numbersData.numbers && Array.isArray(numbersData.numbers)) {
                numbers = numbersData.numbers;
            } else if (numbersData.data && Array.isArray(numbersData.data)) {
                numbers = numbersData.data;
            }

            // Criar mapa de assistentes
            const assistantMap = {};
            if (assistants && assistants.length > 0) {
                console.log('👥 Assistentes carregados para enriquecimento:', assistants.length);
                assistants.forEach(assistant => {
                    const id = assistant.assistente_id || assistant.assistant_id || assistant.id || assistant._id || assistant.assistantId;
                    const name = assistant.name || assistant.assistant_name || assistant.assistantName || assistant.nome;
                    if (id && name) {
                        assistantMap[id] = name;
                    }
                });
            }

            // Criar mapa de números
            const numberMap = {};
            if (numbers && numbers.length > 0) {
                console.log('📞 Números carregados para enriquecimento:', numbers.length);
                numbers.forEach(number => {
                    const id = number.number_id || number.id || number._id;
                    const name = number.number_name || number.name || number.phone_number;
                    if (id && name) {
                        numberMap[id] = name;
                        console.log(`📞 Mapeado número: ${id} -> ${name}`);
                    }
                });
            }

            // Enriquecer cada webhook
            webhooks.forEach(webhook => {
                // Enriquecer com nome da assistente
                const assistantId = webhook.assistente_id || webhook.assistant_id;
                if (assistantId && assistantMap[assistantId]) {
                    webhook.assistant_name = assistantMap[assistantId];
                    console.log(`✅ Webhook "${webhook.name_webhook}" enriquecido com assistente: ${webhook.assistant_name}`);
                }

                // Enriquecer com nome do número
                const numberId = webhook.number_id || webhook.phone_number_id;
                if (numberId && numberMap[numberId]) {
                    webhook.number_name = numberMap[numberId];
                    console.log(`✅ Webhook "${webhook.name_webhook}" enriquecido com número: ${webhook.number_name}`);
                }
            });
        } catch (error) {
            console.error('⚠️ Erro ao buscar assistentes/números para enriquecimento:', error);
            // Não interromper o fluxo, apenas não teremos os nomes
        }
    }

    function renderWebhooks(webhooks) {
        const container = document.getElementById('webhooksList');

        if (!container) {
            console.error('❌ Elemento webhooksList não encontrado!');
            return;
        }

        console.log('📋 Renderizando webhooks:');
        console.log('📊 Total de webhooks:', webhooks ? webhooks.length : 0);
        console.log('📦 Dados dos webhooks:', webhooks);

        if (!webhooks || webhooks.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="padding: 3rem 2rem;">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="rgba(165, 148, 255, 0.3)" stroke-width="1.5" style="margin-bottom: 1.5rem;">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                    <h3 style="color: rgba(255, 255, 255, 0.8); font-size: 1.1rem; margin-bottom: 0.5rem;">Nenhum webhook configurado</h3>
                    <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.9rem;">Clique em "Novo Webhook" para criar sua primeira integração</p>
                </div>
            `;
            return;
        }

        const eventLabels = {
            // Ligações (formato antigo - compatibilidade)
            'success': 'Ligação com sucesso',
            'failed': 'Ligação sem sucesso',
            'ended': 'Ligação finalizada',
            // Ligações (formato novo)
            'call_success': 'Ligação com sucesso',
            'call_failed': 'Ligação sem sucesso',
            'call_ended': 'Ligação finalizada',
            // Mensagens
            'message_received': 'Mensagem recebida',
            'message': 'Mensagem recebida'
        };

        const eventIcons = {
            // Ligações
            'success': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>`,
            'failed': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>`,
            'ended': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>`,
            'call_success': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>`,
            'call_failed': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>`,
            'call_ended': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>`,
            // Mensagens
            'message_received': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>`,
            'message': `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>`
        };

        try {
            container.innerHTML = webhooks.map(webhook => {
                // Nome do webhook (campo correto: name_webhook)
                const webhookName = webhook.name_webhook || webhook.name || 'Webhook sem nome';

                // URL (campo correto: url_webhook)
                const webhookUrl = webhook.url_webhook || webhook.webhook_url || webhook.url || '-';

                // Assistente (campo correto: assistente_id)
                const assistantId = webhook.assistente_id || webhook.assistant_id;
                // Tentar pegar o nome da assistente, nunca mostrar o ID
                let assistantName = 'Carregando...';
                if (webhook.assistant_name) {
                    assistantName = webhook.assistant_name;
                } else if (webhook.assistantName) {
                    assistantName = webhook.assistantName;
                } else if (webhook.nome_assistente) {
                    assistantName = webhook.nome_assistente;
                } else {
                    assistantName = 'Assistente';
                }

                // Obter nome do número
                let numberName = null;
                if (webhook.number_name) {
                    numberName = webhook.number_name;
                } else if (webhook.phone_number_name) {
                    numberName = webhook.phone_number_name;
                }

                // Detectar tipo de evento - CORRIGIDO para usar o campo "status"
                let eventKey = 'ended'; // fallback padrão

                // LOG para debug
                console.log('🔍 Webhook:', webhookName, {
                    status: webhook.status,
                    event_subtype: webhook.event_subtype,
                    event_type: webhook.event_type,
                    type_webhook: webhook.type_webhook
                });

                // PRIORIDADE: status > event_subtype > event_type > type_webhook
                if (webhook.status) {
                    // Campo correto que está sendo enviado agora
                    eventKey = webhook.status;
                    console.log('✅ Usando campo "status":', eventKey);
                } else if (webhook.event_subtype) {
                    eventKey = webhook.event_subtype;
                    console.log('✅ Usando campo "event_subtype":', eventKey);
                } else if (webhook.event_type === 'message') {
                    eventKey = 'message_received';
                    console.log('✅ Usando campo "event_type" = message');
                } else if (webhook.type_webhook) {
                    // Formato antigo - compatibilidade
                    if (typeof webhook.type_webhook === 'string') {
                        eventKey = webhook.type_webhook;
                    } else if (Array.isArray(webhook.type_webhook) && webhook.type_webhook.length > 0) {
                        eventKey = webhook.type_webhook[0];
                    }
                    console.log('✅ Usando campo "type_webhook":', eventKey);
                }

                const eventLabel = eventLabels[eventKey] || eventLabels['ended'];
                const eventIcon = eventIcons[eventKey] || eventIcons['ended'];

                console.log('📋 Resultado final:', { eventKey, eventLabel });

                // Data de criação (campo correto: created_at)
                let createdDate = 'Data não disponível';
                if (webhook.created_at) {
                    try {
                        let date;
                        const timestamp = webhook.created_at;
                        if (typeof timestamp === 'number') {
                            // If it's a timestamp in seconds (10 digits), convert to milliseconds
                            date = timestamp.toString().length === 10 ? new Date(timestamp * 1000) : new Date(timestamp);
                        } else {
                            date = new Date(timestamp);
                        }
                        createdDate = date.toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        createdDate = webhook.created_at;
                    }
                }

                // ID do webhook (campo correto: _id)
                const webhookId = webhook._id || webhook.id || webhook.webhook_id;

                return `
                <div class="webhook-item">
                    <div class="webhook-item-info">
                        <h4 style="font-size: 1.15rem; font-weight: 700; color: #ffffff; margin: 0 0 0.85rem 0;">${webhookName}</h4>

                        <div style="display: flex; flex-direction: column; gap: 0.65rem; font-size: 0.9rem;">
                            <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(165, 148, 255, 0.8)" stroke-width="2" style="flex-shrink: 0; margin-top: 0.15rem;">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                </svg>
                                <div style="flex: 1;">
                                    <div style="color: rgba(165, 148, 255, 0.7); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.2rem;">URL</div>
                                    <div style="color: rgba(255, 255, 255, 0.9); word-break: break-all; font-family: 'Courier New', monospace; font-size: 0.82rem;">${webhookUrl}</div>
                                </div>
                            </div>

                            <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(165, 148, 255, 0.8)" stroke-width="2" style="flex-shrink: 0; margin-top: 0.15rem;">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="8.5" cy="7" r="4"></circle>
                                    <polyline points="17 11 19 13 23 9"></polyline>
                                </svg>
                                <div style="flex: 1;">
                                    <div style="color: rgba(165, 148, 255, 0.7); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.2rem;">Assistente</div>
                                    <div style="color: rgba(255, 255, 255, 0.9); font-weight: 500; font-size: 0.88rem;">${assistantName}</div>
                                </div>
                            </div>

                            ${numberName ? `
                            <div style="display: flex; align-items: flex-start; gap: 0.5rem;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(34, 197, 94, 0.8)" stroke-width="2" style="flex-shrink: 0; margin-top: 0.15rem;">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                </svg>
                                <div style="flex: 1;">
                                    <div style="color: rgba(34, 197, 94, 0.8); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.2rem;">Número de Telefone</div>
                                    <div style="color: rgba(255, 255, 255, 0.9); font-weight: 500; font-size: 0.88rem;">${numberName}</div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 1.5rem; align-items: flex-end; justify-content: space-between; min-height: 100%;">
                        <div style="display: flex; align-items: center; gap: 0.65rem;">
                            <span class="webhook-event-badge" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); padding: 0.6rem 0.75rem; border-radius: 6px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.35rem; height: 100%;">
                                ${eventIcon}
                                ${eventLabel}
                            </span>
                            <div class="webhook-item-actions">
                                <button class="webhook-action-btn test" onclick='testWebhook(${JSON.stringify({
                                    _id: webhookId,
                                    name_webhook: webhookName,
                                    url_webhook: webhookUrl,
                                    assistente_id: assistantId,
                                    type_webhook: eventKey
                                }).replace(/'/g, "&#39;")})'>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                    </svg>
                                    Testar
                                </button>
                                <button class="webhook-action-btn edit" onclick='editWebhook(${JSON.stringify({
                                    _id: webhookId,
                                    name_webhook: webhookName,
                                    url_webhook: webhookUrl,
                                    assistente_id: assistantId,
                                    type_webhook: eventKey
                                }).replace(/'/g, "&#39;")})'>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                    Editar
                                </button>
                                <button class="webhook-action-btn delete" onclick='deleteWebhook(${JSON.stringify({
                                    _id: webhookId,
                                    name_webhook: webhookName,
                                    url_webhook: webhookUrl,
                                    assistente_id: assistantId,
                                    type_webhook: eventKey
                                }).replace(/'/g, "&#39;")})'>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Excluir
                                </button>
                            </div>
                        </div>
                        <span style="font-size: 0.72rem; color: rgba(255, 255, 255, 0.42); display: flex; align-items: center; gap: 0.3rem;">
                            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ${createdDate}
                        </span>
                    </div>
                </div>
            `;
            }).join('');
        } catch (error) {
            console.error('❌ Erro ao renderizar webhooks:', error);
            console.error('Stack trace:', error.stack);
            container.innerHTML = `
                <div class="empty-state" style="padding: 3rem 2rem;">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="rgba(255, 100, 100, 0.5)" stroke-width="1.5" style="margin-bottom: 1.5rem;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <h3 style="color: rgba(255, 255, 255, 0.8); font-size: 1.1rem; margin-bottom: 0.5rem;">Erro ao carregar webhooks</h3>
                    <p style="color: rgba(255, 255, 255, 0.5); font-size: 0.9rem;">Verifique o console para mais detalhes</p>
                </div>
            `;
        }
    }

    // ==================== TESTE DE WEBHOOK ====================
    async function testWebhook(webhook) {
        console.log('🧪 Testando webhook:', webhook);

        const tenantId = getTenantId();

        // Preparar payload com todos os dados do webhook para teste
        const payload = {
            tenant_id: tenantId,
            webhook_id: webhook._id || webhook.id,
            name_webhook: webhook.name_webhook,
            url_webhook: webhook.url_webhook,
            assistente_id: webhook.assistente_id,
            type_webhook: webhook.type_webhook
        };

        console.log('📤 Enviando teste de webhook:', payload);

        // Desabilitar botão de teste
        const button = event.target.closest('button');
        if (button) {
            button.disabled = true;
            button.innerHTML = `
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
                </svg>
                Testando...
            `;
        }

        try {
            const response = await fetch('https://sdr.salesdever.io/webhook/teste-de-webhook-saas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            console.log('📡 Response status:', response.status);

            const data = await response.json().catch(() => null);
            console.log('📦 Resposta do teste:', data);

            if (response.ok) {
                console.log('✅ Webhook testado com sucesso!');
                showPopup('success', 'Teste enviado!', `Webhook "${webhook.name_webhook}" foi testado com sucesso! Verifique se recebeu a notificação.`);
            } else {
                console.error('❌ Erro ao testar webhook:', data);
                showPopup('error', 'Erro no teste', data?.message || `Erro ${response.status}: Falha ao testar webhook`);
            }
        } catch (error) {
            console.error('❌ Erro ao testar webhook:', error);
            showPopup('error', 'Erro no teste', 'Não foi possível enviar o teste. Verifique sua conexão.');
        } finally {
            // Reabilitar botão de teste
            if (button) {
                button.disabled = false;
                button.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                    Testar
                `;
            }
        }
    }

    async function deleteWebhook(webhook) {
        showConfirmPopup(
            'Excluir webhook?',
            'Tem certeza que deseja excluir este webhook? Esta ação não pode ser desfeita.',
            async () => {
                const tenantId = getTenantId();

                // Preparar payload com todos os dados do webhook
                const payload = {
                    tenant_id: tenantId,
                    _id: webhook._id || webhook.id,
                    name_webhook: webhook.name_webhook,
                    url_webhook: webhook.url_webhook,
                    assistente_id: webhook.assistente_id,
                    type_webhook: webhook.type_webhook,
                    created_at: webhook.created_at
                };

                console.log('🗑️ Excluindo webhook com todos os dados:', payload);

                try {
                    const response = await fetch(`${API_BASE}/excluir_webhooks_envios`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    console.log('📦 Resposta da API de exclusão:', data);

                    if (response.ok) {
                        console.log('✅ Webhook excluído com sucesso:', webhook._id);
                        showPopup('success', 'Webhook excluído!', 'Webhook excluído com sucesso!');

                        // Aguardar 500ms antes de recarregar para garantir que o backend processou
                        setTimeout(() => {
                            console.log('🔄 Recarregando lista de webhooks...');
                            loadWebhooks();
                        }, 500);
                    } else {
                        console.error('❌ Erro ao excluir webhook:', data);
                        showPopup('error', 'Erro ao excluir webhook', data.message || 'Erro desconhecido');
                    }
                } catch (error) {
                    console.error('❌ Erro ao excluir webhook:', error);
                    showPopup('error', 'Erro ao excluir webhook', 'Verifique o console para mais detalhes');
                }
            }
        );
    }

    // ==================== EDIÇÃO DE WEBHOOK ====================
    let currentEditingWebhook = null;

    async function editWebhook(webhook) {
        console.log('✏️ Editando webhook:', webhook);
        currentEditingWebhook = webhook;

        // Preencher campos do modal
        document.getElementById('editWebhookName').value = webhook.name_webhook || '';
        document.getElementById('editWebhookUrl').value = webhook.url_webhook || '';

        // Carregar assistentes no select
        await loadAssistantsForEdit();

        // Selecionar o assistente atual
        if (webhook.assistente_id) {
            document.getElementById('editWebhookAssistant').value = webhook.assistente_id;
        }

        // Abrir modal
        document.getElementById('editWebhookModal').classList.add('active');
    }

    function closeEditModal() {
        document.getElementById('editWebhookModal').classList.remove('active');
        currentEditingWebhook = null;
    }

    async function loadAssistantsForEdit() {
        const tenantId = getTenantId();
        const select = document.getElementById('editWebhookAssistant');

        console.log('🔄 Carregando assistentes para edição...');

        try {
            const response = await fetch(`${API_BASE}/procura_assistentes_webhooks_envios`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tenant_id: tenantId })
            });

            const data = await response.json();

            // Tentar diferentes estruturas de resposta
            let assistants = null;

            if (Array.isArray(data)) {
                assistants = data;
            } else if (data.assistants && Array.isArray(data.assistants)) {
                assistants = data.assistants;
            } else if (data.data && Array.isArray(data.data)) {
                assistants = data.data;
            } else if (data.data && data.data.assistants && Array.isArray(data.data.assistants)) {
                assistants = data.data.assistants;
            }

            if (response.ok && assistants && assistants.length > 0) {
                console.log('✅ Assistentes carregados para edição:', assistants.length);

                select.innerHTML = '<option value="">Selecione um assistente</option>';
                assistants.forEach(assistant => {
                    // LOG DETALHADO para debug
                    console.log('🔍 [EDIT] Estrutura do assistente:', JSON.stringify(assistant, null, 2));

                    const option = document.createElement('option');
                    // CORRIGIDO: Tentar primeiro assistente_id (campo correto da API), depois assistant_id
                    option.value = assistant.assistente_id || assistant.assistant_id || assistant.id || assistant._id || assistant.assistantId;
                    const name = assistant.name || assistant.assistant_name || assistant.assistantName || assistant.nome || `Assistente ${option.value}`;
                    option.textContent = name;
                    select.appendChild(option);
                    console.log(`  ➡️ [EDIT] Adicionado: ${name} (ID: ${option.value})`);
                });
            } else {
                console.log('📭 Nenhum assistente encontrado');
                select.innerHTML = '<option value="">Nenhum assistente disponível</option>';
            }
        } catch (error) {
            console.error('❌ Erro ao carregar assistentes:', error);
            select.innerHTML = '<option value="">Erro ao carregar assistentes</option>';
        }
    }

    async function saveEditWebhook() {
        if (!currentEditingWebhook) {
            showPopup('error', 'Erro', 'Nenhum webhook selecionado para edição');
            return;
        }

        const name = document.getElementById('editWebhookName').value.trim();
        const url = document.getElementById('editWebhookUrl').value.trim();
        const assistantId = document.getElementById('editWebhookAssistant').value;
        const tenantId = getTenantId();

        if (!name) {
            showPopup('warning', 'Campo obrigatório', 'Por favor, insira um nome para o webhook');
            return;
        }

        if (!url) {
            showPopup('warning', 'Campo obrigatório', 'Por favor, insira uma URL de webhook');
            return;
        }

        if (!assistantId) {
            showPopup('warning', 'Campo obrigatório', 'Por favor, selecione um assistente');
            return;
        }

        const payload = {
            tenant_id: tenantId,
            webhook_id: currentEditingWebhook._id,
            name_webhook: name,
            url_webhook: url,
            assistente_id: assistantId,
            type_webhook: currentEditingWebhook.type_webhook
        };

        console.log('💾 Atualizando webhook:', payload);

        try {
            const response = await fetch(`${API_BASE}/edita_webhooks_envios`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                console.log('✅ Webhook atualizado com sucesso:', data);
                showPopup('success', 'Webhook atualizado!', 'Webhook atualizado com sucesso!');
                closeEditModal();
                loadWebhooks(); // Recarregar lista
            } else {
                console.error('❌ Erro ao atualizar webhook:', data);
                showPopup('error', 'Erro ao atualizar webhook', data.message || 'Erro desconhecido');
            }
        } catch (error) {
            console.error('❌ Erro ao atualizar webhook:', error);
            showPopup('error', 'Erro ao atualizar webhook', 'Verifique o console para mais detalhes');
        }
    }

    // Fechar modal ao clicar fora dele
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('editWebhookModal');
        if (e.target === modal) {
            closeEditModal();
        }
    });

    async function refreshWebhookLogs() {
        const tenantId = getTenantId();
        const refreshBtn = document.querySelector('.btn-refresh');

        // Adicionar classe loading para animação
        if (refreshBtn) {
            refreshBtn.classList.add('loading');
        }

        console.log('🔄 Atualizando logs de webhooks...');
        console.log('🔑 Tenant ID:', tenantId);

        try {
            const payload = { tenant_id: tenantId };
            console.log('📤 Enviando payload:', payload);

            const response = await fetch(`${API_BASE}/procura_logs-webhooks_envios`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            console.log('📡 Status da resposta:', response.status);
            console.log('📡 Status OK?', response.ok);

            // Verificar se a resposta é JSON válida
            const textResponse = await response.text();
            console.log('📄 Resposta em texto:', textResponse);

            let data;
            try {
                data = JSON.parse(textResponse);
            } catch (parseError) {
                console.error('❌ Erro ao fazer parse do JSON:', parseError);
                console.error('📄 Texto recebido:', textResponse);
                showPopup('error', 'Erro', 'A API retornou uma resposta inválida');
                renderWebhookLogs([]);
                return;
            }

            // Log completo para debug
            console.log('📦 Resposta completa da API de logs:', data);
            console.log('📦 Tipo de data:', typeof data);
            console.log('📦 Keys de data:', data && typeof data === 'object' ? Object.keys(data) : 'Não é objeto');

            // Tentar diferentes estruturas de resposta
            let logs = null;

            if (Array.isArray(data)) {
                logs = data;
                console.log('📋 Logs encontrados diretamente no array:', logs.length, 'logs');
            } else if (data.logs && Array.isArray(data.logs)) {
                logs = data.logs;
                console.log('📋 Logs encontrados em data.logs:', logs.length, 'logs');
            } else if (data.data && Array.isArray(data.data)) {
                logs = data.data;
                console.log('📋 Logs encontrados em data.data:', logs.length, 'logs');
            } else if (data.data && data.data.logs && Array.isArray(data.data.logs)) {
                logs = data.data.logs;
                console.log('📋 Logs encontrados em data.data.logs:', logs.length, 'logs');
            } else if (data.message) {
                console.log('📭 Mensagem da API:', data.message);
            }

            if (logs && logs.length > 0) {
                console.log('✅ Total de logs recebidos da API:', logs.length);
                console.log('📋 LISTA COMPLETA DE LOGS:');
                logs.forEach((log, idx) => {
                    console.log(`  ${idx + 1}. Log completo:`, log);
                    console.log(`     - webhook_name: ${log.webhook_name || log.name_webhook || 'N/A'}`);
                    console.log(`     - status: ${log.status}`);
                    console.log(`     - status_code: ${log.status_code || log.statusCode}`);
                    console.log(`     - url: ${log.webhook_url || log.url_webhook}`);
                    console.log(`     - timestamp: ${log.timestamp || log.created_at || log.createdAt}`);
                });

                // FILTRAR logs inválidos ou vazios - agora menos restritivo
                const validLogs = logs.filter(log => {
                    // Log é válido se tem pelo menos alguma informação relevante
                    const hasWebhookName = log.webhook_name || log.name_webhook || log.name;
                    const hasUrl = log.webhook_url || log.url_webhook || log.url;
                    const hasTimestamp = log.timestamp || log.created_at || log.createdAt || log.criado_em || log.date || log.updatedAt;

                    // Aceitar se tiver nome OU url, E algum tipo de timestamp
                    const isValid = (hasWebhookName || hasUrl) && hasTimestamp;

                    if (!isValid) {
                        console.warn('⚠️ Log inválido removido:', log);
                    }

                    return isValid;
                });

                console.log('✅ Total de logs VÁLIDOS após filtrar:', validLogs.length);

                if (validLogs.length > 0) {
                    renderWebhookLogs(validLogs);
                } else {
                    console.log('📭 Nenhum log válido após filtrar');
                    renderWebhookLogs([]);
                }
            } else if (response.ok) {
                console.log('📭 API retornou sucesso mas sem logs');
                renderWebhookLogs([]);
            } else {
                console.error('❌ Erro na resposta da API:', response.status, data);
                showPopup('error', 'Erro na API', `Status: ${response.status} - ${data.message || 'Erro desconhecido'}`);
                renderWebhookLogs([]);
            }
        } catch (error) {
            console.error('❌ Erro ao carregar logs:', error);
            console.error('❌ Stack trace:', error.stack);
            showPopup('error', 'Erro', `Erro ao buscar logs: ${error.message}`);
            renderWebhookLogs([]);
        } finally {
            // Remover classe loading após completar
            if (refreshBtn) {
                setTimeout(() => {
                    refreshBtn.classList.remove('loading');
                }, 500);
            }
        }
    }

    function renderWebhookLogs(logs) {
        const container = document.getElementById('webhookLogsContainer');

        // Atualizar estatísticas
        const total = logs.length;
        const success = logs.filter(log => {
            const httpStatus = log.status_code || log.statusCode || log.http_status;
            const successFlag = log.success || log.is_success || log.isSuccess;

            // Considerar sucesso por padrão, a menos que tenha erro explícito
            let isSuccess = true;

            // Marcar falha se tiver status HTTP de erro
            if (httpStatus && (httpStatus >= 400 || httpStatus === 0)) {
                isSuccess = false;
            }

            // Se tiver flag explícita, usar ela
            if (typeof successFlag === 'boolean') {
                isSuccess = successFlag;
            }

            // Status específicos que indicam falha
            if (log.status && (log.status.toLowerCase().includes('error') ||
                              log.status.toLowerCase().includes('failed') ||
                              log.status.toLowerCase().includes('falha'))) {
                isSuccess = false;
            }

            return isSuccess;
        }).length;
        const failed = total - success;

        document.getElementById('logsTotalSent').textContent = total;
        document.getElementById('logsSuccess').textContent = success;
        document.getElementById('logsFailed').textContent = failed;

        if (logs.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">📋</div>
                    <p style="color: rgba(255, 255, 255, 0.6);">Nenhum log de webhook disponível</p>
                </div>
            `;
            return;
        }

        // Renderizar logs individuais
        let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';

        logs.forEach((log, index) => {
            console.log(`🔍 Renderizando log ${index + 1}:`, log);

            // Extrair campos do log com múltiplas alternativas
            const webhookName = log.webhook_name || log.name_webhook || log.name || log.webhookName || 'Webhook sem nome';
            const url = log.webhook_url || log.url_webhook || log.url || log.webhookUrl || log.endpoint || 'URL não informada';
            const timestamp = log.timestamp || log.created_at || log.createdAt || log.criado_em || log.date || log.updatedAt || log.updated_at || new Date().toISOString();

            // Extrair número do lead - pode estar no log direto ou no request_body
            let numeroLead = log.enviado_para || log.phone || log.phone_number || log.client_phone ||
                           log.numero || log.to || log.contact_phone || log.phoneNumber || log.numero_lead;

            // Se não achou no log direto, tentar dentro do request_body ou payload
            if (!numeroLead) {
                const requestBody = log.request || log.request_body || log.requestBody || log.payload || log.data;
                if (requestBody && typeof requestBody === 'object') {
                    numeroLead = requestBody.enviado_para || requestBody.phone || requestBody.phone_number ||
                                requestBody.client_phone || requestBody.numero || requestBody.to ||
                                requestBody.contact_phone || requestBody.phoneNumber;
                }
                // Tentar também dentro de um possível campo nested
                if (!numeroLead && requestBody && typeof requestBody === 'string') {
                    try {
                        const parsed = JSON.parse(requestBody);
                        numeroLead = parsed.enviado_para || parsed.phone || parsed.phone_number || parsed.numero;
                    } catch (e) {
                        // Ignora erro de parse
                    }
                }
            }

            numeroLead = numeroLead || 'Não informado';

            // O tipo vem do campo "status" ou "event" ou "type"
            const tipoStatus = log.event_type || log.type || log.event || log.status || log.action || '';
            let tipoEvento = tipoStatus || 'Não especificado';

            // Determinar resultado baseado no status_code HTTP ou campo success
            const httpStatus = log.status_code || log.statusCode || log.http_status || log.responseStatus || 0;
            const successFlag = log.success || log.is_success || log.isSuccess;

            let isSuccess = true; // Por padrão, considerar como sucesso se o log existe

            // Só marcar como falha se houver status code de erro
            if (httpStatus && (httpStatus >= 400 || httpStatus === 0)) {
                isSuccess = false;
            }

            // Se tiver flag explícita de sucesso, usar ela
            if (typeof successFlag === 'boolean') {
                isSuccess = successFlag;
            }

            // Status específicos que indicam falha
            if (log.status && (log.status.toLowerCase().includes('error') ||
                              log.status.toLowerCase().includes('failed') ||
                              log.status.toLowerCase().includes('falha'))) {
                isSuccess = false;
            }

            const statusColor = isSuccess ? '#10b981' : '#ef4444';
            const statusText = isSuccess ? 'ENVIADO' : 'FALHA';
            const statusIcon = isSuccess ? '✓' : '✗';

            // Formatar data
            let formattedDate = '';
            try {
                const date = new Date(timestamp);
                if (!isNaN(date.getTime())) {
                    formattedDate = date.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } else {
                    formattedDate = timestamp;
                }
            } catch (e) {
                formattedDate = timestamp;
            }

            html += `
                <div style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 16px; border-left: 4px solid ${statusColor};">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: start;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-weight: 600; font-size: 1.1rem; color: #fff;">${webhookName}</span>
                                <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                                    ${statusIcon} ${statusText}
                                </span>
                            </div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; display: grid; gap: 6px;">
                                <div><strong style="color: rgba(255, 255, 255, 0.5);">URL:</strong> ${url}</div>
                                <div><strong style="color: rgba(255, 255, 255, 0.5);">Data/Hora:</strong> ${formattedDate}</div>
                                <div><strong style="color: rgba(255, 255, 255, 0.5);">Tipo:</strong> ${tipoEvento}</div>
                                ${httpStatus ? `<div><strong style="color: rgba(255, 255, 255, 0.5);">Status HTTP:</strong> ${httpStatus}</div>` : ''}
                            </div>
                        </div>
                        <div style="color: rgba(255, 255, 255, 0.8); font-weight: 600; font-size: 1.2rem; text-align: right;">
                            ${numeroLead}
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
        console.log('✅ Logs renderizados com sucesso! Total:', logs.length);
    }

    // ==================== EXPORT CSV ====================
    function exportCSV() {
        console.log('📥 Exportando dados para CSV...');
        showPopup('info', 'Em desenvolvimento', 'Funcionalidade de exportação em desenvolvimento');
    }
</script>

</body>
</html>
