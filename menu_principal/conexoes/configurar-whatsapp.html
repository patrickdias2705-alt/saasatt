<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
   <link rel="shortcut icon" type="image/png" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
   <link rel="apple-touch-icon" href="https://imagens-zipline.hgabnb.easypanel.host/u/2FsJTY.png">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar WhatsApp - Salesdever</title>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Raleway', sans-serif;
    }
    
    body {
      background: #0a0420;
      min-height: 100vh;
      color: #ffffff;
      overflow-x: hidden;
      overflow-y: auto;
      position: relative;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: radial-gradient(circle at 20% 50%, rgba(165, 148, 255, 0.08) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.06) 0%, transparent 50%);
      animation: backgroundFloat 20s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes backgroundFloat {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(3%, 3%); }
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(165, 148, 255, 0.3);
      border-radius: 50%;
      border-top-color: #A594FF;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .progress-circle {
      transform: rotate(-90deg);
    }
    
    .progress-path {
      stroke-dasharray: 157;
      stroke-dashoffset: 157;
      transition: stroke-dashoffset 1s linear;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 3rem 2.5rem 4rem 2.5rem;
      position: relative;
      z-index: 1;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      margin-bottom: 3.5rem;
      animation: fadeInDown 0.6s ease;
    }

    .title {
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #ffffff, #A594FF);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 400;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2.5rem;
      padding: 2rem 2.5rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.15);
      gap: 2rem;
      flex-wrap: wrap;
      box-shadow: 0 8px 32px rgba(165, 148, 255, 0.15),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
      animation: fadeInUp 0.6s ease 0.1s both;
    }

    .section-info h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 10px rgba(165, 148, 255, 0.3);
    }

    .section-info p {
      color: rgba(255, 255, 255, 0.65);
      font-size: 0.95rem;
    }
    
    .create-instance-btn {
      background: linear-gradient(135deg, #A594FF, #764ba2);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 1rem;
      font-family: 'Raleway', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 0.625rem;
      box-shadow: 0 4px 20px rgba(165, 148, 255, 0.5);
      position: relative;
      overflow: hidden;
      white-space: nowrap;
      border: 1px solid rgba(165, 148, 255, 0.3);
    }

    .create-instance-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: translateX(-100%);
      transition: transform 0.6s;
    }

    .create-instance-btn:hover::before {
      transform: translateX(100%);
    }

    .create-instance-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 35px rgba(165, 148, 255, 0.7);
    }

    .glass-effect {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 8px 32px rgba(165, 148, 255, 0.15),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .glass-effect:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 40px rgba(165, 148, 255, 0.25);
    }

    .instances-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .instance-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 8px 32px rgba(165, 148, 255, 0.15);
      border-radius: 1.5rem;
      padding: 2rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      animation: fadeInUp 0.6s ease both;
    }

    .instance-card:nth-child(1) { animation-delay: 0.1s; }
    .instance-card:nth-child(2) { animation-delay: 0.2s; }
    .instance-card:nth-child(3) { animation-delay: 0.3s; }
    .instance-card:nth-child(4) { animation-delay: 0.4s; }
    .instance-card:nth-child(5) { animation-delay: 0.5s; }
    .instance-card:nth-child(6) { animation-delay: 0.6s; }

    .instance-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #A594FF, #667EEA);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }

    .instance-card:hover::before {
      transform: scaleX(1);
    }

    .instance-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 15px 40px rgba(165, 148, 255, 0.3);
      border-color: rgba(165, 148, 255, 0.3);
    }

    .instance-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .instance-name-wrapper {
      flex: 1;
      min-width: 0;
    }

    .instance-name {
      font-size: 1.35rem;
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 0.4rem;
      word-wrap: break-word;
      line-height: 1.3;
      text-shadow: 0 2px 10px rgba(165, 148, 255, 0.3);
    }

    .instance-phone {
      color: rgba(255, 255, 255, 0.65);
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }

    .instance-status {
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .status-connected {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.25), rgba(34, 197, 94, 0.15));
      color: #22C55E;
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .status-disconnected {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(239, 68, 68, 0.15));
      color: #EF4444;
      border: 1px solid rgba(239, 68, 68, 0.4);
    }

    .status-connecting {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.25), rgba(251, 191, 36, 0.15));
      color: #FBBF24;
      border: 1px solid rgba(251, 191, 36, 0.4);
    }

    .instance-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: rgba(165, 148, 255, 0.08);
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
      border: 1px solid rgba(165, 148, 255, 0.15);
    }

    .instance-meta svg {
      color: #A594FF;
      flex-shrink: 0;
    }

    .instance-meta-text {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
    }

    /* Badge de Configura√ß√£o */
    .instance-config-badge {
      background: linear-gradient(135deg, rgba(165, 148, 255, 0.15), rgba(102, 126, 234, 0.1));
      border: 1.5px solid rgba(165, 148, 255, 0.3);
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      margin: 1.25rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .config-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .config-item-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      color: #A594FF;
    }

    .config-item-label {
      color: rgba(255, 255, 255, 0.7);
      font-weight: 600;
      flex-shrink: 0;
    }

    .config-item-value {
      color: #A594FF;
      font-weight: 700;
      flex: 1;
      text-align: right;
    }

    .instance-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .instance-btn {
      flex: 1;
      min-width: 140px;
      padding: 0.9rem 1.25rem;
      border: none;
      border-radius: 0.85rem;
      font-family: 'Raleway', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      position: relative;
      overflow: hidden;
    }

    .instance-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: translateX(-100%);
      transition: transform 0.5s;
    }

    .instance-btn:hover::before {
      transform: translateX(100%);
    }

    .btn-connect {
      background: linear-gradient(135deg, #22C55E, #16A34A);
      color: white;
      border: 1px solid rgba(34, 197, 94, 0.3);
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
    }

    .btn-connect:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(34, 197, 94, 0.5);
    }

    .btn-editar {
      background: linear-gradient(135deg, rgba(165, 148, 255, 0.3), rgba(102, 126, 234, 0.2));
      color: #A594FF;
      border: 1px solid rgba(165, 148, 255, 0.5);
      box-shadow: 0 4px 15px rgba(165, 148, 255, 0.2);
    }

    .btn-editar:hover {
      transform: translateY(-2px);
      background: linear-gradient(135deg, rgba(165, 148, 255, 0.4), rgba(102, 126, 234, 0.3));
      box-shadow: 0 6px 25px rgba(165, 148, 255, 0.4);
    }

    .btn-delete {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.15));
      color: #EF4444;
      border: 1px solid rgba(239, 68, 68, 0.4);
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
    }

    .btn-delete:hover {
      transform: translateY(-2px);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.25));
      box-shadow: 0 6px 25px rgba(239, 68, 68, 0.4);
    }

    .btn-templates {
      background: linear-gradient(135deg, rgba(24, 119, 242, 0.3), rgba(24, 119, 242, 0.2));
      color: #1877F2;
      border: 1px solid rgba(24, 119, 242, 0.5);
      box-shadow: 0 4px 15px rgba(24, 119, 242, 0.2);
    }

    .btn-templates:hover {
      transform: translateY(-2px);
      background: linear-gradient(135deg, rgba(24, 119, 242, 0.4), rgba(24, 119, 242, 0.3));
      box-shadow: 0 6px 25px rgba(24, 119, 242, 0.4);
    }


    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
      backdrop-filter: blur(20px);
      border-radius: 1.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: fadeInUp 0.6s ease 0.2s both;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 0.75rem;
    }

    .empty-state p {
      color: rgba(255, 255, 255, 0.5);
      font-size: 1rem;
      max-width: 450px;
      margin: 0 auto;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      z-index: 10000;
      animation: fadeIn 0.3s ease;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1332, #0f0a20);
      border-radius: 1.5rem;
      padding: 2.5rem;
      max-width: 500px;
      width: 100%;
      border: 1px solid rgba(165, 148, 255, 0.3);
      box-shadow: 0 25px 70px rgba(165, 148, 255, 0.3);
      animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .modal-title {
      font-size: 1.75rem;
      font-weight: 800;
      background: linear-gradient(135deg, #ffffff, #A594FF);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.25rem;
      flex-shrink: 0;
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.4);
      transform: rotate(90deg);
    }

    .form-group {
      margin-bottom: 1.75rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.65rem;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-input {
      width: 100%;
      padding: 0.9rem 1.25rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.75rem;
      color: white;
      font-size: 1rem;
      font-family: 'Raleway', sans-serif;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.12);
      border-color: #A594FF;
      box-shadow: 0 0 0 3px rgba(165, 148, 255, 0.2);
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }

    .modal-btn {
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 0.85rem;
      font-family: 'Raleway', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      height: 52px;
      flex: 1;
      min-width: 0;
    }

    /* Bot√µes menores para API Oficial */
    .modal-btn-small {
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 0.75rem;
      font-family: 'Raleway', sans-serif;
      font-weight: 700;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      height: 44px;
      min-width: 120px;
      flex-shrink: 0;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #A594FF, #667EEA);
      color: white;
      box-shadow: 0 4px 15px rgba(165, 148, 255, 0.4);
    }

    .modal-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(165, 148, 255, 0.6);
    }

    .modal-btn-secondary {
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-btn-secondary:hover {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .modal-btn-help {
      background: linear-gradient(135deg, rgba(165, 148, 255, 0.15), rgba(102, 126, 234, 0.15));
      border: 1.5px solid rgba(165, 148, 255, 0.3);
      color: #A594FF;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .modal-btn-help:hover {
      background: linear-gradient(135deg, rgba(165, 148, 255, 0.25), rgba(102, 126, 234, 0.25));
      border-color: rgba(165, 148, 255, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(165, 148, 255, 0.25);
    }


    /* Estilos para o modal de ajuda */
    .help-modal-content {
      background: linear-gradient(135deg, rgba(20, 20, 35, 0.95), rgba(30, 30, 50, 0.95));
      border: 1px solid rgba(165, 148, 255, 0.2);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 1.25rem;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      color: rgba(255, 255, 255, 0.9);
    }

    .help-modal-header {
      background: linear-gradient(135deg, rgba(165, 148, 255, 0.1), rgba(102, 126, 234, 0.1));
      border-bottom: 1px solid rgba(165, 148, 255, 0.2);
      padding: 1.5rem 2rem;
      border-radius: 1.25rem 1.25rem 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .help-modal-title {
      color: #A594FF;
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .help-modal-body {
      padding: 2rem;
      max-height: 70vh;
      overflow-y: auto;
    }

    .help-section {
      margin-bottom: 2rem;
    }

    .help-section-title {
      color: #A594FF;
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 2px solid rgba(165, 148, 255, 0.2);
      padding-bottom: 0.5rem;
    }

    .help-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .help-list li {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.9);
    }

    .help-list li strong {
      color: #A594FF;
      font-weight: 600;
    }

    .help-step {
      background: linear-gradient(135deg, rgba(165, 148, 255, 0.08), rgba(102, 126, 234, 0.08));
      border: 1px solid rgba(165, 148, 255, 0.2);
      border-left: 4px solid #A594FF;
      border-radius: 0.75rem;
      padding: 1.5rem;
      margin: 1rem 0;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .help-step-title {
      color: #A594FF;
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .help-step-content {
      color: rgba(255, 255, 255, 0.85);
      line-height: 1.6;
    }

    .help-step-content p {
      margin: 0.5rem 0;
    }

    .help-link {
      color: #A594FF;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .help-link:hover {
      color: #667EEA;
      text-decoration: underline;
    }

    .help-tips {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .help-tips-title {
      color: #22C55E;
      font-size: 1.125rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .help-tips ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .help-tips li {
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.6;
      margin-bottom: 0.75rem;
      padding-left: 1.5rem;
      position: relative;
    }

    .help-tips li:before {
      content: "‚úì";
      position: absolute;
      left: 0;
      color: #22C55E;
      font-weight: bold;
      font-size: 1.1rem;
    }

    /* QR Code Modal Styles */
    .qr-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 0;
    }

    .qr-code-wrapper {
      background: white;
      padding: 1.5rem;
      border-radius: 1.25rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-placeholder {
      width: 280px;
      height: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(165, 148, 255, 0.1), rgba(102, 126, 234, 0.1));
      border-radius: 0.75rem;
      color: rgba(165, 148, 255, 0.6);
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
      padding: 2rem;
    }

    .qr-instructions {
      text-align: center;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.95rem;
      line-height: 1.6;
      max-width: 400px;
    }

    .qr-instructions strong {
      color: #A594FF;
      font-weight: 700;
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      background: rgba(165, 148, 255, 0.1);
      border: 1px solid rgba(165, 148, 255, 0.3);
      border-radius: 0.75rem;
      margin-top: 1.5rem;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #FBBF24;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading-spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(165, 148, 255, 0.3);
      border-radius: 50%;
      border-top-color: #A594FF;
      animation: spin 0.8s linear infinite;
    }

    /* Scrollbar Styles */
    .modal-content::-webkit-scrollbar {
      width: 6px;
    }

    .modal-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background: rgba(165, 148, 255, 0.5);
      border-radius: 10px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
      background: rgba(165, 148, 255, 0.7);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 2rem 1.5rem 4rem 1.5rem;
      }

      .title {
        font-size: 1.75rem;
      }

      .section-header {
        padding: 1.5rem;
        flex-direction: column;
        align-items: stretch;
      }

      .create-instance-btn {
        width: 100%;
        justify-content: center;
      }

      .instances-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .instance-header {
        flex-direction: column;
      }

      .instance-status {
        align-self: flex-start;
      }

      .instance-actions {
        flex-direction: column;
      }

      .instance-btn {
        min-width: 100%;
      }

      .modal-content {
        padding: 2rem 1.5rem;
        margin: 1rem;
      }

      .modal-actions {
        flex-direction: column;
      }

      .qr-code-wrapper {
        padding: 1rem;
      }

      .qr-placeholder {
        width: 240px;
        height: 240px;
      }

      .time-options-grid {
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }

      .config-modal-content {
        margin: 1rem;
        padding: 2rem 1.5rem;
      }
    }

    @media (max-width: 480px) {
      .title {
        font-size: 1.5rem;
      }

      .subtitle {
        font-size: 0.9rem;
      }

      .modal-title {
        font-size: 1.4rem;
      }
    }

    /* Custom Popup Styles */
    .custom-popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 4, 32, 0.9);
      backdrop-filter: blur(8px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .custom-popup-overlay.active {
      display: flex;
    }

    .custom-popup-content {
      background: linear-gradient(135deg, rgba(26, 20, 60, 0.95), rgba(15, 10, 40, 0.95));
      border: 1px solid rgba(165, 148, 255, 0.3);
      border-radius: 1.5rem;
      padding: 2.5rem;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(165, 148, 255, 0.1);
      animation: popupSlideIn 0.4s ease-out;
      text-align: center;
    }

    @keyframes popupSlideIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .custom-popup-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      animation: iconBounce 0.6s ease-out;
    }

    @keyframes iconBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .custom-popup-icon.warning {
      background: rgba(255, 159, 67, 0.15);
      border: 2px solid rgba(255, 159, 67, 0.4);
      color: #ff9f43;
    }

    .custom-popup-icon.error {
      background: rgba(255, 107, 107, 0.15);
      border: 2px solid rgba(255, 107, 107, 0.4);
      color: #ff6b6b;
    }

    .custom-popup-icon.success {
      background: rgba(75, 255, 159, 0.15);
      border: 2px solid rgba(75, 255, 159, 0.4);
      color: #4bff9f;
    }

    .custom-popup-icon.info {
      background: rgba(165, 148, 255, 0.15);
      border: 2px solid rgba(165, 148, 255, 0.4);
      color: #A594FF;
    }

    .custom-popup-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #ffffff;
    }

    .custom-popup-message {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .custom-popup-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .custom-popup-btn {
      padding: 0.875rem 2rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 120px;
    }

    .custom-popup-btn-primary {
      background: linear-gradient(135deg, #A594FF, #667EEA);
      color: white;
      box-shadow: 0 4px 15px rgba(165, 148, 255, 0.4);
    }

    .custom-popup-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(165, 148, 255, 0.6);
    }

    .custom-popup-btn-danger {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    }

    .custom-popup-btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
    }

    .custom-popup-btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .custom-popup-btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    /* Estilos para o Response Time (usando radio buttons) */
    .response-time-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .response-time-option {
      position: relative;
    }

    .response-time-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }

    .response-time-label {
      display: block;
      background: rgba(165, 148, 255, 0.08);
      border: 2px solid rgba(165, 148, 255, 0.25);
      border-radius: 0.875rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }

    .response-time-option input[type="radio"]:checked + .response-time-label {
      background: linear-gradient(135deg, rgba(0, 217, 165, 0.3), rgba(0, 186, 143, 0.25));
      border-color: #00D9A5;
      box-shadow: 0 0 0 3px rgba(0, 217, 165, 0.3);
      position: relative;
    }

    .response-time-option input[type="radio"]:checked + .response-time-label::after {
      content: '‚úì';
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 1.5rem;
      height: 1.5rem;
      background: #00D9A5;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
      font-weight: 700;
    }

    .response-time-label:hover {
      border-color: rgba(165, 148, 255, 0.5);
      background: rgba(165, 148, 255, 0.12);
      transform: translateY(-2px);
    }

    /* Select style */
    .form-select {
      width: 100%;
      padding: 1rem 1.25rem;
      background: rgba(165, 148, 255, 0.08);
      border: 1.5px solid rgba(165, 148, 255, 0.3);
      border-radius: 0.875rem;
      color: #ffffff;
      font-size: 1rem;
      font-family: 'Raleway', sans-serif;
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23A594FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1.25rem center;
      padding-right: 3rem;
    }

    .form-select:hover {
      border-color: rgba(165, 148, 255, 0.5);
      background: rgba(165, 148, 255, 0.12);
    }

    .form-select:focus {
      outline: none;
      border-color: #A594FF;
      box-shadow: 0 0 0 3px rgba(165, 148, 255, 0.2);
      background: rgba(165, 148, 255, 0.15);
    }

    .form-select option {
      background: #1a1135;
      color: #ffffff;
      padding: 1rem;
      font-weight: 500;
    }

    /* Loading state para o bot√£o de criar inst√¢ncia */
    .config-loading {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
    }

    /* Popup de Alerta para inst√¢ncias n√£o configuradas */
    .alert-popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 4, 32, 0.9);
      backdrop-filter: blur(10px);
      z-index: 10001;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    .alert-popup-overlay.active {
      display: flex;
    }

    .alert-popup-content {
      background: linear-gradient(135deg, #1a1135, #0f0820);
      border: 2px solid rgba(255, 159, 67, 0.5);
      border-radius: 1.5rem;
      padding: 2.5rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 25px 70px rgba(255, 159, 67, 0.3),
                  0 0 60px rgba(255, 159, 67, 0.2);
      animation: alertSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      text-align: center;
    }

    @keyframes alertSlideIn {
      from {
        opacity: 0;
        transform: scale(0.85) translateY(-30px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .alert-icon {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      animation: alertIconPulse 1.5s ease-in-out infinite;
    }

    @keyframes alertIconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .alert-title {
      font-size: 1.75rem;
      font-weight: 800;
      color: #ff9f43;
      margin-bottom: 1rem;
      text-shadow: 0 2px 15px rgba(255, 159, 67, 0.4);
    }

    .alert-message {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 2rem;
      line-height: 1.7;
    }

    .alert-instances-list {
      background: rgba(255, 159, 67, 0.08);
      border: 1px solid rgba(255, 159, 67, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      max-height: 250px;
      overflow-y: auto;
    }

    .alert-instance-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      margin-bottom: 0.75rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.95);
    }

    .alert-instance-item:last-child {
      margin-bottom: 0;
    }

    .alert-btn {
      width: 100%;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #ff9f43, #ff7b29);
      color: white;
      border: none;
      border-radius: 0.875rem;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(255, 159, 67, 0.4);
    }

    .alert-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(255, 159, 67, 0.6);
    }

    /* NOVO: Estilo para loading do QR Code */
    .qr-loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      color: rgba(165, 148, 255, 0.8);
      font-weight: 600;
    }

    .qr-loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(165, 148, 255, 0.2);
      border-radius: 50%;
      border-top-color: #A594FF;
      animation: spin 1s linear infinite;
    }

    /* Estilos para o slider de tempo de resposta */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="range"]::-webkit-slider-track {
      height: 8px;
      background: linear-gradient(90deg, rgba(165, 148, 255, 0.3) 0%, rgba(165, 148, 255, 0.8) 20%, rgba(165, 148, 255, 0.3) 100%);
      border-radius: 5px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #A594FF, #667EEA);
      border: 2px solid rgba(255, 255, 255, 0.8);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(165, 148, 255, 0.5);
      transition: all 0.3s ease;
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(165, 148, 255, 0.7);
    }

    input[type="range"]::-moz-range-track {
      height: 8px;
      background: linear-gradient(90deg, rgba(165, 148, 255, 0.3) 0%, rgba(165, 148, 255, 0.8) 20%, rgba(165, 148, 255, 0.3) 100%);
      border-radius: 5px;
      border: none;
    }

    input[type="range"]::-moz-range-thumb {
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #A594FF, #667EEA);
      border: 2px solid rgba(255, 255, 255, 0.8);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(165, 148, 255, 0.5);
      transition: all 0.3s ease;
    }

    input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(165, 148, 255, 0.7);
    }

    /* Estilos para o Modal de Sele√ß√£o de API */
    .api-option:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    }

    /* API Oficial - efeito hover */
    .api-option:first-child:hover {
      border-color: rgba(24, 119, 242, 0.6);
      background: linear-gradient(135deg, rgba(24, 119, 242, 0.25), rgba(24, 119, 242, 0.12));
      box-shadow: 0 8px 35px rgba(24, 119, 242, 0.4);
    }

    /* API N√£o Oficial - efeito hover */
    .api-option:last-child:hover {
      border-color: rgba(165, 148, 255, 0.6);
      background: linear-gradient(135deg, rgba(165, 148, 255, 0.25), rgba(165, 148, 255, 0.12));
      box-shadow: 0 8px 35px rgba(165, 148, 255, 0.4);
    }

    /* Anima√ß√£o para os cards de sele√ß√£o */
    .api-option {
      transform-origin: center;
    }

    .api-option:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* Responsivo para modal de sele√ß√£o */
    @media (max-width: 768px) {
      .api-option {
        padding: 1.5rem;
      }

      .api-option h3 {
        font-size: 1.1rem;
      }

      .api-option p {
        font-size: 0.85rem;
      }

      /* Responsivo para modal de templates */
      #templatesModal .modal-content {
        max-width: 95%;
        margin: 1rem;
        padding: 1.5rem;
      }

      #templatesModal .modal-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
      }

      #templatesModal .modal-title {
        font-size: 1.4rem;
        text-align: center;
      }

      /* Header do template em mobile */
      #templatesModal .modal-content > div:nth-child(2) {
        padding: 1rem !important;
      }

      /* Estado vazio em mobile */
      #templatesContainer > div {
        padding: 2rem 1rem !important;
      }

      /* Bot√µes em mobile */
      #templatesContainer button {
        width: 100%;
        justify-content: center;
      }
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="header fade-in">
      <h1 class="title">Gerenciar WhatsApp</h1>
      <p class="subtitle">Gerencie suas inst√¢ncias do WhatsApp conectadas</p>
    </div>

    <div class="section-header">
      <div class="section-info">
        <h2>Suas Inst√¢ncias</h2>
        <p>Visualize e gerencie todas as suas conex√µes do WhatsApp</p>
      </div>
      <button class="create-instance-btn" onclick="openCreateInstanceModal()">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Nova Inst√¢ncia
      </button>
    </div>

    <div class="instances-grid" id="instancesGrid">
      <!-- Instances will be loaded here dynamically -->
    </div>

    <div class="empty-state" id="emptyState" style="display: none;">
      <div class="empty-state-icon">üì±</div>
      <h3>Nenhuma inst√¢ncia criada</h3>
      <p>Crie sua primeira inst√¢ncia do WhatsApp para come√ßar a gerenciar suas conversas</p>
    </div>
  </div>

  <!-- Modal de Sele√ß√£o de API -->
  <div class="modal-overlay" id="apiSelectionModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Escolha o Tipo de API</h2>
        <button class="modal-close" onclick="closeApiSelectionModal()">√ó</button>
      </div>
      <div style="padding: 1rem 0;">
        <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 2rem; text-align: center; font-size: 1rem; line-height: 1.5;">
          Selecione qual tipo de API do WhatsApp voc√™ deseja usar para esta inst√¢ncia
        </p>

        <div style="display: grid; gap: 1.5rem;">
          <!-- API Oficial -->
          <div class="api-option" onclick="selectApiType('official')" style="background: linear-gradient(135deg, rgba(24, 119, 242, 0.15), rgba(24, 119, 242, 0.08)); border: 2px solid rgba(24, 119, 242, 0.3); border-radius: 1rem; padding: 2rem; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
            <div style="display: flex; align-items: center; gap: 1.5rem;">
              <!-- Logo Meta/Facebook -->
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #1877F2, #0C5AA6); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                  <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                </svg>
              </div>
              <div style="flex: 1;">
                <h3 style="color: #1877F2; font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem;">API Oficial</h3>
                <p style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; line-height: 1.4; margin: 0;">
                  Use a API oficial do WhatsApp Business da Meta. Mais est√°vel e confi√°vel.
                </p>
                <div style="margin-top: 0.75rem;">
                  <span style="background: rgba(24, 119, 242, 0.2); color: #1877F2; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.8rem; font-weight: 600;">Recomendado</span>
                </div>
              </div>
            </div>
          </div>

          <!-- API N√£o Oficial -->
          <div class="api-option" onclick="selectApiType('unofficial')" style="background: linear-gradient(135deg, rgba(165, 148, 255, 0.15), rgba(165, 148, 255, 0.08)); border: 2px solid rgba(165, 148, 255, 0.3); border-radius: 1rem; padding: 2rem; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;">
            <div style="display: flex; align-items: center; gap: 1.5rem;">
              <!-- √çcone Evolution/API N√£o Oficial -->
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #A594FF, #667EEA); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
              </div>
              <div style="flex: 1;">
                <h3 style="color: #A594FF; font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem;">API N√£o Oficial</h3>
                <p style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; line-height: 1.4; margin: 0;">
                  Use a API n√£o oficial. Mais flex√≠vel e com recursos avan√ßados.
                </p>
                <div style="margin-top: 0.75rem;">
                  <span style="background: rgba(165, 148, 255, 0.2); color: #A594FF; padding: 0.25rem 0.75rem; border-radius: 0.5rem; font-size: 0.8rem; font-weight: 600;">Atual</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para criar inst√¢ncia n√£o oficial (mant√©m funcionalidade atual) -->
  <div class="modal-overlay" id="createInstanceModal">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2 class="modal-title">Nova Inst√¢ncia - API N√£o Oficial</h2>
        <button class="modal-close" onclick="closeCreateInstanceModal()">√ó</button>
      </div>
      <form onsubmit="createInstance(event)">
        <div class="form-group">
          <label class="form-label" for="instanceName">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
            Nome da Inst√¢ncia
          </label>
          <input
            type="text"
            id="instanceName"
            class="form-input"
            placeholder="Ex: Vendas, Suporte, Marketing..."
            required
          />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="instancePhone">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
            </svg>
            N√∫mero do WhatsApp
          </label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <div style="padding: 0.75rem 1rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.75rem; color: rgba(255,255,255,0.7); font-weight: 600; font-size: 1rem;">
              +55
            </div>
            <input
              type="text"
              id="instancePhone"
              class="form-input"
              placeholder="11 98765-4321"
              required
              style="flex: 1;"
            />
          </div>
          <small style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 0.5rem; display: block;">Digite apenas DDD e n√∫mero</small>
        </div>

        <div class="form-group">
          <label class="form-label">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            Quer que a IA responda o WhatsApp?
          </label>
          <div class="response-time-options">
            <div class="response-time-option">
              <input type="radio" name="aiResponse" id="aiYes" value="yes" onchange="toggleAssistantSelect(true)">
              <label for="aiYes" class="response-time-label">Sim</label>
            </div>
            <div class="response-time-option">
              <input type="radio" name="aiResponse" id="aiNo" value="no" onchange="toggleAssistantSelect(false)" checked>
              <label for="aiNo" class="response-time-label">N√£o</label>
            </div>
          </div>
        </div>

        <div class="form-group" id="assistantSelectGroup" style="display: none;">
          <label class="form-label" for="assistantSelect">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            Selecione o Assistente
          </label>
          <select id="assistantSelect" class="form-select">
            <option value="">Carregando...</option>
          </select>
        </div>

        <div class="form-group" id="followUpGroup" style="display: none;">
          <label class="form-label" for="followUpSelect">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
            Qual follow up (opcional)
          </label>
          <select id="followUpSelect" class="form-select" onchange="handleFollowUpSelection()">
            <option value="">Nenhum follow up</option>
          </select>
        </div>

        <div class="form-group" id="responseTimeGroup" style="display: none;">
          <label class="form-label">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
            Tempo de Resposta Inicial
          </label>
          <div style="margin-top: 1rem; padding: 1.5rem; background: rgba(165, 148, 255, 0.08); border: 1px solid rgba(165, 148, 255, 0.2); border-radius: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <svg width="20" height="20" fill="#A594FF" viewBox="0 0 24 24">
                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
              </svg>
              <span style="color: rgba(255, 255, 255, 0.7); font-weight: 600;">Aguardar antes de iniciar o primeiro contato</span>
            </div>

            <input
              type="range"
              id="responseTimeSlider"
              name="responseTime"
              min="0"
              max="10"
              value="2"
              step="1"
              style="width: 100%; height: 8px; background: linear-gradient(90deg, rgba(165, 148, 255, 0.3) 0%, rgba(165, 148, 255, 0.8) 20%, rgba(165, 148, 255, 0.3) 100%); border-radius: 5px; outline: none; -webkit-appearance: none;"
              oninput="updateResponseTimeDisplay(this.value)"
            />

            <div style="display: flex; justify-content: center; margin-top: 1rem;">
              <div style="background: linear-gradient(135deg, rgba(165, 148, 255, 0.25), rgba(102, 126, 234, 0.2)); border: 1.5px solid rgba(165, 148, 255, 0.4); border-radius: 1rem; padding: 1rem 1.5rem; text-align: center; min-width: 120px;">
                <div id="responseTimeValue" style="font-size: 1.5rem; font-weight: 700; color: #A594FF; margin-bottom: 0.25rem;">2 minutos</div>
                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Recomendado: 1-3 minutos para melhor taxa de resposta</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-secondary" onclick="closeCreateInstanceModal()">
            Cancelar
          </button>
          <button type="submit" class="modal-btn modal-btn-primary" id="createInstanceBtn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Criar Inst√¢ncia
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para criar inst√¢ncia API Oficial -->
  <div class="modal-overlay" id="createOfficialInstanceModal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Nova Inst√¢ncia - API Oficial</h2>
        <button class="modal-close" onclick="closeCreateOfficialInstanceModal()">√ó</button>
      </div>
      <form onsubmit="createOfficialInstance(event)">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: linear-gradient(135deg, rgba(24, 119, 242, 0.1), rgba(24, 119, 242, 0.05)); border: 1px solid rgba(24, 119, 242, 0.2); border-radius: 1rem;">
          <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #1877F2, #0C5AA6); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </div>
          <div>
            <h3 style="color: #1877F2; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">WhatsApp Business API</h3>
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin: 0;">Configure sua inst√¢ncia usando a API oficial da Meta</p>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="officialInstanceName">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
            Nome
          </label>
          <input
            type="text"
            id="officialInstanceName"
            class="form-input"
            placeholder="Ex: Vendas, Suporte, Marketing..."
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="officialInstancePhone">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
            </svg>
            N√∫mero
          </label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <div style="padding: 0.75rem 1rem; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.75rem; color: rgba(255,255,255,0.7); font-weight: 600; font-size: 1rem;">
              +55
            </div>
            <input
              type="text"
              id="officialInstancePhone"
              class="form-input"
              placeholder="11 98765-4321"
              required
              style="flex: 1;"
            />
          </div>
          <small style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 0.5rem; display: block;">Digite apenas DDD e n√∫mero</small>
        </div>


        <div class="modal-actions">
          <button type="button" onclick="abrirModalAjuda()" class="modal-btn-small modal-btn-help" title="Clique aqui para obter ajuda sobre como coletar as informa√ß√µes necess√°rias">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Ajuda
          </button>
          <button type="button" class="modal-btn-small modal-btn-secondary" onclick="closeCreateOfficialInstanceModal()">
            Cancelar
          </button>
          <button type="button" class="modal-btn-small modal-btn-primary" onclick="proceedToOfficialStep2()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            Pr√≥ximo
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para segunda etapa da API Oficial - Credenciais Meta -->
  <div class="modal-overlay" id="createOfficialInstanceStep2Modal">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2 class="modal-title">Nova Inst√¢ncia - P√°gina 2/3</h2>
        <button class="modal-close" onclick="closeOfficialStep2Modal()">√ó</button>
      </div>
      <form>
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: linear-gradient(135deg, rgba(24, 119, 242, 0.1), rgba(24, 119, 242, 0.05)); border: 1px solid rgba(24, 119, 242, 0.2); border-radius: 1rem;">
          <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #1877F2, #0C5AA6); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </div>
          <div>
            <h3 style="color: #1877F2; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">Credenciais da Meta</h3>
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin: 0;">Configure as informa√ß√µes da API do WhatsApp Business</p>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="businessIdStep2">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            Business ID
          </label>
          <input
            type="text"
            id="businessIdStep2"
            class="form-input"
            placeholder="Ex: 123456789012345"
            autocomplete="off"
            required
          />
          <small style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 0.5rem; display: block;">ID da sua conta WhatsApp Business no Meta Business Manager</small>
        </div>

        <div class="form-group">
          <label class="form-label" for="numberIdStep2">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
            </svg>
            Number ID
          </label>
          <input
            type="text"
            id="numberIdStep2"
            class="form-input"
            placeholder="Ex: 987654321098765"
            required
          />
          <small style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 0.5rem; display: block;">ID do n√∫mero de telefone no WhatsApp Business</small>
        </div>

        <div class="form-group">
          <label class="form-label" for="metaTokenStep2">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
            </svg>
            Token do Meta
          </label>
          <input
            type="password"
            id="metaTokenStep2"
            class="form-input"
            placeholder="Ex: EAAF..."
            autocomplete="new-password"
            required
          />
          <small style="color: rgba(255,255,255,0.5); font-size: 0.85rem; margin-top: 0.5rem; display: block;">Token de acesso permanente da Meta Business API</small>
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn-small modal-btn-secondary" onclick="backToOfficialStep1()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Voltar
          </button>
          <button type="button" class="modal-btn-small modal-btn-primary" onclick="proceedToOfficialStep3()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            Pr√≥ximo
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para terceira etapa da API Oficial - Assistente -->
  <div class="modal-overlay" id="createOfficialInstanceStep3Modal">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2 class="modal-title">Nova Inst√¢ncia - P√°gina 3/3</h2>
        <button class="modal-close" onclick="closeOfficialStep3Modal()">√ó</button>
      </div>
      <form onsubmit="createOfficialInstance(event)">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: linear-gradient(135deg, rgba(24, 119, 242, 0.1), rgba(24, 119, 242, 0.05)); border: 1px solid rgba(24, 119, 242, 0.2); border-radius: 1rem;">
          <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #1877F2, #0C5AA6); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </div>
          <div>
            <h3 style="color: #1877F2; font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem;">Configura√ß√£o do Assistente</h3>
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin: 0;">Configure se a IA ir√° responder automaticamente no WhatsApp</p>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            Quer que a IA responda o WhatsApp?
          </label>
          <div class="response-time-options">
            <div class="response-time-option">
              <input type="radio" name="officialAiResponse" id="officialAiYes" value="yes" onchange="toggleOfficialAssistantSelect(true)">
              <label for="officialAiYes" class="response-time-label">Sim</label>
            </div>
            <div class="response-time-option">
              <input type="radio" name="officialAiResponse" id="officialAiNo" value="no" onchange="toggleOfficialAssistantSelect(false)" checked>
              <label for="officialAiNo" class="response-time-label">N√£o</label>
            </div>
          </div>
        </div>

        <div class="form-group" id="officialAssistantSelectGroup" style="display: none;">
          <label class="form-label" for="officialAssistantSelect">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            Selecione o Assistente
          </label>
          <select id="officialAssistantSelect" class="form-select">
            <option value="">Carregando...</option>
          </select>
        </div>

        <div class="form-group" id="officialFollowUpGroup" style="display: none;">
          <label class="form-label" for="officialFollowUpSelect">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
            Qual follow up (opcional)
          </label>
          <select id="officialFollowUpSelect" class="form-select" onchange="handleOfficialFollowUpSelection()">
            <option value="">Nenhum follow up</option>
          </select>
        </div>

        <div class="form-group" id="officialResponseTimeGroup" style="display: none;">
          <label class="form-label">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
            Tempo de Resposta Inicial
          </label>
          <div style="margin-top: 1rem; padding: 1.5rem; background: rgba(165, 148, 255, 0.08); border: 1px solid rgba(165, 148, 255, 0.2); border-radius: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <svg width="20" height="20" fill="#A594FF" viewBox="0 0 24 24">
                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
              </svg>
              <span style="color: rgba(255, 255, 255, 0.7); font-weight: 600;">Aguardar antes de iniciar o primeiro contato</span>
            </div>

            <input
              type="range"
              id="officialResponseTimeSlider"
              name="officialResponseTime"
              min="0"
              max="10"
              value="2"
              step="1"
              style="width: 100%; height: 8px; background: linear-gradient(90deg, rgba(165, 148, 255, 0.3) 0%, rgba(165, 148, 255, 0.8) 20%, rgba(165, 148, 255, 0.3) 100%); border-radius: 5px; outline: none; -webkit-appearance: none;"
              oninput="updateOfficialResponseTimeDisplay(this.value)"
            />

            <div style="display: flex; justify-content: center; margin-top: 1rem;">
              <div style="background: linear-gradient(135deg, rgba(165, 148, 255, 0.25), rgba(102, 126, 234, 0.2)); border: 1.5px solid rgba(165, 148, 255, 0.4); border-radius: 1rem; padding: 1rem 1.5rem; text-align: center; min-width: 120px;">
                <div id="officialResponseTimeValue" style="font-size: 1.5rem; font-weight: 700; color: #A594FF; margin-bottom: 0.25rem;">2 minutos</div>
                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Recomendado: 1-3 minutos para melhor taxa de resposta</div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn-small modal-btn-secondary" onclick="backToOfficialStep2()">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Voltar
          </button>
          <button type="submit" class="modal-btn-small modal-btn-primary" id="createOfficialInstanceStep3Btn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Criar Inst√¢ncia
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o -->
  <div class="modal-overlay" id="editInstanceModal">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2 class="modal-title">Editar Configura√ß√£o</h2>
        <button class="modal-close" onclick="closeEditInstanceModal()">√ó
        </button>
      </div>
      <form onsubmit="editInstance(event)">
        <div class="form-group">
          <label class="form-label">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            Quer que a IA responda o WhatsApp?
          </label>
          <div class="response-time-options">
            <div class="response-time-option">
              <input type="radio" name="editAiResponse" id="editAiYes" value="yes" onchange="toggleEditAssistantSelect(true)">
              <label for="editAiYes" class="response-time-label">Sim</label>
            </div>
            <div class="response-time-option">
              <input type="radio" name="editAiResponse" id="editAiNo" value="no" onchange="toggleEditAssistantSelect(false)">
              <label for="editAiNo" class="response-time-label">N√£o</label>
            </div>
          </div>
        </div>

        <div class="form-group" id="editAssistantSelectGroup">
          <label class="form-label" for="editAssistantSelect">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
            </svg>
            Selecione o Assistente
          </label>
          <select id="editAssistantSelect" class="form-select">
            <option value="">Carregando...</option>
          </select>
        </div>


        <div class="form-group" id="editResponseTimeGroup">
          <label class="form-label">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
            </svg>
            Tempo de Resposta Inicial
          </label>
          <div style="margin-top: 1rem; padding: 1.5rem; background: rgba(165, 148, 255, 0.08); border: 1px solid rgba(165, 148, 255, 0.2); border-radius: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <svg width="20" height="20" fill="#A594FF" viewBox="0 0 24 24">
                <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
              </svg>
              <span style="color: rgba(255, 255, 255, 0.7); font-weight: 600;">Aguardar antes de iniciar o primeiro contato</span>
            </div>

            <input
              type="range"
              id="editResponseTimeSlider"
              name="editResponseTime"
              min="0"
              max="10"
              value="2"
              step="1"
              style="width: 100%; height: 8px; background: linear-gradient(90deg, rgba(165, 148, 255, 0.3) 0%, rgba(165, 148, 255, 0.8) 20%, rgba(165, 148, 255, 0.3) 100%); border-radius: 5px; outline: none; -webkit-appearance: none;"
              oninput="updateEditResponseTimeDisplay(this.value)"
            />

            <div style="display: flex; justify-content: center; margin-top: 1rem;">
              <div style="background: linear-gradient(135deg, rgba(165, 148, 255, 0.25), rgba(102, 126, 234, 0.2)); border: 1.5px solid rgba(165, 148, 255, 0.4); border-radius: 1rem; padding: 1rem 1.5rem; text-align: center; min-width: 120px;">
                <div id="editResponseTimeValue" style="font-size: 1.5rem; font-weight: 700; color: #A594FF; margin-bottom: 0.25rem;">2 minutos</div>
                <div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Recomendado: 1-3 minutos para melhor taxa de resposta</div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group" id="editFollowUpGroup">
          <label class="form-label" for="editFollowUpSelect">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
            Qual follow up (opcional)
          </label>
          <select id="editFollowUpSelect" class="form-select" onchange="handleEditFollowUpSelection()">
            <option value="">Nenhum follow up</option>
          </select>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-secondary" onclick="closeEditInstanceModal()">
            Cancelar
          </button>
          <button type="submit" class="modal-btn modal-btn-primary" id="editInstanceBtn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Salvar Altera√ß√µes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Ajuda para API Oficial -->
  <div class="modal-overlay" id="modalAjudaApiOficial">
    <div class="help-modal-content" style="max-width: 900px; max-height: 90vh;">
      <div class="help-modal-header">
        <h2 class="help-modal-title">
          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
          </svg>
          Guia: Como obter as informa√ß√µes da API Oficial
        </h2>
        <button class="modal-close" onclick="fecharModalAjuda()">√ó</button>
      </div>

      <div class="help-modal-body">
        <div class="help-section">
          <h3 class="help-section-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            O que voc√™ precisa coletar:
          </h3>
          <ul class="help-list">
            <li><strong>Nome da Inst√¢ncia:</strong> Um nome para identificar sua conex√£o (ex: "WhatsApp Loja")</li>
            <li><strong>N√∫mero do WhatsApp:</strong> O n√∫mero do WhatsApp Business (com c√≥digo do pa√≠s)</li>
            <li><strong>Business ID:</strong> ID do seu neg√≥cio no Facebook</li>
            <li><strong>Number ID:</strong> ID do n√∫mero no WhatsApp Business</li>
            <li><strong>Token do Meta:</strong> Token de acesso da API do WhatsApp</li>
          </ul>
        </div>

        <div class="help-section">
          <h3 class="help-section-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Passo a passo para coletar as informa√ß√µes:
          </h3>

          <div class="help-step">
            <div class="help-step-title">
              <span style="background: #A594FF; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.875rem;">1</span>
              Acesse o Facebook Business Manager
            </div>
            <div class="help-step-content">
              <p>‚Ä¢ V√° para <a href="https://business.facebook.com" target="_blank" class="help-link">business.facebook.com</a></p>
              <p>‚Ä¢ Fa√ßa login com sua conta Facebook</p>
            </div>
          </div>

          <div class="help-step">
            <div class="help-step-title">
              <span style="background: #A594FF; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.875rem;">2</span>
              Localize seu Business ID
            </div>
            <div class="help-step-content">
              <p>‚Ä¢ No painel principal, clique em <strong>"Configura√ß√µes da empresa"</strong></p>
              <p>‚Ä¢ Na aba <strong>"Informa√ß√µes da empresa"</strong>, voc√™ ver√° o <strong>ID da empresa</strong></p>
              <p>‚Ä¢ Este √© o seu <strong>Business ID</strong> - anote-o</p>
            </div>
          </div>

          <div class="help-step">
            <div class="help-step-title">
              <span style="background: #A594FF; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.875rem;">3</span>
              Configure o WhatsApp Business API
            </div>
            <div class="help-step-content">
              <p>‚Ä¢ No menu lateral, clique em <strong>"WhatsApp"</strong> ou <strong>"Contas do WhatsApp Business"</strong></p>
              <p>‚Ä¢ Selecione sua conta do WhatsApp Business</p>
              <p>‚Ä¢ Clique em <strong>"N√∫meros de telefone"</strong></p>
              <p>‚Ä¢ Voc√™ ver√° o <strong>Number ID</strong> - anote-o</p>
            </div>
          </div>

          <div class="help-step">
            <div class="help-step-title">
              <span style="background: #A594FF; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.875rem;">4</span>
              Gere o Token de Acesso
            </div>
            <div class="help-step-content">
              <p>‚Ä¢ V√° para <a href="https://developers.facebook.com" target="_blank" class="help-link">developers.facebook.com</a></p>
              <p>‚Ä¢ Clique em <strong>"Meus Apps"</strong> e selecione seu app</p>
              <p>‚Ä¢ No menu lateral, clique em <strong>"WhatsApp" > "API Setup"</strong></p>
              <p>‚Ä¢ Na se√ß√£o <strong>"Access Tokens"</strong>, clique em <strong>"Generate Token"</strong></p>
              <p>‚Ä¢ Copie o <strong>Token</strong> gerado - este √© tempor√°rio</p>
            </div>
          </div>

          <div class="help-step">
            <div class="help-step-title">
              <span style="background: #A594FF; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.875rem;">5</span>
              Para Token Permanente (Recomendado)
            </div>
            <div class="help-step-content">
              <p>‚Ä¢ Na mesma p√°gina, role at√© <strong>"Business Portfolio"</strong></p>
              <p>‚Ä¢ Clique em <strong>"Generate Token"</strong> ao lado do seu business</p>
              <p>‚Ä¢ Selecione as permiss√µes necess√°rias <strong>(whatsapp_business_management)</strong></p>
              <p>‚Ä¢ Copie o token gerado - este √© permanente</p>
            </div>
          </div>
        </div>

        <div class="help-tips">
          <h3 class="help-tips-title">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Dicas importantes:
          </h3>
          <ul>
            <li>Mantenha seu token seguro - n√£o compartilhe com terceiros</li>
            <li>O Number ID √© diferente do n√∫mero de telefone</li>
            <li>Certifique-se de que o WhatsApp Business est√° verificado</li>
            <li>Teste a configura√ß√£o antes de usar em produ√ß√£o</li>
          </ul>
        </div>

        <div class="modal-actions" style="margin-top: 2rem; text-align: center;">
          <button type="button" class="modal-btn modal-btn-primary" onclick="fecharModalAjuda()" style="width: 100%; max-width: none;">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Entendi, vou coletar as informa√ß√µes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div class="modal-overlay" id="qrCodeModal">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2 class="modal-title">Conectar WhatsApp</h2>
        <button class="modal-close" onclick="closeQRCodeModal()">√ó</button>
      </div>
      <div class="qr-container">
        <div class="qr-code-wrapper">
          <div class="qr-placeholder" id="qrCodeImage">
            <div class="spinner"></div>
          </div>
        </div>
        
        <!-- Timer do QR Code -->
        <div id="qrCodeTimer" style="display: none; text-align: center; margin: 1rem 0; padding: 0.625rem; background: rgba(165, 148, 255, 0.1); border-radius: 0.75rem; border: 1px solid rgba(165, 148, 255, 0.2);"></div>
        
        <div style="text-align: center; margin: 1rem 0;">
          <div style="display: inline-flex; align-items: center; gap: 0.625rem; background: rgba(165, 148, 255, 0.15); padding: 0.625rem 1.25rem; border-radius: 0.75rem; border: 1px solid rgba(165, 148, 255, 0.3);">
            <svg width="20" height="20" fill="none" stroke="#A594FF" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            <span style="color: #A594FF; font-weight: 600; font-size: 0.875rem;">Abra o WhatsApp no seu celular</span>
          </div>
        </div>
        
        <div class="qr-instructions" style="display: flex; flex-direction: column; gap: 0.625rem; text-align: left; background: rgba(255, 255, 255, 0.05); padding: 1.25rem; border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1);">
          <div style="display: flex; align-items: start; gap: 0.625rem;">
            <div style="min-width: 22px; height: 22px; background: linear-gradient(135deg, #A594FF, #667EEA); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.7rem; flex-shrink: 0;">1</div>
            <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.85rem; margin: 0; line-height: 1.4;">Toque em <strong>Mais op√ß√µes</strong> ou <strong>Configura√ß√µes</strong></p>
          </div>
          <div style="display: flex; align-items: start; gap: 0.625rem;">
            <div style="min-width: 22px; height: 22px; background: linear-gradient(135deg, #A594FF, #667EEA); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.7rem; flex-shrink: 0;">2</div>
            <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.85rem; margin: 0; line-height: 1.4;">Selecione <strong>Aparelhos conectados</strong></p>
          </div>
          <div style="display: flex; align-items: start; gap: 0.625rem;">
            <div style="min-width: 22px; height: 22px; background: linear-gradient(135deg, #A594FF, #667EEA); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.7rem; flex-shrink: 0;">3</div>
            <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.85rem; margin: 0; line-height: 1.4;">Toque em <strong>Conectar um aparelho</strong> e escaneie este c√≥digo</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o -->

  <script>
    let currentInstanceId = null;
    let currentInstanceName = '';
    let currentEditInstance = null; // Inst√¢ncia sendo editada
    let currentTemplateInstance = null; // Inst√¢ncia atual para templates
    let qrCodeCheckInterval = null;
    let userData = null;
    let instancesData = [];
    let instanceConfigurations = {}; // Armazena as configura√ß√µes por instance_id
    let assistantsData = []; // Dados dos assistentes
    let followUpsData = []; // Dados dos follow-ups
    let alertShownThisSession = false; // Flag para n√£o mostrar alerta v√°rias vezes

    // Load instances on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[DEBUG] ========== P√ÅGINA CARREGADA ==========');
      console.log('[DEBUG] ‚è∞ Timestamp:', new Date().toISOString());
      console.log('[DEBUG] üîÑ Iniciando carregamento de dados...');
      
      const userLoaded = loadUserData();
      console.log('[DEBUG] üë§ Usu√°rio carregado?', userLoaded);
      
      if (userLoaded) {
        console.log('[DEBUG] üì° Chamando loadInstances...');
        loadInstances();
        // Carregar assistentes ao abrir a p√°gina
        loadAssistants();
      } else {
        console.error('[DEBUG] ‚ùå Falha ao carregar usu√°rio - n√£o ser√° poss√≠vel carregar inst√¢ncias');
      }
    });

    function loadUserData() {
      try {
        console.log('[DEBUG] üîç Tentando carregar userData do localStorage...');
        
        // Tentar m√∫ltiplas chaves do localStorage
        let storedData = localStorage.getItem('userData') || 
                        localStorage.getItem('finalSelections') ||
                        localStorage.getItem('user') ||
                        localStorage.getItem('loginData');
        
        console.log('[DEBUG] üì¶ Dados encontrados:', storedData ? 'SIM' : 'N√ÉO');
        
        if (!storedData) {
          console.error('[DEBUG] ‚ùå Nenhum dado encontrado no localStorage');
          console.log('[DEBUG] üìã Tentando buscar dados individuais...');
          
          // Tentar pegar dados individuais do localStorage
          const email = localStorage.getItem('userEmail');
          const tenantId = localStorage.getItem('tenant_id');
          
          if (email && tenantId) {
            console.log('[DEBUG] ‚úÖ Dados individuais encontrados, montando userData');
            userData = {
              user: {
                email: email,
                tenant_id: tenantId,
                id: localStorage.getItem('user_id') || tenantId
              }
            };
            console.log('[DEBUG] ‚úÖ userData montado:', userData);
            return true;
          }
          
          console.error('[DEBUG] ‚ùå Dados de usu√°rio n√£o encontrados.');
          return false;
        }

        const parsed = JSON.parse(storedData);
        console.log('[DEBUG] ‚úÖ Dados parseados:', parsed);
        
        // Tentar extrair tenant_id de m√∫ltiplas estruturas poss√≠veis
        const tenantId = parsed?.tenant_id || 
                        parsed?.user?.tenant_id || 
                        parsed?.userData?.tenant_id ||
                        parsed?.[0]?.tenant_id ||
                        parsed?.[0]?.user?.tenant_id;
        
        const userEmail = parsed?.email ||
                         parsed?.user?.email ||
                         parsed?.userData?.email ||
                         parsed?.login ||
                         parsed?.[0]?.email;
        
        console.log('[DEBUG] üîë Tenant ID extra√≠do:', tenantId);
        console.log('[DEBUG] üìß Email extra√≠do:', userEmail);
        
        if (!tenantId) {
          console.error('[DEBUG] ‚ùå tenant_id n√£o encontrado na estrutura');
          return false;
        }
        
        // Criar estrutura normalizada
        userData = {
          user: {
            tenant_id: tenantId,
            email: userEmail || 'usuario@email.com',
            id: parsed?.id || parsed?.user?.id || tenantId,
            nome: parsed?.nome || parsed?.user?.nome || userEmail
          }
        };
        
        console.log('[DEBUG] ‚úÖ userData normalizado:', userData);
        return true;
        
      } catch (error) {
        console.error('[DEBUG] ‚ùå Erro ao carregar dados do usu√°rio:', error);
        console.error('[DEBUG] üìõ Stack:', error.stack);
        return false;
      }
    }

    async function loadInstances() {
      console.log('[DEBUG] ========== INICIANDO loadInstances ==========');
      console.log('[DEBUG] userData:', userData);
      
      if (!userData || !userData.user || !userData.user.tenant_id) {
        console.error('[DEBUG] ‚ùå userData inv√°lido ou tenant_id ausente');
        return;
      }

      try {
        console.log('[DEBUG] üåê Fazendo requisi√ß√£o para o webhook...');
        
        const payload = { tenant_id: userData.user.tenant_id };
        console.log('[DEBUG] üì¶ Payload:', JSON.stringify(payload));
        
        const response = await fetch('https://sdr.salesdever.io/webhook/saas-buscar-instancias', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });
        
        console.log('[DEBUG] üì° Resposta recebida. Status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        console.log('[DEBUG] ‚úÖ Dados recebidos:', data);
        
        instancesData = Array.isArray(data) ? data : (data.instances || [data]);
        
        displayInstances(instancesData);

        // Verificar inst√¢ncias N√ÉO CONECTADAS - REMOVIDO: agora √© feito apenas no dashboard
        // checkDisconnectedInstances(instancesData);
        
      } catch (error) {
        console.error('[DEBUG] ‚ùå Erro ao carregar inst√¢ncias:', error);
        document.getElementById('emptyState').style.display = 'block';
      }
    }

    function displayInstances(instances) {
      console.log('[DEBUG] üé® Exibindo inst√¢ncias:', instances);
      const grid = document.getElementById('instancesGrid');
      const emptyState = document.getElementById('emptyState');

      if (!instances || instances.length === 0) {
        grid.innerHTML = '';
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      // FILTRAR INST√ÇNCIAS N√ÉO DELETADAS (soft delete)
      const activeInstances = instances.filter(instance => {
        // Mostrar apenas inst√¢ncias onde 'deletado' √© false/null/undefined
        const isDeleted = instance.deletado === true || instance.deletado === 'true';
        if (isDeleted) {
          console.log('[DEBUG] üóëÔ∏è Ocultando inst√¢ncia deletada:', instance.instance_name);
        }
        return !isDeleted;
      });

      console.log('[DEBUG] üìä Total de inst√¢ncias:', instances.length, '| Ativas:', activeInstances.length);

      // Verificar se h√° inst√¢ncias ativas para exibir
      if (activeInstances.length === 0) {
        grid.innerHTML = '';
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      // TEM INST√ÇNCIAS ATIVAS: mostrar grid e esconder empty state
      grid.style.display = 'grid';
      emptyState.style.display = 'none';

      grid.innerHTML = activeInstances.map(instance => {
        const phoneFormatted = instance.phone_number ? 
          formatPhoneNumber(instance.phone_number) : 
          'N√∫mero n√£o dispon√≠vel';
        
        // Verificar status - aceitar v√°rias varia√ß√µes
        const isConnected = instance.status === 'connected' ||
                           instance.status === 'open' ||
                           instance.status === 'conectada' ||
                           instance.status === 'conectado' ||
                           instance.status === 'CONECTADA' ||
                           instance.status === 'CONECTADO';

        // DEBUG: Log completo da inst√¢ncia para identificar campos
        console.log('[DEBUG INST√ÇNCIA COMPLETA]', instance.instance_name, ':', instance);

        // Verificar se √© API Oficial
        // Verificar m√∫ltiplas possibilidades de nomes de campos
        const instanceKey = instance.instance_key;
        const apiType = instance.api_type || instance.type || instance.apiType || instance.instance_type;

        const isOfficialApi = apiType === 'OFICIAL' ||
                              apiType === 'oficial' ||
                              apiType === 'OFFICIAL' ||
                              instanceKey === 'BUSSINES' ||
                              instanceKey === 'OFICIAL' ||
                              (!instanceKey && !apiType);

        console.log('[API TYPE]', instance.instance_name, '‚Üí', isOfficialApi ? 'OFICIAL' : 'N√ÉO OFICIAL', '| api_type:', apiType, '| instance_key:', instanceKey);
        
        const statusClass = isConnected ? 'status-connected' :
                          instance.status === 'connecting' ? 'status-connecting' :
                          'status-disconnected';

        // Para API Oficial: "Configurado" em vez de "Conectado"
        const statusText = isConnected ?
                          (isOfficialApi ? 'Configurado' : 'Conectada') :
                          (instance.status === 'connecting' ? 'Conectando' : 'Desconectada');

        const formattedDate = formatDate(instance.created_at);

        // Badge de configura√ß√£o
        let configBadge = '';

        // Log completo da inst√¢ncia para debug
        console.log('[RENDERIZAR CARD] ===================================');
        console.log('[RENDERIZAR CARD] Inst√¢ncia:', instance.instance_name);
        console.log('[RENDERIZAR CARD] Todos os campos:', {
          ai_will_respond: instance.ai_will_respond,
          ativo: instance.ativo,
          configurado: instance.configurado,
          assistente_voz: instance.assistente_voz,
          id_assistente: instance.id_assistente
        });

        // Verificar se IA est√° respondendo - VERIFICAR M√öLTIPLOS CAMPOS
        // PRIORIDADE: ativo > ai_will_respond > configurado
        let aiWillRespond = false;

        if (instance.ativo !== undefined && instance.ativo !== null) {
          // Campo "ativo" do banco (string 'true' ou 'false')
          aiWillRespond = instance.ativo === true || instance.ativo === 'true';
          console.log('[RENDERIZAR CARD] Usando campo "ativo":', instance.ativo, '‚Üí resultado:', aiWillRespond);
        } else if (instance.ai_will_respond !== undefined && instance.ai_will_respond !== null) {
          // Campo ai_will_respond (boolean)
          aiWillRespond = instance.ai_will_respond === true || instance.ai_will_respond === 'true';
          console.log('[RENDERIZAR CARD] Usando campo "ai_will_respond":', instance.ai_will_respond, '‚Üí resultado:', aiWillRespond);
        } else if (instance.configurado !== undefined && instance.configurado !== null) {
          // Campo configurado (fallback)
          aiWillRespond = instance.configurado === true || instance.configurado === 'true';
          console.log('[RENDERIZAR CARD] Usando campo "configurado":', instance.configurado, '‚Üí resultado:', aiWillRespond);
        }

        console.log('[RENDERIZAR CARD] üéØ aiWillRespond FINAL:', aiWillRespond);

        // Verificar se tem assistente configurado
        const assistenteName = instance.assistente_voz || instance.assistant_name || instance.assistente_nome;
        const hasAssistant = !!(assistenteName && assistenteName.trim() !== '');

        console.log('[RENDERIZAR CARD] Assistente:', assistenteName, '| hasAssistant:', hasAssistant);

        // L√ìGICA CORRIGIDA: Mostrar assistente SOMENTE se aiWillRespond for true E tiver assistente
        if (aiWillRespond && hasAssistant) {
          // IA EST√Å RESPONDENDO - Mostrar assistente
          console.log('[RENDERIZAR CARD] ‚úÖ Mostrando assistente:', assistenteName);
          configBadge = `
            <div class="instance-config-badge">
              <div class="config-item">
                <svg class="config-item-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                </svg>
                <span class="config-item-label">Assistente:</span>
                <span class="config-item-value">${assistenteName}</span>
              </div>
            </div>
          `;
        } else if (!aiWillRespond) {
          // IA N√ÉO EST√Å RESPONDENDO - Mostrar mensagens desativadas (COR ROXA NEUTRA)
          console.log('[RENDERIZAR CARD] ‚ö™ Mostrando mensagens desativadas');
          configBadge = `
            <div class="instance-config-badge">
              <div class="config-item">
                <svg class="config-item-icon" fill="currentColor" viewBox="0 0 24 24" style="color: rgba(165, 148, 255, 0.6);">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm1-13h-2v6h2zm0 8h-2v2h-2z"/>
                </svg>
                <span class="config-item-label">Status:</span>
                <span class="config-item-value" style="color: rgba(165, 148, 255, 0.8);">Mensagens desativadas</span>
              </div>
            </div>
          `;
        } else {
          // Caso de configura√ß√£o incompleta (aiWillRespond true mas sem assistente)
          console.log('[RENDERIZAR CARD] ‚ö†Ô∏è Configura√ß√£o incompleta - n√£o mostrando badge');
        }
        console.log('[RENDERIZAR CARD] ===================================');

        return `
          <div class="instance-card">
            <div class="instance-header">
              <div class="instance-name-wrapper">
                <div class="instance-name">${instance.instance_name || 'Sem Nome'}</div>
                <div class="instance-phone">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
                  </svg>
                  ${phoneFormatted}
                </div>
              </div>
              <span class="instance-status ${statusClass}">${statusText}</span>
            </div>
            
            <div class="instance-meta">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <span class="instance-meta-text">Criada em ${formattedDate}</span>
            </div>
            
            ${configBadge}
            
            <div class="instance-actions">
              ${!isConnected && !isOfficialApi ? `
                <button class="instance-btn btn-connect" onclick="connectInstance('${instance.instance_name}', '${instance.id}')">
                  <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                  Conectar
                </button>
              ` : ''}
              ${isOfficialApi && isConnected ? `
                <button class="instance-btn btn-templates" onclick="openTemplatesModal('${instance.instance_name}', '${instance.id}')">
                  <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                  </svg>
                  Templates
                </button>
              ` : ''}
              ${isConnected ? `
                <button class="instance-btn btn-editar" onclick="openEditInstanceModal('${instance.id}')">
                  <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  Editar
                </button>
              ` : ''}
              <button class="instance-btn btn-delete" onclick="confirmDeleteInstance('${instance.instance_name}', '${instance.id}')">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Excluir
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function formatPhoneNumber(phoneNumber) {
      if (!phoneNumber) return 'N√∫mero n√£o informado';
      
      let phone = phoneNumber.toString();
      
      // Remover + se j√° existir no in√≠cio
      if (phone.startsWith('+')) {
        phone = phone.substring(1);
      }
      
      // Formatar n√∫mero brasileiro
      if (phone.length === 13 && phone.startsWith('55')) {
        const area = phone.substring(2, 4);
        const number = phone.substring(4);
        return `+55 ${area} ${number.substring(0, 5)}-${number.substring(5)}`;
      } else if (phone.length === 12 && phone.startsWith('55')) {
        const area = phone.substring(2, 4);
        const number = phone.substring(4);
        return `+55 ${area} ${number.substring(0, 4)}-${number.substring(4)}`;
      }
      
      // Se j√° come√ßar com +, n√£o adiciona outro
      if (phoneNumber.toString().startsWith('+')) {
        return phoneNumber.toString();
      }
      
      return `+${phone}`;
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      
      const date = new Date(dateString);
      return date.toLocaleDateString('pt-BR') + ' √†s ' + date.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    function toggleAssistantSelect(show) {
      const assistantGroup = document.getElementById('assistantSelectGroup');
      const assistantSelect = document.getElementById('assistantSelect');
      const responseTimeGroup = document.getElementById('responseTimeGroup');
      const followUpGroup = document.getElementById('followUpGroup');

      if (show) {
        assistantGroup.style.display = 'block';
        assistantSelect.setAttribute('required', 'required');
        followUpGroup.style.display = 'block';
        responseTimeGroup.style.display = 'none';
        // Carregar follow-ups quando IA for habilitada
        loadFollowUps();
      } else {
        assistantGroup.style.display = 'none';
        assistantSelect.removeAttribute('required');
        responseTimeGroup.style.display = 'none';
        followUpGroup.style.display = 'none';
        // Resetar slider para valor padr√£o
        const slider = document.getElementById('responseTimeSlider');
        if (slider) {
          slider.value = 2;
          updateResponseTimeDisplay(2);
        }
      }
    }

    function handleFollowUpSelection() {
      const followUpSelect = document.getElementById('followUpSelect');
      const responseTimeGroup = document.getElementById('responseTimeGroup');

      if (followUpSelect.value && followUpSelect.value !== '') {
        // Usu√°rio selecionou um follow-up, mostrar tempo de resposta
        responseTimeGroup.style.display = 'block';
      } else {
        // Usu√°rio escolheu "Nenhum follow up", esconder tempo de resposta
        responseTimeGroup.style.display = 'none';
      }
    }

    function toggleEditAssistantSelect(show) {
      const assistantGroup = document.getElementById('editAssistantSelectGroup');
      const assistantSelect = document.getElementById('editAssistantSelect');
      const responseTimeGroup = document.getElementById('editResponseTimeGroup');
      const followUpGroup = document.getElementById('editFollowUpGroup');

      if (show) {
        assistantGroup.style.display = 'block';
        assistantSelect.setAttribute('required', 'required');
        followUpGroup.style.display = 'block';
        responseTimeGroup.style.display = 'none';
        // Carregar follow-ups quando IA for habilitada no edit
        loadFollowUps();
      } else {
        assistantGroup.style.display = 'none';
        assistantSelect.removeAttribute('required');
        responseTimeGroup.style.display = 'none';
        followUpGroup.style.display = 'none';
        // Resetar slider para valor padr√£o
        const slider = document.getElementById('editResponseTimeSlider');
        if (slider) {
          slider.value = 2;
          updateEditResponseTimeDisplay(2);
        }
      }
    }

    function handleEditFollowUpSelection() {
      const followUpSelect = document.getElementById('editFollowUpSelect');
      const responseTimeGroup = document.getElementById('editResponseTimeGroup');

      if (followUpSelect.value && followUpSelect.value !== '') {
        // Usu√°rio selecionou um follow-up, mostrar tempo de resposta
        responseTimeGroup.style.display = 'block';
      } else {
        // Usu√°rio escolheu "Nenhum follow up", esconder tempo de resposta
        responseTimeGroup.style.display = 'none';
      }
    }

    // Fun√ß√£o para atualizar o display do tempo de resposta no modal de cria√ß√£o
    function updateResponseTimeDisplay(value) {
      const displayElement = document.getElementById('responseTimeValue');
      if (displayElement) {
        const pluralText = value == 1 ? 'minuto' : 'minutos';
        displayElement.textContent = value + ' ' + pluralText;
      }
    }

    // Fun√ß√£o para atualizar o display do tempo de resposta no modal de edi√ß√£o
    function updateEditResponseTimeDisplay(value) {
      const displayElement = document.getElementById('editResponseTimeValue');
      if (displayElement) {
        const pluralText = value == 1 ? 'minuto' : 'minutos';
        displayElement.textContent = value + ' ' + pluralText;
      }
    }

    function openCreateInstanceModal() {
      // Abrir modal de sele√ß√£o de API em vez do modal direto
      document.getElementById('apiSelectionModal').classList.add('active');
    }

    function closeCreateInstanceModal() {
      // Parar verifica√ß√£o QR se estiver rodando
      if (qrCodeCheckInterval) {
        clearInterval(qrCodeCheckInterval);
        qrCodeCheckInterval = null;
      }
      
      document.getElementById('createInstanceModal').classList.remove('active');
      
      // Resetar formul√°rio
      const form = document.querySelector('#createInstanceModal form');
      form.style.display = 'block';
      document.getElementById('instanceName').value = '';
      document.getElementById('instancePhone').value = '';
      document.getElementById('assistantSelect').value = '';
      document.getElementById('followUpSelect').value = '';
      // Resetar slider para valor padr√£o
      const slider = document.getElementById('responseTimeSlider');
      if (slider) {
        slider.value = 2;
        updateResponseTimeDisplay(2);
      }
      
      // Limpar container de sucesso se existir
      const successContainer = document.getElementById('successAndQRContainer');
      if (successContainer) {
        successContainer.remove();
      }
      
      // Resetar t√≠tulo
      document.querySelector('#createInstanceModal .modal-title').textContent = 'Nova Inst√¢ncia';
      
      // Reabilitar bot√£o se ficou desabilitado
      const createBtn = document.getElementById('createInstanceBtn');
      createBtn.disabled = false;
      createBtn.innerHTML = `
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Criar Inst√¢ncia
      `;

      currentInstanceId = null;
      currentInstanceName = '';
    }

    // === NOVAS FUN√á√ïES PARA GERENCIAR OS MODAIS ===

    function closeApiSelectionModal() {
      document.getElementById('apiSelectionModal').classList.remove('active');
    }

    function selectApiType(apiType) {
      // Fechar modal de sele√ß√£o
      closeApiSelectionModal();

      if (apiType === 'official') {
        // Abrir modal da API oficial
        document.getElementById('createOfficialInstanceModal').classList.add('active');
      } else if (apiType === 'unofficial') {
        // Abrir modal da API n√£o oficial (mant√©m funcionalidade atual)
        document.getElementById('createInstanceModal').classList.add('active');
        // Recarregar assistentes e follow-ups ao abrir modal
        loadAssistants();
        loadFollowUps();
        // Resetar o campo de AI response para "N√£o" e esconder sele√ß√£o de assistente
        document.getElementById('aiNo').checked = true;
        toggleAssistantSelect(false);
      }
    }

    function closeCreateOfficialInstanceModal() {
      document.getElementById('createOfficialInstanceModal').classList.remove('active');
      // Resetar formul√°rio da API oficial
      document.getElementById('officialInstanceName').value = '';
      document.getElementById('officialInstancePhone').value = '';
    }

    async function createOfficialInstance(event) {
      event.preventDefault();

      // Dados da primeira etapa (Nome e N√∫mero)
      const name = document.getElementById('officialInstanceName').value.trim();
      const phone = document.getElementById('officialInstancePhone').value.trim();

      // Dados da segunda etapa (Credenciais Meta)
      const businessId = document.getElementById('businessIdStep2').value.trim();
      const numberId = document.getElementById('numberIdStep2').value.trim();
      const metaToken = document.getElementById('metaTokenStep2').value.trim();

      // Dados da segunda etapa - Configura√ß√£o do assistente
      const aiResponseRadio = document.querySelector('input[name="officialAiResponse"]:checked');
      const aiWillRespond = aiResponseRadio ? aiResponseRadio.value === 'yes' : false;

      const assistantSelect = document.getElementById('officialAssistantSelect');
      const assistanteId = aiWillRespond ? assistantSelect.value : '';
      const assistenteName = aiWillRespond && assistantSelect.selectedIndex > 0 ? assistantSelect.options[assistantSelect.selectedIndex].dataset.assistantName : '';

      const responseTimeSlider = document.getElementById('officialResponseTimeSlider');
      const responseTime = responseTimeSlider ? responseTimeSlider.value : '';

      const followUpSelect = document.getElementById('officialFollowUpSelect');
      const followUpId = aiWillRespond ? followUpSelect.value : '';

      // Capturar o nome do follow-up selecionado
      let followUpName = '';
      if (aiWillRespond && followUpId) {
        const followUpOption = followUpSelect.options[followUpSelect.selectedIndex];
        followUpName = followUpOption && followUpOption.value !== '' ? followUpOption.textContent : '';
      }

      const formData = {
        name: name,
        phone: phone,
        businessId: businessId,
        numberId: numberId,
        metaToken: metaToken,
        apiType: 'official',
        aiWillRespond: aiWillRespond,
        assistanteId: assistanteId,
        assistenteName: assistenteName,
        responseTime: responseTime,
        followUpId: followUpId,
        followUpName: followUpName,
        // Informa√ß√µes do usu√°rio
        tenant_id: userData.user.tenant_id,
        user_id: userData.user.id || userData.user.user_id,
        user_email: userData.user.email,
        user_name: userData.user.name || userData.user.nome
      };

      // Valida√ß√µes b√°sicas
      if (!name || !phone) {
        customError('Por favor, preencha o nome e n√∫mero da inst√¢ncia.', 'Campos Obrigat√≥rios');
        return;
      }

      if (!businessId || !numberId || !metaToken) {
        customError('Por favor, preencha todas as credenciais da Meta.', 'Campos Obrigat√≥rios');
        return;
      }

      if (aiWillRespond && !assistanteId) {
        customError('Por favor, selecione um assistente para responder automaticamente.', 'Campo Obrigat√≥rio');
        return;
      }

      // Desabilitar bot√£o durante cria√ß√£o
      const createBtn = document.getElementById('createOfficialInstanceStep3Btn');
      createBtn.disabled = true;
      createBtn.innerHTML = `
        <div class="spinner"></div>
        Criando...
      `;

      console.log('[DEBUG] Criando inst√¢ncia API oficial completa:', formData);

      // Fazer chamada para a API oficial
      try {
        const response = await fetch('https://sdr.salesdever.io/webhook/criarinstancia-api-oficial', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
          closeOfficialStep3Modal();

          // Mostrar mensagem de sucesso
          customSuccess('Inst√¢ncia da API oficial criada com sucesso! Configura√ß√£o completa com assistente.', 'API Oficial Configurada!');

          // Recarregar lista de inst√¢ncias
          loadInstances();
        } else {
          throw new Error(result.message || 'Erro ao criar inst√¢ncia');
        }
      } catch (error) {
        console.error('[ERROR] Erro ao criar inst√¢ncia oficial:', error);
        customError('Erro ao criar inst√¢ncia: ' + error.message, 'Erro na Cria√ß√£o');
      } finally {
        // Reabilitar bot√£o
        createBtn.disabled = false;
        createBtn.innerHTML = `
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Criar Inst√¢ncia
        `;
      }
    }

    // Fun√ß√µes para o fluxo da API Oficial em tr√™s etapas
    function proceedToOfficialStep2() {
      // Validar primeira etapa - apenas Nome e N√∫mero
      const name = document.getElementById('officialInstanceName').value.trim();
      const phone = document.getElementById('officialInstancePhone').value.trim();

      if (!name || !phone) {
        customError('Por favor, preencha o nome e n√∫mero da inst√¢ncia', 'Campos Obrigat√≥rios');
        return;
      }

      // Fechar primeira modal e abrir segunda (nova p√°gina com credenciais)
      document.getElementById('createOfficialInstanceModal').classList.remove('active');
      document.getElementById('createOfficialInstanceStep2Modal').classList.add('active');
    }

    function proceedToOfficialStep3() {
      // Validar segunda etapa - Credenciais da Meta
      const businessId = document.getElementById('businessIdStep2').value.trim();
      const numberId = document.getElementById('numberIdStep2').value.trim();
      const metaToken = document.getElementById('metaTokenStep2').value.trim();

      if (!businessId || !numberId || !metaToken) {
        customError('Por favor, preencha todas as credenciais da Meta', 'Campos Obrigat√≥rios');
        return;
      }

      // Fechar segunda modal e abrir terceira (assistente)
      document.getElementById('createOfficialInstanceStep2Modal').classList.remove('active');
      document.getElementById('createOfficialInstanceStep3Modal').classList.add('active');

      // Carregar assistentes para a terceira etapa
      loadAssistantsForOfficial();
    }

    function backToOfficialStep1() {
      // Fechar segunda modal
      document.getElementById('createOfficialInstanceStep2Modal').classList.remove('active');

      // Abrir primeira modal
      document.getElementById('createOfficialInstanceModal').classList.add('active');
    }

    function backToOfficialStep2() {
      // Fechar terceira modal
      document.getElementById('createOfficialInstanceStep3Modal').classList.remove('active');

      // Abrir segunda modal
      document.getElementById('createOfficialInstanceStep2Modal').classList.add('active');
    }

    function closeOfficialStep2Modal() {
      document.getElementById('createOfficialInstanceStep2Modal').classList.remove('active');

      // Resetar campos da segunda etapa
      document.getElementById('businessIdStep2').value = '';
      document.getElementById('numberIdStep2').value = '';
      document.getElementById('metaTokenStep2').value = '';

      // Tamb√©m resetar primeira etapa
      closeCreateOfficialInstanceModal();
    }

    function closeOfficialStep3Modal() {
      document.getElementById('createOfficialInstanceStep3Modal').classList.remove('active');

      // Resetar campos da terceira etapa
      document.getElementById('officialAiNo').checked = true;
      toggleOfficialAssistantSelect(false);

      // Tamb√©m resetar etapas anteriores
      closeOfficialStep2Modal();
    }

    // Fun√ß√£o para abrir modal de ajuda
    function abrirModalAjuda() {
      document.getElementById('modalAjudaApiOficial').classList.add('active');
    }

    function fecharModalAjuda() {
      document.getElementById('modalAjudaApiOficial').classList.remove('active');
    }

    function toggleOfficialAssistantSelect(showAssistant) {
      const assistantGroup = document.getElementById('officialAssistantSelectGroup');
      const followUpGroup = document.getElementById('officialFollowUpGroup');
      const responseTimeGroup = document.getElementById('officialResponseTimeGroup');

      if (showAssistant) {
        assistantGroup.style.display = 'block';
        followUpGroup.style.display = 'block';
        // N√ÉO mostrar tempo de resposta ainda - s√≥ quando selecionar follow-up
        responseTimeGroup.style.display = 'none';
      } else {
        assistantGroup.style.display = 'none';
        followUpGroup.style.display = 'none';
        responseTimeGroup.style.display = 'none';
      }
    }

    async function loadAssistantsForOfficial() {
      try {
        console.log('Carregando assistentes para API oficial...');
        const response = await fetch('https://sdr.salesdever.io/webhook/procura_assistentes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tenant_id: userData.user.tenant_id
          })
        });

        if (!response.ok) {
          throw new Error('Erro ao carregar assistentes');
        }

        const data = await response.json();
        console.log('Assistentes recebidos para API oficial:', data);

        // Filtrar assistentes v√°lidos
        const validAssistants = Array.isArray(data) ? data.filter(item => item.assistente_id && item.name) : [];

        // Popular select da API oficial
        populateOfficialAssistantSelect(validAssistants);

        // Carregar follow-ups
        loadFollowUpsForOfficial();

      } catch (error) {
        console.error('Erro ao carregar assistentes para API oficial:', error);
        document.getElementById('officialAssistantSelect').innerHTML = '<option value="">Erro ao carregar assistentes</option>';
      }
    }

    function populateOfficialAssistantSelect(assistants) {
      const select = document.getElementById('officialAssistantSelect');

      if (!assistants || assistants.length === 0) {
        select.innerHTML = '<option value="">Nenhum assistente dispon√≠vel</option>';
        return;
      }

      select.innerHTML = '<option value="">Selecione um assistente</option>' +
        assistants.map(assistant =>
          `<option value="${assistant.assistente_id}" data-assistant-name="${assistant.name}">${assistant.name}</option>`
        ).join('');
    }

    async function loadFollowUpsForOfficial() {
      try {
        console.log('[FOLLOW-UP OFICIAL] üîÑ Carregando follow-ups...');
        console.log('[FOLLOW-UP OFICIAL] üìã Tenant ID:', userData.user.tenant_id);

        const response = await fetch('https://sdr.salesdever.io/webhook/saas-buscar-follows-', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tenant_id: userData.user.tenant_id
          })
        });

        console.log('[FOLLOW-UP OFICIAL] üì° Response status:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('[FOLLOW-UP OFICIAL] üì¶ Dados recebidos:', data);

        // Verificar estrutura dos dados
        let followUpArray = [];
        if (Array.isArray(data)) {
          followUpArray = data;
        } else if (data.follow_ups && Array.isArray(data.follow_ups)) {
          followUpArray = data.follow_ups;
        } else if (data.data && Array.isArray(data.data)) {
          followUpArray = data.data;
        } else {
          console.warn('[FOLLOW-UP OFICIAL] ‚ö†Ô∏è Estrutura n√£o reconhecida:', data);
          followUpArray = [];
        }

        // Filtrar follow-ups v√°lidos
        const validFollowUps = followUpArray.filter(item => item.follow_up_id && item.strategy_name);

        console.log('[FOLLOW-UP OFICIAL] ‚úÖ Follow-ups v√°lidos:', validFollowUps);

        // Popular select
        populateOfficialFollowUpSelect(validFollowUps);

      } catch (error) {
        console.error('[FOLLOW-UP OFICIAL] ‚ùå Erro:', error);
        document.getElementById('officialFollowUpSelect').innerHTML = '<option value="">Erro ao carregar follow-ups</option>';
      }
    }

    function populateOfficialFollowUpSelect(followUps) {
      const select = document.getElementById('officialFollowUpSelect');

      select.innerHTML = '<option value="">Nenhum follow up</option>';

      if (followUps && followUps.length > 0) {
        followUps.forEach(followUp => {
          const option = document.createElement('option');
          option.value = followUp.follow_up_id;
          option.textContent = followUp.strategy_name;
          select.appendChild(option);
        });
      }
    }

    function handleOfficialFollowUpSelection() {
      const followUpSelect = document.getElementById('officialFollowUpSelect');
      const responseTimeGroup = document.getElementById('officialResponseTimeGroup');

      // Mostrar tempo de resposta apenas se um follow-up for selecionado
      if (followUpSelect.value && followUpSelect.value !== '') {
        responseTimeGroup.style.display = 'block';
      } else {
        responseTimeGroup.style.display = 'none';
      }
    }

    function updateOfficialResponseTimeDisplay(value) {
      const display = document.getElementById('officialResponseTimeValue');
      if (value === '0') {
        display.textContent = 'Imediatamente';
      } else {
        const minutes = value === '1' ? '1 minuto' : `${value} minutos`;
        display.textContent = minutes;
      }
    }

    // FUN√á√ÉO CORRIGIDA: Criar inst√¢ncia mantendo estrutura original + novos campos
    async function createInstance(event) {
      event.preventDefault();

      const name = document.getElementById('instanceName').value.trim();
      const phoneInput = document.getElementById('instancePhone').value.trim();

      // Capturar se quer IA respondendo
      const aiResponseRadio = document.querySelector('input[name="aiResponse"]:checked');
      const aiWillRespond = aiResponseRadio ? aiResponseRadio.value === 'yes' : false;

      const assistantSelect = document.getElementById('assistantSelect');
      const assistanteId = aiWillRespond ? assistantSelect.value : '';
      const assistenteName = aiWillRespond && assistantSelect.selectedIndex > 0 ? assistantSelect.options[assistantSelect.selectedIndex].dataset.assistantName : '';

      const responseTimeSlider = document.getElementById('responseTimeSlider');
      const responseTime = responseTimeSlider ? responseTimeSlider.value : '';

      const followUpSelect = document.getElementById('followUpSelect');
      const followUpId = aiWillRespond ? followUpSelect.value : '';

      // Capturar o nome do follow-up selecionado
      let followUpName = '';
      if (aiWillRespond && followUpId && followUpsData.length > 0) {
        const selectedFollowUp = followUpsData.find(fu => fu.follow_up_id === followUpId);
        followUpName = selectedFollowUp ? selectedFollowUp.strategy_name : '';
      }

      // Valida√ß√µes
      if (!name) {
        customError('Por favor, insira o nome da inst√¢ncia', 'Campo Obrigat√≥rio');
        return;
      }

      if (!phoneInput) {
        customError('Por favor, insira o n√∫mero do WhatsApp', 'Campo Obrigat√≥rio');
        return;
      }

      if (aiWillRespond && !assistanteId) {
        customError('Por favor, selecione um assistente', 'Campo Obrigat√≥rio');
        return;
      }

      if (aiWillRespond && !responseTime) {
        customError('Por favor, selecione o tempo de resposta', 'Campo Obrigat√≥rio');
        return;
      }

      // Formatar o n√∫mero: limpar e adicionar +55
      const cleanPhone = phoneInput.replace(/\D/g, ''); // Remove tudo que n√£o √© n√∫mero
      const whatsappNumber = `+55${cleanPhone}`;

      // Desabilitar bot√£o e mostrar loading
      const createBtn = document.getElementById('createInstanceBtn');
      const originalBtnContent = createBtn.innerHTML;
      createBtn.disabled = true;
      createBtn.innerHTML = '<div class="config-loading"><div class="spinner"></div> Criando...</div>';

      try {
        if (!userData || !userData.user || !userData.user.tenant_id) {
          customError('Dados do usu√°rio n√£o encontrados. Fa√ßa login novamente.', 'Erro de Autentica√ß√£o');
          return;
        }

        // Gerar chave de inst√¢ncia (MANTENDO ESTRUTURA ORIGINAL)
        const instanceKey = generateInstanceKey();

        // Log dos dados capturados para depura√ß√£o
        console.log('[CRIAR INST√ÇNCIA] Dados capturados:', {
          name,
          whatsappNumber,
          aiWillRespond,
          assistanteId,
          assistenteName,
          responseTime
        });

        // PAYLOAD CORRETO: Estrutura original + novos campos
        const payload = {
          instanceName: name,
          whatsappNumber: whatsappNumber,
          instanceKey: instanceKey,
          tenant_id: userData.user.tenant_id,
          // NOVOS CAMPOS:
          ai_will_respond: aiWillRespond,
          assistente_id: assistanteId,
          assistente_voz: assistenteName,
          response_time: responseTime,
          follow_up_id: followUpId,
          follow_up_name: followUpName
        };

        console.log('[CRIAR INST√ÇNCIA] Payload enviado ao webhook:', JSON.stringify(payload, null, 2));

        const response = await fetch('https://sdr.salesdever.io/webhook/criar-instancia-salesdever', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        // Verificar se houve erro HTTP
        if (!response.ok) {
          console.log('[CRIAR INST√ÇNCIA] ‚ùå Response n√£o OK. Status:', response.status);

          // Tentar ler o corpo da resposta de erro
          let errorBody = '';
          try {
            errorBody = await response.text();
            console.log('[CRIAR INST√ÇNCIA] Corpo do erro:', errorBody);
          } catch (e) {
            console.log('[CRIAR INST√ÇNCIA] N√£o conseguiu ler corpo do erro');
          }

          // JOGAR ERRO com status e corpo da resposta
          throw new Error(`HTTP_ERROR|${response.status}|${errorBody}`);
        }

        // Se chegou aqui, response.ok = true, fazer parse JSON
        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          console.log('[CRIAR INST√ÇNCIA] ‚ùå Erro ao fazer parse JSON da resposta:', jsonError);
          // Se n√£o conseguiu fazer parse do JSON, provavelmente √© duplica√ß√£o
          throw new Error('JSON_PARSE_ERROR|' + response.status + '|Erro de duplica√ß√£o detectado');
        }
        
        // N√ÉO fechar modal, transformar em modal QR
        // Mudar t√≠tulo
        document.querySelector('#createInstanceModal .modal-title').textContent = 'Conectar WhatsApp';
        
        // Esconder formul√°rio
        document.querySelector('#createInstanceModal form').style.display = 'none';
        
        // Criar container de sucesso + loading
        const form = document.querySelector('#createInstanceModal form');
        const successContainer = document.createElement('div');
        successContainer.id = 'successAndQRContainer';
        successContainer.innerHTML = `
          <div style="text-align: center; padding: 2rem 0;">
            <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; background: rgba(75, 255, 159, 0.15); border: 2px solid rgba(75, 255, 159, 0.4); color: #4bff9f;">
              ‚úì
            </div>
            <h3 style="font-size: 1.5rem; font-weight: 700; color: #ffffff; margin-bottom: 0.5rem;">Inst√¢ncia Criada!</h3>
            <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 2rem;">Preparando conex√£o...</p>
            
            <div class="qr-code-wrapper" style="background: white; padding: 1.5rem; border-radius: 1.25rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); margin: 0 auto 1.5rem; display: inline-block;">
              <div class="qr-placeholder" id="inlineQRCodeImage" style="width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(165, 148, 255, 0.1), rgba(102, 126, 234, 0.1)); border-radius: 0.75rem;">
                <div class="spinner"></div>
              </div>
            </div>
            
            <div id="inlineQRTimer" style="display: none; text-align: center; margin-bottom: 1rem; padding: 0.75rem; background: rgba(165, 148, 255, 0.1); border-radius: 0.75rem; border: 1px solid rgba(165, 148, 255, 0.2);"></div>
            
            <div style="margin-bottom: 1.5rem;">
              <div style="display: inline-flex; align-items: center; gap: 0.75rem; background: rgba(165, 148, 255, 0.15); padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: 1px solid rgba(165, 148, 255, 0.3);">
                <svg width="24" height="24" fill="none" stroke="#A594FF" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                <span style="color: #A594FF; font-weight: 600; font-size: 0.95rem;">Abra o WhatsApp no seu celular</span>
              </div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 0.75rem; text-align: left; background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 1rem; border: 1px solid rgba(255, 255, 255, 0.1);">
              <div style="display: flex; align-items: start; gap: 0.75rem;">
                <div style="min-width: 24px; height: 24px; background: linear-gradient(135deg, #A594FF, #667EEA); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.75rem; flex-shrink: 0;">1</div>
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; margin: 0;">Toque em <strong>Mais op√ß√µes</strong> ou <strong>Configura√ß√µes</strong></p>
              </div>
              <div style="display: flex; align-items: start; gap: 0.75rem;">
                <div style="min-width: 24px; height: 24px; background: linear-gradient(135deg, #A594FF, #667EEA); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.75rem; flex-shrink: 0;">2</div>
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; margin: 0;">Selecione <strong>Aparelhos conectados</strong></p>
              </div>
              <div style="display: flex; align-items: start; gap: 0.75rem;">
                <div style="min-width: 24px; height: 24px; background: linear-gradient(135deg, #A594FF, #667EEA); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.75rem; flex-shrink: 0;">3</div>
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; margin: 0;">Toque em <strong>Conectar um aparelho</strong> e escaneie este c√≥digo</p>
              </div>
            </div>
          </div>
        `;
        
        form.parentNode.insertBefore(successContainer, form.nextSibling);
        
        // Salvar dados da inst√¢ncia para verifica√ß√£o
        currentInstanceName = name;
        
        // Aguardar 1.5 segundos e recarregar inst√¢ncias
        setTimeout(async () => {
          await loadInstances();
          
          // Encontrar inst√¢ncia criada
          const newInstance = instancesData.find(inst => inst.instance_name === name);
          if (newInstance) {
            currentInstanceId = newInstance.id;
            currentInstanceName = newInstance.instance_name;
            
            // Gerar QR Code inline
            generateInlineQRCode();
          } else {
            console.error('Inst√¢ncia rec√©m-criada n√£o encontrada');
            document.getElementById('inlineQRCodeImage').innerHTML = '<p style="color: #ff6b6b;">Erro ao encontrar inst√¢ncia</p>';
          }
        }, 1500);
        
      } catch (error) {
        console.error('[CRIAR INST√ÇNCIA] Erro completo:', error);
        console.error('[CRIAR INST√ÇNCIA] Error message:', error.message);
        console.error('[CRIAR INST√ÇNCIA] Error stack:', error.stack);


        // Verificar se o erro cont√©m informa√ß√£o sobre duplica√ß√£o de nome da Supabase
        let isDuplicateError = false;

        // O erro pode ser:
        // 1. HTTP_ERROR|status|errorBody (erro HTTP)
        // 2. JSON_PARSE_ERROR|status|message (erro de JSON = duplica√ß√£o)
        if (error.message && (error.message.includes('HTTP_ERROR|') || error.message.includes('JSON_PARSE_ERROR|'))) {
          const parts = error.message.split('|');

          if (parts.length >= 3) {
            const errorBody = parts[2]; // A terceira parte cont√©m o corpo do erro do Supabase
            // Verificar se o errorBody cont√©m a constraint violation
            const errorBodyLower = errorBody.toLowerCase();

            // Verificar se √© erro de JSON (novo padr√£o detectado)
            const isJsonParseError = parts[0] === 'JSON_PARSE_ERROR';

            // BASEADO NO QUE VIMOS: quando h√° duplica√ß√£o, pode ser:
            // 1. Status 500 (padr√£o antigo)
            // 2. JSON_PARSE_ERROR (padr√£o novo)
            const isStatus500 = parts.length >= 2 && parts[1] === '500';

            // Verifica√ß√£o original do Supabase (caso mude no futuro)
            const hasSupabaseError = errorBodyLower.includes('duplicate key value') &&
                                   errorBodyLower.includes('whatsapp_instances_instance_name_key');

            // DUPLICA√á√ÉO DETECTADA SE:
            // 1. Status 500 OU
            // 2. Erro de parse JSON OU
            // 3. Erro direto do Supabase
            isDuplicateError = isStatus500 || isJsonParseError || hasSupabaseError;

          }
        } else {
          // Fallback: verificar na mensagem completa
          const errorMsg = (error.message || '').toLowerCase();
          isDuplicateError = errorMsg.includes('duplicate key value') &&
                           errorMsg.includes('whatsapp_instances_instance_name_key');
        }

        if (isDuplicateError) {
          console.log('[CRIAR INST√ÇNCIA] ‚úÖ NOME DUPLICADO DETECTADO NO BANCO!');
          customError(
            `Este nome j√° est√° sendo usado! Cada inst√¢ncia precisa de um nome √∫nico. Tente outro nome.`,
            'Nome indispon√≠vel'
          );
        } else {
          console.log('[CRIAR INST√ÇNCIA] ‚ùå Erro gen√©rico:', error.message);
          customError(
            `Erro ao criar inst√¢ncia. Tente novamente ou entre em contato com o suporte.`,
            'Erro na cria√ß√£o'
          );
        }

        // Reabilitar bot√£o
        createBtn.disabled = false;
        createBtn.innerHTML = originalBtnContent;
      }
    }

    // MANTENDO FUN√á√ÉO ORIGINAL DE GERAR KEY
    function generateInstanceKey() {
      const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let key = '';
      
      for (let i = 0; i < 12; i++) {
        key += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      key += '-';
      
      for (let i = 0; i < 4; i++) {
        key += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      key += '-';
      
      for (let i = 0; i < 4; i++) {
        key += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      key += '-';
      
      for (let i = 0; i < 12; i++) {
        key += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      return key;
    }

    async function connectInstance(instanceName, instanceId) {
      // Salvar dados da inst√¢ncia atual
      currentInstanceId = instanceId;
      currentInstanceName = instanceName;
      
      // Abrir o modal
      document.getElementById('qrCodeModal').classList.add('active');
      
      // Resetar o container do QR Code para mostrar bot√£o
      const qrContainer = document.getElementById('qrCodeImage');
      qrContainer.innerHTML = `
        <button onclick="generateQRCode()" style="
          background: linear-gradient(135deg, #A594FF, #667EEA);
          color: white;
          border: none;
          padding: 1rem 2rem;
          border-radius: 0.75rem;
          font-weight: 600;
          font-size: 1rem;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(165, 148, 255, 0.4);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(165, 148, 255, 0.6)';" 
           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(165, 148, 255, 0.4)';">
          üîó Gerar QR Code
        </button>
      `;
    }

    async function generateQRCode() {
      try {
        // Mostrar loading
        const qrContainer = document.getElementById('qrCodeImage');
        qrContainer.innerHTML = '<div class="spinner"></div>';
        
        // Chamar o webhook
        const response = await fetch('https://sdr.salesdever.io/webhook/atualizar-qr-code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            instanceName: currentInstanceName,
            instanceId: currentInstanceId,
            tenant_id: userData.user.tenant_id
          })
        });

        if (!response.ok) {
          throw new Error('Failed to generate QR code');
        }

        // O webhook retorna uma IMAGEM (binary), n√£o JSON
        const blob = await response.blob();
        
        // Converter blob para data URL
        const reader = new FileReader();
        reader.onloadend = function() {
          const base64data = reader.result;
          displayQRCode(base64data);
          startQRCodeCheck(currentInstanceName, currentInstanceId);
        };
        reader.readAsDataURL(blob);
        
      } catch (error) {
        console.error('Error generating QR code:', error);
        const qrContainer = document.getElementById('qrCodeImage');
        qrContainer.innerHTML = `
          <div style="text-align: center; color: #ff6b6b;">
            <p style="margin-bottom: 1rem;">‚ùå Erro ao gerar QR Code</p>
            <button onclick="generateQRCode()" style="
              background: linear-gradient(135deg, #A594FF, #667EEA);
              color: white;
              border: none;
              padding: 0.75rem 1.5rem;
              border-radius: 0.75rem;
              font-weight: 600;
              cursor: pointer;
            ">
              üîÑ Tentar Novamente
            </button>
          </div>
        `;
      }
    }

    function displayQRCode(qrCodeData) {
      const qrContainer = document.getElementById('qrCodeImage');
      // Verificar se j√° tem o prefixo data:image
      const qrSrc = qrCodeData.startsWith('data:image') ? qrCodeData : `data:image/png;base64,${qrCodeData}`;
      qrContainer.innerHTML = `<img src="${qrSrc}" alt="QR Code" style="width: 100%; height: 100%; border-radius: 0.75rem;" />`;
      
      // INICIAR TIMER DE 30 SEGUNDOS
      startQRCodeTimer();
    }

    // FUN√á√ÉO INLINE para gerar QR Code dentro do modal de criar
    async function generateInlineQRCode() {
      try {
        console.log('[INLINE QR] üîÑ Gerando QR Code inline...');
        
        const qrContainer = document.getElementById('inlineQRCodeImage');
        qrContainer.innerHTML = '<div class="spinner"></div>';
        
        const response = await fetch('https://sdr.salesdever.io/webhook/atualizar-qr-code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            instanceName: currentInstanceName,
            instanceId: currentInstanceId,
            tenant_id: userData.user.tenant_id
          })
        });

        if (!response.ok) {
          throw new Error('Failed to generate QR code');
        }

        const blob = await response.blob();
        
        const reader = new FileReader();
        reader.onloadend = function() {
          const base64data = reader.result;
          const qrSrc = base64data.startsWith('data:image') ? base64data : `data:image/png;base64,${base64data}`;
          qrContainer.innerHTML = `<img src="${qrSrc}" alt="QR Code" style="width: 100%; height: 100%; border-radius: 0.75rem;" />`;
          
          // Iniciar timer inline
          startInlineQRCodeTimer();
          
          // Iniciar verifica√ß√£o
          startQRCodeCheck(currentInstanceName, currentInstanceId);
        };
        reader.readAsDataURL(blob);
        
      } catch (error) {
        console.error('[INLINE QR] ‚ùå Erro:', error);
        const qrContainer = document.getElementById('inlineQRCodeImage');
        qrContainer.innerHTML = `
          <div style="text-align: center; color: #ff6b6b; padding: 2rem;">
            <p>‚ùå Erro ao gerar QR Code</p>
            <button onclick="generateInlineQRCode()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #A594FF; color: white; border: none; border-radius: 0.75rem; cursor: pointer;">
              üîÑ Tentar Novamente
            </button>
          </div>
        `;
      }
    }

    function startInlineQRCodeTimer() {
      if (qrCodeTimer) {
        clearInterval(qrCodeTimer);
      }
      
      qrCodeTimeLeft = 30;
      
      const timerElement = document.getElementById('inlineQRTimer');
      if (timerElement) {
        timerElement.style.display = 'block';
        updateInlineTimerDisplay();
        
        qrCodeTimer = setInterval(() => {
          qrCodeTimeLeft--;
          updateInlineTimerDisplay();
          
          if (qrCodeTimeLeft <= 0) {
            clearInterval(qrCodeTimer);
            if (qrCodeCheckInterval) {
              clearInterval(qrCodeCheckInterval);
              qrCodeCheckInterval = null;
            }
            timerElement.innerHTML = `
              <div style="color: #ff6b6b; font-weight: 600; display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <div>‚è±Ô∏è Tempo esgotado</div>
                <button onclick="generateInlineQRCode()" style="background: linear-gradient(135deg, #A594FF, #667EEA); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                  üîÑ Gerar Novo QR Code
                </button>
              </div>
            `;
          }
        }, 1000);
      }
    }

    function updateInlineTimerDisplay() {
      const timerElement = document.getElementById('inlineQRTimer');
      if (timerElement) {
        const color = qrCodeTimeLeft <= 10 ? '#ff6b6b' : '#A594FF';
        timerElement.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
            <svg width="20" height="20" fill="none" stroke="${color}" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span style="color: ${color}; font-weight: 600;">QR Code expira em: <strong>${qrCodeTimeLeft}s</strong></span>
          </div>
        `;
      }
    }

    let qrCodeTimer = null;
    let qrCodeTimeLeft = 30;
    
    function startQRCodeTimer() {
      // Limpar timer anterior se existir
      if (qrCodeTimer) {
        clearInterval(qrCodeTimer);
      }
      
      // Resetar tempo
      qrCodeTimeLeft = 30;
      
      // Criar elemento do timer
      const timerElement = document.getElementById('qrCodeTimer');
      if (timerElement) {
        timerElement.style.display = 'block';
        updateTimerDisplay();
        
        // Atualizar a cada segundo
        qrCodeTimer = setInterval(() => {
          qrCodeTimeLeft--;
          updateTimerDisplay();
          
          if (qrCodeTimeLeft <= 0) {
            clearInterval(qrCodeTimer);
            // Tamb√©m limpar o intervalo de verifica√ß√£o do QR Code
            if (qrCodeCheckInterval) {
              clearInterval(qrCodeCheckInterval);
              qrCodeCheckInterval = null;
            }
            timerElement.innerHTML = `
              <div style="color: #ff6b6b; font-weight: 600; display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                <div>‚è±Ô∏è Tempo esgotado</div>
                <button onclick="generateQRCode()" style="
                  background: linear-gradient(135deg, #A594FF, #667EEA);
                  color: white;
                  border: none;
                  padding: 0.75rem 1.5rem;
                  border-radius: 0.75rem;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  font-size: 0.9rem;
                " onmouseover="this.style.transform='translateY(-2px)'"
                   onmouseout="this.style.transform='translateY(0)'">
                  üîÑ Gerar Novo QR Code
                </button>
              </div>
            `;
          }
        }, 1000);
      }
    }
    
    function updateTimerDisplay() {
      const timerElement = document.getElementById('qrCodeTimer');
      if (timerElement) {
        const color = qrCodeTimeLeft <= 10 ? '#ff6b6b' : '#A594FF';
        timerElement.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
            <svg width="20" height="20" fill="none" stroke="${color}" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span style="color: ${color}; font-weight: 600;">QR Code expira em: <strong>${qrCodeTimeLeft}s</strong></span>
          </div>
        `;
      }
    }

    function startQRCodeCheck(instanceName, instanceId) {
      if (qrCodeCheckInterval) {
        clearInterval(qrCodeCheckInterval);
      }

      console.log('[QR CHECK] üîÑ Iniciando verifica√ß√£o para inst√¢ncia:', instanceName);

      qrCodeCheckInterval = setInterval(async () => {
        try {
          console.log('[QR CHECK] üì° Verificando status da inst√¢ncia...');
          
          const payload = { tenant_id: userData.user.tenant_id };
          const response = await fetch('https://sdr.salesdever.io/webhook/saas-buscar-instancias', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
          });
          
          const data = await response.json();
          const instances = Array.isArray(data) ? data : (data.instances || [data]);
          
          const instance = instances.find(inst => inst.id === instanceId);
          
          if (instance) {
            console.log('[QR CHECK] üìä Status atual:', instance.status);
            
            const isConnected = instance.status === 'connected' || 
                               instance.status === 'open' || 
                               instance.status === 'conectada' ||
                               instance.status === 'CONECTADA';
            
            if (isConnected) {
              console.log('[QR CHECK] ‚úÖ Inst√¢ncia conectada! Parando verifica√ß√£o.');
              clearInterval(qrCodeCheckInterval);
              qrCodeCheckInterval = null;
              customSuccess('WhatsApp conectado com sucesso!');
              closeQRCodeModal();
              loadInstances();
            }
          } else {
            console.log('[QR CHECK] ‚ö†Ô∏è Inst√¢ncia n√£o encontrada na busca');
          }
        } catch (error) {
          console.error('[QR CHECK] ‚ùå Erro ao verificar status:', error);
        }
      }, 5000); // Verificar a cada 5 segundos
    }

    function closeQRCodeModal() {
      document.getElementById('qrCodeModal').classList.remove('active');
      if (qrCodeCheckInterval) {
        clearInterval(qrCodeCheckInterval);
        qrCodeCheckInterval = null;
      }
      if (qrCodeTimer) {
        clearInterval(qrCodeTimer);
        qrCodeTimer = null;
      }
      document.getElementById('qrCodeTimer').style.display = 'none';
      currentInstanceId = null;
      currentInstanceName = '';
    }

    async function confirmDeleteInstance(instanceName, instanceId) {
      const confirmed = await customConfirm(
        `Tem certeza que deseja excluir a inst√¢ncia "${instanceName}"?`,
        'Esta a√ß√£o n√£o pode ser desfeita',
        'Excluir',
        'Cancelar'
      );

      if (confirmed) {
        await deleteInstance(instanceName, instanceId);
      }
    }

    async function deleteInstance(instanceName, instanceId) {
      try {
        const instance = instancesData.find(inst => inst.id === instanceId);
        
        const response = await fetch('https://sdr.salesdever.io/webhook/saas-excluir-instancia', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            instanceName: instanceName,
            instanceId: instanceId,
            tenant_id: userData.user.tenant_id,
            instanceData: instance,
            action: 'delete',
            timestamp: new Date().toISOString(),
            userInfo: {
              userId: userData.user.id,
              userEmail: userData.user.email || userData.user.nome
            }
          })
        });

        if (!response.ok) {
          throw new Error('Erro ao excluir inst√¢ncia');
        }

        customSuccess('Inst√¢ncia exclu√≠da com sucesso!');
        loadInstances();

      } catch (error) {
        console.error('Erro ao excluir inst√¢ncia:', error);
        customError('Erro ao excluir inst√¢ncia. Por favor, tente novamente.');
      }
    }

    // Carregar assistentes
    async function loadAssistants() {
      try {
        console.log('Carregando assistentes...');
        const response = await fetch('https://sdr.salesdever.io/webhook/procura_assistentes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tenant_id: userData.user.tenant_id
          })
        });

        if (!response.ok) {
          throw new Error('Erro ao carregar assistentes');
        }

        const data = await response.json();
        console.log('Assistentes recebidos:', data);

        // Armazenar globalmente
        assistantsData = Array.isArray(data) ? data.filter(item => item.assistente_id && item.name) : [];

        // Popular ambos os selects
        populateAssistantSelect('assistantSelect');
        populateAssistantSelect('editAssistantSelect');

      } catch (error) {
        console.error('Erro ao carregar assistentes:', error);
        document.getElementById('assistantSelect').innerHTML = '<option value="">Erro ao carregar assistentes</option>';
        document.getElementById('editAssistantSelect').innerHTML = '<option value="">Erro ao carregar assistentes</option>';
      }
    }

    function populateAssistantSelect(selectId) {
      const assistantSelect = document.getElementById(selectId);

      if (!assistantsData || assistantsData.length === 0) {
        assistantSelect.innerHTML = '<option value="">Nenhum assistente dispon√≠vel</option>';
        return;
      }

      assistantSelect.innerHTML = '<option value="">Selecione um assistente</option>' +
        assistantsData.map(assistant =>
          `<option value="${assistant.assistente_id}" data-assistant-name="${assistant.name}">${assistant.name}</option>`
        ).join('');
    }

    // Carregar follow-ups
    async function loadFollowUps() {
      try {
        console.log('[FOLLOW-UP] üîÑ Carregando follow-ups...');
        console.log('[FOLLOW-UP] üìã Tenant ID:', userData.user.tenant_id);

        const response = await fetch('https://sdr.salesdever.io/webhook/saas-buscar-follows-', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tenant_id: userData.user.tenant_id
          })
        });

        console.log('[FOLLOW-UP] üì° Response status:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('[FOLLOW-UP] üì¶ Dados recebidos do webhook:', data);

        // Verificar se data √© array ou tem propriedade espec√≠fica
        let followUpArray = [];
        if (Array.isArray(data)) {
          followUpArray = data;
        } else if (data.follow_ups && Array.isArray(data.follow_ups)) {
          followUpArray = data.follow_ups;
        } else if (data.data && Array.isArray(data.data)) {
          followUpArray = data.data;
        } else {
          console.warn('[FOLLOW-UP] ‚ö†Ô∏è Estrutura de dados n√£o reconhecida:', data);
          followUpArray = [];
        }

        console.log('[FOLLOW-UP] üîç Array para filtrar:', followUpArray);

        // Filtrar apenas follow-ups do tipo WhatsApp
        followUpsData = followUpArray.filter(item => {
          console.log('[FOLLOW-UP] üîç Item COMPLETO:', item);

          const isWhatsApp = item.follow_up_type === 'whatsapp';
          const hasId = item.follow_up_id && item.follow_up_id !== '';
          const strategyName = item.strategy_name || '';

          console.log('[FOLLOW-UP] üîç An√°lise do item:', {
            follow_up_id: item.follow_up_id,
            strategy_name: item.strategy_name,
            type: item.follow_up_type,
            isWhatsApp,
            hasId,
            passa: isWhatsApp && hasId
          });

          // S√≥ filtrar por tipo e ID
          return isWhatsApp && hasId;
        });

        console.log('[FOLLOW-UP] ‚úÖ Follow-ups filtrados (WhatsApp):', followUpsData);

        // Popular ambos os selects
        populateFollowUpSelect('followUpSelect');
        populateFollowUpSelect('editFollowUpSelect');

      } catch (error) {
        console.error('[FOLLOW-UP] ‚ùå Erro completo:', error);
        console.error('[FOLLOW-UP] üìõ Stack trace:', error.stack);

        // Definir mensagem de erro mais espec√≠fica
        const errorMessage = error.message.includes('HTTP') ?
          `Erro ${error.message}` :
          'Erro ao conectar com o servidor';

        document.getElementById('followUpSelect').innerHTML = `<option value="">${errorMessage}</option>`;
        document.getElementById('editFollowUpSelect').innerHTML = `<option value="">${errorMessage}</option>`;
      }
    }

    function populateFollowUpSelect(selectId) {
      const followUpSelect = document.getElementById(selectId);

      if (!followUpsData || followUpsData.length === 0) {
        followUpSelect.innerHTML = '<option value="">Nenhum follow-up dispon√≠vel</option>';
        return;
      }

      followUpSelect.innerHTML = '<option value="">Selecione um follow-up</option>' +
        followUpsData.map(followUp => {
          // Usar strategy_name como nome principal
          const name = followUp.strategy_name || `Follow-up ${followUp.follow_up_id}`;

          return `<option value="${followUp.follow_up_id}">${name}</option>`;
        }).join('');
    }

    // MODAL DE EDI√á√ÉO
    function openEditInstanceModal(instanceId) {
      // Encontrar inst√¢ncia
      const instance = instancesData.find(inst => inst.id === instanceId);
      if (!instance) {
        customError('Inst√¢ncia n√£o encontrada');
        return;
      }

      console.log('[EDIT MODAL] Dados completos da inst√¢ncia:', instance);

      currentEditInstance = instance;

      // Normalizar campos vindos do webhook
      const assistenteId = instance.assistente_id || instance.id_assistente || '';
      const assistenteNome = instance.assistente_voz || instance.assistant_name || instance.assistente_nome || '';

      // Verificar se a IA vai responder usando ai_will_respond como campo principal
      let aiWillRespond = false;

      if (instance.ai_will_respond !== undefined && instance.ai_will_respond !== null) {
        // PRINCIPAL: usar ai_will_respond
        aiWillRespond = instance.ai_will_respond === true || instance.ai_will_respond === 'true';
      } else if (instance.ativo !== undefined && instance.ativo !== null) {
        // Fallback: campo "ativo" do Supabase
        aiWillRespond = instance.ativo === true || instance.ativo === 'true';
      } else if (instance.configurado !== undefined && instance.configurado !== null) {
        // Fallback: campo configurado do Supabase
        aiWillRespond = instance.configurado === true || instance.configurado === 'true';
      } else {
        // √öltimo recurso: inferir baseado se tem assistente
        aiWillRespond = !!(assistenteId && assistenteId !== '');
      }

      console.log('[EDIT MODAL] Dados da inst√¢ncia completos:', instance);
      console.log('[EDIT MODAL] AI vai responder?', aiWillRespond);
      console.log('[EDIT MODAL] Assistente ID:', assistenteId);
      console.log('[EDIT MODAL] Assistente Nome:', assistenteNome);

      if (aiWillRespond) {
        document.getElementById('editAiYes').checked = true;
        toggleEditAssistantSelect(true);
      } else {
        document.getElementById('editAiNo').checked = true;
        toggleEditAssistantSelect(false);
      }

      // Recarregar assistentes se necess√°rio
      if (assistantsData.length === 0) {
        loadAssistants().then(() => {
          // Selecionar assistente atual
          if (assistenteId) {
            document.getElementById('editAssistantSelect').value = assistenteId;
            console.log('[EDIT MODAL] Assistente selecionado ap√≥s load:', assistenteId);
          }
        });
      } else {
        populateAssistantSelect('editAssistantSelect');
        // Selecionar assistente atual
        if (assistenteId) {
          document.getElementById('editAssistantSelect').value = assistenteId;
          console.log('[EDIT MODAL] Assistente selecionado imediatamente:', assistenteId);
        }
      }

      // Recarregar follow-ups se necess√°rio
      if (followUpsData.length === 0) {
        loadFollowUps().then(() => {
          // Selecionar follow-up atual se tiver
          if (instance.follow_up_id) {
            document.getElementById('editFollowUpSelect').value = instance.follow_up_id;
            console.log('[EDIT MODAL] Follow-up selecionado ap√≥s load:', instance.follow_up_id);
          }
        });
      } else {
        populateFollowUpSelect('editFollowUpSelect');
        // Selecionar follow-up atual
        if (instance.follow_up_id) {
          document.getElementById('editFollowUpSelect').value = instance.follow_up_id;
          console.log('[EDIT MODAL] Follow-up selecionado imediatamente:', instance.follow_up_id);
        }
      }

      // Selecionar tempo de resposta atual
      const slider = document.getElementById('editResponseTimeSlider');
      if (instance.response_time !== undefined && instance.response_time !== null) {
        const responseTime = parseInt(instance.response_time);
        if (slider && responseTime >= 0 && responseTime <= 10) {
          slider.value = responseTime;
          updateEditResponseTimeDisplay(responseTime);
          console.log('[EDIT MODAL] Tempo de resposta selecionado:', responseTime);
        } else {
          console.warn('[EDIT MODAL] Tempo de resposta fora do range ou slider n√£o encontrado:', responseTime);
        }
      } else {
        console.warn('[EDIT MODAL] Tempo de resposta n√£o definido na inst√¢ncia - definindo 2m como padr√£o');
        // Se n√£o tem tempo definido, selecionar 2m como padr√£o
        if (slider) {
          slider.value = 2;
          updateEditResponseTimeDisplay(2);
        }
      }


      // Abrir modal
      document.getElementById('editInstanceModal').classList.add('active');
    }

    function closeEditInstanceModal() {
      document.getElementById('editInstanceModal').classList.remove('active');
      currentEditInstance = null;
      // Limpar form
      document.getElementById('editAssistantSelect').value = '';
      document.getElementById('editFollowUpSelect').value = '';
      // Resetar slider para valor padr√£o
      const editSlider = document.getElementById('editResponseTimeSlider');
      if (editSlider) {
        editSlider.value = 2;
        updateEditResponseTimeDisplay(2);
      }
    }

    async function editInstance(event) {
      event.preventDefault();

      if (!currentEditInstance) {
        customError('Nenhuma inst√¢ncia selecionada para editar');
        return;
      }

      // Capturar se quer IA respondendo
      const aiResponseRadio = document.querySelector('input[name="editAiResponse"]:checked');
      const aiWillRespond = aiResponseRadio ? aiResponseRadio.value === 'yes' : false;

      const assistantSelect = document.getElementById('editAssistantSelect');
      const assistanteId = aiWillRespond ? assistantSelect.value : '';
      const assistenteName = aiWillRespond && assistantSelect.selectedIndex > 0 ? assistantSelect.options[assistantSelect.selectedIndex].dataset.assistantName : '';

      const responseTimeSlider = document.getElementById('editResponseTimeSlider');
      const responseTime = responseTimeSlider ? responseTimeSlider.value : '';

      const followUpSelect = document.getElementById('editFollowUpSelect');
      const followUpId = aiWillRespond ? followUpSelect.value : '';

      // Capturar o nome do follow-up selecionado
      let followUpName = '';
      if (aiWillRespond && followUpId && followUpsData.length > 0) {
        const selectedFollowUp = followUpsData.find(fu => fu.follow_up_id === followUpId);
        followUpName = selectedFollowUp ? selectedFollowUp.strategy_name : '';
      }

      // Valida√ß√µes
      if (aiWillRespond && !assistanteId) {
        customError('Por favor, selecione um assistente', 'Campo Obrigat√≥rio');
        return;
      }

      if (aiWillRespond && !responseTime) {
        customError('Por favor, selecione o tempo de resposta', 'Campo Obrigat√≥rio');
        return;
      }

      // Desabilitar bot√£o e mostrar loading (PREVENIR M√öLTIPLOS CLIQUES)
      const saveBtn = document.getElementById('editInstanceBtn');

      // Se j√° est√° desabilitado, n√£o fazer nada (previne m√∫ltiplos cliques)
      if (saveBtn.disabled) {
        console.log('[EDITAR] Bot√£o j√° est√° processando, ignorando clique');
        return;
      }

      const originalBtnContent = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<div class="config-loading"><div class="spinner"></div> Salvando...</div>';

      try {
        const payload = {
          // Informa√ß√µes da inst√¢ncia
          instance_id: currentEditInstance.id,
          instance_name: currentEditInstance.instance_name,
          instance_key: currentEditInstance.instance_key,
          whatsapp_number: currentEditInstance.phone_number || currentEditInstance.whatsapp_number,
          status: currentEditInstance.status,
          tenant_id: userData.user.tenant_id,
          // Atualiza√ß√µes
          ai_will_respond: aiWillRespond,
          assistente_id: assistanteId,
          assistente_voz: assistenteName,
          response_time: responseTime,
          follow_up_id: followUpId,
          follow_up_name: followUpName
        };

        console.log('[EDITAR INST√ÇNCIA] Payload enviado:', JSON.stringify(payload, null, 2));

        const response = await fetch('https://sdr.salesdever.io/webhook/saas-editar-instancias', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error('Erro ao salvar configura√ß√£o');
        }

        // Recarregar inst√¢ncias
        await loadInstances();

        // Fechar modal
        closeEditInstanceModal();

        // Mostrar sucesso
        customSuccess('Configura√ß√£o atualizada com sucesso!');

      } catch (error) {
        console.error('Erro:', error);
        customError('Erro ao salvar configura√ß√£o. Por favor, tente novamente.');
      } finally {
        // SEMPRE reabilitar bot√£o no finally
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalBtnContent;
      }
    }

    // Custom Alert/Confirm Functions
    function customSuccess(message, title = 'Sucesso!') {
      showCustomPopup(message, title, 'success', [
        { text: 'OK', class: 'custom-popup-btn-primary', callback: () => {} }
      ]);
    }

    function customError(message, title = 'Erro') {
      showCustomPopup(message, title, 'error', [
        { text: 'OK', class: 'custom-popup-btn-primary', callback: () => {} }
      ]);
    }

    function customConfirm(message, title = 'Confirmar', confirmText = 'Confirmar', cancelText = 'Cancelar') {
      return new Promise((resolve) => {
        showCustomPopup(message, title, 'warning', [
          { text: cancelText, class: 'custom-popup-btn-secondary', callback: () => resolve(false) },
          { text: confirmText, class: 'custom-popup-btn-danger', callback: () => resolve(true) }
        ]);
      });
    }

    function showCustomPopup(message, title, type, buttons) {
      const popup = document.getElementById('customPopup');
      const icon = document.getElementById('popupIcon');
      const titleEl = document.getElementById('popupTitle');
      const messageEl = document.getElementById('popupMessage');
      const buttonsEl = document.getElementById('popupButtons');

      const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
      };

      icon.className = `custom-popup-icon ${type}`;
      icon.textContent = icons[type] || icons.info;
      titleEl.textContent = title;
      messageEl.textContent = message;

      buttonsEl.innerHTML = buttons.map((btn, index) => 
        `<button class="custom-popup-btn ${btn.class}" onclick="handlePopupButton(${index})">${btn.text}</button>`
      ).join('');

      window.currentPopupButtons = buttons;
      popup.classList.add('active');
    }

    function handlePopupButton(index) {
      const popup = document.getElementById('customPopup');
      popup.classList.remove('active');
      if (window.currentPopupButtons && window.currentPopupButtons[index]) {
        window.currentPopupButtons[index].callback();
      }
    }

    function checkDisconnectedInstances(instances) {
      // FUN√á√ÉO DESABILITADA - Alerta agora √© exibido apenas no dashboard
      console.log('[DEBUG] ‚ÑπÔ∏è Verifica√ß√£o de inst√¢ncias desconectadas desabilitada nesta p√°gina');
      console.log('[DEBUG] ‚ÑπÔ∏è Alerta agora √© exibido apenas no dashboard');
      return; // Fun√ß√£o desabilitada

      // C√≥digo comentado abaixo - mantido para refer√™ncia
      /*
      // N√£o mostrar alerta se j√° foi mostrado nesta sess√£o
      if (alertShownThisSession) {
        console.log('[DEBUG] ‚ÑπÔ∏è Alerta j√° foi mostrado nesta sess√£o');
        return;
      }

      // NOVA L√ìGICA: Filtrar inst√¢ncias N√ÉO conectadas
      const unconnected = instances.filter(instance => {
        const isConnected = instance.status === 'connected' ||
                           instance.status === 'open' ||
                           instance.status === 'conectada' ||
                           instance.status === 'CONECTADA';

        // Retornar apenas as N√ÉO conectadas
        return !isConnected;
      });

      console.log('[DEBUG] üîç Verificando inst√¢ncias n√£o conectadas...');
      console.log('[DEBUG] Total de inst√¢ncias:', instances.length);
      console.log('[DEBUG] Inst√¢ncias N√ÉO conectadas:', unconnected.length);

      if (unconnected.length > 0) {
        console.log('[DEBUG] ‚ö†Ô∏è Inst√¢ncias aguardando conex√£o:', unconnected.map(i => ({
          name: i.instance_name,
          status: i.status
        })));
        showAlertPopup(unconnected);
        alertShownThisSession = true; // Marcar como mostrado
      } else {
        console.log('[DEBUG] ‚úÖ Todas as inst√¢ncias est√£o conectadas!');
      }
      */
    }

    function showAlertPopup(instances) {
      const popup = document.getElementById('alertPopup');
      const listElement = document.getElementById('alertInstancesList');
      
      // Criar lista de inst√¢ncias n√£o configuradas
      listElement.innerHTML = instances.map(instance => `
        <div class="alert-instance-item">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="color: #ff6b6b;">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
          </svg>
          <span>${instance.instance_name}</span>
        </div>
      `).join('');
      
      // Mostrar popup ap√≥s 5 segundos
      setTimeout(() => {
        popup.classList.add('active');
      }, 5000);
    }

    function closeAlertPopup() {
      document.getElementById('alertPopup').classList.remove('active');
    }

    // ===== FUN√á√ïES DE GERENCIAMENTO DE TEMPLATES =====

    // Abrir modal de templates
    async function openTemplatesModal(instanceName, instanceId) {
      currentTemplateInstance = { name: instanceName, id: instanceId };
      document.getElementById('templatesModal').classList.add('active');
      await loadTemplates();
    }

    // Fechar modal de templates
    function closeTemplatesModal() {
      document.getElementById('templatesModal').classList.remove('active');
      currentTemplateInstance = null;
    }

    // Carregar templates da inst√¢ncia
    async function loadTemplates() {
      const container = document.getElementById('templatesContainer');
      container.innerHTML = '<div style="text-align: center; margin: 2rem auto; color: rgba(255,255,255,0.7);"><div class="spinner" style="margin: 0 auto 1rem;"></div>Carregando templates...</div>';

      try {
        console.log('[TEMPLATES] Carregando para inst√¢ncia:', currentTemplateInstance.name);

        const payload = {
          instanceName: currentTemplateInstance.name,
          tenant_id: userData.user.tenant_id
        };

        console.log('[TEMPLATES] Payload:', payload);

        const response = await fetch('https://sdr.salesdever.io/webhook/saas-listar-templates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        console.log('[TEMPLATES] Response status:', response.status);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('[TEMPLATES] Dados recebidos:', data);

        // CORRIGIDO: A API retorna um array onde o primeiro elemento tem a propriedade 'body' com os templates
        let allTemplates = [];

        if (Array.isArray(data)) {
          // Se data √© um array, procurar pela propriedade 'body' no primeiro elemento
          if (data.length > 0 && data[0].body) {
            allTemplates = data[0].body;
            console.log('[TEMPLATES] Templates encontrados em data[0].body:', allTemplates.length);
          } else {
            // Fallback: se n√£o encontrar 'body', tentar usar data diretamente
            allTemplates = data;
            console.log('[TEMPLATES] Usando data diretamente como fallback:', allTemplates.length);
          }
        } else if (data.body) {
          // Se data tem propriedade 'body'
          allTemplates = data.body;
          console.log('[TEMPLATES] Templates encontrados em data.body:', allTemplates.length);
        } else {
          // Fallback para outras estruturas
          allTemplates = data.data || data.templates || [];
          console.log('[TEMPLATES] Usando fallback para outras estruturas:', allTemplates.length);
        }

        // Filtrar templates v√°lidos (remover undefined, null ou vazios)
        const templates = allTemplates.filter(template =>
          template &&
          template.name &&
          template.name.trim() !== '' &&
          template.name !== 'undefined'
        );

        console.log('[TEMPLATES] Total bruto:', allTemplates.length, '| V√°lidos:', templates.length);

        if (templates.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.02); border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1);">
              <div style="font-size: 3.5rem; margin-bottom: 1.5rem; opacity: 0.7;">üìù</div>
              <h3 style="margin-bottom: 1rem; color: white; font-size: 1.4rem; font-weight: 700;">Nenhum template encontrado</h3>
              <p style="margin-bottom: 1.5rem; font-size: 1rem; line-height: 1.6; max-width: 400px; margin-left: auto; margin-right: auto;">Crie seu primeiro template para come√ßar a enviar mensagens personalizadas aprovadas pela Meta.</p>
              <button onclick="openCreateTemplateModal()" style="background: linear-gradient(135deg, #1877F2, #0C5AA6); color: white; border: none; padding: 0.875rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Criar Primeiro Template
              </button>
            </div>
          `;
          return;
        }

        console.log('[TEMPLATES] Renderizando templates:', templates);

        container.innerHTML = `
          <div style="display: grid; gap: 1rem;">
            ${templates.map((template, index) => {
              console.log(`[TEMPLATE ${index}] Renderizando:`, template);
              const preview = getTemplatePreview(template);
              console.log(`[TEMPLATE ${index}] Preview gerado:`, preview);

              return `
              <div style="background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03)); border: 1px solid rgba(255,255,255,0.15); border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">

                <!-- Cabe√ßalho do Template -->
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <svg width="18" height="18" fill="#A594FF" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                        <polyline points="14,2 14,8 20,8"/>
                      </svg>
                      <h4 style="color: white; font-weight: 700; margin: 0; font-size: 1.1rem;">${template.name || 'Nome n√£o dispon√≠vel'}</h4>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <svg width="14" height="14" fill="rgba(255,255,255,0.5)" viewBox="0 0 24 24">
                        <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.01-4.65.75-6.84L14 7l-5-5-2.74 2.74A7.99 7.99 0 004.13 8.9L3 10l10 10 1.1-1.13a7.99 7.99 0 002.03-2.13l2.74-2.74z"/>
                      </svg>
                      <span style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">${template.language || 'pt_BR'}</span>
                    </div>
                  </div>
                  <span style="padding: 0.4rem 0.8rem; border-radius: 0.6rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; ${getStatusStyle(template.status)}">${template.status || 'PENDING'}</span>
                </div>

                <!-- Preview do Template -->
                <div style="background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2)); border: 1px solid rgba(255,255,255,0.1); padding: 1rem; border-radius: 0.75rem; font-size: 0.9rem; margin-bottom: 1rem;">
                  ${preview}
                </div>

                <!-- Tags e Metadata -->
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;">
                  <span style="background: rgba(165,148,255,0.2); color: #A594FF; padding: 0.3rem 0.7rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(165,148,255,0.3);">
                    üìÇ ${template.category || 'MARKETING'}
                  </span>
                  <span style="background: rgba(34,197,94,0.15); color: #22C55E; padding: 0.3rem 0.7rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(34,197,94,0.3);">
                    üÜî ${template.id || 'N/A'}
                  </span>
                </div>
              </div>
            `;
            }).join('')}
          </div>
        `;

        console.log('[TEMPLATES] Templates renderizados com sucesso!');

      } catch (error) {
        console.error('[TEMPLATES] Erro completo:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.8); background: rgba(255,68,68,0.1); border-radius: 1rem; border: 1px solid rgba(255,68,68,0.3);">
            <div style="font-size: 3rem; margin-bottom: 1.5rem; opacity: 0.8;">‚ö†Ô∏è</div>
            <h3 style="margin-bottom: 1rem; color: #ff6b6b; font-size: 1.3rem; font-weight: 700;">Erro ao carregar templates</h3>
            <p style="margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.6; color: rgba(255,255,255,0.7);">N√£o foi poss√≠vel conectar com o servidor. Verifique sua conex√£o e tente novamente.</p>
            <button onclick="loadTemplates()" style="background: linear-gradient(135deg, #A594FF, #667EEA); color: white; border: none; padding: 0.875rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Tentar Novamente
            </button>
            <div style="margin-top: 1rem; font-size: 0.8rem; color: rgba(255,255,255,0.5);">
              Erro: ${error.message || 'Falha na comunica√ß√£o com o servidor'}
            </div>
          </div>
        `;
      }
    }

    // Helper: Estilo do status
    function getStatusStyle(status) {
      switch(status) {
        case 'APPROVED': return 'background: rgba(34,197,94,0.2); color: #22C55E;';
        case 'REJECTED': return 'background: rgba(239,68,68,0.2); color: #EF4444;';
        default: return 'background: rgba(251,191,36,0.2); color: #FBBF24;';
      }
    }

    // Helper: Preview do template
    function getTemplatePreview(template) {
      console.log('[TEMPLATE PREVIEW] Template:', template);

      // Verificar se tem components
      if (template.components && Array.isArray(template.components)) {
        const components = template.components;
        let preview = '';

        // Buscar HEADER se existir
        const header = components.find(c => c.type === 'HEADER');
        if (header && header.text) {
          preview += `<div style="font-weight: 700; color: #A594FF; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
            </svg>
            ${header.text}
          </div>`;
        }

        // Buscar BODY (obrigat√≥rio)
        const body = components.find(c => c.type === 'BODY');
        if (body && body.text) {
          preview += `<div style="color: rgba(255,255,255,0.9); line-height: 1.5; margin: 0.5rem 0;">
            ${body.text}
          </div>`;
        }

        // Buscar FOOTER se existir
        const footer = components.find(c => c.type === 'FOOTER');
        if (footer && footer.text) {
          preview += `<div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-style: italic;">
            ${footer.text}
          </div>`;
        }

        return preview || '<div style="color: rgba(255,255,255,0.5);">Sem conte√∫do</div>';
      }

      // Fallback para outras estruturas
      return `<div style="color: rgba(255,255,255,0.9);">${template.text || template.body || 'Sem conte√∫do'}</div>`;
    }

    // Abrir modal de criar template
    function openCreateTemplateModal() {
      document.getElementById('createTemplateModal').classList.add('active');
    }

    // Fechar modal de criar template
    function closeCreateTemplateModal() {
      document.getElementById('createTemplateModal').classList.remove('active');
      // Limpar form
      document.getElementById('templateName').value = '';
      document.getElementById('templateCategory').value = '';
      document.getElementById('templateHeader').value = '';
      document.getElementById('templateBody').value = '';
      document.getElementById('templateFooter').value = '';
      document.getElementById('templateLanguage').value = 'pt_BR';
    }

    // Criar template
    async function createTemplate(event) {
      event.preventDefault();

      const name = document.getElementById('templateName').value.trim().toLowerCase().replace(/\s+/g, '_');
      const category = document.getElementById('templateCategory').value;
      const language = document.getElementById('templateLanguage').value;
      const header = document.getElementById('templateHeader').value.trim();
      const body = document.getElementById('templateBody').value.trim();
      const footer = document.getElementById('templateFooter').value.trim();

      // Valida√ß√µes
      if (!name || !category || !body) {
        customError('Preencha todos os campos obrigat√≥rios', 'Campos Obrigat√≥rios');
        return;
      }

      // Montar components
      const components = [];

      if (header) {
        components.push({ type: 'HEADER', format: 'TEXT', text: header });
      }

      components.push({ type: 'BODY', text: body });

      if (footer) {
        components.push({ type: 'FOOTER', text: footer });
      }

      // Desabilitar bot√£o
      const btn = document.getElementById('createTemplateBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Criando...';

      try {
        const response = await fetch('https://sdr.salesdever.io/webhook/saas-criar-template', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            instanceName: currentTemplateInstance.name,
            tenant_id: userData.user.tenant_id,
            templateData: {
              name: name,
              category: category,
              language: language,
              components: components
            }
          })
        });

        if (!response.ok) throw new Error('Erro ao criar template');

        customSuccess('Template criado com sucesso! Aguarde aprova√ß√£o da Meta (pode levar at√© 24h).', 'Template Enviado!');
        closeCreateTemplateModal();
        await loadTemplates();

      } catch (error) {
        console.error('Erro:', error);
        customError('Erro ao criar template. Verifique os dados e tente novamente.', 'Erro');
      } finally {
        btn.disabled = false;
        btn.innerHTML = `
          <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Criar Template
        `;
      }
    }

  </script>

  <!-- Custom Popup/Alert Modal -->
  <div class="custom-popup-overlay" id="customPopup">
    <div class="custom-popup-content">
      <div class="custom-popup-icon" id="popupIcon"></div>
      <h3 class="custom-popup-title" id="popupTitle"></h3>
      <p class="custom-popup-message" id="popupMessage"></p>
      <div class="custom-popup-buttons" id="popupButtons"></div>
    </div>
  </div>

  <!-- Modal de Templates -->
  <div class="modal-overlay" id="templatesModal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title">Templates de Mensagem</h2>
        <button class="modal-close" onclick="closeTemplatesModal()">√ó</button>
      </div>

      <!-- Header com info e bot√£o criar -->
      <div style="margin-bottom: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, rgba(24, 119, 242, 0.1), rgba(24, 119, 242, 0.05)); border: 1px solid rgba(24, 119, 242, 0.2); border-radius: 1rem;">
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div style="text-align: center;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="#1877F2">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
              <h3 style="color: #1877F2; font-size: 1.2rem; font-weight: 700; margin: 0;">WhatsApp Business API</h3>
            </div>
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin: 0;">Gerencie seus templates de mensagem aprovados pela Meta</p>
          </div>
          <div style="display: flex; justify-content: center;">
            <button class="modal-btn modal-btn-primary" onclick="openCreateTemplateModal()" style="background: linear-gradient(135deg, #1877F2, #0C5AA6); padding: 0.875rem 1.5rem; border-radius: 0.75rem; font-weight: 600;">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 0.5rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
              </svg>
              Novo Template
            </button>
          </div>
        </div>
      </div>

      <!-- Container dos templates -->
      <div id="templatesContainer">
        <div class="spinner" style="margin: 2rem auto;"></div>
      </div>
    </div>
  </div>

  <!-- Modal de Cria√ß√£o de Template -->
  <div class="modal-overlay" id="createTemplateModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Criar Novo Template</h2>
        <button class="modal-close" onclick="closeCreateTemplateModal()">√ó</button>
      </div>

      <form onsubmit="createTemplate(event)">
        <!-- Nome -->
        <div class="form-group">
          <label class="form-label">Nome do Template</label>
          <input type="text" id="templateName" class="form-input" placeholder="ex: mensagem_boas_vindas" required pattern="[a-z0-9_]+" title="Use apenas letras min√∫sculas, n√∫meros e underscores">
          <small style="color: rgba(255,255,255,0.5); display: block; margin-top: 0.5rem;">Apenas letras min√∫sculas, n√∫meros e _ (underscore)</small>
        </div>

        <!-- Categoria -->
        <div class="form-group">
          <label class="form-label">Categoria</label>
          <select id="templateCategory" class="form-select" required>
            <option value="">Selecione...</option>
            <option value="MARKETING">Marketing - Promo√ß√µes e ofertas</option>
            <option value="UTILITY">Utilidade - Confirma√ß√µes e atualiza√ß√µes</option>
            <option value="AUTHENTICATION">Autentica√ß√£o - C√≥digos e verifica√ß√£o</option>
          </select>
        </div>

        <!-- Idioma -->
        <div class="form-group">
          <label class="form-label">Idioma</label>
          <select id="templateLanguage" class="form-select" required>
            <option value="pt_BR" selected>Portugu√™s (Brasil)</option>
            <option value="en_US">English (US)</option>
            <option value="es">Espa√±ol</option>
          </select>
        </div>

        <!-- Header (opcional) -->
        <div class="form-group">
          <label class="form-label">Header (opcional)</label>
          <input type="text" id="templateHeader" class="form-input" placeholder="Ex: üéâ Promo√ß√£o Especial!">
        </div>

        <!-- Body (obrigat√≥rio) -->
        <div class="form-group">
          <label class="form-label">Corpo da Mensagem</label>
          <textarea id="templateBody" class="form-input" rows="4" placeholder="Ex: Ol√° {{1}}! Temos uma oferta especial para voc√™." required></textarea>
          <small style="color: rgba(255,255,255,0.5); display: block; margin-top: 0.5rem;">Use {{1}}, {{2}}, {{3}} para vari√°veis din√¢micas</small>
        </div>

        <!-- Footer (opcional) -->
        <div class="form-group">
          <label class="form-label">Footer (opcional)</label>
          <input type="text" id="templateFooter" class="form-input" placeholder="Ex: Responda SAIR para cancelar">
        </div>

        <div class="modal-actions">
          <button type="button" class="modal-btn modal-btn-secondary" onclick="closeCreateTemplateModal()">Cancelar</button>
          <button type="submit" class="modal-btn modal-btn-primary" id="createTemplateBtn" style="background: linear-gradient(135deg, #1877F2, #0C5AA6);">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Criar Template
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Popup de Alerta: Inst√¢ncias n√£o conectadas -->
  <div class="alert-popup-overlay" id="alertPopup">
    <div class="alert-popup-content">
      <div class="alert-icon">üì±</div>
      <h2 class="alert-title">Conex√£o Pendente</h2>
      <p class="alert-message">
        Identificamos que voc√™ possui inst√¢ncia(s) que ainda n√£o foram conectadas ao WhatsApp. 
        Clique em "Conectar" na inst√¢ncia desejada para gerar o QR Code e finalizar a conex√£o.
      </p>
      <div class="alert-instances-list" id="alertInstancesList">
        <!-- Inst√¢ncias n√£o conectadas ser√£o listadas aqui -->
      </div>
      <button class="alert-btn" onclick="closeAlertPopup()">
        Entendi, vou conectar agora
      </button>
    </div>
  </div>

</body>
</html>